<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Stellantis ‚Äì Suivi des Arr√™ts Cha√Æne & Absences</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- Biblioth√®que PeerJS pour la synchronisation P2P -->
<script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>

<!-- Socket.IO (mode en ligne / temps r√©el) -->
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- Firebase (Realtime Database) -->
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-database-compat.js"></script>

<!-- Chart.js pour les graphiques -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
    :root {
        --primary: #1A7DFF;
        --danger: #d90429;
        --success: #2a9d8f;
        --warning: #ff9f1c;
        --info: #0ea5e9;
        --dark: #0d1b2a;
        --darker: #1b263b;
        --light: #e0e1dd;
    }
    
    body { 
        font-family: 'Segoe UI', Arial, sans-serif; 
        background: linear-gradient(135deg, var(--dark) 0%, #1a1a2e 100%);
        color: var(--light); 
        margin: 0; 
        padding: 15px; 
        min-height: 100vh;
    }
    
    .container { 
        max-width: 600px; 
        margin: auto;
        background: rgba(27, 38, 59, 0.8);
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 0 40px rgba(0, 0, 0, 0.5); 
        backdrop-filter: blur(10px);
    }
    
    h1 { 
        text-align: center; 
        color: var(--primary); 
        font-size: 28px; 
        margin-bottom: 20px;
        text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    .header-info {
        display: flex;
        justify-content: space-between;
        margin-bottom: 15px;
        font-size: 14px;
    }
    
    .timer-display {
        background: rgba(0,0,0,0.3);
        padding: 10px;
        border-radius: 8px;
        text-align: center;
        margin: 15px 0;
        font-size: 18px;
        font-weight: bold;
        color: var(--warning);
        border: 2px solid rgba(255, 159, 28, 0.3);
    }
    
    select, input { 
        width: 100%; 
        padding: 14px; 
        background: rgba(255,255,255,0.1); 
        border: 1px solid rgba(255,255,255,0.2);
        color: var(--light); 
        margin-top: 8px; 
        border-radius: 8px; 
        font-size: 16px;
        transition: border 0.3s;
    }
    
    input[type="time"], input[type="number"] {
        padding: 10px;
        font-size: 16px;
    }

    select:focus, input:focus {
        outline: none;
        border-color: var(--primary);
    }
    
    .button-group {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-top: 15px;
    }
    
    button { 
        padding: 16px; 
        border: none; 
        font-size: 16px; 
        font-weight: bold; 
        border-radius: 8px; 
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }
    
    button:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    button:active {
        transform: translateY(0);
    }
    
    #stopBtn { 
        background: linear-gradient(135deg, var(--danger) 0%, #9d0208 100%);
        color: white;
    }
    
    #goBtn { 
        background: linear-gradient(135deg, var(--success) 0%, #1a936f 100%);
        color: white;
    }
    
    .button-group-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-top: 10px;
    }
    
    #csvBtn, #csvAbsencesBtn { 
        background: linear-gradient(135deg, var(--primary) 0%, #00509e 100%);
        color: white;
    }

    #csvAbsencesBtn {
        background: linear-gradient(135deg, var(--info) 0%, #0077c2 100%);
    }

    #whBtn, #whStartBtn { 
        background: linear-gradient(135deg, #25D366 0%, #1ebc5b 100%);
        color: white;
    }
    
    .button-group-3 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-top: 10px;
    }
    
    #whShiftBtn {
        background: linear-gradient(135deg, #5856d6 0%, #5e5ce6 100%);
        color: white;
    }
    
    #clearBtn {
        background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        color: white;
    }
    
    .stats-container {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        margin: 20px 0;
    }
    
    .stat-box {
        background: rgba(0,0,0,0.2);
        padding: 15px;
        border-radius: 8px;
        text-align: center;
        border-left: 4px solid var(--primary);
    }
    
    .stat-value {
        font-size: 24px;
        font-weight: bold;
        color: var(--primary);
        display: block;
    }
    
    .stat-box[style*="--success"] .stat-value {
        color: var(--success) !important;
    }
    .stat-box[style*="--info"] .stat-value {
        color: var(--info) !important;
    }

    #absenceBreakdownTable th {
        background: rgba(14, 165, 233, 0.2);
        font-weight: 500;
        font-size: 12px;
        padding: 8px;
    }
    #absenceBreakdownTable td {
        padding: 8px;
        font-size: 13px;
        border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    table { 
        width:100%; 
        margin-top:20px; 
        background: rgba(0,0,0,0.2);
        border-collapse:collapse; 
        border-radius: 8px;
        overflow: hidden;
    }
    
    th,td { 
        padding:12px; 
        text-align: left;
        border-bottom:1px solid rgba(255,255,255,0.1); 
        font-size:14px; 
    }
    
    th {
        background: rgba(26, 125, 255, 0.2);
        font-weight: 600;
    }
    
    tr:hover {
        background: rgba(255,255,255,0.05);
    }
    
    .tabs {
        display: flex;
        margin: 20px 0 10px 0;
        background: rgba(0,0,0,0.2);
        border-radius: 8px;
        overflow: hidden;
        flex-wrap: wrap;
    }
    
    .tab {
        flex: 1;
        padding: 12px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
        min-width: 100px;
    }
    
    .tab.active {
        background: var(--primary);
        font-weight: bold;
    }
    
    .chart-container {
        background: rgba(0,0,0,0.2); 
        padding:20px; 
        margin-top:10px; 
        border-radius:12px;
        border: 1px solid rgba(255,255,255,0.1);
        display: none;
    }
    
    .chart-container.active {
        display: block;
    }
    
    canvas { 
        width:100%!important; 
        height:280px!important; 
    }
    
    .cause-suggestions {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 10px;
    }
    
    .cause-btn {
        padding: 6px 12px;
        background: rgba(26, 125, 255, 0.2);
        border: 1px solid var(--primary);
        border-radius: 20px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .cause-btn:hover {
        background: var(--primary);
    }
    
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }
    
    .modal-content {
        background: var(--darker);
        padding: 30px;
        border-radius: 15px;
        max-width: 400px;
        width: 90%;
    }
    
    .filter-group {
        display: flex;
        gap: 10px;
        margin: 10px 0;
        flex-wrap: wrap;
    }
    
    .filter-btn {
        flex: 1;
        padding: 8px;
        background: rgba(26, 125, 255, 0.2);
        border: 1px solid var(--primary);
        border-radius: 6px;
        text-align: center;
        cursor: pointer;
        font-size: 14px;
        min-width: 80px;
    }
    
    .filter-btn.active {
        background: var(--primary);
    }
    
    .input-group {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 10px;
    }
    
    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
    
    .save-indicator {
        position: fixed;
        bottom: 10px;
        right: 10px;
        background: var(--success);
        color: white;
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 12px;
        opacity: 0;
        transition: opacity 0.3s;
        z-index: 1000;
    }
    
    .save-indicator.visible {
        opacity: 1;
    }
    
    .alarm-indicator {
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--warning);
        color: white;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(255, 159, 28, 0.4);
        z-index: 10000;
        animation: pulse 1.5s infinite;
        max-width: 300px;
        display: none;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 159, 28, 0.7); }
        70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(255, 159, 28, 0); }
        100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 159, 28, 0); }
    }
    
    .alarm-controls {
        display: flex;
        gap: 10px;
        margin-top: 10px;
    }
    
    .alarm-controls button {
        padding: 8px 12px;
        font-size: 12px;
        flex: 1;
    }
    
    @media (max-width: 480px) {
        .container { padding: 15px; }
        .button-group, .button-group-2, .button-group-3 { grid-template-columns: 1fr; }
        .stats-container { grid-template-columns: 1fr; }
        button { padding: 14px; }
        .filter-group { flex-wrap: wrap; }
        .input-group { grid-template-columns: 1fr; }
        .tabs { flex-wrap: wrap; }
        .tab { min-width: 30%; }
        .alarm-indicator {
            top: 10px;
            right: 10px;
            left: 10px;
            max-width: none;
        }
    }
    
    .shift-indicator {
        text-align: center;
        margin: 10px 0 20px 0;
        padding: 10px;
        background: rgba(26, 125, 255, 0.2);
        border-radius: 8px;
        font-size: 14px;
        border: 1px solid rgba(26, 125, 255, 0.3);
    }
    
    .shift-date-selector {
        margin: 10px 0;
        padding: 10px;
        background: rgba(0,0,0,0.2);
        border-radius: 8px;
    }
    
    #shiftSelector {
        margin: 10px 0;
        padding: 10px;
        background: rgba(26, 125, 255, 0.1);
        border-radius: 8px;
        border: 1px solid rgba(26, 125, 255, 0.3);
    }
    
    /* ANIMATIONS POUR LE RENDEMENT AUTO */
    @keyframes slideInUp {
        from {
            transform: translate(-50%, 100%);
            opacity: 0;
        }
        to {
            transform: translate(-50%, 0);
            opacity: 1;
        }
    }
    
    @keyframes slideOutDown {
        from {
            transform: translate(-50%, 0);
            opacity: 1;
        }
        to {
            transform: translate(-50%, 100%);
            opacity: 0;
        }
    }
    
    @keyframes pulseGlow {
        0% { box-shadow: 0 0 0 0 rgba(26, 125, 255, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(26, 125, 255, 0); }
        100% { box-shadow: 0 0 0 0 rgba(26, 125, 255, 0); }
    }
    
    /* STYLES AJOUT√âS POUR TEAM LEADER */
    .team-leader-group {
        margin-bottom: 15px;
        background: rgba(0,0,0,0.1);
        padding: 15px;
        border-radius: 8px;
        border: 1px solid rgba(255,255,255,0.1);
    }
    
    .team-leader-input {
        width: 100%;
        padding: 12px;
        background: rgba(255,255,255,0.15);
        border: 2px solid var(--primary);
        border-radius: 8px;
        color: #FFD700;
        font-size: 16px;
        font-weight: bold;
        margin-bottom: 10px;
        transition: all 0.3s;
    }
    
    .team-leader-input:focus {
        outline: none;
        border-color: #FFD700;
        box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
    }
    
    #saveTeamLeaderBtn {
        background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
        color: #000;
        font-weight: bold;
        width: 100%;
    }
    
    #saveTeamLeaderBtn:hover {
        background: linear-gradient(135deg, #FFA500 0%, #FF8C00 100%);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3);
    }
    
    /* STYLES POUR L'√âDITION EN LIGNE */
    .editable-cell {
        cursor: pointer;
        position: relative;
        transition: background-color 0.2s;
    }
    
    .editable-cell:hover {
        background-color: rgba(26, 125, 255, 0.2) !important;
    }
    
    .editable-cell.editing {
        background-color: rgba(255, 215, 0, 0.2) !important;
        padding: 2px !important;
    }
    
    .editable-input {
        width: 100%;
        height: 100%;
        padding: 8px;
        background: rgba(0,0,0,0.7);
        border: 2px solid #FFD700;
        border-radius: 4px;
        color: #FFD700;
        font-size: 14px;
        font-weight: bold;
        outline: none;
    }
    
    .edit-tooltip {
        position: absolute;
        top: -25px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.9);
        color: #FFD700;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 11px;
        white-space: nowrap;
        z-index: 100;
        border: 1px solid #FFD700;
        display: none;
    }
    
    .editable-cell:hover .edit-tooltip {
        display: block;
    }
    
    /* STYLES POUR LES CELLULES D'√âQUIPE */
    .team-cell {
        padding: 6px 10px;
        border-radius: 15px;
        font-weight: bold;
        text-align: center;
        display: inline-block;
        min-width: 60px;
    }
    
    .team-A { background: rgba(26, 125, 255, 0.3); color: #1A7DFF; }
    .team-B { background: rgba(42, 157, 143, 0.3); color: #2a9d8f; }
    .team-C { background: rgba(255, 159, 28, 0.3); color: #ff9f1c; }
    .team-D { background: rgba(148, 0, 211, 0.3); color: #9400d3; }
    
    /* STYLES POUR LE CHAT */
    .chat-toggle-btn {
        position: fixed;
        bottom: 20px;
        left: 20px;
        background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
        color: black;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        cursor: pointer;
        z-index: 999;
        box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
        transition: all 0.3s;
    }
    
    .chat-toggle-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(255, 215, 0, 0.4);
    }
    
    .chat-toggle-btn.has-unread::after {
        content: 'üî¥';
        position: absolute;
        top: 0;
        right: 0;
        font-size: 12px;
        animation: pulse 1.5s infinite;
    }
    
    .chat-container {
        position: fixed;
        bottom: 80px;
        left: 20px;
        width: 350px;
        height: 450px;
        background: rgba(13, 27, 42, 0.95);
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        z-index: 998;
        display: none;
        flex-direction: column;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 215, 0, 0.3);
        overflow: hidden;
    }
    
    .chat-container.active {
        display: flex;
        animation: slideInUp 0.3s ease-out;
    }
    
    .chat-header {
        background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
        color: black;
        padding: 15px;
        font-weight: bold;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid rgba(0,0,0,0.2);
    }
    
    .chat-close-btn {
        background: none;
        border: none;
        color: black;
        font-size: 20px;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background 0.3s;
    }
    
    .chat-close-btn:hover {
        background: rgba(0,0,0,0.1);
    }
    
    .chat-messages {
        flex: 1;
        padding: 15px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    
    .chat-message {
        max-width: 80%;
        padding: 10px 15px;
        border-radius: 15px;
        word-wrap: break-word;
        font-size: 14px;
        line-height: 1.4;
    }
    
    .chat-message.sent {
        align-self: flex-end;
        background: linear-gradient(135deg, #1A7DFF 0%, #00509e 100%);
        color: white;
        border-bottom-right-radius: 5px;
    }
    
    .chat-message.received {
        align-self: flex-start;
        background: rgba(255, 255, 255, 0.1);
        color: #e0e1dd;
        border-bottom-left-radius: 5px;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .chat-message .sender {
        font-size: 11px;
        font-weight: bold;
        margin-bottom: 3px;
        opacity: 0.8;
    }
    
    .chat-message .time {
        font-size: 10px;
        opacity: 0.6;
        margin-top: 5px;
        text-align: right;
    }
    
    .chat-input-container {
        padding: 15px;
        border-top: 1px solid rgba(255,255,255,0.1);
        display: flex;
        gap: 10px;
    }
    
    .chat-input {
        flex: 1;
        padding: 10px 15px;
        background: rgba(255,255,255,0.1);
        border: 1px solid rgba(255, 215, 0, 0.3);
        border-radius: 25px;
        color: white;
        font-size: 14px;
    }
    
    .chat-input:focus {
        outline: none;
        border-color: #FFD700;
    }
    
    .chat-send-btn {
        background: linear-gradient(135deg, #25D366 0%, #1ebc5b 100%);
        color: white;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .chat-send-btn:hover {
        transform: scale(1.1);
    }
    
    .chat-send-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }
    
    .chat-notification {
        position: fixed;
        bottom: 140px;
        left: 20px;
        background: rgba(13, 27, 42, 0.95);
        color: white;
        padding: 10px 15px;
        border-radius: 10px;
        font-size: 12px;
        max-width: 300px;
        border-left: 4px solid #FFD700;
        animation: slideInUp 0.3s ease-out;
        z-index: 997;
        backdrop-filter: blur(10px);
        display: none;
    }
    
    @keyframes blink {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

/* === Auto Stop Badge (Arr√™t de cha√Æne) === */
#autoStopBadge{
  position: fixed;
  top: calc(env(safe-area-inset-top, 0px) + 12px);
  right: 16px;
  z-index: 10000;
  display: none;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  border-radius: 14px;
  background: rgba(13,27,42,0.92);
  border: 1px solid rgba(255,255,255,0.12);
  box-shadow: 0 10px 30px rgba(255, 159, 28, 0.25);
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
  max-width: min(92vw, 360px);
}
#autoStopBadge .icon{
  width: 34px;
  height: 34px;
  border-radius: 12px;
  display:flex;
  align-items:center;
  justify-content:center;
  background: rgba(255,159,28,0.18);
  border: 1px solid rgba(255,159,28,0.35);
  font-size: 18px;
}
#autoStopBadge .meta{
  display:flex;
  flex-direction: column;
  gap: 2px;
  min-width: 0;
}
#autoStopBadge .title{
  font-weight: 800;
  color: #ff9f1c;
  font-size: 13px;
  line-height: 1.1;
}
#autoStopBadge .line{
  color: rgba(255,255,255,0.88);
  font-size: 12px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
#autoStopBadge .time{
  font-variant-numeric: tabular-nums;
  font-weight: 800;
}
#autoStopBadge .actions{
  margin-left: auto;
  display:flex;
  gap: 6px;
}
#autoStopBadge button{
  border: 1px solid rgba(255,255,255,0.18);
  background: rgba(255,255,255,0.06);
  color: rgba(255,255,255,0.9);
  border-radius: 10px;
  padding: 6px 8px;
  cursor: pointer;
  font-size: 12px;
}
#autoStopBadge button:hover{
  background: rgba(255,255,255,0.10);
}


/* --- Google search bar --- */
.google-search-card{
  margin: 14px 0 18px 0;
  padding: 12px;
  border: 1px solid rgba(255,255,255,.12);
  border-radius: 14px;
  background: rgba(255,255,255,.04);
}
.google-search-row{
  display:flex;
  gap:10px;
  align-items:center;
}
.google-search-input{
  flex:1;
  padding: 12px 12px;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,.18);
  background: rgba(0,0,0,.18);
  color: #fff;
  font-size: 16px;
}
.google-search-input::placeholder{ color: rgba(255,255,255,.55); }
.google-search-btn{
  padding: 12px 14px;
  border-radius: 12px;
  border: none;
  font-weight: 800;
  font-size: 16px;
  background: #fff;
  color:#000;
  cursor:pointer;
  white-space: nowrap;
}
.google-search-hint{
  margin-top: 8px;
  font-size: 12px;
  opacity: .85;
}


/* ===== Mode Recherche (App / Google) ===== */
.search-mode-row{
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
  margin:8px 0 10px 0;
}
.sm-item{
  display:flex;
  gap:8px;
  align-items:center;
  padding:8px 10px;
  border-radius:999px;
  background: rgba(255,255,255,0.08);
  border:1px solid rgba(255,255,255,0.10);
  font-weight:800;
  font-size:13px;
  color:#fff;
}
.sm-item input{ transform: scale(1.1); }
.sm-scope{ margin-left:auto; }

/* ===== R√©sultats recherche ÿØÿßÿÆŸÑ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ===== */
.app-search-results{
  margin-top:10px;
  padding:10px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,0.12);
  background:#ffffff;
  color:#000000;
}
.app-search-results .as-head{
  display:flex;
  gap:10px;
  align-items:center;
  justify-content:space-between;
  margin-bottom:8px;
}
.app-search-results .as-title{
  font-weight:900;
  font-size:14px;
}
.app-search-results .as-btn{
  padding:8px 10px;
  border-radius:12px;
  border:2px solid #000000;
  background:#ffffff;
  color:#000000;
  font-weight:900;
  font-size:13px;
  cursor:pointer;
}
.app-search-results .as-list{
  display:flex;
  flex-direction:column;
  gap:8px;
  max-height:260px;
  overflow:auto;
  padding-right:4px;
}
.app-search-results .as-item{
  padding:10px;
  border-radius:12px;
  border:1px solid rgba(0,0,0,0.12);
  background:#f8fafc;
}
.app-search-results .as-line1{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  align-items:center;
  font-weight:900;
}
.app-search-results .tag{
  display:inline-block;
  padding:2px 8px;
  border-radius:999px;
  border:1px solid rgba(0,0,0,0.25);
  font-size:12px;
  font-weight:900;
}
.app-search-results .tag.missed{ background:#ffe4e6; }
.app-search-results .tag.team{ background:#e0f2fe; }
.app-search-results .as-cause{
  margin-top:6px;
  font-size:14px;
  line-height:1.25;
  font-weight:800;
}


 (table des arr√™ts) ===== */
.internal-search-bar{
  display:flex;
  gap:10px;
  align-items:center;
  margin:10px 0 8px 0;
  padding:10px;
  background: rgba(255,255,255,0.06);
  border:1px solid rgba(255,255,255,0.10);
  border-radius:14px;
}
.internal-search-bar input{
  flex:1;
  padding:12px 14px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,0.18);
  background:#ffffff;
  color:#000000;
  font-size:16px;
  outline:none;
}
.internal-search-bar button{
  padding:12px 14px;
  border-radius:12px;
  border:none;
  background: rgba(255,255,255,0.14);
  color:#ffffff;
  font-weight:800;
  font-size:14px;
}
#internalSearchInfo{
  margin-top:4px;
  font-size:12px;
  color:#e5e7eb;
  opacity:0.9;
  text-align:right;
}


/* =============================
   MODE SUPPRESSION (DELETE)
   ============================= */
.delete-col, .delete-cell { display: none; }
body.delete-mode .delete-col,
body.delete-mode .delete-cell { display: table-cell; }

.delete-btn {
    background: rgba(231, 76, 60, 0.18);
    border: 1px solid rgba(231, 76, 60, 0.45);
    color: #fff;
    font-weight: 800;
    padding: 8px 10px;
    border-radius: 10px;
    cursor: pointer;
    min-width: 44px;
}
.delete-btn:active { transform: scale(0.98); }


    /* Date r√©elle (calendrier) affich√©e sous l'heure */
    .real-date{
        font-size: 11px;
        font-weight: 800;
        opacity: 0.85;
        margin-top: 2px;
        line-height: 1.1;
    }
    
</style>

<!-- ============================
     AJOUT IA - RAPPORT PDF / 5 POURQUOI / PDCA / PLAN D'ACTION
     ============================ -->
<style>
    /* Zone rapport IA/PDF */
    .ai-panel {
        margin-top: 10px;
        padding: 15px;
        background: rgba(0,0,0,0.2);
        border-radius: 12px;
        border: 1px solid rgba(255,255,255,0.1);
    }
    .ai-panel h3 {
        margin: 0 0 10px 0;
        color: #FFD700;
        text-align: center;
        font-size: 16px;
    }

    .ai-controls-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-top: 10px;
    }
    @media (max-width: 480px) {
        .ai-controls-grid { grid-template-columns: 1fr; }
    }

    .ai-btn-row {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 10px;
        margin-top: 12px;
    }
    @media (max-width: 480px) {
        .ai-btn-row { grid-template-columns: 1fr; }
    }

    .ai-btn {
        padding: 12px;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
    }
    .ai-btn-generate { background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); color: #000; }
    .ai-btn-save { background: linear-gradient(135deg, #1A7DFF 0%, #00509e 100%); color: #fff; }
    .ai-btn-pdf { background: linear-gradient(135deg, #2a9d8f 0%, #1a936f 100%); color: #fff; }
    .ai-btn-print { background: linear-gradient(135deg, #6c757d 0%, #495057 100%); color: #fff; }

    /* Imprimable PDF: fond blanc / texte sombre */
    #aiReportPrintable {
        background: #ffffff;
        color: #111827;
        border-radius: 12px;
        padding: 18px;
        border: 1px solid rgba(0,0,0,0.08);
    }

    .ai-report-header {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        gap: 10px;
        align-items: flex-start;
        margin-bottom: 12px;
        border-bottom: 2px solid rgba(0,0,0,0.08);
        padding-bottom: 10px;
    }
    .ai-report-title {
        font-size: 18px;
        font-weight: 800;
        letter-spacing: 0.3px;
        color: #0f172a;
        outline: none;
    }
    .ai-report-meta {
        font-size: 12px;
        color: #334155;
        line-height: 1.4;
    }
    .ai-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 999px;
        font-size: 11px;
        font-weight: 700;
        background: rgba(26,125,255,0.12);
        color: #1A7DFF;
        border: 1px solid rgba(26,125,255,0.2);
        margin-right: 6px;
        margin-bottom: 4px;
    }

    .ai-kpi-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
        margin: 12px 0 16px 0;
    }
    @media (max-width: 900px) { .ai-kpi-grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 480px) { .ai-kpi-grid { grid-template-columns: 1fr; } }

    .ai-kpi {
        background: rgba(0,0,0,0.03);
        border: 1px solid rgba(0,0,0,0.06);
        border-radius: 10px;
        padding: 10px;
    }
    .ai-kpi .label { font-size: 11px; color: #475569; }
    .ai-kpi .value { font-size: 18px; font-weight: 800; color: #0f172a; margin-top: 4px; }

    .ai-grid-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-top: 10px;
    }
    @media (max-width: 900px) { .ai-grid-2 { grid-template-columns: 1fr; } }

    .ai-card {
        background: rgba(0,0,0,0.02);
        border: 1px solid rgba(0,0,0,0.06);
        border-radius: 12px;
        padding: 12px;
    }

    .ai-card h3 {
        margin: 0 0 10px 0;
        font-size: 14px;
        color: #0f172a;
    }

    .ai-editable {
        outline: none;
        background: #fff;
        border: 1px dashed rgba(0,0,0,0.25);
        border-radius: 8px;
        padding: 8px;
        min-height: 38px;
        white-space: pre-wrap;
        font-size: 13px;
        color: #0f172a;
    }
    .ai-editable.small { min-height: 28px; padding: 6px 8px; }

    .ai-5why-list {
        margin: 0;
        padding-left: 20px;
        display: grid;
        gap: 8px;
    }

    .ai-table {
        width: 100%;
        border-collapse: collapse;
        overflow: hidden;
        border-radius: 10px;
        margin-top: 8px;
    }
    .ai-table th, .ai-table td {
        border-bottom: 1px solid rgba(0,0,0,0.08);
        padding: 8px;
        font-size: 12px;
        vertical-align: top;
    }
    .ai-table th { background: rgba(26,125,255,0.08); color: #0f172a; }
    .ai-table td { background: rgba(255,255,255,0.6); }

    .ai-muted {
        font-size: 11px;
        color: #64748b;
        margin-top: 6px;
    }

    /* Export PDF: on cache les √©l√©ments "no-print" et on √©largit la zone */
    body.ai-exporting .no-print {
        display: none !important;
    }
    body.ai-exporting .container {
        max-width: 980px !important;
    }

    /* Impression syst√®me (Print -> Enregistrer en PDF) */
    @media print {
        body.ai-printing {
            background: #ffffff !important;
        }
        body.ai-printing .container {
            max-width: none !important;
            margin: 0 !important;
            padding: 0 !important;
            background: #ffffff !important;
            box-shadow: none !important;
            border-radius: 0 !important;
        }
        body.ai-printing .container > * {
            display: none !important;
        }
        body.ai-printing #aiReportChartContainer {
            display: block !important;
        }
        body.ai-printing #aiReportPrintable {
            display: block !important;
            border: none !important;
            padding: 0 !important;
        }
        body.ai-printing .no-print {
            display: none !important;
        }
    }

</style>

<style id="__top_shortcuts_style">
  .top-shortcuts{position:sticky;top:0;z-index:9999;display:flex;gap:10px;justify-content:center;align-items:center;
    padding:10px 12px;margin:10px 0 14px 0;border-radius:14px;
    background:#0b2847;border:1px solid rgba(255,255,255,.16);box-shadow:0 10px 24px rgba(0,0,0,.25);
  }
  .top-shortcuts button{appearance:none;border:1px solid rgba(255,255,255,.18);border-radius:12px;padding:10px 14px;
    font-weight:900;letter-spacing:.2px;cursor:pointer;
    background:#1f76ff;color:#fff;min-width:140px;
  }
  #topBtnDefauts{background:#ffd700;color:#1a1200;border-color:rgba(0,0,0,.12);}
  .top-shortcuts button:active{transform:translateY(1px);}
</style>

</head>
<body>
<div class="container">

<h1>üè≠ STELLANTIS - SUIVI DES ARR√äTS CHA√éNE</h1>

<div class="header-info">
    <div id="currentDate"></div>
    <div id="currentTime"></div>
</div>

<!-- üß≠ Raccourcis (haut) -->
<div id="topShortcuts" class="top-shortcuts no-print" role="navigation" aria-label="Raccourcis">
  <button id="topBtnDefauts" type="button">üß© D√©fauts</button>
</div>

<!-- üîé Recherche (App + Google) -->
<div id="googleSearchSection" class="google-search-card no-print">
  <div style="font-weight:900;margin-bottom:8px;">üîé Recherche (ÿØÿßÿÆŸÑ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ + Google)</div>

  <div class="search-mode-row" role="group" aria-label="Mode de recherche">
    <label class="sm-item">
      <input type="radio" name="searchMode" id="searchModeApp" value="app" checked>
      <span>ÿØÿßÿÆŸÑ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ</span>
    </label>
    <label class="sm-item">
      <input type="radio" name="searchMode" id="searchModeGoogle" value="google">
      <span>Google</span>
    </label>
    <label class="sm-item sm-scope" title="Si activ√©: chercher dans tout l'historique enregistr√©">
      <input type="checkbox" id="searchAllHistory" checked>
      <span>ŸÉŸÑ ÿßŸÑÿ≥ÿ¨ŸÑ</span>
    </label>
  </div>

  <form id="googleSearchForm" class="google-search-row" autocomplete="off">
    <input id="googleSearchInput" class="google-search-input" type="search"
           placeholder="ÿßŸÉÿ™ÿ® ÿ≥ÿ®ÿ® ÿ™ŸàŸÇŸÅ‚Ä¶ (ex: Manque pi√®ce, Qualit√©, Andon‚Ä¶)" />
    <button class="google-search-btn" type="submit">Rechercher</button>
  </form>

  <div id="appSearchResults" class="app-search-results" style="display:none;"></div>
</div>


<!-- S√©lecteur de shift 3x8 -->
<div id="shiftSelector">
    <div style="font-size: 14px; margin-bottom: 8px; color: #ccc; text-align: center;">
        üïê S√âLECTION DU SHIFT 3x8
    </div>
    <div style="display: flex; gap: 8px; justify-content: center; flex-wrap: wrap;">
        <button onclick="selectShift('Nuit')" id="shiftNuitBtn" style="padding: 8px 12px; background: var(--primary); color: white; border-radius: 5px; border: 1px solid var(--primary); font-weight: bold;">
            üåô Nuit (22h-6h)
        </button>
        <button onclick="selectShift('Matin')" id="shiftMatinBtn" style="padding: 8px 12px; background: var(--dark); color: white; border-radius: 5px; border: 1px solid var(--primary);">
            ‚òÄÔ∏è Matin (6h-14h)
        </button>
        <button onclick="selectShift('Apr√®s-midi')" id="shiftApresMidiBtn" style="padding: 8px 12px; background: var(--dark); color: white; border-radius: 5px; border: 1px solid var(--primary);">
            üåÖ Apr√®s-midi (14h-22h)
        </button>
    </div>
</div>

<!-- Indicateur de shift actuel -->
<div id="shiftIndicator" class="shift-indicator">
    üìÖ <strong>Shift actuel:</strong> <span id="currentShiftDate">...</span> 
    (<span id="currentShiftHours">23h-6h</span>)
</div>

<!-- S√©lecteur de shift manuel -->
<div class="shift-date-selector">
    <div style="font-size: 13px; margin-bottom: 5px; color: #ccc;">
        üîç S√©lectionner un shift sp√©cifique :
    </div>
    <div style="display: flex; gap: 10px;">
        <input type="date" id="shiftDatePicker" style="flex: 1;">
        <button onclick="selectSpecificShift()" style="padding: 8px 12px; background: var(--primary);">
            üìÖ Aller
        </button>
        <button onclick="resetToCurrentShift()" style="padding: 8px 12px; background: var(--warning);">
            üîÑ Actuel
        </button>
    </div>
</div>

<!-- Indicateur d'alarme -->
<div class="alarm-indicator" id="pauseAlarmIndicator">
    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
        <span style="font-size: 24px;">‚è∞</span>
        <div>
            <strong id="alarmTitle">ALARME PAUSE</strong>
            <div id="alarmMessage" style="font-size: 14px; margin-top: 5px;"></div>
        </div>
    </div>
    <div class="alarm-controls">
        <button id="snoozeAlarmBtn" style="background: var(--warning);">Snooze 5 min</button>
        <button id="stopAlarmBtn" style="background: var(--danger);">Arr√™ter l'alarme</button>
    </div>
</div>

<select id="equipe">
    <option value="A">√âquipe A</option>
    <option value="B">√âquipe B</option>
    <option value="C">√âquipe C</option>
    <option value="D">√âquipe D</option>
</select>

<button id="whStartBtn" style="margin-top: 10px; width: 100%;">üìã Rapport D√©but de Shift</button>

<div id="timerDisplay" class="timer-display">00:00:00</div>

<!-- CHAMP TEAM LEADER -->
<div class="team-leader-group">
    <label for="teamLeader" style="color: #FFD700; font-weight: bold; display: block; margin-bottom: 8px;">
        üë®‚Äçüíº TEAM LEADER:
    </label>
    <input id="teamLeader" type="text" placeholder="Nom du Team Leader" class="team-leader-input">
    <button id="saveTeamLeaderBtn" onclick="saveTeamLeader()">
        üíæ SAUVEGARDER TEAM LEADER
    </button>
</div>

<input id="cause" type="text" placeholder="üîç Saisir la cause librement..." list="cause-list" />
<datalist id="cause-list">
    <option value="PAUSE CAF√â / MIDI">
    <option value="Manque composant">
    <option value="Probl√®me machine">
    <option value="Maintenance pr√©ventive">
    <option value="R√©glage machine">
    <option value="Attente chariot">
    <option value="Probl√®me qualit√©">
    <option value="Absence op√©rateur">
    <option value="Formation">
    <option value="Incident s√©curit√©">
    <option value="Changement outillage">
    <option value="Nettoyage poste">
    <option value="Attente composant">
    <option value="Panne √©lectrique">
    <option value="Panne pneumatique">
    <option value="R√©union d'√©quipe">
</datalist>

<div class="cause-suggestions">
    <span class="cause-btn" onclick="setCause('PAUSE CAF√â / MIDI')">Pause</span>
    <span class="cause-btn" onclick="setCause('Manque composant')">Manque composant</span>
    <span class="cause-btn" onclick="setCause('Probl√®me machine')">Probl√®me machine</span>
    <span class="cause-btn" onclick="setCause('Maintenance pr√©ventive')">Maintenance</span>
</div>

<div class="button-group">
    <button id="stopBtn">‚õî D√âBUT ARR√äT</button>
    <button id="goBtn">‚ñ∂Ô∏è REPRISE CHA√éNE</button>
</div>

<div class="button-group" style="margin-top: 10px;">
    <button id="missedStopBtn">‚è±Ô∏è AJOUTER ARR√äT RAT√â</button>
</div>

<div class="button-group" style="margin-top: 10px;">
    <button id="specialStartNowBtn" style="background: rgba(255, 193, 7, 0.18); border: 1px solid rgba(255, 193, 7, 0.35);">
        ‚≠ê D√âBUT ARR√äT SP√âCIAL (EN COURS)
    </button>
    <button id="specialResumeBtn" disabled style="background: rgba(46, 204, 113, 0.18); border: 1px solid rgba(46, 204, 113, 0.35); opacity:0.6;">
        ‚úÖ REPRISE ARR√äT SP√âCIAL
    </button>
</div>

<div id="specialActiveBanner" style="display:none; margin-top:12px; padding:12px; border-radius:12px; border:1px solid rgba(255,193,7,0.35); background: rgba(255, 193, 7, 0.12);">
    <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap;">
        <div style="flex:1; min-width:220px;">
            <div style="font-weight:800; letter-spacing:0.2px;">‚≠ê ARR√äT SP√âCIAL EN COURS</div>
            <div id="specialActiveText" style="margin-top:6px; color:#fff; opacity:0.95; line-height:1.35;"></div>
            <div style="margin-top:6px; font-size:12px; color:#ddd; opacity:0.9;">
                La production est consid√©r√©e en arr√™t jusqu‚Äô√† ce que vous cliquiez sur <strong>REPRISE</strong>.
            </div>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
            <button id="specialResumeBigBtn" style="background: rgba(46, 204, 113, 0.22); border: 1px solid rgba(46, 204, 113, 0.45); font-weight:800;">
                ‚úÖ REPRISE
            </button>
            <button id="specialChangeBtn" style="background: rgba(255,255,255,0.10); border: 1px solid rgba(255,255,255,0.20);">
                ‚úèÔ∏è Modifier cause
            </button>
        </div>
    </div>
</div>


<div class="stats-container">
    <div class="stat-box">
        <span>Arr√™ts Aujourd'hui</span>
        <span class="stat-value" id="count">0</span>
    </div>
    <div class="stat-box">
        <span>Arr√™ts Rat√©s (Aujourd'hui)</span>
        <span class="stat-value" id="missedStopsCount" style="color:var(--warning);">0</span>
    </div>
    <div class="stat-box">
        <span>Temps Total (Brut)</span>
        <span class="stat-value" id="totalTime">0s</span>
    </div>
    
    <div class="stat-box" style="grid-column: 1 / 3; border-left-color: var(--warning); padding: 10px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
            <span style="font-weight: bold;">Pauses Forfaitaires D√©finies</span>
            <button id="testAlarmBtn" style="background: var(--warning); padding: 5px 10px; font-size: 12px; border-radius: 5px;">
                üîî Tester Alarme
            </button>
        </div>
        <p style="font-size:12px; margin-top:0; color:#ccc;">Ces pauses seront automatiquement enregistr√©es pour la d√©duction NETTE.</p>

        <label for="p1Start" style="display: block; margin-top: 5px; font-size: 13px;">Pause 1</label>
        <div style="display: flex; gap: 10px;">
            <input type="time" id="p1Start" value="08:00" onchange="updatePauseTimes();" style="flex: 1;">
            <input type="time" id="p1End" value="08:30" onchange="updatePauseTimes();" style="flex: 1;">
        </div>
        
        <label for="p2Start" style="display: block; margin-top: 5px; font-size: 13px;">Pause 2</label>
        <div style="display: flex; gap: 10px;">
            <input type="time" id="p2Start" value="10:00" onchange="updatePauseTimes();" style="flex: 1;">
            <input type="time" id="p2End" value="10:30" onchange="updatePauseTimes();" style="flex: 1;">
        </div>
        
        <label for="p3Start" style="display: block; margin-top: 5px; font-size: 13px;">Pause 3</label>
        <div style="display: flex; gap: 10px;">
            <input type="time" id="p3Start" value="12:00" onchange="updatePauseTimes();" style="flex: 1;">
            <input type="time" id="p3End" value="12:30" onchange="updatePauseTimes();" style="flex: 1;">
        </div>
        
        <div style="margin-top: 10px; padding: 8px; background: rgba(255, 159, 28, 0.1); border-radius: 5px;">
            <label style="display: block; margin-bottom: 5px; font-size: 12px;">
                <input type="checkbox" id="enableAlarms" checked onchange="toggleAlarms()">
                Activer les alarmes de pause
            </label>
            <label style="display: block; margin-top: 5px; font-size: 12px;">
                <input type="number" id="alarmMinutes" min="1" max="30" value="2" style="width: 50px; padding: 3px; margin-right: 5px;">
                minutes avant chaque pause
            </label>
        </div>
    </div>
    <div class="stat-box" style="border-left-color: var(--success);">
        <span>Total Minutes Arr√™t (Net)</span>
        <span class="stat-value" id="netTotalMinutes" style="color:var(--success);">0 min</span>
    </div>
    <div class="stat-box" style="border-left-color: var(--success);">
        <span>Total Secondes Arr√™t (Net)</span>
        <span class="stat-value" id="netTotalSeconds" style="color:var(--success);">0s</span>
    </div>
</div>


<!-- SECTION DISPONIBILIT√â (AUTO - TEMPS R√âEL) -->
<div style="margin-top: 18px; padding: 15px; background: rgba(0,0,0,0.25); border-radius: 12px; border: 1px solid rgba(255,255,255,0.10);">
    <h2 style="color:#4CC9F0; text-align:center; margin-bottom:10px; font-size: 18px;">üìà DISPONIBILIT√â (TEMPS R√âEL)</h2>

    <div class="stats-container">
        <div class="stat-box" style="border-left-color: var(--info);">
            <span>Disponibilit√©</span>
            <span class="stat-value" id="disponibilite" style="color:var(--info);">--%</span>
        </div>
    </div>

    <div id="dispoDetails" style="margin-top: 10px; font-size: 12px; color:#cbd5e1; text-align:center;"></div>
</div>


<!-- SECTION CALCUL DE PRODUCTION DE V√âHICULES -->
<div style="margin-top: 25px; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);">
    <h2 style="color:#FFD700; text-align:center; margin-bottom:15px; font-size: 18px;">üöó CALCUL DE PRODUCTION DE V√âHICULES</h2>
    <!-- OBJECTIF & SUIVI PRODUCTION (AUTO) -->
    <div id="prodObjectiveDashboard" style="margin: 15px 0 10px; padding: 12px; border-radius: 14px; background: rgba(255,215,0,0.07); border: 1px solid rgba(255,215,0,0.25);">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
        <div style="font-weight:900; color:#FFD700;">üéØ Objectif production (Auto)</div>
        <div style="font-size:12px; color:#ccc;">Temps restant: <span id="objectiveTimeRemaining" style="color:#FFD700; font-weight:900;">--:--</span></div>
      </div>

      <div style="margin-top:10px; padding:10px; border-radius:12px; background: rgba(0,0,0,0.25); border: 1px solid rgba(255,255,255,0.10);">
        <div style="font-weight:900; margin-bottom:6px;">‚è±Ô∏è Temps de cycle (mm:ss)</div>
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <div style="display:flex; gap:8px; align-items:center; flex:1; min-width:220px;">
            <input id="cycleMinInput" type="number" inputmode="numeric" min="0" step="1" placeholder="4"
                   style="width:90px; padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,0.12); background: rgba(255,215,0,0.08); color:#FFD700; font-weight:900; text-align:center;">
            <span style="color:#ddd; font-weight:800;">min</span>
            <input id="cycleSecInput" type="number" inputmode="numeric" min="0" max="59" step="1" placeholder="27"
                   style="width:90px; padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,0.12); background: rgba(255,215,0,0.08); color:#FFD700; font-weight:900; text-align:center;">
            <span style="color:#ddd; font-weight:800;">s</span>

            <!-- Champ technique (reste pour ne pas casser le JS existant) -->
            <input id="cycleTimeInput" type="hidden" value="4:27">
          </div>
          <button id="saveCycleTimeBtn" style="padding:12px; border-radius:12px; border:0; font-weight:900; background: linear-gradient(135deg, #25D366 0%, #1ebc5b 100%); color:#fff;">üíæ Sauvegarder</button>
          <button id="deleteCycleTimeBtn" style="padding:12px; border-radius:12px; border:0; font-weight:900; background: linear-gradient(135deg, #d90429 0%, #9d0208 100%); color:#fff;">üóëÔ∏è Supprimer</button>
        </div>
        <div style="margin-top:6px; font-size:12px; color:#ddd;">
          Actuel: <span id="cycleTimeDisplay" style="color:#FFD700; font-weight:900;">4:27</span>
          <span style="margin-left:8px; color:#ccc;">|</span>
          <span style="margin-left:8px; color:#ddd;">‚âà <span id="cycleRatePerHour" style="color:#FFD700; font-weight:900;">--</span> v√©h/h</span>
          <span style="margin-left:8px; color:#ccc;">|</span>
          <span style="margin-left:8px; color:#ddd;">Th√©orique (450 min, sans arr√™ts): <span id="cycleShiftTheoretical" style="color:#FFD700; font-weight:900;">--</span></span>
          <span id="cycleTimeDirtyBadge" style="display:none; margin-left:8px; padding:2px 8px; border-radius:999px; background: rgba(255,159,28,0.18); color:#ff9f1c; font-weight:900;">Non sauvegard√©</span>
        </div>
      </div>

      <div class="stats-container" style="margin-top:12px;">
        <div class="stat-box" style="border-left-color: var(--info);">
          <span>Cadence cible (v√©h/heure)</span>
          <span class="stat-value" id="cadenceCibleValue" style="color:var(--info);">-- v√©h/h</span>
        </div>

        <div class="stat-box" style="border-left-color: var(--warning);">
          <span>Objectif fin de shift</span>
          <span class="stat-value" id="objectiveShiftUnits" style="color:var(--warning);">0</span>
        </div>
        <div class="stat-box" style="border-left-color: var(--primary);">
          <span>Produits maintenant (auto)</span>
          <span class="stat-value" id="producedNowAuto" style="color:var(--primary);">0</span>
        </div>
        <div class="stat-box" style="border-left-color: var(--success);">
          <span>Restant (auto)</span>
          <span class="stat-value" id="remainingToObjective" style="color:var(--success);">0</span>
        </div>
        <div class="stat-box" style="border-left-color: var(--danger);">
          <span>Perdus (fin shift)</span>
          <span class="stat-value" id="lostUnitsEnd" style="color:var(--danger);">0</span>
        </div>
        <div class="stat-box" style="border-left-color: var(--danger);">
          <span>Perdus cette heure</span>
          <span class="stat-value" id="lostThisHourUnits" style="color:var(--danger);">0</span>
        </div>
        <div class="stat-box" style="border-left-color: var(--info);">
          <span>Arr√™ts nets (min)</span>
          <span class="stat-value" id="stopsNetMinutesEnd" style="color:var(--info);">0</span>
        </div>
      </div>

      <div style="margin-top:10px; padding:10px; border-radius:12px; background: rgba(0,0,0,0.18); border: 1px solid rgba(255,255,255,0.08);">
        <div style="font-weight:900; margin-bottom:8px;">üïí Pertes par heure (arr√™ts nets)</div>
        <table style="width:100%; border-collapse:collapse;">
          <thead>
            <tr>
              <th style="text-align:left; padding:8px; font-size:12px;">Heure</th>
              <th style="text-align:right; padding:8px; font-size:12px;">Arr√™ts (min)</th>
              <th style="text-align:right; padding:8px; font-size:12px;">V√©hicules perdus</th>
            </tr>
          </thead>
          <tbody id="hourlyLossBody"></tbody>
        </table>
      </div>

      
      <!-- PARETO 80/20 ‚Äì Pertes de production (v√©hicules) -->
      <div id="paretoProductionLossContainer" style="margin-top:14px; padding:12px; border-radius:14px; background: rgba(0,0,0,0.25); border: 1px solid rgba(255,255,255,0.10);">
        <div style="display:flex; align-items:flex-start; justify-content:space-between; flex-wrap:wrap; gap:10px;">
          <div style="font-weight:900; color:#FFD700;">üìä Pareto 80/20 ‚Äì Pertes de production (v√©hicules) par cause</div>
          <div style="font-size:12px; color:#9aa4b2; text-align:right;">
            Calcul = Dur√©e d‚Äôarr√™t (s) √∑ Temps de cycle (s) ‚Üí v√©hicules perdus
          </div>
        </div>

        <div style="margin-top:10px;">
          <canvas id="paretoProductionLossChart" height="170"></canvas>
        </div>

        <div id="paretoProductionLossSummary" style="margin-top:10px; font-size:12px; color:#cbd5e1; line-height:1.5;">
          <!-- rempli automatiquement -->
        </div>
      </div>

      <!-- √©l√©ments "compat" (cach√©s) pour √©viter de casser d'anciens calculs -->
      <div style="display:none">
        <span id="availableTimeDisplay"></span>
        <span id="theoreticalVehicles"></span>
        <span id="lostVehicles"></span>
        <span id="producedVehicles"></span>
      </div>
    </div>

    <!-- Statut du jour / Jours sans travail -->
    <div style="margin-bottom: 15px; padding: 12px; border-radius: 12px; background: rgba(0,0,0,0.25); border: 1px solid rgba(255,255,255,0.12);">
        <div style="display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;">
            <div style="color:#FFD700; font-weight:900;">üóìÔ∏è Statut du jour / ÿ≠ÿßŸÑÿ© ÿßŸÑŸäŸàŸÖ</div>
            <div id="workModeBadge" style="padding:6px 10px; border-radius:999px; font-weight:900; font-size:12px; background:#1f8a3b; color:#fff;">
                üü¢ Travail / Production
            </div>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
            <input type="date" id="workStatusDate"
                   style="flex:1; min-width:160px; padding:10px; border-radius:12px;
                          border:1px solid rgba(255,215,0,0.4); background: rgba(255,215,0,0.08);
                          color:#FFD700; font-weight:800;" />
            <select id="workModeSelect"
                    style="flex:2; min-width:200px; padding:10px; border-radius:12px;
                           border:1px solid rgba(255,215,0,0.4); background: rgba(255,215,0,0.08);
                           color:#FFD700; font-weight:900;">
                <option value="production">üü¢ Travail / Production</option>
                <option value="holiday">üü° ÿπÿ∑ŸÑÿ© / Week-end / F√©ri√© (Pas de production)</option>
                <option value="machine_off">üî¥ Machine arr√™t total (Pas de production)</option>
            </select>
        </div>

        <input type="text" id="workModeReason"
               placeholder="(ÿßÿÆÿ™Ÿäÿßÿ±Ÿä) ÿ≥ÿ®ÿ® ÿßŸÑÿ™ŸàŸÇŸÅ ÿßŸÑŸäŸàŸÖ / Raison du statut..."
               style="width:100%; margin-top:10px; padding:10px; border-radius:12px;
                      border:1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.06);
                      color:#fff; font-weight:800;" />

        <button id="saveWorkModeBtn"
                style="margin-top:10px; width:100%; padding:12px; border:0; border-radius:14px;
                       font-size:16px; font-weight:900; background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
                       color:#000;">
            üíæ Sauvegarder le statut (ÿßŸÑŸäŸàŸÖ)
        </button>

        <!-- ÿπÿ∑ŸÑÿ© ÿ£ÿ≥ÿ®ŸàÿπŸäÿ© ÿ™ŸÑŸÇÿßÿ¶Ÿäÿ© / Week-end auto -->
        <div style="margin-top:10px; padding-top:10px; border-top:1px dashed rgba(255,255,255,0.18);">
            <div style="color:#FFD700; font-weight:900; margin-bottom:6px;">üîÅ ÿπÿ∑ŸÑÿ© ÿ£ÿ≥ÿ®ŸàÿπŸäÿ© ÿ™ŸÑŸÇÿßÿ¶Ÿäÿ© / Week-end auto</div>
            <div id="offDaysBox" style="display:flex; flex-wrap:wrap; gap:8px;">
                <label style="font-size:12px; color:#fff; font-weight:700;"><input class="offDayCb" type="checkbox" value="1"> Lun ÿßŸÑÿ•ÿ´ŸÜŸäŸÜ</label>
                <label style="font-size:12px; color:#fff; font-weight:700;"><input class="offDayCb" type="checkbox" value="2"> Mar ÿßŸÑÿ´ŸÑÿßÿ´ÿßÿ°</label>
                <label style="font-size:12px; color:#fff; font-weight:700;"><input class="offDayCb" type="checkbox" value="3"> Mer ÿßŸÑÿ£ÿ±ÿ®ÿπÿßÿ°</label>
                <label style="font-size:12px; color:#fff; font-weight:700;"><input class="offDayCb" type="checkbox" value="4"> Jeu ÿßŸÑÿÆŸÖŸäÿ≥</label>
                <label style="font-size:12px; color:#fff; font-weight:700;"><input class="offDayCb" type="checkbox" value="5"> Ven ÿßŸÑÿ¨ŸÖÿπÿ©</label>
                <label style="font-size:12px; color:#fff; font-weight:700;"><input class="offDayCb" type="checkbox" value="6"> Sam ÿßŸÑÿ≥ÿ®ÿ™</label>
                <label style="font-size:12px; color:#fff; font-weight:700;"><input class="offDayCb" type="checkbox" value="0"> Dim ÿßŸÑÿ£ÿ≠ÿØ</label>
            </div>
            <div style="font-size:12px; color:#ddd; margin-top:6px; line-height:1.35;">
                ÿ•ÿ∞ÿß ŸÑŸÖ ÿ™ÿ≠ŸÅÿ∏ ÿ≠ÿßŸÑÿ© ÿ™ÿßÿ±ŸäÿÆ ŸÖÿπŸäŸëŸÜÿå ÿ≥Ÿäÿ™ŸÖ ÿ™ÿ∑ÿ®ŸäŸÇ <b>ÿßŸÑÿπÿ∑ŸÑÿ© ÿßŸÑÿ£ÿ≥ÿ®ŸàÿπŸäÿ©</b> ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã.
            </div>
        </div>

        <div style="margin-top:8px; font-size:12px; color:#ddd; line-height:1.4;">
            ‚úÖ ÿ•ÿ∞ÿß ÿßÿÆÿ™ÿ±ÿ™ <b>‚ÄúPas de production‚Äù</b> ÿ≥Ÿäÿ™ŸÖ Ÿàÿ∂ÿπ <b>ÿßŸÑÿ•ŸÜÿ™ÿßÿ¨ = 0</b> ŸàŸÑŸÜ ÿ™Ÿèÿ≠ÿ≥ÿ® ÿßŸÑÿÆÿ≥ÿßÿ¶ÿ± ŸÅŸä Ÿáÿ∞ÿß ÿßŸÑŸäŸàŸÖ.
        </div>
    </div>

    
    

<div style="margin-top: 25px; padding: 15px; background: rgba(0,0,0,0.22); border-radius: 12px; border:1px solid rgba(255,255,255,0.06);">
    <div style="font-size: 22px; color: #0ea5e9; font-weight:900; text-align:center; letter-spacing:0.5px;">
        SYNCHRONISATION EN LIGNE (TEMPS R√âEL)
    </div>
    <div style="font-size: 12px; color:#9aa4b2; margin-top: 6px; text-align:center; line-height:1.4;">
        Collaboration <b>en ligne</b> : tous les coll√®gues se connectent au m√™me <b>Room</b>.
        <br><span style="opacity:.9;">(Choisis: Supabase ÿ®ÿØŸàŸÜ ÿ≥Ÿäÿ±ŸÅÿ± ‚úÖ ÿ£Ÿà Socket.IO ÿ£Ÿà Firebase)</span>
    </div>

    <div class="input-group" style="margin-top: 10px;">
        <label style="font-size: 12px; color:#c7d2fe;">Mode</label>
        <select id="onlineMode" style="width:100%; padding: 12px; border-radius: 12px; border:1px solid rgba(255,255,255,0.10); background: rgba(0,0,0,0.25); color:#e5e7eb;">
            <option value="supabase">‚úÖ Supabase (sans serveur)</option>
            <option value="socket">üß© Serveur Socket.IO</option>
			<option value="firebase">üî• Firebase RTDB</option>
        </select>
        <div id="onlineModeHelp" style="font-size: 11px; color:#9aa4b2; margin-top:6px; line-height:1.35;">
            <b>Supabase:</b> ÿ™ÿ≠ÿ™ÿßÿ¨ <b>Project URL</b> + <b>anon key</b> ŸÅŸÇÿ∑. <span style="color:#fbbf24;">ŸÑÿß ÿ™ÿ≥ÿ™ÿπŸÖŸÑ secret key.</span><br>
            <b>Socket.IO:</b> ÿ™ÿ≠ÿ™ÿßÿ¨ ÿ±ÿßÿ®ÿ∑ ÿ≥Ÿäÿ±ŸÅÿ± Node.js ŸÅŸäŸá socket.io.<br><b>Firebase:</b> ÿ™ÿ≠ÿ™ÿßÿ¨ <b>firebaseConfig JSON</b> + ÿ™ŸÅÿπŸäŸÑ <b>Anonymous Auth</b> + ŸÇŸàÿßÿπÿØ Rules.
        </div>
    </div>

    <div id="onlineSupabaseFields" style="margin-top: 8px;">
        <div class="input-group">
            <input id="onlineSupabaseUrl" type="text" placeholder="Supabase Project URL (ex: https://xxxx.supabase.co)"
                   style="background: rgba(0,0,0,0.25); border: 1px solid rgba(255,255,255,0.08); color: #e5e7eb;">
        </div>
        <div class="input-group">
            <input id="onlineSupabaseKey" type="password" placeholder="Supabase anon (publishable) key"
                   style="background: rgba(0,0,0,0.25); border: 1px solid rgba(255,255,255,0.08); color: #e5e7eb;">
            <div style="font-size: 11px; color:#9aa4b2; margin-top:6px;">
                ÿßŸÑŸÖÿ≥ÿßÿ±: <b>Supabase ‚Üí Project Settings ‚Üí API ‚Üí (Project URL + anon/public key)</b>
            </div>
        </div>
    </div>

    <div id="onlineSocketFields" style="margin-top: 8px; display:none;">
        <div class="input-group">
            <input id="onlineServerUrl" type="text" placeholder="URL du serveur Socket.IO (ex: https://votre-serveur.onrender.com)"
                   style="background: rgba(0,0,0,0.25); border: 1px solid rgba(255,255,255,0.08); color: #e5e7eb;">
        </div>
    </div>


    <div id="onlineFirebaseFields" style="margin-top: 8px; display:none;">
        <div class="input-group">
            <textarea id="onlineFirebaseConfig" rows="5" placeholder='firebaseConfig JSON (ex: {"apiKey":"...","authDomain":"...","databaseURL":"...","projectId":"...","appId":"..."})'
                      style="width:100%; padding: 12px; border-radius: 12px; border:1px solid rgba(255,255,255,0.10); background: rgba(0,0,0,0.25); color:#e5e7eb; resize:vertical;"></textarea>
            <div style="font-size: 11px; color:#9aa4b2; margin-top:6px; line-height:1.35;">
                ÿßŸÑŸÖÿ≥ÿßÿ±: <b>Firebase Console ‚Üí Project settings ‚Üí General ‚Üí Your apps (Web) ‚Üí firebaseConfig</b><br>
                ‚ö†Ô∏è ÿßÿ≥ÿ™ÿπŸÖŸÑ <b>Realtime Database</b> (databaseURL) ŸàŸÅÿπŸëŸÑ <b>Anonymous Auth</b>.
            </div>
        </div>
        <div class="input-group" style="margin-top:6px;">
            <label style="font-size:12px; color:#c7d2fe; font-weight:700; display:flex; gap:8px; align-items:center;">
                <input id="onlineFirebaseAdminMode" type="checkbox">
                Responsable (ÿ•ÿ±ÿ≥ÿßŸÑ/ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ≠ÿßŸÑÿ©). ÿ•ÿ∞ÿß ÿ∫Ÿäÿ± ŸÖŸÅÿπŸëŸÑ: ŸÖÿ¥ÿßŸáÿØÿ© ŸÅŸÇÿ∑.
            </label>
            <div style="font-size: 11px; color:#9aa4b2; margin-top:6px; line-height:1.35;">
                ŸÜŸÜÿµÿ≠ ÿ®ŸÇŸàÿßÿπÿØ Rules: ÿßŸÑŸÇÿ±ÿßÿ°ÿ© ŸÑŸÑÿ¨ŸÖŸäÿπ (auth) ŸàÿßŸÑŸÉÿ™ÿßÿ®ÿ© ŸÑŸÑŸÖÿ≥ÿ§ŸàŸÑŸäŸÜ ŸÅŸÇÿ∑ (admins).
            </div>
        </div>
    </div>

    <div class="input-group">
        <input id="onlineRoom" type="text" placeholder="Room (ex: LIGNE-1-A)"
               style="background: rgba(0,0,0,0.25); border: 1px solid rgba(255,255,255,0.08); color: #e5e7eb;">
    </div>

    <div class="input-group">
        <input id="onlineUserName" type="text" placeholder="Votre nom"
               style="background: rgba(0,0,0,0.25); border: 1px solid rgba(255,255,255,0.08); color: #e5e7eb;">
    </div>

    <button id="onlineConnectBtn" class="btn-primary" style="width:100%; margin-top:8px;">
        üñäÔ∏è Se connecter en ligne
    </button>

    <button id="onlineDisconnectBtn" class="btn-secondary" style="width:100%; margin-top:8px;">
        ‚õî D√©connecter
    
</button>


    <div style="margin-top:10px; display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;">
        <label style="display:flex; align-items:center; gap:8px; font-size:13px; color:#e5e7eb; font-weight:800;">
            <input id="onlineAutoConnect" type="checkbox" style="width:18px; height:18px; accent-color:#22c55e;">
            üîÅ Auto‚ÄëConnect (ÿπŸÜÿØ ŸÅÿ™ÿ≠ ÿßŸÑÿµŸÅÿ≠ÿ©)
        </label>

        <button id="secretResetBtn" type="button"
                style="padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,0.18);
                       background: rgba(0,0,0,0.25); color:#fff; font-weight:900; cursor:pointer;">
            üîí Reset (PIN)
        </button>
    </div>
    <div style="font-size:11px; color:#9aa4b2; margin-top:6px; line-height:1.35;">
        ‚úÖ Reset ŸäŸÖÿ≥ÿ≠ ÿ®ŸäÿßŸÜÿßÿ™ Ÿáÿ∞ÿß ÿßŸÑÿ¨Ÿáÿßÿ≤ ŸÅŸÇÿ∑ (localStorage + IndexedDB + Cache) ÿ´ŸÖ ŸäÿπŸäÿØ ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©. ŸÑÿß ŸäŸÖÿ≥ÿ≠ Firebase ÿπŸÜÿØ ÿßŸÑÿ≤ŸÖŸÑÿßÿ°.
    </div>

    <div class="stats-container" style="margin-top: 12px; grid-template-columns: 1fr 1fr;">
        <div class="stat-box" style="border-left: 4px solid #0ea5e9;">
            <div class="stat-label">√âtat (en ligne)</div>
            <div class="stat-value" id="onlineStatus">Non connect√©</div>
        </div>
        <div class="stat-box" style="border-left: 4px solid #22c55e;">
            <div class="stat-label">Connect√©s dans le Room</div>
            <div class="stat-value" id="onlinePeersCount">0</div>
        </div>
    </div>

    <div style="font-size: 11px; color:#9aa4b2; margin-top: 10px; text-align:center;">
        ‚úÖ Les arr√™ts, absences, chat et <b>posts</b> se synchronisent automatiquement (toutes les ~1-2 secondes).
    </div>
</div>


<!-- SECTION SYNCHRONISATION P2P AVEC PEERJS -->
<div style="margin-top: 25px; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);">
    <h2 style="color:#FFD700; text-align:center; margin-bottom:15px; font-size: 18px;">üîÑ SYNCHRONISATION P2P ENTRE APPAREILS</h2>
    
    <div class="input-group">
        <input id="peerIdInput" type="text" placeholder="ID de l'appareil distant (auto-g√©n√©r√©)" readonly style="background: rgba(255,215,0,0.1); color: #FFD700;"/>
        <button id="copyPeerIdBtn" style="background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); color: black;">
            üìã Copier ID
        </button>
    </div>
    
    <div class="input-group" style="margin-top: 10px;">
        <input id="connectToPeerInput" type="text" placeholder="Collez l'ID de l'autre appareil"/>
        <button id="connectPeerBtn" style="background: linear-gradient(135deg, #25D366 0%, #1ebc5b 100%); color: white;">
            üîó Se connecter
        </button>
    </div>
    
    <div class="stats-container" style="margin-top: 15px; grid-template-columns: 1fr 1fr;">
        <div class="stat-box" style="border-left-color: #25D366;">
            <span>√âtat Connexion</span>
            <span class="stat-value" id="peerStatus" style="color:#25D366;">Non connect√©</span>
        </div>
        <div class="stat-box" style="border-left-color: #FFD700;">
            <span>Appareils Connect√©s</span>
            <span class="stat-value" id="connectedPeersCount" style="color:#FFD700;">0</span>
        </div>
    </div>
    
    <div class="button-group" style="margin-top: 15px;">
        <button id="syncDataBtn" style="background: linear-gradient(135deg, #5856d6 0%, #5e5ce6 100%); color: white;">
            üîÑ Synchroniser donn√©es
        </button>
        <button id="broadcastBtn" style="background: linear-gradient(135deg, #0ea5e9 0%, #0077c2 100%); color: white;">
            üì° Diffuser arr√™t en cours
        </button>
    </div>
    
    <div style="margin-top: 10px; padding: 10px; background: rgba(255,215,0,0.1); border-radius: 8px; border-left: 3px solid #FFD700;">
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
            <span style="font-size: 16px;">‚ÑπÔ∏è</span>
            <div style="font-size: 12px; color: #FFD700;">
                <strong>Comment synchroniser :</strong>
            </div>
        </div>
        <div style="font-size: 11px; color: #ccc;">
            1. Copiez votre ID (ci-dessus)<br>
            2. Sur l'autre appareil, collez cet ID et cliquez "Se connecter"<br>
            3. Cliquez "Synchroniser donn√©es" pour √©changer les arr√™ts
        </div>
    </div>
</div>

<!-- SECTION ENREGISTREMENT DES ABSENCES -->
<div style="margin-top: 25px; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);">
    <h2 style="color:var(--info); text-align:center; margin-bottom:15px; font-size: 18px;">üë• ENREGISTREMENT DES ABSENCES</h2>
    
    <div class="input-group">
        <select id="absenceType">
            <option value="">-- Type d'Absence --</option>
            <option value="AA">AA: Absences Autoris√©</option>
            <option value="AI">AI: Absences Irr√©gulier</option>
            <option value="CM">CM: Cong√©s M√©dical</option>
            <option value="CR">CR: Cong√©s R√©cup√©ration</option>
            <option value="CA">CA: Cong√©s Annuels</option>
            <option value="SU">SU: Suspendu</option>
        </select>
        <input id="absencePoste" type="text" placeholder="Poste/Op√©rateur" />
    </div>
    
    <div class="input-group">
        <input id="absenceDays" type="number" placeholder="Dur√©e (Jours)" min="0.5" step="0.5" style="margin-bottom: 10px;" />
        <input id="absenceHours" type="number" placeholder="Dur√©e (Heures - Auto)" min="0.5" step="0.5" style="margin-bottom: 10px;" />
    </div>
    
    <button id="logAbsenceBtn" style="background: linear-gradient(135deg, var(--info) 0%, #0077c2 100%); color: white; padding: 12px; width: 100%;" onclick="logAbsence()">
        ‚ûï ENREGISTRER L'ABSENCE
    </button>
    
    <div class="stats-container" style="margin-top: 15px; grid-template-columns: repeat(2, 1fr);">
        <div class="stat-box" style="border-left-color: var(--info);">
            <span>Nb Absences (Total)</span>
            <span class="stat-value" id="totalAbsenceCount" style="color:var(--info);">0</span>
        </div>
        <div class="stat-box" style="border-left-color: var(--info);">
            <span>Total Jours (Jour)</span>
            <span class="stat-value" id="absenceTotalDays" style="color:var(--info);">0j</span>
        </div>
        <div class="stat-box" style="border-left-color: var(--info);">
            <span>Nb Jours d'Absence</span>
            <span class="stat-value" id="absenceDaysCount" style="color:var(--info);">0</span>
        </div>
        <div class="stat-box" style="border-left-color: var(--info);">
            <span>Nb Absences (Jour)</span>
            <span class="stat-value" id="todayAbsenceCount" style="color:var(--info);">0</span>
        </div>
    </div>
    
    <div class="stat-box" style="border-left-color: var(--info); margin-top: 15px; grid-column: 1 / 3;">
        <h4 style="color:var(--info); margin-top: 0; text-align: center;">D√©tail par Justificatif (Total √âquipe)</h4>
        <table style="width: 100%; margin-top: 10px; font-size: 14px;" id="absenceBreakdownTable">
            <thead>
                <tr>
                    <th style="padding: 8px;">Type</th>
                    <th style="padding: 8px;">Poste/Op√©rateur</th>
                    <th style="padding: 8px;">Nb Jours</th>
                </tr>
            </thead>
            <tbody id="absenceBreakdownBody">
                </tbody>
        </table>
    </div>
</div>

<button id="manualSaveBtn" style="margin-top: 10px; width: 100%; background: linear-gradient(135deg, #9d4edd 0%, #560bad 100%); color: white;">
    üíæ Sauvegarder maintenant
</button>

<div class="button-group-2">
    <button id="csvBtn">üìÑ Export Arr√™ts CSV (Aujourd'hui)</button>
    <button id="csvAbsencesBtn">üìÑ Export Absences CSV</button>
</div>

<div class="button-group-3">
    <button id="whBtn">üì≤ WhatsApp Rapport Rapide</button>
    <button id="whShiftBtn">üìã WhatsApp Fin Shift</button>
</div>

<button id="clearBtn" style="margin-top: 10px; width: 100%;">üóëÔ∏è Effacer Donn√©es</button>

<button id="saveChangesBtn" style="margin-top: 10px; width: 100%; background: linear-gradient(135deg, #9d4edd 0%, #560bad 100%); color: white;">
    üíæ SAUVEGARDER MODIFICATIONS (CAUSES/ARR√äTS)
</button>

<div class="filter-group" id="stopTypeFilterGroup" style="margin-top: 10px;">
    <div class="filter-btn active" onclick="setStopTypeFilter('all')">Tous</div>
    <div class="filter-btn" onclick="setStopTypeFilter('normal')">Arr√™ts normaux</div>
    <div class="filter-btn" onclick="setStopTypeFilter('rat√©')">‚è±Ô∏è Arr√™ts rat√©s</div>
</div>

<!-- Recherche interne dans le tableau (hors Internet) -->
<div class="internal-search-bar">
    <input id="internalTableSearch" type="search" placeholder="üîé ÿ®ÿ≠ÿ´ ÿØÿßÿÆŸÑ ÿ¨ÿØŸàŸÑ ÿßŸÑÿ£ÿπÿ∑ÿßŸÑ (Cause / Date / Heure / TL...)"
           oninput="setInternalTableSearch(this.value)">
    <button type="button" onclick="clearInternalTableSearch()">‚úñ</button>
</div>
<div id="internalSearchInfo"></div>

<div style="font-size: 11px; color:#9aa4b2; margin-top: -2px; margin-bottom: 6px; text-align:center;">
    Les arr√™ts rat√©s (‚è±Ô∏è) sont inclus dans la grille des causes (Pareto) pour la tra√ßabilit√©.
</div>


<div class="button-group" style="margin-top: 10px;">
    <button id="toggleDeleteModeBtn" style="background: rgba(231, 76, 60, 0.18); border: 1px solid rgba(231, 76, 60, 0.35); color: #fff;">
        üóëÔ∏è Mode suppression : OFF
    </button>
</div>
<div style="font-size: 11px; color:#9aa4b2; text-align:center; margin-top: 6px;">
    Active le mode suppression pour afficher les boutons üóëÔ∏è dans la grille et supprimer un arr√™t.
</div>

<!-- Tableau avec √©dition en ligne -->


<!-- (Outils Direction supprim√©) -->


<!-- Zone invisible pour g√©n√©rer le PDF -->
<div id="pdfReportContainer" style="position:fixed; left:-9999px; top:-9999px; width:800px;"></div>


<div style="overflow-x: auto;">
    <table id="tableHist">
        <thead>
            <tr>
                <th>Date</th>
                <th>Cause</th>
                <th>D√©but</th>
                <th>Fin</th>
                <th>Dur√©e</th>
                <th>√âquipe</th>
                <th>Team Leader</th>
                <th class="delete-col">Supprimer</th>
            </tr>
        </thead>
        <tbody id="tableBody">
        </tbody>
    </table>
</div>

<div class="tabs">
    <div class="tab active" onclick="showTab('paretoHours')">üïí Tendance Temporelle</div>
    <div class="tab" onclick="showTab('paretoCauses')">üìä Pareto 80/20 Causes</div>
    <div class="tab" onclick="showTab('paretoStops')">üìà Pareto Nombre Arr√™ts</div>
    <div class="tab" onclick="showTab('paretoAbsences')">üë• Pareto Absences</div>
    <div class="tab" onclick="showTab('teamPerformance')">‚≠ê Performance √âquipes</div>
    <div class="tab" onclick="showTab('postsBoard')">üìù Posts</div>
    <div class="tab" onclick="showTab('aiReport')">üß† Rapport PDF + 5 Pourquoi</div>
</div>

<div id="paretoHoursChartContainer" class="chart-container active">
    <h2 style="color:var(--primary); text-align:center; margin-bottom:20px;">üïí DISTRIBUTION DES ARR√äTS PAR PLAGE HORAIRE</h2>
    <div class="filter-group">
        <div class="filter-btn active" onclick="filterHours('all')">Toutes √âquipes</div>
        <div class="filter-btn" onclick="filterHours('A')">√âquipe A</div>
        <div class="filter-btn" onclick="filterHours('B')">√âquipe B</div>
        <div class="filter-btn" onclick="filterHours('C')">√âquipe C</div>
        <div class="filter-btn" onclick="filterHours('D')">√âquipe D</div>
    </div>
    <div class="filter-group" style="margin-top: 10px;">
        <div class="filter-btn active" onclick="setChartPeriod('all')">Tous shifts</div>
        <div class="filter-btn" onclick="setChartPeriod('today')">Shift actuel</div>
        <div class="filter-btn" onclick="setChartPeriod('last4')">4 derniers shifts</div>    </div>
    <canvas id="paretoHoursChart"></canvas>
</div>

<div id="paretoCausesChartContainer" class="chart-container">
    <h2 style="color:var(--primary); text-align:center; margin-bottom:20px;">üìä PARETO 80/20 DES CAUSES (DUR√âE)</h2>
    <div class="filter-group">
        <div class="filter-btn active" onclick="filterCauses('all')">Toutes √âquipes</div>
        <div class="filter-btn" onclick="filterCauses('A')">√âquipe A</div>
        <div class="filter-btn" onclick="filterCauses('B')">√âquipe B</div>
        <div class="filter-btn" onclick="filterCauses('C')">√âquipe C</div>
        <div class="filter-btn" onclick="filterCauses('D')">√âquipe D</div>
    </div>
    <div class="filter-group" style="margin-top: 10px;">
        <div class="filter-btn active" onclick="setChartPeriod('all')">Tous shifts</div>
        <div class="filter-btn" onclick="setChartPeriod('today')">Shift actuel</div>
        <div class="filter-btn" onclick="setChartPeriod('last4')">4 derniers shifts</div>    </div>
    <canvas id="paretoCausesChart"></canvas>

<!-- Grille des causes + arr√™ts rat√©s (tra√ßabilit√©) -->
<div style="margin-top: 15px; background: rgba(0,0,0,0.18); border-radius: 12px; padding: 12px; border: 1px solid rgba(255,255,255,0.08);">
    <h3 style="margin: 0 0 10px; color: var(--primary); text-align:center;">üßæ Grille des causes (tra√ßabilit√©)</h3>
    <div style="font-size: 11px; color:#9aa4b2; text-align:center; margin-bottom: 10px;">
        Vue d√©taill√©e par cause (dur√©e + nb) avec colonne <b>Rat√©s</b> (‚è±Ô∏è).
    </div>
    <div style="overflow-x:auto;">
        <table style="width:100%; border-collapse: collapse; font-size: 13px;">
            <thead>
                <tr>
                    <th style="text-align:left; padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.08);">Cause</th>
                    <th style="text-align:right; padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.08);">Dur√©e</th>
                    <th style="text-align:right; padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.08);">Nb</th>
                    <th style="text-align:right; padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.08); color: var(--warning);">Rat√©s</th>
                    <th style="text-align:left; padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.08);">Exemples (horaires)</th>
                </tr>
            </thead>
            <tbody id="causesTraceBody"></tbody>
        </table>
    </div>
</div>

<div style="margin-top: 12px; background: rgba(255,159,28,0.08); border-radius: 12px; padding: 12px; border: 1px solid rgba(255,159,28,0.25);">
    <h3 style="margin: 0 0 10px; color: var(--warning); text-align:center;">‚è±Ô∏è Arr√™ts rat√©s (tra√ßabilit√©)</h3>
    <div style="font-size: 11px; color:#9aa4b2; text-align:center; margin-bottom: 10px;">
        Liste des arr√™ts rat√©s sur le filtre s√©lectionn√© (√©quipe + p√©riode).
    </div>
    <div style="overflow-x:auto;">
        <table style="width:100%; border-collapse: collapse; font-size: 13px;">
            <thead>
                <tr>
                    <th style="text-align:left; padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.08);">Date</th>
                    <th style="text-align:left; padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.08);">D√©but</th>
                    <th style="text-align:left; padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.08);">Fin</th>
                    <th style="text-align:right; padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.08);">Dur√©e</th>
                    <th style="text-align:left; padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.08);">Cause</th>
                    <th style="text-align:left; padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.08);">√âquipe</th>
                </tr>
            </thead>
            <tbody id="missedStopsTraceBody"></tbody>
        </table>
    </div>
</div>
</div>

<div id="paretoStopsChartContainer" class="chart-container">
    <h2 style="color:var(--primary); text-align:center; margin-bottom:20px;">üìà PARETO 80/20 DU NOMBRE D'ARR√äTS</h2>
    <div class="filter-group">
        <div class="filter-btn active" onclick="filterStops('all')">Toutes √âquipes</div>
        <div class="filter-btn" onclick="filterStops('A')">√âquipe A</div>
        <div class="filter-btn" onclick="filterStops('B')">√âquipe B</div>
        <div class="filter-btn" onclick="filterStops('C')">√âquipe C</div>
        <div class="filter-btn" onclick="filterStops('D')">√âquipe D</div>
    </div>
    <div class="filter-group" style="margin-top: 10px;">
        <div class="filter-btn active" onclick="setChartPeriod('all')">Tous shifts</div>
        <div class="filter-btn" onclick="setChartPeriod('today')">Shift actuel</div>
        <div class="filter-btn" onclick="setChartPeriod('last4')">4 derniers shifts</div>    </div>
    <canvas id="paretoStopsChart"></canvas>
</div>

<div id="paretoAbsencesChartContainer" class="chart-container">
    <h2 style="color:var(--info); text-align:center; margin-bottom:20px;">üìä PARETO 80/20 DES ABSENCES (JOURS)</h2>
    <div class="filter-group">
        <div class="filter-btn active" onclick="filterAbsences('all')">Toutes √âquipes</div>
        <div class="filter-btn" onclick="filterAbsences('A')">√âquipe A</div>
        <div class="filter-btn" onclick="filterAbsences('B')">√âquipe B</div>
        <div class="filter-btn" onclick="filterAbsences('C')">√âquipe C</div>
        <div class="filter-btn" onclick="filterAbsences('D')">√âquipe D</div>
    </div>
    <div class="filter-group" style="margin-top: 10px;">
        <div class="filter-btn active" onclick="setChartPeriod('all')">Tous shifts</div>
        <div class="filter-btn" onclick="setChartPeriod('today')">Shift actuel</div>
        <div class="filter-btn" onclick="setChartPeriod('last4')">4 derniers shifts</div>    </div>
    <canvas id="paretoAbsencesChart"></canvas>
</div>

<div id="teamPerformanceChartContainer" class="chart-container">
    <h2 style="color:var(--primary); text-align:center; margin-bottom:20px;">üë• PERFORMANCE PAR √âQUIPE</h2>
    <div class="filter-group">
        <div class="filter-btn active" onclick="filterPerformance('today')">Shift actuel</div>
        <div class="filter-btn" onclick="filterPerformance('week')">4 derniers shifts</div>        <div class="filter-btn" onclick="filterPerformance('all')">Tous shifts</div>
    </div>
    <div class="filter-group" style="margin-top: 10px;">
        <div class="filter-btn active" onclick="filterMetric('duration')">Par Dur√©e</div>
        <div class="filter-btn" onclick="filterMetric('stops')">Par Nombre d'Arr√™ts</div>
        <div class="filter-btn" onclick="filterMetric('efficiency')">Par Efficacit√©</div>
    </div>
    <canvas id="teamPerformanceChart"></canvas>
</div>




<div id="realtimeStopsBoardChartContainer" class="chart-container">
  <h2 style="text-align:center; margin-bottom:12px;">üìç ARR√äTS EN TEMPS R√âEL (USINE)</h2>

  <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center; align-items:center; margin-bottom:10px;">
    <input id="stationIdInput" type="text" placeholder="Poste (ex: P12)" style="min-width:140px; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.18); background:rgba(0,0,0,0.18); color:#e0e1dd;">
    <input id="stationZoneInput" type="text" placeholder="Zone / Cha√Æne (ex: Montage 1)" style="min-width:200px; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.18); background:rgba(0,0,0,0.18); color:#e0e1dd;">
    <button id="saveStationBtn" class="btn" style="padding:10px 12px;">üíæ Enregistrer</button>
  </div>

  <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center; align-items:center; margin-bottom:10px;">
    <select id="stationCauseSelect" style="min-width:220px; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.18); background:rgba(0,0,0,0.18); color:#e0e1dd;">
      <option value="">Cause (s√©lection)</option>
      <option value="Panne">Panne</option>
      <option value="Manque mati√®re">Manque mati√®re</option>
      <option value="Qualit√©">Qualit√©</option>
      <option value="R√©glage">R√©glage</option>
      <option value="S√©curit√©">S√©curit√©</option>
      <option value="Autre">Autre</option>
    </select>
    <input id="stationCauseOther" type="text" placeholder="Cause (si autre)" style="min-width:220px; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.18); background:rgba(0,0,0,0.18); color:#e0e1dd;">
    <button id="startStationStopBtn" class="btn" style="padding:10px 12px; background:rgba(239,68,68,0.18); border:1px solid rgba(239,68,68,0.45);">üî¥ D√©clarer arr√™t</button>
    <button id="endStationStopBtn" class="btn" style="padding:10px 12px; background:rgba(34,197,94,0.18); border:1px solid rgba(34,197,94,0.45);">üü¢ Reprise</button>
  </div>

  <div style="margin:8px 0 12px; font-size:11px; color:#9aa4b2; text-align:center;">
    ‚úÖ Chaque poste peut d√©clarer un arr√™t ind√©pendamment. Si 3 postes sont √† l‚Äôarr√™t en m√™me temps, vous verrez 3 ic√¥nes rouges üìç.
    <br/>üí° Pour le partage, activez <b>Mode en ligne ‚Üí Firebase</b> et utilisez la <b>m√™me room</b>.
  </div>

  <div id="realtimeStopsGrid" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap:10px;"></div>

  <!-- ‚úÖ NOUVEAU: üîî Alarmes STOP (Realtime) -->
  <div id="rtStopAlarmBar" style="margin-top:14px; padding:12px; border-radius:14px; border:1px solid rgba(255,255,255,0.12); background:rgba(0,0,0,0.18);">
    <div style="display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:center;">
      <div style="font-weight:900; color:#FFD700;">üÜï ÿ•ŸÜÿ∞ÿßÿ± STOP (Realtime)</div>
      <label style="display:flex; gap:8px; align-items:center; font-size:12px; color:#cbd5e1;">
        <input id="stopAlarmToggle" type="checkbox" style="transform: scale(1.15);" checked>
        <span>üîî ÿ•ŸÜÿ∞ÿßÿ± ÿπŸÜÿØ STOP ÿ¨ÿØŸäÿØ</span>
      </label>
      <label style="display:flex; gap:8px; align-items:center; font-size:12px; color:#cbd5e1;">
        <input id="stopAlarmLoopToggle" type="checkbox" style="transform: scale(1.15);">
        <span>üö® ÿµŸàÿ™ ŸÖÿ≥ÿ™ŸÖÿ±</span>
      </label>
      <label style="display:flex; gap:8px; align-items:center; font-size:12px; color:#cbd5e1;">
        <input id="stopAlarmPopupToggle" type="checkbox" style="transform: scale(1.15);">
        <span>ü™ü Pop-up</span>
      </label>
      <button id="stopAlarmStopBtn" class="btn" style="padding:8px 10px; background:rgba(239,68,68,0.18); border:1px solid rgba(239,68,68,0.45);">‚õî ÿ•ŸäŸÇÿßŸÅ ÿßŸÑÿ•ŸÜÿ∞ÿßÿ±</button>
</div>
    <div style="margin-top:8px; font-size:11px; color:#9aa4b2; text-align:center;">
      ‚úÖ ŸÖŸáŸÖ: ŸÅÿπŸëŸÑ ÿßŸÑÿÆŸäÿßÿ± üîî ŸÑŸäÿµÿØÿ± ÿµŸàÿ™ ÿπŸÜÿØ STOP ÿ¨ÿØŸäÿØÿå ŸàŸäŸÖŸÉŸÜ ÿ™ŸÅÿπŸäŸÑ Pop-up ÿ£Ÿà ÿµŸàÿ™ ŸÖÿ≥ÿ™ŸÖÿ±.
      ‚ö†Ô∏è Chrome ŸÇÿØ ŸäŸÖŸÜÿπ ÿßŸÑÿµŸàÿ™ ÿ≠ÿ™Ÿâ ÿ™ÿ∂ÿ∫ÿ∑ ÿ£Ÿä ÿ≤ÿ± ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ©.
    </div>
  </div>

  
  <!-- (Cam√©ra supprim√©e) -->


</div>

<!-- Indicateur "Pivot" (ic√¥ne) : nombre d'arr√™ts actifs -->
<div id="pivotStopsIndicator" title="Arr√™ts actifs (cliquer pour afficher)" style="position:fixed; right:14px; bottom:14px; z-index:9999; display:none; cursor:pointer;
  padding:10px 12px; border-radius:999px; background:rgba(239,68,68,0.22); border:1px solid rgba(239,68,68,0.55); color:#fff; font-weight:700; box-shadow:0 10px 25px rgba(0,0,0,0.35);">
  üìç <span id="pivotStopsCount">0</span>
</div>

<!-- Modal d'appel au poste -->
<div id="callModal" style="display:none; position:fixed; inset:0; z-index:10000; background:rgba(0,0,0,0.60);">
  <div style="max-width:520px; margin:12vh auto; padding:16px; background:rgba(15,23,42,0.98); border:1px solid rgba(255,255,255,0.16); border-radius:14px;">
    <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
      <div style="font-weight:800; color:#FFD700;">üì£ Appel au poste</div>
      <button id="callModalCloseBtn" class="btn" style="padding:6px 10px;">‚úñ</button>
    </div>
    <div id="callModalText" style="margin-top:12px; color:#e0e1dd; white-space:pre-wrap;"></div>
    <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:14px;">
      <button id="callAcknowledgeBtn" class="btn" style="padding:10px 12px; background:rgba(34,197,94,0.18); border:1px solid rgba(34,197,94,0.45);">‚úÖ Acquitter</button>
    </div>
  </div>
</div>


<div id="postsBoardChartContainer" class="chart-container">
  <h2 style="text-align:center; margin-bottom:15px;">üìù POSTS (JOURNAL D'√âQUIPE)</h2>

  <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-bottom:10px;">
    <input id="postAuthor" type="text" placeholder="Auteur (ex: TL Samir)" style="max-width:220px;"/>
    <button id="addPostBtn" style="background: linear-gradient(135deg, #25D366 0%, #1ebc5b 100%); color: white;">
      ‚ûï Publier
    </button>
  </div>

  <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center; align-items:center; margin:8px 0 4px;">
    <label style="display:flex; gap:8px; align-items:center; font-size:12px; color:#cbd5e1; background: rgba(0,0,0,0.18); padding:8px 10px; border-radius:10px; border: 1px solid rgba(255,255,255,0.10);">
      <input id="autoPostStopsToggle" type="checkbox" style="transform: scale(1.1);"/>
      <span>üì£ Publier automatiquement un post √† la fin de chaque arr√™t (cause + dur√©e) pour que les coll√®gues proposent une solution</span>
    </label>
  </div>


  <textarea id="postText" placeholder="√âcrivez ici (ex: arr√™t 12 min - cause: capteur - action: appel maintenance)..." 
    style="width:100%; min-height:90px; resize:vertical; padding:12px; border-radius:10px; border:1px solid rgba(255,255,255,0.12); background: rgba(0,0,0,0.18); color:#e0e1dd;"></textarea>

  <div style="margin-top:12px; font-size:11px; color:#9aa4b2; text-align:center;">
    Les posts sont partag√©s avec les coll√®gues via <b>Mode en ligne</b> (ou P2P si activ√©).
  </div>

  <div id="postsList" style="margin-top:15px;"></div>
</div>


<div id="aiReportChartContainer" class="chart-container">
    <h2 style="color:#FFD700; text-align:center; margin-bottom:20px;">üß† RAPPORT AUTOMATIQUE - 5 POURQUOI / PDCA / PLAN D'ACTION</h2>

    <!-- Panneau de contr√¥le (non imprim√©) -->
    <div class="ai-panel no-print">
        <h3>‚öôÔ∏è Param√®tres du rapport</h3>

        <div class="ai-controls-grid">
            <div>
                <label style="display:block; font-size:12px; color:#ccc; margin-bottom:6px;">√âquipe (rapport)</label>
                <select id="aiTeamSelect">
                    <option value="all">Toutes √©quipes</option>
                    <option value="A">√âquipe A</option>
                    <option value="B">√âquipe B</option>
                    <option value="C">√âquipe C</option>
                    <option value="D">√âquipe D</option>
                </select>
            </div>

            <div>
                <label style="display:block; font-size:12px; color:#ccc; margin-bottom:6px;">P√©riode (donn√©es)</label>
                <select id="aiShiftPeriodSelect">
                    <option value="today">Shift actuel</option>
                    <option value="week">4 derniers shifts</option>                    <option value="all">Tous shifts</option>
                </select>
            </div>

            <div>
                <label style="display:block; font-size:12px; color:#ccc; margin-bottom:6px;">Regrouper le graphique par</label>
                <select id="aiGroupBySelect">
                    <option value="week">Semaine (N¬∞ ISO)</option>
                    <option value="month">Mois</option>
                    <option value="year">Ann√©e</option>
                </select>
            </div>

            <div>
                <label style="display:block; font-size:12px; color:#ccc; margin-bottom:6px;">M√©trique</label>
                <select id="aiMetricSelect">
                    <option value="duration">Dur√©e totale</option>
                    <option value="stops">Nombre d'arr√™ts</option>
                </select>
            </div>

            <div>
                <label style="display:block; font-size:12px; color:#ccc; margin-bottom:6px;">P√©riode pr√©cise (optionnel)</label>
                <select id="aiPeriodValueSelect">
                    <option value="all">Toutes</option>
                </select>
                <div class="ai-muted">Ex: choisir S52/2025 ou 12/2025 ou 2025 pour faire le rapport sur cette p√©riode.</div>
            </div>

            <div style="display:flex; align-items:center; gap:10px; padding-top: 20px;">
                <label style="font-size:12px; color:#ccc;">
                    <input type="checkbox" id="aiExcludePauses" checked>
                    Exclure les pauses (si enregistr√©es)
                </label>
            </div>
        </div>

        <div class="ai-btn-row">
            <button class="ai-btn ai-btn-generate" id="aiGenerateBtn">ü§ñ G√©n√©rer / Mettre √† jour</button>
            <button class="ai-btn ai-btn-save" id="aiSaveBtn">üíæ Sauvegarder le rapport</button>
            <button class="ai-btn ai-btn-pdf" id="aiPdfBtn">üìÑ Export PDF</button>
            <button class="ai-btn ai-btn-print" id="aiPrintBtn">üñ®Ô∏è Imprimer / PDF syst√®me</button>
        </div>

        <div class="ai-muted">
            Astuce: Vous pouvez modifier tous les textes directement dans le rapport (zones encadr√©es en pointill√©s) avant l'export PDF.
        </div>
    </div>

    <!-- Zone imprimable PDF -->
    <div id="aiReportPrintable">

        <div class="ai-report-header">
            <div>
                <div id="aiReportTitle" class="ai-report-title ai-editable small" contenteditable="true">
RAPPORT ARR√äTS CHA√éNE - STELLANTIS
                </div>
                <div id="aiReportMeta" class="ai-report-meta"></div>
            </div>

            <div style="text-align:right;">
                <div class="ai-badge" id="aiBadgeTeam">√âquipe: -</div>
                <div class="ai-badge" id="aiBadgePeriod">P√©riode: -</div>
                <div class="ai-badge" id="aiBadgeGenerated">G√©n√©r√©: -</div>
            </div>
        </div>

        <div class="ai-kpi-grid">
            <div class="ai-kpi">
                <div class="label">Nb arr√™ts</div>
                <div class="value" id="aiKpiStops">0</div>
            </div>
            <div class="ai-kpi">
                <div class="label">Temps total (brut)</div>
                <div class="value" id="aiKpiDurationGross">0</div>
            </div>
            <div class="ai-kpi">
                <div class="label">Temps total (hors pauses)</div>
                <div class="value" id="aiKpiDurationNoPause">0</div>
            </div>
            <div class="ai-kpi">
                <div class="label">Cause principale</div>
                <div class="value" id="aiKpiTopCause">-</div>
            </div>
        </div>

        <div class="ai-grid-2">
            <div class="ai-card">
                <h3>üìä Pareto des causes (Dur√©e)</h3>
                <canvas id="aiParetoCauseChart" style="width:100%!important; height:260px!important;"></canvas>
                <div class="ai-muted" id="aiParetoNote"></div>
            </div>
            <div class="ai-card">
                <h3>üìÖ Visualisation par semaine / mois / ann√©e</h3>
                <canvas id="aiPeriodChart" style="width:100%!important; height:260px!important;"></canvas>
                <div class="ai-muted" id="aiPeriodNote"></div>
            </div>
        </div>

        <div class="ai-card" style="margin-top: 12px;">
            <h3>üß© Synth√®se (modifiable)</h3>
            <div id="aiSummary" class="ai-editable" contenteditable="true"></div>
        </div>

        <div class="ai-card" style="margin-top: 12px;">
            <h3>‚ùì Analyse 5 Pourquoi (modifiable)</h3>
            <ol class="ai-5why-list">
                <li><div id="aiWhy1" class="ai-editable" contenteditable="true"></div></li>
                <li><div id="aiWhy2" class="ai-editable" contenteditable="true"></div></li>
                <li><div id="aiWhy3" class="ai-editable" contenteditable="true"></div></li>
                <li><div id="aiWhy4" class="ai-editable" contenteditable="true"></div></li>
                <li><div id="aiWhy5" class="ai-editable" contenteditable="true"></div></li>
            </ol>
            <div style="margin-top: 10px;">
                <strong>Cause racine (hypoth√®se):</strong>
                <div id="aiRootCause" class="ai-editable small" contenteditable="true"></div>
            </div>
        </div>

        <div class="ai-card" style="margin-top: 12px;">
            <h3>üåÄ PDCA (modifiable)</h3>
            <div class="ai-grid-2">
                <div>
                    <div style="font-weight:800; margin-bottom:6px;">P - Plan</div>
                    <div id="aiPDCAPlan" class="ai-editable" contenteditable="true"></div>
                </div>
                <div>
                    <div style="font-weight:800; margin-bottom:6px;">D - Do</div>
                    <div id="aiPDCAdo" class="ai-editable" contenteditable="true"></div>
                </div>
                <div>
                    <div style="font-weight:800; margin-bottom:6px;">C - Check</div>
                    <div id="aiPDCAcheck" class="ai-editable" contenteditable="true"></div>
                </div>
                <div>
                    <div style="font-weight:800; margin-bottom:6px;">A - Act</div>
                    <div id="aiPDCAact" class="ai-editable" contenteditable="true"></div>
                </div>
            </div>
        </div>

        <div class="ai-card" style="margin-top: 12px;">
            <h3>‚úÖ Plan d'action (modifiable)</h3>
            <table class="ai-table" id="aiActionPlanTable">
                <thead>
                    <tr>
                        <th>Action</th>
                        <th>Responsable</th>
                        <th>√âch√©ance</th>
                        <th>Priorit√©</th>
                        <th>Statut</th>
                        <th>Commentaires / Preuves</th>
                        <th class="no-print">‚úñ</th>
                    </tr>
                </thead>
                <tbody id="aiActionPlanBody"></tbody>
            </table>

            <div class="no-print" style="margin-top: 10px; display:flex; gap:10px; flex-wrap:wrap;">
                <button class="ai-btn ai-btn-generate" onclick="aiAddActionRow()">‚ûï Ajouter une action</button>
                <button class="ai-btn ai-btn-save" onclick="aiResetActionPlan()">üîÑ R√©initialiser (auto)</button>
            </div>
        </div>

        <div class="ai-card" style="margin-top: 12px;">
            <h3>üßë‚Äçüîß Mon intervention (terrain) (modifiable)</h3>
            <div id="aiIntervention" class="ai-editable" contenteditable="true"></div>
        </div>

        <div class="ai-card" style="margin-top: 12px;">
            <h3>üìå Constats / preuves terrain (modifiable)</h3>
            <div class="ai-muted">Exemples: photos (√©cran d√©faut, pi√®ce, zone), relev√©s, n¬∞ OF, n¬∞ chariot, code panne, check-list, t√©moignages, etc.</div>
            <div id="aiEvidence" class="ai-editable" contenteditable="true"></div>
        </div>

        <div class="ai-card" style="margin-top: 12px;">
            <h3>üñäÔ∏è Validation responsables (modifiable)</h3>
            <div class="ai-muted">Renseigner le nom, la date et la d√©cision (OK/NOK) pour formaliser le rapport avant diffusion.</div>
            <table class="ai-table">
                <thead>
                    <tr>
                        <th>Service / Fonction</th>
                        <th>Nom</th>
                        <th>Date</th>
                        <th>Validation / Commentaires</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Team Leader</strong></td>
                        <td><div id="aiValTLName" class="ai-editable small" contenteditable="true"></div></td>
                        <td><div id="aiValTLDate" class="ai-editable small" contenteditable="true"></div></td>
                        <td><div id="aiValTLComment" class="ai-editable small" contenteditable="true"></div></td>
                    </tr>
                    <tr>
                        <td><strong>Superviseur Production</strong></td>
                        <td><div id="aiValProdName" class="ai-editable small" contenteditable="true"></div></td>
                        <td><div id="aiValProdDate" class="ai-editable small" contenteditable="true"></div></td>
                        <td><div id="aiValProdComment" class="ai-editable small" contenteditable="true"></div></td>
                    </tr>
                    <tr>
                        <td><strong>Maintenance</strong></td>
                        <td><div id="aiValMaintName" class="ai-editable small" contenteditable="true"></div></td>
                        <td><div id="aiValMaintDate" class="ai-editable small" contenteditable="true"></div></td>
                        <td><div id="aiValMaintComment" class="ai-editable small" contenteditable="true"></div></td>
                    </tr>
                    <tr>
                        <td><strong>Logistique</strong></td>
                        <td><div id="aiValLogName" class="ai-editable small" contenteditable="true"></div></td>
                        <td><div id="aiValLogDate" class="ai-editable small" contenteditable="true"></div></td>
                        <td><div id="aiValLogComment" class="ai-editable small" contenteditable="true"></div></td>
                    </tr>
                    <tr>
                        <td><strong>Qualit√©</strong></td>
                        <td><div id="aiValQualName" class="ai-editable small" contenteditable="true"></div></td>
                        <td><div id="aiValQualDate" class="ai-editable small" contenteditable="true"></div></td>
                        <td><div id="aiValQualComment" class="ai-editable small" contenteditable="true"></div></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="ai-card" style="margin-top: 12px;">
            <h3>üìã D√©tail des principales causes</h3>
            <table class="ai-table">
                <thead>
                    <tr>
                        <th>Cause</th>
                        <th>Nb arr√™ts</th>
                        <th>Dur√©e totale</th>
                        <th>%</th>
                        <th>% cumul</th>
                    </tr>
                </thead>
                <tbody id="aiTopCausesTableBody"></tbody>
            </table>
        </div>

        <div class="ai-muted" style="margin-top: 10px;">
            ‚ö†Ô∏è Ce rapport est g√©n√©r√© automatiquement √† partir des arr√™ts saisis (HISTO) et reste <strong>modifiable</strong>. 
            Pensez √† valider les hypoth√®ses (5 pourquoi) avec l'√©quipe terrain / maintenance / logistique.
        </div>

    </div>
</div>


<!-- MODAL AJOUTER ARR√äT RAT√â -->
<div class="modal" id="missedStopModal">
    <div class="modal-content">
        <h3 style="color:var(--warning);">‚è±Ô∏è AJOUTER UN ARR√äT RAT√â</h3>
        
        <div style="margin: 15px 0;">
            <label style="display: block; margin-bottom: 5px;">Date de l'arr√™t :</label>
            <input type="date" id="missedDate" style="width: 100%;">
        </div>
        
        <div class="input-group" style="margin: 15px 0;">
            <div>
                <label style="display: block; margin-bottom: 5px;">Heure de d√©but :</label>
                <input type="time" id="missedStart" style="width: 100%;">
            </div>
            <div>
                <label style="display: block; margin-bottom: 5px;">Heure de fin :</label>
                <input type="time" id="missedEnd" style="width: 100%;">
            </div>
        </div>
        
        <div style="margin: 15px 0;">
            <label style="display: block; margin-bottom: 5px;">Dur√©e (minutes) :</label>
            <input type="number" id="missedDuration" min="1" step="1" placeholder="Saisir la dur√©e en minutes" style="width: 100%;" oninput="updateMissedTimes()">
        </div>
        
        <div style="margin: 15px 0;">
            <label style="display: block; margin-bottom: 5px;">Cause de l'arr√™t :</label>
            <select id="missedCause" style="width: 100%;">
                <option value="">-- S√©lectionner une cause --</option>
                <option value="PAUSE CAF√â / MIDI">PAUSE CAF√â / MIDI</option>
                <option value="Manque composant">Manque composant</option>
                <option value="Probl√®me machine">Probl√®me machine</option>
                <option value="Maintenance pr√©ventive">Maintenance pr√©ventive</option>
                <option value="R√©glage machine">R√©glage machine</option>
                <option value="Attente chariot">Attente chariot</option>
                <option value="Probl√®me qualit√©">Probl√®me qualit√©</option>
                <option value="Absence op√©rateur">Absence op√©rateur</option>
                <option value="Formation">Formation</option>
                <option value="Incident s√©curit√©">Incident s√©curit√©</option>
                <option value="Changement outillage">Changement outillage</option>
                <option value="Nettoyage poste">Nettoyage poste</option>
                <option value="Attente composant">Attente composant</option>
                <option value="Panne √©lectrique">Panne √©lectrique</option>
                <option value="Panne pneumatique">Panne pneumatique</option>
                <option value="R√©union d'√©quipe">R√©union d'√©quipe</option>
                <option value="OTHER">Autre (saisir ci-dessous)</option>
            </select>
            <input type="text" id="missedCustomCause" placeholder="Saisir la cause manuellement..." style="width: 100%; margin-top: 5px; display: none;">
        </div>
        
        <div style="margin: 15px 0;">
            <label style="display: block; margin-bottom: 5px;">√âquipe concern√©e :</label>
            <select id="missedEquipe" style="width: 100%;">
                <option value="A">√âquipe A</option>
                <option value="B">√âquipe B</option>
                <option value="C">√âquipe C</option>
                <option value="D">√âquipe D</option>
            </select>
        </div>
        
        <div style="margin: 15px 0; padding: 10px; background: rgba(255, 159, 28, 0.1); border-radius: 8px; border-left: 4px solid var(--warning);">
            <h4 style="color:var(--warning); margin-top: 0;">R√©sum√© de l'arr√™t</h4>
            <div style="font-size: 14px;">
                <div><strong>Date:</strong> <span id="missedSummaryDate">-</span></div>
                <div><strong>P√©riode:</strong> <span id="missedSummaryTime">-</span></div>
                <div><strong>Dur√©e:</strong> <span id="missedSummaryDuration">-</span></div>
                <div><strong>Cause:</strong> <span id="missedSummaryCause">-</span></div>
                <div><strong>√âquipe:</strong> <span id="missedSummaryEquipe">-</span></div>
            </div>
        </div>
        
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button onclick="saveMissedStop()" style="background:var(--warning); flex:1;">
                ‚úÖ Enregistrer l'arr√™t
            </button>
            <button onclick="closeMissedStopModal()" style="background:var(--darker); flex:1;">
                ‚ùå Annuler
            </button>
        </div>
    </div>
</div>


<!-- MODAL AJOUTER ARR√äT SP√âCIAL -->
<div class="modal" id="specialStopModal">
    <div class="modal-content">
        <h3 style="color:var(--info);">‚≠ê AJOUTER UN ARR√äT SP√âCIAL (LIBRE)</h3>
        <div style="font-size: 13px; color:#ccc; margin-top: -5px;">
            Exemple : 23:00 pendant 3 heures (le syst√®me g√®re le passage minuit).<br><strong>Vous pouvez saisir n'importe quelle heure et dur√©e.</strong>
        </div>

        <div style="display:flex; gap:10px; margin-top: 12px; flex-wrap: wrap;">
            <button onclick="presetSpecialStop2300()" style="background:var(--darker); border:1px solid rgba(255,255,255,0.15);">
                üåô Preset 23:00 + 3h
            </button>
            <button onclick="presetSpecialStopFree()" style="background:var(--darker); border:1px solid rgba(255,255,255,0.15);">üìù Libre</button>
            <button onclick="presetSpecialStopNow()" style="background:var(--darker); border:1px solid rgba(255,255,255,0.15);">
                ‚è±Ô∏è Maintenant + 30 min
            </button>
        </div>

        <div style="margin: 15px 0;">
            <label style="display: block; margin-bottom: 5px;">Date :</label>
            <input type="date" id="specialDate" style="width: 100%;" oninput="updateSpecialTimes()">
        </div>

        <div style="margin: 15px 0;">
            <label style="display: block; margin-bottom: 5px;">Heure de d√©but :</label>
            <input type="time" id="specialStart" style="width: 100%;" oninput="updateSpecialTimes()">
        </div>

        <div style="margin: 15px 0; display:flex; gap:10px;">
            <div style="flex:1;">
                <label style="display: block; margin-bottom: 5px;">Dur√©e (heures) :</label>
                <input type="number" id="specialDurationH" min="0" step="1" value="3" style="width: 100%;" oninput="updateSpecialTimes()">
            </div>
            <div style="flex:1;">
                <label style="display: block; margin-bottom: 5px;">Dur√©e (minutes) :</label>
                <input type="number" id="specialDurationM" min="0" step="5" value="0" style="width: 100%;" oninput="updateSpecialTimes()">
            </div>
        </div>

        <div style="margin: 15px 0;">
            <label style="display: block; margin-bottom: 5px;">Fin estim√©e :</label>
            <input type="text" id="specialEndDisplay" readonly style="width: 100%; opacity: 0.9;">
            <div id="specialEndHint" style="font-size: 12px; color:#bbb; margin-top: 4px;"></div>
        </div>

        <div style="margin: 15px 0;">
            <label style="display: block; margin-bottom: 5px;">Cause :</label>
            <select id="specialCause" style="width: 100%;" onchange="onSpecialCauseChange()">
                <option value="">-- S√©lectionner une cause --</option>
                <option value="PAUSE CAF√â / MIDI">PAUSE CAF√â / MIDI</option>
                <option value="Manque composant">Manque composant</option>
                <option value="Probl√®me machine">Probl√®me machine</option>
                <option value="Maintenance pr√©ventive">Maintenance pr√©ventive</option>
                <option value="R√©glage machine">R√©glage machine</option>
                <option value="Attente chariot">Attente chariot</option>
                <option value="Probl√®me qualit√©">Probl√®me qualit√©</option>
                <option value="Absence op√©rateur">Absence op√©rateur</option>
                <option value="Formation">Formation</option>
                <option value="Incident s√©curit√©">Incident s√©curit√©</option>
                <option value="Changement outillage">Changement outillage</option>
                <option value="Nettoyage poste">Nettoyage poste</option>
                <option value="Attente composant">Attente composant</option>
                <option value="Panne √©lectrique">Panne √©lectrique</option>
                <option value="Panne pneumatique">Panne pneumatique</option>
                <option value="R√©union d'√©quipe">R√©union d'√©quipe</option>
                <option value="OTHER">Autre (saisir ci-dessous)</option>
            </select>
            <input type="text" id="specialCustomCause" placeholder="‚úçÔ∏è Cause libre (vous pouvez √©crire ici)..." style="width: 100%; margin-top: 5px; display: block;">
            <div style="font-size:12px; color:#bbb; margin-top:4px;">Astuce : choisissez une cause dans la liste puis modifiez-la ici.</div>
        </div>

        <div style="margin: 15px 0;">
            <label style="display: block; margin-bottom: 5px;">√âquipe :</label>
            <select id="specialEquipe" style="width: 100%;">
                <option value="A">√âquipe A</option>
                <option value="B">√âquipe B</option>
                <option value="C">√âquipe C</option>
            </select>
        </div>

        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button onclick="saveSpecialStop()" style="background:var(--info); flex:1;">
                ‚úÖ Enregistrer l'arr√™t sp√©cial
            </button>
            <button onclick="closeSpecialStopModal()" style="background:var(--darker); flex:1;">
                ‚ùå Annuler
            </button>
        </div>
    </div>
</div>

<!-- MODAL ARR√äT SP√âCIAL EN COURS -->
<div class="modal" id="specialLiveModal">
  <div class="modal-content">
    <h3 style="color:var(--warning);">‚≠ê D√âMARRER UN ARR√äT SP√âCIAL (EN COURS)</h3>
    <div style="font-size: 13px; color:#ccc; margin-top: -5px;">
      Vous cliquez <strong>D√âMARRER</strong> maintenant, puis plus tard <strong>REPRISE</strong>. L‚Äôarr√™t reste actif jusqu‚Äô√† votre ordre.
    </div>

    <div style="margin: 15px 0;">
      <label style="display:block; margin-bottom: 5px;">Cause :</label>
      <select id="liveSpecialCause" style="width:100%;" onchange="onLiveSpecialCauseChange()">
        <option value="">-- S√©lectionner une cause --</option>
        <option value="PAUSE CAF√â / MIDI">PAUSE CAF√â / MIDI</option>
        <option value="Manque composant">Manque composant</option>
        <option value="Probl√®me machine">Probl√®me machine</option>
        <option value="Maintenance pr√©ventive">Maintenance pr√©ventive</option>
        <option value="R√©glage machine">R√©glage machine</option>
        <option value="Attente chariot">Attente chariot</option>
        <option value="Qualit√© / Retouche">Qualit√© / Retouche</option>
        <option value="Changement s√©rie">Changement s√©rie</option>
        <option value="Autre">Autre (saisie libre)</option>
      </select>
      <input id="liveSpecialCustomCause" placeholder="√âcrire la cause ici (optionnel)" style="width:100%; margin-top:8px; display:none;">
    </div>

    <div style="margin: 15px 0;">
      <label style="display:block; margin-bottom: 5px;">√âquipe :</label>
      <select id="liveSpecialEquipe" style="width:100%;">
        <option value="A">√âquipe A</option>
        <option value="B">√âquipe B</option>
        <option value="C">√âquipe C</option>
      </select>
    </div>

    <div style="display:flex; gap:10px; margin-top: 20px;">
      <button onclick="startSpecialStopLive()" style="background: var(--warning); flex:1; font-weight:800;">
        ‚≠ê D√âMARRER MAINTENANT
      </button>
      <button onclick="closeSpecialLiveModal()" style="background:var(--darker); flex:1;">
        ‚ùå Annuler
      </button>
    </div>
  </div>
</div>

<!-- MODAL CONFIRMATION EFFACER -->
<div class="modal" id="clearModal">
    <div class="modal-content">
        <h3 style="color:var(--danger);">‚ö†Ô∏è CONFIRMATION</h3>
        <p>Quelles donn√©es voulez-vous effacer ?</p>
        <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 20px;">
            <button onclick="clearHistory('today')" style="background:var(--warning);">
                Effacer shift actuel seulement
            </button>
            <button onclick="clearHistory('equipe')" style="background:var(--primary);">
                Effacer mon √©quipe seulement
            </button>
            <button onclick="clearHistory('all')" style="background:var(--danger);">
                Effacer TOUTES les donn√©es (Arr√™ts & Absences)
            </button>
            
            <button onclick="resetFirebaseRoomTeam()" style="background:var(--danger); border:2px solid rgba(255,255,255,0.12);">
                üß® Effacer FIREBASE (Room) ‚Äî pour toute l'√©quipe
            </button>
<button onclick="cancelClear()" style="background:var(--darker);">
                Annuler
            </button>
        </div>
    </div>
</div>

<!-- MODAL RAPPORT FIN SHIFT -->
<div class="modal" id="shiftModal">
    <div class="modal-content">
        <h3 style="color:var(--primary);">üìã RAPPORT FIN DE SHIFT</h3>
        <p>S√©lectionnez l'√©quipe pour le rapport :</p>
        <div class="filter-group" style="margin: 15px 0;">
            <div class="filter-btn active" onclick="selectReportTeam('A')">√âquipe A</div>
            <div class="filter-btn" onclick="selectReportTeam('B')">√âquipe B</div>
            <div class="filter-btn" onclick="selectReportTeam('C')">√âquipe C</div>
            <div class="filter-btn" onclick="selectReportTeam('D')">√âquipe D</div>
        </div>
        <div style="margin: 15px 0;">
            <label style="display: block; margin-bottom: 5px;">P√©riode :</label>
            <select id="periodSelect" style="width: 100%;">
                <option value="today">Shift actuel</option>
                <option value="week">4 derniers shifts</option>                <option value="all">Tous shifts</option>
            </select>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button onclick="sendShiftReport()" style="background:var(--primary); flex:1;">
                üì§ Envoyer WhatsApp
            </button>
            <button onclick="closeShiftModal()" style="background:var(--darker); flex:1;">
                Annuler
            </button>
        </div>
    </div>
</div>


<!-- MODAL APR√àS WHATSAPP (Nettoyage Firebase) -->
<div class="modal" id="postSendModal">
  <div class="modal-content">
    <h3 style="color:var(--warning);">‚úÖ WhatsApp ouvert</h3>
    <p style="line-height:1.5;">Apr√®s avoir envoy√© le message sur WhatsApp, cliquez sur <b>Nettoyer Firebase</b> pour effacer l'historique de la <b>Room</b> (toute l'√©quipe) afin que la base reste l√©g√®re.</p>

    <div style="margin:12px 0; padding:10px; border-radius:10px; background:rgba(0,0,0,0.18); border:1px solid rgba(255,255,255,0.10);">
      <label style="display:flex; gap:8px; align-items:center; font-size:13px;">
        <input id="purgeKeepArchives" type="checkbox" checked style="transform:scale(1.15);">
        <span>Garder un petit <b>archive</b> du rapport (texte + statistiques) ÿØÿßÿÆŸÑ Firebase</span>
      </label>
    </div>

    <div style="display:flex; gap:10px; margin-top:16px;">
      <button onclick="confirmFirebasePurgeAfterSend()" style="background:var(--danger); flex:1; font-weight:900;">
        üßπ Nettoyer Firebase (Room)
      </button>
      <button onclick="closePostSendModal()" style="background:var(--darker); flex:1;">
        Fermer
      </button>
    </div>
  </div>
</div>
<!-- FEN√äTRE DE CHAT -->
<div class="chat-toggle-btn" id="chatToggleBtn" onclick="toggleChat()">
    üí¨
</div>

<div class="chat-container" id="chatContainer">
    <div class="chat-header">
        <span>üí¨ Chat Interne - √âquipe</span>
        <button class="chat-close-btn" onclick="toggleChat()">√ó</button>
    </div>
    <div class="chat-messages" id="chatMessages">
        <!-- Les messages seront ajout√©s ici dynamiquement -->
    </div>
    <div class="chat-input-container">
        <input type="text" class="chat-input" id="chatInput" placeholder="√âcrivez votre message..." onkeypress="handleChatKeyPress(event)">
        <button class="chat-send-btn" id="chatSendBtn" onclick="sendChatMessage()">
            üì§
        </button>
    </div>
</div>

<div class="chat-notification" id="chatNotification">
    <div id="chatNotificationContent"></div>
</div>

<!-- AUDIOS -->
<audio id="alarm" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" loop></audio>
<audio id="resumeSound" src="https://actions.google.com/sounds/v1/crowds/crowd_cheer.ogg"></audio>
<audio id="pauseStartAlarm" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>
<audio id="pauseEndAlarm" src="https://actions.google.com/sounds/v1/alarms/medium_bell.ogg"></audio>
<audio id="autoSaveSound" src="https://actions.google.com/sounds/v1/office/computer_typing.ogg"></audio>
<audio id="pauseReminderSound" src="https://actions.google.com/sounds/v1/alarms/digital_watch_alarm_long.ogg" loop></audio>
<audio id="chatSound" src="https://actions.google.com/sounds/v1/electronic/electronic_beep.ogg"></audio>

</div>

<script>

// ===== STOCKAGE S√õR (Android content://) =====
function getSafeStorage(){
  try{
    const t="__st_test__";
    window.localStorage.setItem(t,"1");
    window.localStorage.removeItem(t);
    return { store: window.localStorage, persistent: true };
  }catch(e){
    const mem = new Map();
    return {
      store: {
        getItem:(k)=> mem.has(k)? mem.get(k): null,
        setItem:(k,v)=> { mem.set(k, String(v)); },
        removeItem:(k)=> { mem.delete(k); }
      },
      persistent:false
    };
  }
}
const __SAFE = getSafeStorage();
const LS = __SAFE.store;

// ===== DIAGNOSTIC VISUEL (si erreur) =====
;(function(){
  function showDiag(msg){
    let box = document.getElementById("diagBox");
    if(!box){
      box = document.createElement("div");
      box.id="diagBox";
      box.style.cssText="position:fixed;left:10px;right:10px;bottom:10px;z-index:999999;background:#fff;color:#000;border:2px solid #d11;padding:10px;border-radius:12px;font-size:14px;max-height:40vh;overflow:auto;box-shadow:0 10px 30px rgba(0,0,0,.25)";
      box.innerHTML = "<b>‚ö†Ô∏è Diagnostic</b><div id='diagMsg' style='white-space:pre-wrap;margin-top:6px'></div>";
      document.addEventListener("DOMContentLoaded", ()=> document.body.appendChild(box));
    }
    const msgEl = box.querySelector("#diagMsg");
    if(msgEl) msgEl.textContent = msg;
  }
  window.addEventListener("error", (e)=>{
    const m = (e && (e.message || e.error && e.error.message)) || "Erreur inconnue";
    showDiag("Erreur JS: " + m);
  });
  window.addEventListener("unhandledrejection", (e)=>{
    const m = (e && e.reason && (e.reason.message || String(e.reason))) || "Promise rejet√©e";
    showDiag("Erreur (Promise): " + m);
  });
  document.addEventListener("DOMContentLoaded", ()=>{
    if(!__SAFE.persistent){
      // Affiche une info si le stockage persistant est bloqu√©
      showDiag("Le stockage persistant (localStorage) est bloqu√© sur cette page (Android content://).\nL'application fonctionne, mais les donn√©es ne seront pas conserv√©es apr√®s fermeture.\nAstuce: ouvre le fichier via 'T√©l√©chargements' dans Chrome ou ajoute √† l'√©cran d'accueil.");
    }
  });
})();
// =============================================
// INITIALISATION
// =============================================
let start = null;
let timerInterval = null;
let history = JSON.parse(LS.getItem("HISTO") || "[]");
let internalTableSearchQuery = "";
let internalTableSearchTimer = null;

let deleteMode = LS.getItem("DELETE_MODE") === "1";

function applyDeleteModeUI() {
    document.body.classList.toggle("delete-mode", !!deleteMode);
    const b = document.getElementById("toggleDeleteModeBtn");
    if (b) {
        b.textContent = deleteMode ? "üóëÔ∏è Mode suppression : ON" : "üóëÔ∏è Mode suppression : OFF";
        b.style.opacity = deleteMode ? "1" : "0.9";
    }
}

function toggleDeleteMode() {
    deleteMode = !deleteMode;
    LS.setItem("DELETE_MODE", deleteMode ? "1" : "0");
    applyDeleteModeUI();
    refreshTable();
    showNotification(deleteMode ? "üóëÔ∏è Mode suppression activ√©" : "‚úÖ Mode suppression d√©sactiv√©", deleteMode ? "warning" : "success");
}

function deleteStop(rowIndex) {
    const stop = history[rowIndex];
    if (!stop) return;

    const label = `${stop.date || ""}  ${stop.start || ""} ‚Üí ${stop.end || ""}  |  ${stop.cause || ""}  |  √âquipe ${stop.equipe || ""}`;
    if (!confirm("Supprimer cet arr√™t ?\n\n" + label)) return;

    history.splice(rowIndex, 1);
    LS.setItem("HISTO", JSON.stringify(history));
    if (db) saveToIndexedDB();

    refreshTable();
    try { updateActiveChart(); } catch(e) {}
    showNotification("üóëÔ∏è Arr√™t supprim√©", "warning");
}


let absenceHistory = JSON.parse(LS.getItem("ABSENCES") || "[]"); 
let equipe = "A";
let charts = {
    paretoHours: null,
    paretoCauses: null,
    paretoStops: null,
    teamPerformance: null,
    paretoAbsences: null 
};
let currentReportTeam = 'A';
let currentFilter = {
    hours: 'all',
    causes: 'all',
    stops: 'all',
    performance: 'today',
    metric: 'duration',
    absences: 'all',
    period: 'all'
};

// Filtre d'affichage du tableau (Tous / Normal / Rat√©)
let currentStopTypeFilter = 'all';

// Variables pour la gestion des shifts 3x8
let shiftConfigs = {
    'Nuit': { start: 22, end: 6, name: 'Nuit (22h-6h)' },
    'Matin': { start: 6, end: 14, name: 'Matin (6h-14h)' },
    'Apr√®s-midi': { start: 14, end: 22, name: 'Apr√®s-midi (14h-22h)' }
};
let currentShiftType = 'Nuit'; // Shift par d√©faut

// =============================================
// MODE JOURN√âE (Travail / ÿπÿ∑ŸÑÿ© / Machine OFF)
// =============================================
let workModeMap = (() => {
  try {
    const raw = LS.getItem("WORK_MODE_MAP_V1");
    return raw ? JSON.parse(raw) : {};
  } catch(e) { return {}; }
})();

let offDaysOfWeek = (() => {
  try {
    const raw = LS.getItem("OFF_DAYS_V1");
    // ÿßŸÅÿ™ÿ±ÿßÿ∂ŸäÿßŸã ÿßŸÑÿ≥ÿ®ÿ™+ÿßŸÑÿ£ÿ≠ÿØ (6 Ÿà 0)
    const arr = raw ? JSON.parse(raw) : [6,0];
    return Array.isArray(arr) ? arr : [6,0];
  } catch(e) { return [6,0]; }
})();

function saveOffDays(){
  try { LS.setItem("OFF_DAYS_V1", JSON.stringify(offDaysOfWeek||[])); } catch(e) {}
}

function dayOfWeekFromDateStr(dateStr){
  // dateStr: YYYY-MM-DD
  const d = new Date(dateStr + "T00:00:00");
  if (isNaN(d)) return null;
  return d.getDay(); // 0=Sun ... 6=Sat
}

function isAutoOffDay(dateStr){
  const dow = dayOfWeekFromDateStr(dateStr);
  if (dow === null) return false;
  return (offDaysOfWeek || []).includes(dow);
}


function getWorkModeForDate(dateStr){
  try{
    const entry = workModeMap && workModeMap[dateStr];
    if (!entry) {
      // AUTO_OFFDAY: ÿπÿ∑ŸÑÿ© ÿ£ÿ≥ÿ®ŸàÿπŸäÿ© ÿ™ŸÑŸÇÿßÿ¶Ÿäÿ©
      if (isAutoOffDay(dateStr)) return { mode: "holiday", reason: "Auto week-end" };
      return { mode: "production", reason: "" };
    }
    if (typeof entry === "string") return { mode: entry, reason: "" };
    return { mode: entry.mode || "production", reason: entry.reason || "" };
  }catch(e){
    return { mode: "production", reason: "" };
  }
}

function setWorkModeForDate(dateStr, mode, reason=""){
  if (!dateStr) return;
  workModeMap = workModeMap || {};
  workModeMap[dateStr] = { mode: mode || "production", reason: reason || "", updatedAt: Date.now() };
  try { LS.setItem("WORK_MODE_MAP_V1", JSON.stringify(workModeMap)); } catch(e) {}
  updateWorkModeUI();
  // Recalcul imm√©diat
  try { updateProductionCalculations(); } catch(e) {}
showSimpleToast("‚úÖ Statut sauvegard√© / ÿ™ŸÖ ÿßŸÑÿ≠ŸÅÿ∏");
}

function isNoProductionDay(dateStr){
  const w = getWorkModeForDate(dateStr);
  return (w.mode && w.mode !== "production");
}

function showSimpleToast(msg){
  const el = document.getElementById("simpleToast");
  if (!el) return;
  el.textContent = msg;
  el.style.display = "block";
  clearTimeout(el._t);
  el._t = setTimeout(()=>{ el.style.display="none"; }, 2200);
}

function updateWorkModeBadge(dateStr){
  const badge = document.getElementById("workModeBadge");
  if (!badge) return;
  const w = getWorkModeForDate(dateStr);
  if (w.mode === "production"){
    badge.textContent = "üü¢ Travail / Production";
    badge.style.background = "#1f8a3b";
    badge.style.color = "#fff";
  } else if (w.mode === "holiday"){
    badge.textContent = "üü° ÿπÿ∑ŸÑÿ© / Pas de production";
    badge.style.background = "#c79c00";
    badge.style.color = "#000";
  } else {
    badge.textContent = "üî¥ Machine OFF / Pas de production";
    badge.style.background = "#c1121f";
    badge.style.color = "#fff";
  }
}

function updateWorkModeUI(){
  const dateEl = document.getElementById("workStatusDate");
  const selEl = document.getElementById("workModeSelect");
  const reasonEl = document.getElementById("workModeReason");
  const now = new Date();
  const todayShift = (typeof getShiftDate === "function") ? getShiftDate(now) : new Date().toISOString().slice(0,10);

  const dateStr = (dateEl && dateEl.value) ? dateEl.value : todayShift;
  const w = getWorkModeForDate(dateStr);

  if (dateEl && !dateEl.value) dateEl.value = dateStr;
  if (selEl) selEl.value = w.mode || "production";
  if (reasonEl) reasonEl.value = w.reason || "";

  updateWorkModeBadge(dateStr);
}

// Init + Modal (Ÿäÿ≥ÿ£ŸÑ ŸÖÿ±ÿ© ŸÅŸä ÿßŸÑŸäŸàŸÖ)
document.addEventListener("DOMContentLoaded", () => {
  try{
    const now = new Date();
    const todayShift = (typeof getShiftDate === "function") ? getShiftDate(now) : new Date().toISOString().slice(0,10);

    const dateEl = document.getElementById("workStatusDate");
    const selEl = document.getElementById("workModeSelect");
    const reasonEl = document.getElementById("workModeReason");
    const saveBtn = document.getElementById("saveWorkModeBtn");

    if (dateEl) {
      dateEl.value = todayShift;
      dateEl.onchange = () => updateWorkModeUI();
    }
    if (selEl) selEl.onchange = () => updateWorkModeUI();
    if (saveBtn) {
      saveBtn.onclick = () => {
        const d = dateEl ? dateEl.value : todayShift;
        const m = selEl ? selEl.value : "production";
        const r = reasonEl ? reasonEl.value : "";
        setWorkModeForDate(d, m, r);
      };
    }

    updateWorkModeUI();

    // Init ÿπÿ∑ŸÑÿ© ÿ£ÿ≥ÿ®ŸàÿπŸäÿ© checkboxes
    const cbs = document.querySelectorAll(".offDayCb");
    cbs.forEach(cb => {
      const v = parseInt(cb.value,10);
      cb.checked = (offDaysOfWeek || []).includes(v);
      cb.onchange = () => {
        const val = parseInt(cb.value,10);
        if (cb.checked) {
          if (!(offDaysOfWeek||[]).includes(val)) offDaysOfWeek.push(val);
        } else {
          offDaysOfWeek = (offDaysOfWeek||[]).filter(x => x !== val);
        }
        saveOffDays();
        updateWorkModeUI();
        try { updateProductionCalculations(); } catch(e) {}
};
    });

    // Message si ÿßŸÑŸäŸàŸÖ ÿπÿ∑ŸÑÿ© ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã
    if (!workModeMap[todayShift] && isAutoOffDay(todayShift)) {
      showSimpleToast("üîÅ Auto week-end: Pas de production");
    }

    // ÿπÿ±ÿ∂ ÿßŸÑŸÖŸàÿØÿßŸÑ ÿ•ÿ∞ÿß ŸÑŸÖ Ÿäÿ™ŸÖ ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑÿ≠ÿßŸÑÿ© ŸÑŸÑŸäŸàŸÖ
    const modal = document.getElementById("workModeModal");
    if (modal && !(workModeMap && workModeMap[todayShift]) && !isAutoOffDay(todayShift)) {
      modal.style.display = "block";
    }

    // ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑŸÖŸàÿØÿßŸÑ
    const wmBtns = document.querySelectorAll(".wmBtn");
    wmBtns.forEach(btn => {
      btn.onclick = () => {
        const mode = btn.getAttribute("data-workmode") || "production";
        setWorkModeForDate(todayShift, mode, "");
        if (modal) modal.style.display = "none";
      };
    });

    const laterBtn = document.getElementById("wmLaterBtn");
    if (laterBtn) laterBtn.onclick = () => {
      if (modal) modal.style.display = "none";
      showSimpleToast("‚ÑπÔ∏è ŸäŸÖŸÉŸÜŸÉ ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑÿ≠ÿßŸÑÿ© ŸÑÿßÿ≠ŸÇÿßŸã");
    };

    const openSettingsBtn = document.getElementById("wmOpenSettingsBtn");
    if (openSettingsBtn) openSettingsBtn.onclick = () => {
      if (modal) modal.style.display = "none";
      // ŸÜÿ≤ŸàŸÑ ÿ•ŸÑŸâ ŸÇÿ≥ŸÖ ÿßŸÑÿ•ŸÜÿ™ÿßÿ¨
      const prodTitle = document.querySelector('h2[style*="CALCUL DE PRODUCTION"]') || document.getElementById("cycleTimeInput");
      if (prodTitle && prodTitle.scrollIntoView) prodTitle.scrollIntoView({ behavior: "smooth", block: "start" });
    };
  }catch(e){}
});

let selectedShiftDate = null; // Date de shift s√©lectionn√©e manuellement

// Variables pour les alarmes de pause
let pauseAlarmTimeouts = [];
let activeAlarms = [];
let lastSaveTime = Date.now();
let saveInterval;
let db = null;

// Valeurs par d√©faut pour les pauses
const defaultPauses = {
    // 3 pauses de 30 min (valeurs par d√©faut)
    p1Start: "08:00", p1End: "08:30",
    p2Start: "10:00", p2End: "10:30",
    p3Start: "12:00", p3End: "12:30",
};

// Variables pour Team Leader
let teamLeader = LS.getItem("TEAM_LEADER") || "";

// Variables pour les objectifs et EPO
let objectifs = JSON.parse(LS.getItem("OBJECTIFS") || "{}");

// Variables pour l'√©dition en ligne
let editingRowIndex = -1;
let editingCellIndex = -1;

// =============================================
// VARIABLES POUR SYNCHRONISATION P2P ET CHAT
// =============================================
let peer = null;
let peerId = null;
let fixedPeerId = null; // ID fixe sauvegard√©
let connections = new Map(); // Map pour stocker toutes les connexions
let isSyncing = false;

// Variables pour le chat
let chatMessages = JSON.parse(LS.getItem("CHAT_MESSAGES") || "[]");
let posts = JSON.parse(LS.getItem("POSTS") || "[]");
let unreadMessages = 0;
let chatSyncInterval = null;

// =============================================
// NOUVELLES VARIABLES POUR LE CALCUL DE PRODUCTION
// =============================================
const DEFAULT_CYCLE_TIME_SECONDS = 267; // 4 minutes 27 secondes (par d√©faut)
let cycleTimeSeconds = DEFAULT_CYCLE_TIME_SECONDS;
let SHIFT_TOTAL_MINUTES = 480; // 8 heures de shift

// =============================================
// FONCTIONS POUR LE CALCUL DE PRODUCTION
// =============================================

function updateProductionCalculations() {
    // Mettre √† jour le temps de cycle depuis l'input
    const _cycleEl = document.getElementById("cycleTimeInput");
    const cycleInput = _cycleEl ? (_cycleEl.value || "") : "";
    const cycleParts = cycleInput.split(':');
    
    if (cycleParts.length === 2) {
        const minutes = parseInt(cycleParts[0]) || 0;
        const seconds = parseInt(cycleParts[1]) || 0;
        cycleTimeSeconds = (minutes * 60) + seconds;
    }
    
    // Afficher le temps de cycle format√©
    const cycleMinutes = Math.floor(cycleTimeSeconds / 60);
    const cycleSeconds = cycleTimeSeconds % 60;
    const _ctDisp = document.getElementById("cycleTimeDisplay");
    if (_ctDisp) _ctDisp.textContent = `${cycleMinutes}:${cycleSeconds.toString().padStart(2,'0')}`;
    
    // Cadence cible (v√©h/heure) d√©pend du temps de cycle
    const perHour = (cycleTimeSeconds > 0) ? (3600 / cycleTimeSeconds) : 0;
    const _phEl = document.getElementById("cycleRatePerHour");
    if (_phEl) _phEl.textContent = (Math.round(perHour)).toString();
    const _cadEl = document.getElementById("cadenceCibleValue");
    if (_cadEl) _cadEl.textContent = `${(Math.round(perHour))} v√©h/h`;

    // JOUR SANS PRODUCTION (ÿπÿ∑ŸÑÿ© / Machine OFF) => Production = 0
    const ctxWork = getActiveShiftContext(new Date());
    const shiftDateWork = ctxWork.shiftDate;
    if (isNoProductionDay(shiftDateWork)) {
        const _el_availableTimeDisplay = document.getElementById("availableTimeDisplay");
        if (_el_availableTimeDisplay) _el_availableTimeDisplay.textContent = "0 min";
        const _el_theoreticalVehicles = document.getElementById("theoreticalVehicles");
        if (_el_theoreticalVehicles) _el_theoreticalVehicles.textContent = "0";
        const _el_lostVehicles = document.getElementById("lostVehicles");
        if (_el_lostVehicles) _el_lostVehicles.textContent = "0";
        const _el_producedVehicles = document.getElementById("producedVehicles");
        if (_el_producedVehicles) _el_producedVehicles.textContent = "0";

        updateShiftObjectiveDashboard();
        updateInstantProductionPlanner();
        refreshProductionInWhatsApp();
        try { updateParetoProductionLossChart(); } catch(e) {}
        return;
    }

    // Calculer le temps disponible (shift total - pauses)
    const pauseData = calculateTotalPauseMinutes();
    const availableMinutes = SHIFT_TOTAL_MINUTES - pauseData.total;
    const _el_availableTimeDisplay = document.getElementById("availableTimeDisplay");
        if (_el_availableTimeDisplay) _el_availableTimeDisplay.textContent = `${availableMinutes} min`;
    
    // Calculer les v√©hicules th√©oriques (sans arr√™ts)
    const availableSeconds = availableMinutes * 60;
    const theoreticalVehicles = Math.floor(availableSeconds / cycleTimeSeconds);
    const _el_theoreticalVehicles = document.getElementById("theoreticalVehicles");
        if (_el_theoreticalVehicles) _el_theoreticalVehicles.textContent = theoreticalVehicles;
    
    // Calculer les v√©hicules perdus d√ª aux arr√™ts
    const ctxProd = getActiveShiftContext(new Date());
    const shiftDate = ctxProd.shiftDate;
    const filteredStops = history.filter(h => h.equipe === equipe && h.date === shiftDate);
    const totalDurationGross = filteredStops.reduce((a, b) => a + b.duration, 0);
    const pauseSeconds = pauseData.total * 60;
    const totalDurationNet = Math.max(0, totalDurationGross - pauseSeconds);
    
    const lostVehicles = Math.floor(totalDurationNet / cycleTimeSeconds);
    const _el_lostVehicles = document.getElementById("lostVehicles");
        if (_el_lostVehicles) _el_lostVehicles.textContent = lostVehicles;
    
    // Calculer les v√©hicules produits
    const producedVehicles = Math.max(0, theoreticalVehicles - lostVehicles);
    const _el_producedVehicles = document.getElementById("producedVehicles");
        if (_el_producedVehicles) _el_producedVehicles.textContent = producedVehicles;
    
    // (Temps de cycle) ne se sauvegarde que via le bouton "Sauvegarder"
    updateCycleTimeDirtyUI();

    // Mettre √† jour l'affichage
    updateShiftObjectiveDashboard();
    updateInstantProductionPlanner();
    refreshProductionInWhatsApp();
    try { updateParetoProductionLossChart(); } catch(e) {}
}


// =============================================
// OBJECTIF SHIFT + SUIVI INSTANTAN√â + PERTES / HEURE
// =============================================
let _objectiveTicker = null;
let _lastHourlyRenderKey = "";

function _formatMMSSFromSeconds(sec){
    const s = Math.max(0, Math.floor(sec || 0));
    const m = Math.floor(s / 60);
    const r = s % 60;
    return `${String(m).padStart(2,'0')}:${String(r).padStart(2,'0')}`;
}

function _formatHHMMFromSeconds(sec){
    const s = Math.max(0, Math.floor(sec || 0));
    const h = Math.floor(s / 3600);
    const m = Math.floor((s % 3600) / 60);
    return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
}

function updateCycleTimeDirtyUI(){
    try{
        const badge = document.getElementById("cycleTimeDirtyBadge");
        if(!badge) return;

        const saved = parseInt(LS.getItem("CYCLE_TIME_SECONDS") || "", 10);
        const hasSaved = !isNaN(saved) && saved > 0;
        const dirty = (!hasSaved && cycleTimeSeconds !== DEFAULT_CYCLE_TIME_SECONDS) || (hasSaved && saved !== cycleTimeSeconds);

        badge.style.display = dirty ? "inline-block" : "none";
    }catch(e){}
}

async function _setIndexedDBCycleTimeValue(val){
    try{
        if(!db) return;
        const tx = db.transaction(['settings'], 'readwrite');
        const store = tx.objectStore('settings');
        // val peut √™tre null pour "supprimer"
        store.put({ key: 'cycleTimeSeconds', value: val });
    }catch(e){}
}

function saveCycleTime(){
    try{
        const safe = Math.max(1, Math.floor(cycleTimeSeconds || DEFAULT_CYCLE_TIME_SECONDS));
        cycleTimeSeconds = safe;

        try{ LS.setItem("CYCLE_TIME_SECONDS", String(safe)); }catch(e){}
        if (db) {
            try{ _setIndexedDBCycleTimeValue(safe); }catch(e){}
        }

        updateCycleTimeDirtyUI();
        updateProductionCalculations();
        if(typeof showSimpleToast === "function") showSimpleToast("‚úÖ Temps de cycle sauvegard√©");
    }catch(e){}
}

function deleteCycleTime(){
    try{
        // Retour au d√©faut + suppression de la valeur sauvegard√©e
        try{ LS.removeItem("CYCLE_TIME_SECONDS"); }catch(e){}
        if (db) {
            try{ _setIndexedDBCycleTimeValue(null); }catch(e){}
        }
        cycleTimeSeconds = DEFAULT_CYCLE_TIME_SECONDS;

        const inp = document.getElementById("cycleTimeInput");
        if(inp) inp.value = _formatMMSSFromSeconds(cycleTimeSeconds);

        const disp = document.getElementById("cycleTimeDisplay");
        if(disp){
            const m = Math.floor(cycleTimeSeconds / 60);
            const s = cycleTimeSeconds % 60;
            disp.textContent = `${m}:${String(s).padStart(2,'0')}`;
        }

        updateCycleTimeDirtyUI();
        updateProductionCalculations();
        if(typeof showSimpleToast === "function") showSimpleToast("üóëÔ∏è Temps de cycle supprim√© (retour d√©faut)");
    }catch(e){}
}

function _computePauseSecondsOverlap(intervalStart, intervalEnd, shiftType, shiftDateStr){
    let total = 0;
    try{
        const cfg = (shiftConfigs && shiftConfigs[shiftType]) ? shiftConfigs[shiftType] : (shiftConfigs ? shiftConfigs['Nuit'] : null);
        if(!cfg) return 0;
        const pauses = getPauseIntervalsForShift(shiftDateStr, cfg) || [];
        for(const p of pauses){
            if(!p || !p.start || !p.end) continue;
            total += overlapSeconds(intervalStart, intervalEnd, p.start, p.end);
        }
    }catch(e){}
    return total;
}


function _computePauseSecondsFromSettings(intervalStart, intervalEnd, shiftDateStrOrType, shiftDateStrMaybe){
    // Utilise les pauses configur√©es (par d√©faut 30 min) : pas besoin de shiftConfigs
    let total = 0;
    
    // Supporte les appels: (start,end,shiftDate) OU (start,end,shiftType,shiftDate)
    const shiftDateStr = (typeof shiftDateStrMaybe === "string" && shiftDateStrMaybe) ? shiftDateStrMaybe : shiftDateStrOrType;
try{
        if(typeof calculateTotalPauseMinutes !== "function") return 30*60;
        const pd = calculateTotalPauseMinutes();
        const details = (pd && Array.isArray(pd.details)) ? pd.details : [];
        const baseISO = shiftDateStrToISO ? (shiftDateStrToISO(shiftDateStr) || new Date().toISOString().slice(0,10)) : new Date().toISOString().slice(0,10);

        // Helper: build Date from ISO date + "HH:MM"
        const buildDT = (isoDate, hhmm) => {
            const [hh, mm] = String(hhmm || "00:00").split(":").map(x=>parseInt(x,10));
            const d = new Date(isoDate + "T00:00:00");
            d.setHours(isNaN(hh)?0:hh, isNaN(mm)?0:mm, 0, 0);
            return d;
        };

        for(const p of details){
            if(!p || !p.start || !p.end) continue;
            let ps = buildDT(baseISO, p.start);
            let pe = buildDT(baseISO, p.end);
            if(pe.getTime() <= ps.getTime()){
                // si la pause traverse minuit
                pe = new Date(pe.getTime() + 24*3600*1000);
            }
            total += overlapSeconds(intervalStart, intervalEnd, ps, pe);
        }

        // Fallback si aucune pause d√©finie
        if(total === 0 && pd && typeof pd.total === "number" && pd.total > 0){
            // si interval couvre tout le shift, pd.total est le total des pauses
            // mais si interval partiel, on laisse total=0 (pas encore pass√© dans la pause)
        }
    }catch(e){}
    return total;
}


function updateShiftObjectiveDashboard(){
    try{
        const root = document.getElementById("prodObjectiveDashboard");
        if(!root) return;

        const ctx = getActiveShiftContext(new Date());
        const cfg = (shiftConfigs && shiftConfigs[ctx.shiftType]) ? shiftConfigs[ctx.shiftType] : (shiftConfigs ? shiftConfigs['Nuit'] : null);
        if(!cfg) return;

        const shiftDateISO = shiftDateStrToISO(ctx.shiftDate) || new Date().toISOString().slice(0,10);
        const startHH = String(cfg.start).padStart(2,'0') + ":00";
        const endHH   = String(cfg.end).padStart(2,'0') + ":00";
        const shiftStart = buildDateTimeFromShiftDateISO(shiftDateISO, startHH, ctx.shiftType);
        const shiftEnd   = buildDateTimeFromShiftDateISO(shiftDateISO, endHH,   ctx.shiftType);

        const now = new Date();
        const nowClamped = new Date(Math.min(Math.max(now.getTime(), shiftStart.getTime()), shiftEnd.getTime()));

        const totalSec = Math.max(1, (shiftEnd.getTime() - shiftStart.getTime()) / 1000);
        const elapsedSec = Math.max(0, (nowClamped.getTime() - shiftStart.getTime()) / 1000);
        const remainingSec = Math.max(0, (shiftEnd.getTime() - now.getTime()) / 1000);

        // Temps restant affich√©
        const remEl = document.getElementById("objectiveTimeRemaining");
        if(remEl) remEl.textContent = _formatHHMMFromSeconds(remainingSec);

        // Jour sans production => tout √† 0
        if (isNoProductionDay(ctx.shiftDate)) {
            const ids = ["objectiveShiftUnits","producedNowAuto","remainingToObjective","lostUnitsEnd","lostThisHourUnits","stopsNetMinutesEnd"];
            ids.forEach(id => { const el=document.getElementById(id); if(el) el.textContent="0"; });
            const body = document.getElementById("hourlyLossBody");
            if(body) body.innerHTML = `<tr><td colspan="3" style="padding:10px; font-size:12px; color:#ccc;">Pas de production ÿßŸÑŸäŸàŸÖ</td></tr>`;
            return;
        }

        const ct = Math.max(1, Math.floor(cycleTimeSeconds || DEFAULT_CYCLE_TIME_SECONDS));

        // Total pauses prises en compte sur le shift (en secondes)
        const pauseShiftSec = (function(){
            // Objectif = 480 - 30 min pauses (configur√©es), donc on calcule les pauses depuis les r√©glages
            const sec = _computePauseSecondsFromSettings(shiftStart, shiftEnd, ctx.shiftDate);
            // si aucune pause d√©tect√©e, on applique 30 min par d√©faut
            return (sec && sec > 0) ? sec : 30*60;
        })();

        // Arr√™ts (overlap) sur tout le shift, puis NET = arr√™ts - pauses
        const stopShiftSecGross = _computeStopSecondsOverlap(shiftStart, shiftEnd, ctx.shiftType, ctx.shiftDate);
        const stopShiftSecNet = Math.max(0, stopShiftSecGross - pauseShiftSec);

        // Temps disponible net (shift - pauses)
        const availShiftSec = Math.max(0, totalSec - pauseShiftSec);

        const netProdSecEnd = Math.max(0, availShiftSec - stopShiftSecNet);

        const objectiveUnits = Math.floor(netProdSecEnd / ct);
        const lostUnitsEnd = Math.floor(stopShiftSecNet / ct);

        // Arr√™ts nets minutes
        const stopsNetMin = Math.round((stopShiftSecNet / 60) * 10) / 10;

        const objEl = document.getElementById("objectiveShiftUnits");
        if(objEl) objEl.textContent = String(objectiveUnits);

        const lostEndEl = document.getElementById("lostUnitsEnd");
        if(lostEndEl) lostEndEl.textContent = String(lostUnitsEnd);

        const stopsMinEl = document.getElementById("stopsNetMinutesEnd");
        if(stopsMinEl) stopsMinEl.textContent = String(stopsNetMin);

        // --- PRODUCTION AUTO "MAINTENANT" ---
        const pauseSoFarSec = _computePauseSecondsFromSettings(shiftStart, nowClamped, ctx.shiftDate);
        const stopSoFarGross = _computeStopSecondsOverlap(shiftStart, nowClamped, ctx.shiftType, ctx.shiftDate);
        const stopSoFarNet = Math.max(0, stopSoFarGross - pauseSoFarSec);

        const runSec = Math.max(0, elapsedSec - pauseSoFarSec - stopSoFarNet);
        const producedNow = Math.floor(runSec / ct);

        const prodEl = document.getElementById("producedNowAuto");
        if(prodEl) prodEl.textContent = String(producedNow);

        const remainingUnits = Math.max(0, objectiveUnits - producedNow);
        const remUnitsEl = document.getElementById("remainingToObjective");
        if(remUnitsEl) remUnitsEl.textContent = String(remainingUnits);

        // --- PERDUS CETTE HEURE (so far) ---
        const msFromStart = Math.max(0, nowClamped.getTime() - shiftStart.getTime());
        const hourIndex = Math.floor(msFromStart / (3600 * 1000));
        const hourStart = new Date(shiftStart.getTime() + hourIndex * 3600 * 1000);

        const pauseHourSoFar = _computePauseSecondsFromSettings(hourStart, nowClamped, ctx.shiftType, ctx.shiftDate);
        const pauseHourSec = _computePauseSecondsFromSettings(hourStart, nowClamped, ctx.shiftDate);
        const stopHourGross = _computeStopSecondsOverlap(hourStart, nowClamped, ctx.shiftType, ctx.shiftDate);
        const stopHourNet = Math.max(0, stopHourGross - pauseHourSec);
        const lostThisHour = Math.floor(stopHourNet / ct);

        const lostHrEl = document.getElementById("lostThisHourUnits");
        if(lostHrEl) lostHrEl.textContent = String(lostThisHour);

        // --- TABLE PERTES / HEURE ---
        const key = `${ctx.shiftDate}|${ctx.shiftType}|${(history||[]).length}|${ct}|${now.getMinutes()}`;
        if(_lastHourlyRenderKey !== key){
            _lastHourlyRenderKey = key;
            const body = document.getElementById("hourlyLossBody");
            if(body){
                let rows = "";
                let segStart = new Date(shiftStart.getTime());
                while(segStart < shiftEnd){
                    const segEnd = new Date(Math.min(shiftEnd.getTime(), segStart.getTime() + 3600*1000));
                    const pauseSeg = _computePauseSecondsFromSettings(segStart, segEnd, ctx.shiftType, ctx.shiftDate);
                    const stopSegGross = _computeStopSecondsOverlap(segStart, segEnd, ctx.shiftType, ctx.shiftDate);
                    const stopSegNet = Math.max(0, stopSegGross - pauseSeg);

                    const stopMin = Math.round((stopSegNet/60)*10)/10;
                    const lostUnits = Math.floor(stopSegNet / ct);

                    rows += `<tr>
                        <td style="padding:8px; font-size:12px;">${formatHHMM(segStart)} - ${formatHHMM(segEnd)}</td>
                        <td style="padding:8px; font-size:12px; text-align:right;">${stopMin}</td>
                        <td style="padding:8px; font-size:12px; text-align:right;">${lostUnits}</td>
                    </tr>`;
                    segStart = segEnd;
                }
                body.innerHTML = rows || `<tr><td colspan="3" style="padding:10px; font-size:12px; color:#ccc;">‚Äî</td></tr>`;
            }
        }

        // compat values (cach√©s)
        const availMin = Math.floor(availShiftSec / 60);
        const theoreticalUnits = Math.floor(availShiftSec / ct);
        const producedEnd = Math.max(0, theoreticalUnits - lostUnitsEnd);

        const avEl = document.getElementById("availableTimeDisplay");
        if(avEl) avEl.textContent = `${availMin} min`;
        const thEl = document.getElementById("theoreticalVehicles");
        if(thEl) thEl.textContent = String(theoreticalUnits);
        const loEl = document.getElementById("lostVehicles");
        if(loEl) loEl.textContent = String(lostUnitsEnd);
        const prEl = document.getElementById("producedVehicles");
        if(prEl) prEl.textContent = String(producedEnd);

    }catch(e){}
}

// =============================================
// PLANIFICATEUR "√Ä PRODUIRE √Ä L‚ÄôINSTANT" (Manuel & Auto)
// =============================================

function _plannerKeyForActiveShift(ctx){
    try{
        const iso = shiftDateStrToISO(ctx.shiftDate) || new Date().toISOString().slice(0,10);
        const team = (typeof equipe !== "undefined" && equipe) ? equipe : "NA";
        const st = (ctx && ctx.shiftType) ? ctx.shiftType : "NA";
        return `MANUAL_PRODUCED_NOW__${team}__${st}__${iso}`;
    }catch(e){
        return "MANUAL_PRODUCED_NOW__NA";
    }
}

function loadManualProducedNowForActiveShift(){
    try{
        const input = document.getElementById("manualProducedNow");
        if(!input) return;
        const ctx = getActiveShiftContext(new Date());
        const key = _plannerKeyForActiveShift(ctx);
        const saved = LS.getItem(key);
        if(saved !== null && saved !== undefined && saved !== ""){
            // Ne pas √©craser si l'utilisateur est en train de saisir
            if(document.activeElement !== input){
                input.value = String(parseInt(saved, 10) || 0);
            }
        }
    }catch(e){}
}

function saveManualProducedNowForActiveShift(){
    try{
        const input = document.getElementById("manualProducedNow");
        if(!input) return;
        const val = parseInt(input.value || "0", 10);
        const safeVal = isNaN(val) ? 0 : Math.max(0, val);

        const ctx = getActiveShiftContext(new Date());
        const key = _plannerKeyForActiveShift(ctx);
        LS.setItem(key, String(safeVal));
        if (db) saveToIndexedDB();

        if(typeof showNotification === "function"){
            showNotification("‚úÖ Production r√©elle sauvegard√©e (manuel)", "success");
        }else if(typeof showSimpleToast === "function"){
            showSimpleToast("‚úÖ Sauvegard√©");
        }
        updateInstantProductionPlanner();
    }catch(e){}
}

function _catchupKeyForActiveShift(ctx){
    try{
        return `AUTO_CATCHUP:${ctx.shiftType}:${ctx.shiftDate}`;
    }catch(e){
        return "AUTO_CATCHUP";
    }
}
function isAutoCatchUpEnabledForActiveShift(ctx){
    try{
        const k = _catchupKeyForActiveShift(ctx);
        return (LS.getItem(k) || "0") === "1";
    }catch(e){
        return false;
    }
}
function toggleAutoCatchUp(){
    try{
        const ctx = getActiveShiftContext(new Date());
        const k = _catchupKeyForActiveShift(ctx);
        const cur = (LS.getItem(k) || "0") === "1";
        LS.setItem(k, cur ? "0" : "1");
        if (db) saveToIndexedDB();
        updateInstantProductionPlanner();
        if(typeof showNotification === "function"){
            showNotification(cur ? "üîÅ Rattrapage Auto d√©sactiv√©" : "üîÅ Rattrapage Auto activ√©", "info");
        }else if(typeof showSimpleToast === "function"){
            showSimpleToast(cur ? "Rattrapage OFF" : "Rattrapage ON");
        }
    }catch(e){}
}


function _formatRemainHHMM(totalSeconds){
    const s = Math.max(0, Math.floor(totalSeconds || 0));
    const h = Math.floor(s / 3600);
    const m = Math.floor((s % 3600) / 60);
    return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
}

function _computeStopSecondsOverlap(intervalStart, intervalEnd, shiftType, shiftDateStr){
    let total = 0;
    try{
        const list = Array.isArray(history) ? history : [];
        const startMs = intervalStart.getTime();
        const endMs = intervalEnd.getTime();
        const dateISO = shiftDateStrToISO(shiftDateStr) || null;

        for(const stop of list){
            if(!stop) continue;
            if(typeof equipe !== "undefined" && equipe && stop.equipe && stop.equipe !== equipe) continue;

            // la plupart des donn√©es sont d√©j√† group√©es par date de shift
            if(shiftDateStr && stop.date && stop.date !== shiftDateStr){
                // si l'arr√™t a des startDateTime, on laisse une chance (cas import)
                // sinon on ignore
                if(!stop.startDateTime) continue;
            }

            try{ updateStopDateTimes(stop, shiftType); }catch(e){}

            let sdt = null;
            if(stop.startDateTime){
                sdt = new Date(stop.startDateTime);
            }else if(stop.start && dateISO){
                sdt = buildDateTimeFromShiftDateISO(dateISO, stop.start, shiftType);
            }
            if(!sdt || isNaN(sdt.getTime())) continue;

            let edt = null;
            if(stop.endDateTime){
                edt = new Date(stop.endDateTime);
            }else if(stop.end && dateISO){
                edt = buildDateTimeFromShiftDateISO(dateISO, stop.end, shiftType);
            }
            if(!edt || isNaN(edt.getTime())){
                const dur = Number(stop.duration);
                if(!isNaN(dur) && dur > 0){
                    // duration est en secondes dans l'app
                    edt = new Date(sdt.getTime() + dur * 1000);
                }else{
                    // arr√™t en cours => on coupe √† intervalEnd
                    edt = new Date(endMs);
                }
            }

            const sMs = sdt.getTime();
            const eMs = edt.getTime();

            const overlapMs = Math.max(0, Math.min(eMs, endMs) - Math.max(sMs, startMs));
            total += overlapMs / 1000;
        }
    }catch(e){}
    return total;
}

function updateInstantProductionPlanner(){
    try{
        const targetEl = document.getElementById("instantTarget");
        const remainEl = document.getElementById("shiftTimeRemaining");
        const remManEl = document.getElementById("remainingManual");
        const gapManEl = document.getElementById("gapManual");
        const rateManEl = document.getElementById("rateManual");
        const remAutoEl = document.getElementById("remainingAuto");
        const autoProdEl = document.getElementById("autoProducedNow");
        const rateAutoEl = document.getElementById("rateAuto");
        const autoLostEl = document.getElementById("autoLostVehicles");
        const autoObjBaseEl = document.getElementById("autoObjectiveBase");
        const autoObjAdjEl = document.getElementById("autoObjectiveAdj");
        const autoBtnEl = document.getElementById("autoCatchUpBtn");
        const inputMan = document.getElementById("manualProducedNow");

        if(!targetEl || !remainEl || !remManEl || !gapManEl || !rateManEl || !remAutoEl || !autoProdEl || !rateAutoEl) return;

        const ctx = getActiveShiftContext(new Date());
        const cfg = (shiftConfigs && shiftConfigs[ctx.shiftType]) ? shiftConfigs[ctx.shiftType] : shiftConfigs['Nuit'];
        const shiftDateISO = shiftDateStrToISO(ctx.shiftDate) || new Date().toISOString().slice(0,10);

        const startHH = String(cfg.start).padStart(2,'0') + ":00";
        const endHH = String(cfg.end).padStart(2,'0') + ":00";
        const shiftStart = buildDateTimeFromShiftDateISO(shiftDateISO, startHH, ctx.shiftType);
        const shiftEnd = buildDateTimeFromShiftDateISO(shiftDateISO, endHH, ctx.shiftType);

        const totalSec = Math.max(1, (shiftEnd.getTime() - shiftStart.getTime()) / 1000);
        const now = new Date();
        const nowClamped = new Date(Math.min(Math.max(now.getTime(), shiftStart.getTime()), shiftEnd.getTime()));
        const elapsedSec = Math.max(0, (nowClamped.getTime() - shiftStart.getTime()) / 1000);
        const remainingSec = Math.max(0, (shiftEnd.getTime() - now.getTime()) / 1000);

        // Objectif production (manuel) : priorit√© √† l'input, sinon objectifs.production
        let objectif = null;
        const objInput = document.getElementById("objectifProd");
        if(objInput){
            const v = parseInt(objInput.value || "", 10);
            if(!isNaN(v) && v > 0) objectif = v;
        }
        if(!objectif && typeof objectifs === "object" && objectifs && objectifs.production){
            objectif = objectifs.production;
        }

        // Affichage temps restant
        remainEl.textContent = _formatRemainHHMM(remainingSec);

        if(!objectif){
            targetEl.textContent = "-";
            remManEl.textContent = "-";
            gapManEl.textContent = "-";
            rateManEl.textContent = "-";
            remAutoEl.textContent = "-";
            autoProdEl.textContent = "-";
            rateAutoEl.textContent = "-";
            return;
        }

        const progress = Math.min(1, Math.max(0, elapsedSec / totalSec));
        // Rattrapage Auto (Optionnel): Objectif ajust√© = Objectif + V√©hicules perdus (arr√™ts)
        const stopSecSoFar_forCatch = _computeStopSecondsOverlap(shiftStart, nowClamped, ctx.shiftType, ctx.shiftDate);
        const lostVehSoFar = Math.floor(stopSecSoFar_forCatch / Math.max(1, cycleTimeSeconds || 1));
        const catchUpOn = isAutoCatchUpEnabledForActiveShift(ctx);
        const objectifAuto = objectif + (catchUpOn ? lostVehSoFar : 0);

        if(autoLostEl) autoLostEl.textContent = String(lostVehSoFar);
        if(autoObjBaseEl) autoObjBaseEl.textContent = String(objectif);
        if(autoObjAdjEl) autoObjAdjEl.textContent = String(objectifAuto);
        if(autoBtnEl) autoBtnEl.innerHTML = catchUpOn ? "‚ö° AUTO : Rattrapage ON" : "‚ö° AUTO : Rattrapage OFF";

        const targetNow = Math.floor(objectif * progress);
        targetEl.textContent = String(targetNow);

        // --- Manuel ---
        loadManualProducedNowForActiveShift();
        const producedMan = inputMan ? parseInt(inputMan.value || "", 10) : NaN;

        if(!isNaN(producedMan)){
            const remainingMan = Math.max(0, objectif - producedMan);
            remManEl.textContent = String(remainingMan);

            const gapMan = producedMan - targetNow;
            gapManEl.textContent = (gapMan >= 0 ? "+" : "") + String(gapMan);

            const hoursLeft = remainingSec / 3600;
            const rate = (hoursLeft > 0.0001) ? (remainingMan / hoursLeft) : 0;
            rateManEl.textContent = String(Math.round(rate));
        }else{
            remManEl.textContent = "-";
            gapManEl.textContent = "-";
            rateManEl.textContent = "-";
        }

        // --- Auto (temps de marche hors arr√™ts) ---
        const stopSecSoFar = _computeStopSecondsOverlap(shiftStart, nowClamped, ctx.shiftType, ctx.shiftDate);
        const runSec = Math.max(0, elapsedSec - stopSecSoFar);
        const autoProducedNow = Math.floor(runSec / Math.max(1, cycleTimeSeconds || 1));
        autoProdEl.textContent = String(autoProducedNow);

        const remainingAuto = Math.max(0, (typeof objectifAuto!=="undefined"?objectifAuto:objectif) - autoProducedNow);
        remAutoEl.textContent = String(remainingAuto);

        const hoursLeft2 = remainingSec / 3600;
        const rate2 = (hoursLeft2 > 0.0001) ? (remainingAuto / hoursLeft2) : 0;
        rateAutoEl.textContent = String(Math.round(rate2));

    }catch(e){}
}



// =============================================
// CALCUL DE PRODUCTION - DERNI√àRE HEURE
// =============================================

function parseTimeParts(timeStr) {
    if (!timeStr) return null;
    const parts = timeStr.toString().trim().split(':').map(p => parseInt(p, 10));
    return {
        h: parts[0] || 0,
        m: parts[1] || 0,
        s: parts[2] || 0
    };
}

function shiftDateStrToMidnight(shiftDateStr) {
    // Format attendu: "dd/mm/yyyy"
    if (!shiftDateStr) return null;
    const [d, m, y] = shiftDateStr.split('/').map(Number);
    if (!d || !m || !y) return null;
    return new Date(y, m - 1, d, 0, 0, 0, 0);
}

function timeStrToDateInShift(timeStr, shiftDateStr, config) {
    const base = shiftDateStrToMidnight(shiftDateStr);
    if (!base) return null;

    const t = parseTimeParts(timeStr);
    if (!t) return null;

    let dayOffset = 0;

    // Shift qui passe minuit (ex: 22 -> 6)
    if (config && typeof config.start === 'number' && typeof config.end === 'number' && config.start > config.end) {
        // Les heures 00:00 -> end appartiennent au lendemain
        if (t.h <= config.end) dayOffset = 1;
    }

    const dt = new Date(base.getTime());
    dt.setDate(dt.getDate() + dayOffset);
    dt.setHours(t.h, t.m, t.s, 0);
    return dt;
}

function getCurrentShiftBounds(now = new Date()) {
    const shiftDate = getShiftDate(now);
    const config = shiftConfigs[currentShiftType];
    const base = shiftDateStrToMidnight(shiftDate);
    if (!base || !config) return null;

    const shiftStart = new Date(base.getTime());
    shiftStart.setHours(config.start, 0, 0, 0);

    const shiftEnd = new Date(base.getTime());
    if (config.start > config.end) {
        shiftEnd.setDate(shiftEnd.getDate() + 1);
    }
    shiftEnd.setHours(config.end, 0, 0, 0);

    return { shiftDate, config, start: shiftStart, end: shiftEnd };
}

function overlapSeconds(aStart, aEnd, bStart, bEnd) {
    const startMs = Math.max(aStart.getTime(), bStart.getTime());
    const endMs = Math.min(aEnd.getTime(), bEnd.getTime());
    return Math.max(0, (endMs - startMs) / 1000);
}

function getPauseIntervalsForShift(shiftDateStr, config) {
    const p1s = document.getElementById("p1Start")?.value || getPauseTime("PAUSE_1_START", defaultPauses.p1Start);
    const p1e = document.getElementById("p1End")?.value || getPauseTime("PAUSE_1_END", defaultPauses.p1End);
    const p2s = document.getElementById("p2Start")?.value || getPauseTime("PAUSE_2_START", defaultPauses.p2Start);
    const p2e = document.getElementById("p2End")?.value || getPauseTime("PAUSE_2_END", defaultPauses.p2End);
    const p3s = document.getElementById("p3Start")?.value || getPauseTime("PAUSE_3_START", defaultPauses.p3Start);
    const p3e = document.getElementById("p3End")?.value || getPauseTime("PAUSE_3_END", defaultPauses.p3End);

    const raw = [
        { start: p1s, end: p1e },
        { start: p2s, end: p2e },
        { start: p3s, end: p3e }
    ];

    const intervals = [];
    raw.forEach(p => {
        if (!p.start || !p.end) return;
        const s = timeStrToDateInShift(p.start, shiftDateStr, config);
        const e = timeStrToDateInShift(p.end, shiftDateStr, config);
        if (!s || !e) return;

        const end = new Date(e.getTime());
        // S√©curit√© si fin <= d√©but (cas rare)
        if (end <= s) end.setDate(end.getDate() + 1);

        intervals.push({ start: s, end: end });
    });

    return intervals;
}


// (HOURLY) bloc supprim√© √† la demande de l'utilisateur



function refreshProductionInWhatsApp() {
    // Cette fonction sera appel√©e pour mettre √† jour les rapports WhatsApp
    // avec les informations de production
}

// =============================================
// FONCTIONS POUR CHAT
// =============================================

function initializeChat() {
    // Charger les messages existants
    loadChatMessages();
    
    // V√©rifier les nouveaux messages toutes les 3 secondes
    chatSyncInterval = setInterval(checkForNewMessages, 3000);
    
    // Initialiser le bouton de chat
    document.getElementById('chatSendBtn').onclick = sendChatMessage;
    
    // V√©rifier si des messages non lus existent
    updateChatNotification();
}

function toggleChat() {
    const chatContainer = document.getElementById('chatContainer');
    const chatToggleBtn = document.getElementById('chatToggleBtn');
    
    if (chatContainer.classList.contains('active')) {
        chatContainer.classList.remove('active');
        // Marquer tous les messages comme lus
        unreadMessages = 0;
        chatToggleBtn.classList.remove('has-unread');
    } else {
        chatContainer.classList.add('active');
        // Marquer tous les messages comme lus
        unreadMessages = 0;
        chatToggleBtn.classList.remove('has-unread');
        // Faire d√©filer vers le bas
        setTimeout(() => {
            const chatMessagesDiv = document.getElementById('chatMessages');
            chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
        }, 100);
    }
}

function loadChatMessages() {
    const chatMessagesDiv = document.getElementById('chatMessages');
    chatMessagesDiv.innerHTML = '';
    
    chatMessages.forEach(msg => {
        const messageElement = createMessageElement(msg);
        chatMessagesDiv.appendChild(messageElement);
    });
    
    // Faire d√©filer vers le bas
    setTimeout(() => {
        chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
    }, 100);
}

function createMessageElement(msg) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${msg.senderId === peerId ? 'sent' : 'received'}`;
    
    const senderName = msg.senderId === peerId ? 'Moi' : `Appareil ${msg.senderId.substring(0, 8)}`;
    const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    
    messageDiv.innerHTML = `
        <div class="sender">${senderName}</div>
        <div class="content">${escapeHtml(msg.content)}</div>
        <div class="time">${time}</div>
    `;
    
    return messageDiv;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// ==============================
// Helpers (types / dates)
// ==============================
function normalizeTextNoAccent(str) {
    try {
        return (str ?? '').toString().trim().toLowerCase()
            .normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    } catch (e) {
        return (str ?? '').toString().trim().toLowerCase();
    }
}

function isMissedStop(stop) {
    if (!stop) return false;
    if (stop.isMissed === true || stop.missed === true) return true;
    const t = normalizeTextNoAccent(stop.type);
    // accepte "rat√©", "rate", "missed", etc.
    return (t === 'rate' || t === 'missed' || t === 'arretrate' || t === 'arret rate');
}

function shiftDateStrToISO(dateStr) {
    const m = (dateStr || '').match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/);
    if (!m) return null;
    const dd = String(m[1]).padStart(2, '0');
    const mm = String(m[2]).padStart(2, '0');
    const yy = String(m[3]);
    return `${yy}-${mm}-${dd}`;
}

function getShiftDateISO(dateObj) {
    const sd = getShiftDate(dateObj);
    return shiftDateStrToISO(sd) || new Date().toISOString().slice(0, 10);
}

// IMPORTANT Android : "new Date('YYYY-MM-DD')" peut √™tre interpr√©t√© en UTC.
// On force une cr√©ation en heure locale.
function parseISODateLocal(iso) {
    if (!iso) return new Date();
    const parts = String(iso).split('-').map(n => parseInt(n, 10));
    if (parts.length !== 3 || !parts[0] || !parts[1] || !parts[2]) return new Date(iso);
    return new Date(parts[0], parts[1] - 1, parts[2]);
}

function handleChatKeyPress(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendChatMessage();
    }
}

function sendChatMessage() {
    const chatInput = document.getElementById('chatInput');
    const content = chatInput.value.trim();
    
    if (!content) return;
    
    // Cr√©er le message
    const message = {
        id: Date.now(),
        content: content,
        senderId: peerId,
        senderName: teamLeader || `√âquipe ${equipe}`,
        timestamp: Date.now(),
        read: false
    };
    
    // Ajouter au chat local
    chatMessages.push(message);
    if (chatMessages.length > 100) {
        chatMessages = chatMessages.slice(-100); // Garder seulement les 100 derniers messages
    }
    
    // Sauvegarder localement
    LS.setItem("CHAT_MESSAGES", JSON.stringify(chatMessages));
    
    // Afficher le message
    const chatMessagesDiv = document.getElementById('chatMessages');
    chatMessagesDiv.appendChild(createMessageElement(message));
    
    // Faire d√©filer vers le bas
    setTimeout(() => {
        chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
    }, 100);
    
    // Effacer le champ de saisie
    chatInput.value = '';
    
    // Diffuser le message √† tous les appareils connect√©s
    if (connections.size > 0) {
        broadcastChatMessage(message);
    }
    
    // Jouer un son
    document.getElementById('chatSound').play().catch(() => {});
}

function broadcastChatMessage(message) {
    const chatData = {
        type: 'chat_message',
        from: peerId,
        timestamp: Date.now(),
        message: message
    };
    
    connections.forEach((conn, peerId) => {
        conn.send(chatData);
    });
}

function handleIncomingChatMessage(data) {
    if (!data.message) return;
    
    const message = data.message;
    
    // V√©rifier si le message existe d√©j√†
    const existingMessage = chatMessages.find(m => m.id === message.id);
    if (existingMessage) return;
    
    // Ajouter le message
    chatMessages.push(message);
    if (chatMessages.length > 100) {
        chatMessages = chatMessages.slice(-100);
    }
    
    // Sauvegarder localement
    LS.setItem("CHAT_MESSAGES", JSON.stringify(chatMessages));
    
    // Afficher le message
    const chatMessagesDiv = document.getElementById('chatMessages');
    chatMessagesDiv.appendChild(createMessageElement(message));
    
    // Faire d√©filer vers le bas si le chat est ouvert
    if (document.getElementById('chatContainer').classList.contains('active')) {
        setTimeout(() => {
            chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
        }, 100);
    } else {
        // Afficher une notification si le chat n'est pas ouvert
        unreadMessages++;
        updateChatNotification();
        
        // Afficher une notification temporaire
        showChatNotification(`Nouveau message de ${message.senderName || 'Appareil ' + data.from.substring(0, 8)}`);
    }
    
    // Jouer un son
    document.getElementById('chatSound').play().catch(() => {});
}

function showChatNotification(message) {
    const notification = document.getElementById('chatNotification');
    const content = document.getElementById('chatNotificationContent');
    
    content.textContent = message;
    notification.style.display = 'block';
    
    setTimeout(() => {
        notification.style.display = 'none';
    }, 3000);
}

function updateChatNotification() {
    const chatToggleBtn = document.getElementById('chatToggleBtn');
    
    if (unreadMessages > 0) {
        chatToggleBtn.classList.add('has-unread');
        chatToggleBtn.title = `${unreadMessages} message(s) non lu(s)`;
    } else {
        chatToggleBtn.classList.remove('has-unread');
        chatToggleBtn.title = 'Ouvrir le chat';
    }
}

function checkForNewMessages() {
    // Cette fonction pourrait √™tre utilis√©e pour v√©rifier les messages
    // depuis un serveur dans une version future
    // Pour l'instant, la synchronisation se fait via P2P
}

// =============================================
// FONCTIONS POUR TEAM LEADER
// =============================================

function saveTeamLeader() {
    const teamLeaderInput = document.getElementById("teamLeader");
    if (teamLeaderInput) {
        teamLeader = teamLeaderInput.value.trim();
        LS.setItem("TEAM_LEADER", teamLeader);
        
        // Mettre √† jour la couleur du champ
        teamLeaderInput.style.color = "#FFD700";
        teamLeaderInput.style.borderColor = "#FFD700";
        
        showNotification("‚úÖ Team Leader sauvegard√©: " + teamLeader, "success");
        
        // Mettre √† jour tous les arr√™ts existants avec le nouveau Team Leader
        updateExistingStopsWithTeamLeader();
    }
}

function updateExistingStopsWithTeamLeader() {
    if (!teamLeader) return;
    
    const now = new Date();
    const shiftDate = getShiftDate(now);
    
    // Mettre √† jour tous les arr√™ts du shift actuel sans Team Leader
    history.forEach((stop, index) => {
        if (stop.date === shiftDate && stop.equipe === equipe && (!stop.teamLeader || stop.teamLeader === "")) {
            stop.teamLeader = teamLeader;
        }
    });
    
    LS.setItem("HISTO", JSON.stringify(history));
    refreshTable();
}

// =============================================
// FONCTIONS D'√âDITION EN LIGNE
// =============================================

function makeCellEditable(cell, rowIndex, cellIndex) {
    const originalContent = cell.innerHTML;
    const stop = history[rowIndex];
    
    // Cr√©er l'input d'√©dition
    const input = document.createElement("input");
    input.type = "text";
    input.className = "editable-input";
    input.value = getCellValue(stop, cellIndex);
    
    // Remplacer le contenu de la cellule par l'input
    cell.innerHTML = "";
    cell.appendChild(input);
    cell.classList.add("editing");
    
    // Focus sur l'input
    input.focus();
    input.select();
    
    // Sauvegarder au blur
    input.addEventListener("blur", function() {
        saveCellEdit(input.value, rowIndex, cellIndex, cell);
    });
    
    // Sauvegarder avec Enter
    input.addEventListener("keypress", function(e) {
        if (e.key === "Enter") {
            saveCellEdit(input.value, rowIndex, cellIndex, cell);
        }
        if (e.key === "Escape") {
            cancelCellEdit(originalContent, cell);
        }
    });
}

function getCellValue(stop, cellIndex) {
    switch(cellIndex) {
        case 0: // Date
            return stop.date || "";
        case 1: // Cause
            return stop.cause || "";
        case 2: // D√©but
            return stop.start || "";
        case 3: // Fin
            return stop.end || "";
        case 5: // Team Leader
            return stop.teamLeader || "";
        default:
            return "";
    }
}

function saveCellEdit(newValue, rowIndex, cellIndex, cell) {
    const stop = history[rowIndex];
    
    // Mettre √† jour la valeur selon la colonne
    switch(cellIndex) {
        case 0: // Date
            stop.date = newValue;
            updateStopDateTimes(stop);
            break;
        case 1: // Cause
            stop.cause = newValue;
            break;
        case 2: // D√©but
            stop.start = newValue;
            updateStopDateTimes(stop);
            // Recalculer la dur√©e si n√©cessaire
            if (stop.end) {
                const startTime = parseTime(stop.start);
                const endTime = parseTime(stop.end);
                if (startTime && endTime) {
                    stop.duration = calculateDurationInSeconds(stop.start, stop.end);
                }
            }
            break;
        case 3: // Fin
            stop.end = newValue;
            updateStopDateTimes(stop);
            // Recalculer la dur√©e si n√©cessaire
            if (stop.start) {
                stop.duration = calculateDurationInSeconds(stop.start, stop.end);
            }
            break;
        case 5: // Team Leader
            stop.teamLeader = newValue;
            break;
    }
    
    // Mettre √† jour le timestamp
    stop.timestamp = Date.now();
    
    // Sauvegarder
    LS.setItem("HISTO", JSON.stringify(history));
    if (db) saveToIndexedDB();
    
    // Rafra√Æchir le tableau
    refreshTable();
    
    showNotification("‚úÖ Modification sauvegard√©e", "success");
}


function updateStopDateTimes(stop){
    try{
        if (!stop) return;
        const shiftType = getStopShiftType(stop);
        const dateISO = shiftDateStrToISO(stop.date) || (stop.startDateTime ? String(stop.startDateTime).slice(0,10) : null);
        if (!dateISO) return;

        if (stop.start){
            const sdt = buildDateTimeFromShiftDateISO(dateISO, stop.start, shiftType);
            if (sdt && !isNaN(sdt.getTime())){
                stop.startDateTime = sdt.toISOString();
                stop.timestamp = sdt.getTime();
            }
        }
        if (stop.end){
            let edt = buildDateTimeFromShiftDateISO(dateISO, stop.end, shiftType);
            if (stop.startDateTime){
                const sdt2 = new Date(stop.startDateTime);
                if (edt && sdt2 && !isNaN(edt.getTime()) && !isNaN(sdt2.getTime()) && edt.getTime() < sdt2.getTime()){
                    edt.setDate(edt.getDate()+1);
                }
            }
            if (edt && !isNaN(edt.getTime())){
                stop.endDateTime = edt.toISOString();
            }
        }
    }catch(e){}
}

function cancelCellEdit(originalContent, cell) {
    cell.innerHTML = originalContent;
    cell.classList.remove("editing");
}

function parseTime(timeStr) {
    if (!timeStr) return null;
    const parts = timeStr.split(':');
    if (parts.length >= 2) {
        return {
            hours: parseInt(parts[0]),
            minutes: parseInt(parts[1]),
            seconds: parts[2] ? parseInt(parts[2]) : 0
        };
    }
    return null;
}

function calculateDurationInSeconds(startStr, endStr) {
    const start = parseTime(startStr);
    const end = parseTime(endStr);
    
    if (!start || !end) return 0;
    
    let startSeconds = start.hours * 3600 + start.minutes * 60 + start.seconds;
    let endSeconds = end.hours * 3600 + end.minutes * 60 + end.seconds;
    
    // G√©rer le cas o√π l'arr√™t traverse minuit
    if (endSeconds < startSeconds) {
        endSeconds += 24 * 3600;
    }
    
    return endSeconds - startSeconds;
}

// =============================================
// CALCUL AUTOMATIQUE DU RENDEMENT EPO
// =============================================

function calculerRendementAuto() {
    const now = new Date();
    const shiftDate = getShiftDate(now);
    const config = shiftConfigs[currentShiftType];
    
    // 1. Calcul du temps disponible (dur√©e du shift)
    let tempsShift = 8 * 60; // 8h en minutes par d√©faut
    if (config.start < config.end) {
        tempsShift = (config.end - config.start) * 60;
    } else {
        tempsShift = ((24 - config.start) + config.end) * 60;
    }
    
    // 2. R√©cup√©rer les arr√™ts du shift actuel
    const filteredStops = history.filter(h => h.equipe === equipe && h.date === shiftDate);
    const totalDurationGross = filteredStops.reduce((a, b) => a + b.duration, 0);
    const totalDurationMinutes = totalDurationGross / 60;
    
    // 3. Calcul Disponibilit√©
    const tempsDisponible = Math.max(0, tempsShift - totalDurationMinutes);
    const disponibilite = tempsShift > 0 ? (tempsDisponible / tempsShift) * 100 : 0;
    
    // 4. Calcul Performance (estimation automatique)
    let performance = 100;
    if (filteredStops.length > 0) {
        const avgStopDuration = totalDurationMinutes / filteredStops.length;
        // Si dur√©e moyenne arr√™t > 10min, p√©nalit√© performance
        if (avgStopDuration > 10) {
            performance = Math.max(60, 100 - ((avgStopDuration - 10) * 2));
        }
        // Si beaucoup d'arr√™ts courts, bonne performance
        if (filteredStops.length > 5 && avgStopDuration < 5) {
            performance = Math.min(100, 95 + (filteredStops.length * 0.5));
        }
    }
    
    // 5. Calcul Qualit√© (estimation bas√©e sur causes)
    let qualite = 99.5; // Valeur par d√©faut
    const causesQualite = ["Probl√®me qualit√©", "Manque composant", "Absence op√©rateur"];
    const qualiteStops = filteredStops.filter(h => 
        causesQualite.some(cause => h.cause.includes(cause))
    ).length;
    
    // P√©nalit√© qualit√© si arr√™ts qualit√©
    if (qualiteStops > 0) {
        qualite = Math.max(95, 100 - (qualiteStops * 0.5));
    }
    
    // Bonus si peu d'arr√™ts
    if (filteredStops.length <= 3) {
        qualite = Math.min(100, qualite + 0.3);
    }
    
    // 6. Calcul Rendement Global (EPO)
    const rendementGlobal = (disponibilite * performance * qualite) / 10000;
    
    return {
        disponibilite: Math.round(disponibilite * 10) / 10,
        performance: Math.round(performance * 10) / 10,
        qualite: Math.round(qualite * 10) / 10,
        rendementGlobal: Math.round(rendementGlobal * 10) / 10,
        tempsDisponible: Math.round(tempsDisponible),
        totalArrets: filteredStops.length,
        dureeMoyenneArret: filteredStops.length > 0 ? 
            Math.round(totalDurationMinutes / filteredStops.length * 10) / 10 : 0
    };
}

function mettreAJourRendementAuto() {
    const rendement = calculerRendementAuto();
    
    // Mettre √† jour l'affichage
    const _el_disponibilite = document.getElementById("disponibilite");
    if (_el_disponibilite) _el_disponibilite.textContent = rendement.disponibilite + "%";
    const _el_performance = document.getElementById("performance");
    if (_el_performance) _el_performance.textContent = rendement.performance + "%";
    const _el_qualite = document.getElementById("qualite");
    if (_el_qualite) _el_qualite.textContent = rendement.qualite + "%";
    const _el_rendementGlobal = document.getElementById("rendementGlobal");
    if (_el_rendementGlobal) _el_rendementGlobal.textContent = rendement.rendementGlobal + "%";
    
    // Afficher les infos de calcul
    const infoElement = document.querySelector('.info-calcul');
    if (infoElement) {
        infoElement.innerHTML = `
            üìä Calcul auto: ${rendement.totalArrets} arr√™ts (moy: ${rendement.dureeMoyenneArret}min)<br>
            ‚è±Ô∏è Temps disponible: ${rendement.tempsDisponible}/${480}min
        `;
    }
    
    // V√©rifier les objectifs automatiquement
    verifierObjectifsAuto(rendement);
}

// =============================================
// FONCTIONS POUR OBJECTIFS
// =============================================

function saveObjectifs() {
    const _objProdEl = document.getElementById("objectifProd");
    const _objTrsEl = document.getElementById("objectifTRS");
    const _objQualEl = document.getElementById("objectifQualite");
    const _objArrEl = document.getElementById("objectifArrets");
    if (!_objProdEl || !_objTrsEl || !_objQualEl || !_objArrEl) {
        // Section objectifs supprim√©e: ne rien faire
        return;
    }
    const prod = _objProdEl.value;
    const trs = _objTrsEl.value;
    const qualite = _objQualEl.value;
    const arrets = _objArrEl.value;
    
    objectifs = {
        production: prod ? parseInt(prod) : null,
        trs: trs ? parseFloat(trs) : null,
        qualite: qualite ? parseFloat(qualite) : null,
        arrets: arrets ? parseInt(arrets) : null,
        date: getShiftDate(new Date()),
        equipe: equipe
    };
    
    LS.setItem("OBJECTIFS", JSON.stringify(objectifs));
    if (db) saveToIndexedDB();
    
    updateObjectifsDisplay();
    mettreAJourRendementAuto();
    showNotification("‚úÖ Objectifs enregistr√©s pour le shift", "success");
}

function updateObjectifsDisplay() {
    const now = new Date();
    const shiftDate = getShiftDate(now);
    
    // V√©rifier si les objectifs sont pour le shift actuel
    if (objectifs.date === shiftDate && objectifs.equipe === equipe) {
        (()=>{const el=document.getElementById("displayProdObjectif"); if(el) el.textContent = objectifs.production ? objectifs.production + " u" : "-";})();
        (()=>{const el=document.getElementById("displayTRSObjectif"); if(el) el.textContent = objectifs.trs ? objectifs.trs + "%" : "-";})();
        (()=>{const el=document.getElementById("displayQualiteObjectif"); if(el) el.textContent = objectifs.qualite ? objectifs.qualite + "%" : "-";})();
        (()=>{const el=document.getElementById("displayArretsObjectif"); if(el) el.textContent = objectifs.arrets ? objectifs.arrets : "-";})();
    } else {
        (()=>{const el=document.getElementById("displayProdObjectif"); if(el) el.textContent = "-";})();
        (()=>{const el=document.getElementById("displayTRSObjectif"); if(el) el.textContent = "-";})();
        (()=>{const el=document.getElementById("displayQualiteObjectif"); if(el) el.textContent = "-";})();
        (()=>{const el=document.getElementById("displayArretsObjectif"); if(el) el.textContent = "-";})();
    }
}

function verifierObjectifsAuto(rendement) {
    if (!objectifs.date || objectifs.date !== getShiftDate(new Date()) || objectifs.equipe !== equipe) {
        return;
    }
    
    const filteredStops = history.filter(h => 
        h.equipe === equipe && h.date === getShiftDate(new Date())
    );
    
    let messages = [];
    let couleur = "var(--success)";
    
    // V√©rification TRS (Disponibilit√©)
    if (objectifs.trs) {
        if (rendement.disponibilite >= objectifs.trs) {
            messages.push(`‚úÖ TRS: ${rendement.disponibilite}% ‚â• ${objectifs.trs}%`);
        } else {
            messages.push(`‚ö†Ô∏è TRS: ${rendement.disponibilite}% < ${objectifs.trs}%`);
            couleur = "var(--warning)";
        }
    }
    
    // V√©rification Qualit√©
    if (objectifs.qualite) {
        if (rendement.qualite >= objectifs.qualite) {
            messages.push(`‚úÖ Qualit√©: ${rendement.qualite}% ‚â• ${objectifs.qualite}%`);
        } else {
            messages.push(`‚ö†Ô∏è Qualit√©: ${rendement.qualite}% < ${objectifs.qualite}%`);
            couleur = "var(--warning)";
        }
    }
    
    // V√©rification Arr√™ts
    if (objectifs.arrets) {
        if (filteredStops.length <= objectifs.arrets) {
            messages.push(`‚úÖ Arr√™ts: ${filteredStops.length} ‚â§ ${objectifs.arrets}`);
        } else {
            messages.push(`‚ö†Ô∏è Arr√™ts: ${filteredStops.length} > ${objectifs.arrets}`);
            couleur = "var(--danger)";
        }
    }
    
    // Affichage notification si besoin
    if (messages.length > 0 && filteredStops.length > 0) {
        afficherNotificationObjectifs(messages, couleur);
    }
}

function afficherNotificationObjectifs(messages, couleur) {
    // V√©rifier si une notification existe d√©j√†
    if (document.getElementById('notification-objectifs-auto')) {
        return;
    }
    
    const notification = document.createElement('div');
    notification.id = 'notification-objectifs-auto';
    notification.style.cssText = `
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(13, 27, 42, 0.95);
        color: white;
        padding: 10px 15px;
        border-radius: 8px;
        z-index: 9999;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        animation: slideInUp 0.3s ease-out;
        max-width: 400px;
        border-left: 4px solid ${couleur};
        font-size: 12px;
        backdrop-filter: blur(10px);
    `;
    
    notification.innerHTML = `
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
            <span style="font-size: 16px;">üéØ</span>
            <div style="font-weight: bold; color: ${couleur};">OBJECTIFS SHIFT</div>
            <button onclick="this.parentElement.parentElement.remove()" 
                    style="margin-left: auto; background: none; border: none; color: #ccc; cursor: pointer; font-size: 18px;">
                √ó
            </button>
        </div>
        <div style="font-size: 11px;">
            ${messages.join('<br>')}
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-suppression apr√®s 15 secondes
    setTimeout(() => {
        if (notification.parentElement) {
            notification.style.animation = 'slideOutDown 0.3s ease-out';
            setTimeout(() => notification.remove(), 300);
        }
    }, 15000);
}

// =============================================
// FONCTIONS DE GESTION DES SHIFTS 3x8
// =============================================

// =============================
// SHIFT HELPERS (22-06 / 06-14 / 14-22)
// - getShiftDate(dateObj): calcule la date du shift (d√©but du shift) pour UNE date/heure donn√©e (sans changer la s√©lection UI)
// - getActiveShiftContext(dateObj?): retourne {shiftDate, shiftType} selon le shift s√©lectionn√© (date + type)
// =============================

function inferShiftType(dateObj) {
    const d = (dateObj instanceof Date) ? dateObj : new Date(dateObj);
    const hour = d.getHours();
    const shiftTypes = Object.keys(shiftConfigs || {});
    for (const shiftType of shiftTypes) {
        const config = shiftConfigs[shiftType];
        if (!config) continue;
        if (config.start < config.end) {
            if (hour >= config.start && hour < config.end) return shiftType;
        } else {
            // Traverse minuit (ex: 22->06)
            if (hour >= config.start || hour < config.end) return shiftType;
        }
    }
    // fallback
    return (shiftConfigs && shiftConfigs[currentShiftType]) ? currentShiftType : 'Nuit';
}

function getShiftDateForShiftType(dateObj, shiftType) {
    const d0 = (dateObj instanceof Date) ? new Date(dateObj) : new Date(dateObj);
    const config = (shiftConfigs && shiftConfigs[shiftType]) ? shiftConfigs[shiftType] : (shiftConfigs ? shiftConfigs['Nuit'] : null);
    if (!config) return formatShiftDate(d0);

    const hour = d0.getHours();
    if (config.start < config.end) {
        // Shift dans la m√™me journ√©e
        return formatShiftDate(d0);
    } else {
        // Traverse minuit: si on est apr√®s minuit (< end), la date de shift = veille
        if (hour < config.end) d0.setDate(d0.getDate() - 1);
        return formatShiftDate(d0);
    }
}

// Pour un horodatage donn√©, retourne {shiftType, shiftDate(dd/mm/yyyy)}
function getShiftContext(dateObj) {
    const shiftType = inferShiftType(dateObj);
    const shiftDate = getShiftDateForShiftType(dateObj, shiftType);
    return { shiftType, shiftDate };
}

// IMPORTANT: ne d√©pend PAS de selectedShiftDate (sinon on "d√©place" les donn√©es)
function getShiftDate(dateObj) {
    return getShiftContext(dateObj).shiftDate;
}

function getStopShiftType(stop) {
    if (stop && stop.shiftType && shiftConfigs && shiftConfigs[stop.shiftType]) return stop.shiftType;
    let dt = null;
    try {
        if (stop && stop.startDateTime) dt = new Date(stop.startDateTime);
        else if (stop && stop.timestamp) dt = new Date(stop.timestamp);
    } catch(e) {}
    if (dt && !isNaN(dt.getTime())) return inferShiftType(dt);
    // fallback: si on ne peut pas d√©duire, on met le shift courant
    return (shiftConfigs && shiftConfigs[currentShiftType]) ? currentShiftType : 'Nuit';
}

// Contexte UI (shift s√©lectionn√©)
function getActiveShiftContext(dateObj) {
    const now = (dateObj instanceof Date) ? dateObj : new Date();
    const shiftType = (shiftConfigs && shiftConfigs[currentShiftType]) ? currentShiftType : inferShiftType(now);
    const shiftDate = selectedShiftDate ? selectedShiftDate : getShiftDateForShiftType(now, shiftType);
    return { shiftType, shiftDate };
}

function getActiveShiftDateISO() {
    const ctx = getActiveShiftContext(new Date());
    return shiftDateStrToISO(ctx.shiftDate) || new Date().toISOString().slice(0, 10);
}

// Convertit (date shift ISO + HH:MM) => Date r√©elle dans le shift s√©lectionn√©
// Ex: shift Nuit 22->06 : 02:00 appartient au jour suivant.
function buildDateTimeFromShiftDateISO(shiftDateISO, timeHHMM, shiftType) {
    const cfg = (shiftConfigs && shiftConfigs[shiftType]) ? shiftConfigs[shiftType] : (shiftConfigs ? shiftConfigs['Nuit'] : null);
    const d = parseISODateLocal(shiftDateISO);
    const parts = String(timeHHMM || '').split(':').map(n => parseInt(n, 10));
    const hh = parts[0] || 0;
    const mm = parts[1] || 0;
    d.setHours(hh, mm, 0, 0);

    if (cfg && cfg.start > cfg.end) {
        // traverse minuit
        // <= end : 06:00 appartient au lendemain pour Nuit 22->06
        if (hh <= cfg.end) d.setDate(d.getDate() + 1);
    }
    return d;
}

function formatHHMM(dateObj) {
    try {
        const h = String(dateObj.getHours()).padStart(2,'0');
        const m = String(dateObj.getMinutes()).padStart(2,'0');
        return `${h}:${m}`;
    } catch(e) { return ""; }
}


function formatDateDDMMYYYY(dateObj){
    try{
        const d = String(dateObj.getDate()).padStart(2,'0');
        const m = String(dateObj.getMonth()+1).padStart(2,'0');
        const y = String(dateObj.getFullYear());
        return `${d}/${m}/${y}`;
    }catch(e){ return ""; }
}

// Retourne la date r√©elle (calendrier) associ√©e √† une heure (d√©but/fin) d'un arr√™t
// Utile pour Nuit 22->06 : 02:00 = lendemain.
function getRealDateLabel(stop, field){
    if (!stop) return "";
    const shiftType = getStopShiftType(stop);
    const shiftDateISO = shiftDateStrToISO(stop.date) || (stop.startDateTime ? String(stop.startDateTime).slice(0,10) : null);
    let dt = null;

    try{
        if (field === 'start'){
            if (stop.startDateTime) dt = new Date(stop.startDateTime);
            else if (shiftDateISO && stop.start) dt = buildDateTimeFromShiftDateISO(shiftDateISO, stop.start, shiftType);
        } else if (field === 'end'){
            if (stop.endDateTime) dt = new Date(stop.endDateTime);
            else if (shiftDateISO && stop.end) dt = buildDateTimeFromShiftDateISO(shiftDateISO, stop.end, shiftType);
        }
    }catch(e){ dt = null; }

    if (dt && !isNaN(dt.getTime())){
        return formatDateDDMMYYYY(dt);
    }
    return "";
}


function filterStopsByShift(data, shiftDateStr, shiftType, teamOrNull = null) {
    const arr = Array.isArray(data) ? data : [];
    return arr.filter(s => {
        if (teamOrNull && s.equipe !== teamOrNull) return false;

        // Recalage si date manquante
        if (!s.date) {
            try {
                const dt = s.startDateTime ? new Date(s.startDateTime) : (s.timestamp ? new Date(s.timestamp) : null);
                if (dt && !isNaN(dt.getTime())) s.date = getShiftDate(dt);
            } catch(e) {}
        }

        return (s.date === shiftDateStr) && (getStopShiftType(s) === shiftType);
    });
}

// Normaliser l'historique (important pour Nuit qui traverse minuit : 02:00 doit rester dans le shift de la veille)
function normalizeHistoryShiftMeta() {
    try {
        if (!Array.isArray(history)) return;
        history.forEach(s => {
            if (!s) return;
            let dt = null;
            try {
                if (s.startDateTime) dt = new Date(s.startDateTime);
                else if (s.timestamp) dt = new Date(s.timestamp);
            } catch(e) {}
            if (dt && !isNaN(dt.getTime())) {
                const ctx = getShiftContext(dt);
                s.shiftType = ctx.shiftType;
                s.date = ctx.shiftDate;
                if (!s.startDateTime) s.startDateTime = dt.toISOString();
            }
        });
    } catch(e) {}
}
try { normalizeHistoryShiftMeta(); } catch(e) {}


function formatShiftDate(date) {
    const day = date.getDate().toString().padStart(2, '0');
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const year = date.getFullYear();
    return `${day}/${month}/${year}`;
}

// Fonction pour convertir une date shift en objet Date
function shiftDateToDate(shiftDateStr) {
    const [day, month, year] = shiftDateStr.split('/').map(Number);
    const date = new Date(year, month - 1, day);
    
    // Ajouter l'heure de d√©but du shift pour une comparaison correcte
    const config = shiftConfigs[currentShiftType];
    date.setHours(config.start, 0, 0, 0);
    
    return date;
}

function selectShift(shiftType) {
    if (!shiftConfigs[shiftType]) return;
    
    currentShiftType = shiftType;
    const config = shiftConfigs[shiftType];
    
    // Mettre √† jour l'affichage des boutons
    document.querySelectorAll('#shiftSelector button').forEach(btn => {
        btn.style.background = 'var(--dark)';
        btn.style.color = 'white';
        btn.style.fontWeight = 'normal';
    });
    
    // G√©rer les caract√®res sp√©ciaux dans l'ID
    let buttonId = '';
    if (shiftType === 'Apr√®s-midi') {
        buttonId = 'shiftApresMidiBtn';
    } else {
        buttonId = `shift${shiftType}Btn`;
    }
    
    const activeBtn = document.getElementById(buttonId);
    if (activeBtn) {
        activeBtn.style.background = 'var(--primary)';
        activeBtn.style.color = 'white';
        activeBtn.style.fontWeight = 'bold';
    }
    
    // Mettre √† jour l'indicateur
    const now = new Date();
    const shiftDate = getActiveShiftContext(now).shiftDate;
    document.getElementById("currentShiftDate").textContent = shiftDate;
    document.getElementById("currentShiftHours").textContent = config.name.split('(')[1].replace(')', '');
    
    // Rafra√Æchir les donn√©es
    refreshTable();
    try { updateCausesTraceabilityTables(history); } catch(e) {}
    updateAllCharts();
    
    // Sauvegarder la pr√©f√©rence
    LS.setItem('selectedShift', shiftType);
    if (db) saveToIndexedDB();
    
    showNotification(`Shift ${shiftType} s√©lectionn√©`, 'success');
}

// S√©lectionner un shift sp√©cifique avec date
function selectSpecificShift() {
    const datePicker = document.getElementById("shiftDatePicker");
    if (!datePicker.value) {
        alert("Veuillez s√©lectionner une date");
        return;
    }
    
    const date = new Date(datePicker.value);
    const shiftDate = formatShiftDate(date);
    selectedShiftDate = shiftDate;
    
    // Mettre √† jour l'affichage
    document.getElementById("currentShiftDate").textContent = selectedShiftDate + ` (${currentShiftType})`;
    
    // Rafra√Æchir les donn√©es
    refreshTable();
    try { updateCausesTraceabilityTables(history); } catch(e) {}
    updateAllCharts();
    
    showNotification(`Shift ${currentShiftType} du ${selectedShiftDate} s√©lectionn√©`, 'info');
}

// Revenir au shift actuel
function resetToCurrentShift() {
    selectedShiftDate = null;
    const now = new Date();
    currentShiftType = inferShiftType(now);
    const ctx = getActiveShiftContext(now);
    const shiftDate = ctx.shiftDate;
    const config = shiftConfigs[currentShiftType];
    
    document.getElementById("currentShiftDate").textContent = shiftDate;
    document.getElementById("currentShiftHours").textContent = config.name.split('(')[1].replace(')', '');
    document.getElementById("shiftDatePicker").value = "";
    
    // Rafra√Æchir les donn√©es
    refreshTable();
    try { updateCausesTraceabilityTables(history); } catch(e) {}
    updateAllCharts();
    
    showNotification(`Retour au shift ${currentShiftType} actuel`, 'success');
}

// Fonction utilitaire pour filtrer les donn√©es par p√©riode shift
function filterByShiftPeriod(data, period, dateField = 'date') {
    if (period === 'all') return data;
    
    const now = new Date();
    
    if (period === 'today') {
        const ctx = getActiveShiftContext(now);
        const currentShiftDate = ctx.shiftDate;
        return data.filter(item => {
            if (item[dateField] !== currentShiftDate) return false;
            // si ce sont des arr√™ts (dateField='date'), filtrer aussi par type de shift
            if (dateField === 'date') {
                return getStopShiftType(item) === ctx.shiftType;
            }
            return true;
        });
    }
    
    if (period === 'week' || period === 'last4' || period === 'month') {
        // Derniers N shifts (par d√©faut 4) pour le type de shift courant
        const N = 4;
        const ctx = getActiveShiftContext(now);

        // 1) Filtrer d'abord par type de shift si on manipule des arr√™ts (dateField='date')
        const base = (dateField === 'date')
            ? data.filter(item => getStopShiftType(item) === ctx.shiftType)
            : data.slice();

        // 2) Extraire les dates uniques (shiftDate) tri√©es du plus r√©cent au plus ancien
        const uniqueDates = Array.from(new Set(base.map(item => item[dateField]).filter(Boolean)));
        uniqueDates.sort((a, b) => shiftDateToDate(b) - shiftDateToDate(a));

        const lastDates = new Set(uniqueDates.slice(0, N));

        // 3) Retourner les √©l√©ments dont la date est dans les N derni√®res dates
        return base.filter(item => lastDates.has(item[dateField]));
    }

    if (period === 'month') {
        const oneMonthAgo = new Date(now);
        oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
        const cutoffDate = shiftDateToDate(getShiftDate(oneMonthAgo));
        
        return data.filter(item => {
            if (dateField === 'date' && getStopShiftType(item) !== ctx.shiftType) return false;
            const itemDate = shiftDateToDate(item[dateField]);
            return itemDate >= cutoffDate;
        });
    }
    
    return data;
}

// =============================================
// FONCTIONS DE BASE
// =============================================

function updateDateTime() {
    const now = new Date();
    const shiftDate = getShiftDate(now);
    const config = shiftConfigs[currentShiftType];
    
    // Mettre √† jour l'indicateur de shift
    document.getElementById("currentShiftDate").textContent = shiftDate;
    document.getElementById("currentShiftHours").textContent = config.name.split('(')[1].replace(')', '');
    
    document.getElementById('currentDate').textContent = now.toLocaleDateString('fr-FR', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
    document.getElementById('currentTime').textContent = now.toLocaleTimeString('fr-FR');
}
setInterval(updateDateTime, 1000);
updateDateTime();

// Mise √† jour des compteurs production "derni√®re heure"

function updateTimer() {
    if (!start) return;
    const now = new Date();
    const diff = Math.floor((now - start) / 1000);
    const hours = Math.floor(diff / 3600);
    const minutes = Math.floor((diff % 3600) / 60);
    const seconds = diff % 60;
    document.getElementById('timerDisplay').textContent = 
        `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

function setStopTypeFilter(type) {
    currentStopTypeFilter = type || 'all';
    const group = document.getElementById('stopTypeFilterGroup');
    if (group) {
        group.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        // marquer le bouton actif
        const btn = group.querySelector(`[onclick*="setStopTypeFilter('${type}')"]`);
        if (btn) btn.classList.add('active');
    }
    refreshTable();
}


function setInternalTableSearch(val){
    internalTableSearchQuery = (val || '').trim().toLowerCase();
    const info = document.getElementById('internalSearchInfo');
    if (info){
        info.textContent = internalTableSearchQuery ? '‚Ä¶' : '';
    }
    if (internalTableSearchTimer) clearTimeout(internalTableSearchTimer);
    internalTableSearchTimer = setTimeout(() => {
        try { refreshTable(); } catch(e){ console.error(e); }
    }, 180);
}

function clearInternalTableSearch(){
    const input = document.getElementById('internalTableSearch');
    if (input) input.value = '';
    setInternalTableSearch('');
}

function refreshTable() {
    const tbody = document.getElementById("tableBody");
    const now = new Date();
    const ctxActive = getActiveShiftContext(now);
    const shiftDate = ctxActive.shiftDate;
    const shiftType = ctxActive.shiftType;

    // Donn√©es du shift actuel (pour les stats) - toutes causes, y compris rat√©s
    const shiftStops = filterStopsByShift(history, shiftDate, shiftType, equipe);

// Inclure un arr√™t sp√©cial "en cours" (si actif) pour affichage & stats du shift
let activeSpecialForShift = null;
let activeSpecialDuration = 0;
let activeSpecialCount = 0;
try {
    if (activeSpecialStop && activeSpecialStop.inProgress && activeSpecialStop.equipe === equipe) {
        // On l'affiche m√™me si la date de shift diff√®re, mais on ne l'ajoute aux stats que si m√™me shift
        activeSpecialForShift = activeSpecialStop;
        if (activeSpecialStop.date === shiftDate) {
            activeSpecialDuration = Math.max(0, Math.floor((Date.now() - activeSpecialStop.timestamp) / 1000));
            activeSpecialCount = 1;
        }
    }
} catch(e) {}

    // Donn√©es affich√©es dans le tableau (avec index original -> √©dition fiable)
    let displayed = shiftStops
        .map(h => ({ h, idx: history.indexOf(h) }))
        .map(x => ({ h: x.h, idx: x.idx })); // clone l√©ger

    // Si doublons/objets identiques, indexOf peut retourner le premier. S√©curiser via mapping index direct.
    // => On reconstruit displayed correctement:
    displayed = history
        .map((h, idx) => ({ h, idx }))
        .filter(x => x.h.equipe === equipe && x.h.date === shiftDate && getStopShiftType(x.h) === shiftType);

    if (currentStopTypeFilter === 'rat√©') {
        displayed = displayed.filter(x => x.h.type === "rat√©");
    } else if (currentStopTypeFilter === 'normal') {
        displayed = displayed.filter(x => x.h.type !== "rat√©");
    }

    
    // Filtre texte (recherche interne)
    if (internalTableSearchQuery) {
        const q = internalTableSearchQuery;
        displayed = displayed.filter(({h}) => {
            const text = `${h.date||''} ${h.cause||''} ${h.start||''} ${h.end||''} ${h.equipe||''} ${h.teamLeader||''} ${h.type||''}`.toLowerCase();
            return text.includes(q);
        });
    }
tbody.innerHTML = '';
    displayed.forEach(({h, idx}) => {
        const tr = document.createElement('tr');

        // Ic√¥ne pour les arr√™ts rat√©s
        const typeIcon = h.type === "rat√©" ? '‚è±Ô∏è ' : (h.type === "sp√©cial" ? '‚≠ê ' : '');

        const teamClass = `team-${h.equipe}`;

        

        const startReal = getRealDateLabel(h, 'start');
        const endReal = getRealDateLabel(h, 'end');
        const startMetaHtml = startReal ? `<div class="real-date" title="${startReal}">${startReal}</div>` : '';
        const endMetaHtml = endReal ? `<div class="real-date" title="${endReal}">${endReal}</div>` : '';
tr.innerHTML = `
            <td class="editable-cell" onclick="makeCellEditable(this, ${idx}, 0)">
                ${typeIcon}${h.date}
                <div class="edit-tooltip">Cliquer pour modifier la date</div>
            </td>
            <td class="editable-cell" onclick="makeCellEditable(this, ${idx}, 1)">
                <div style="border: 1px solid rgba(255,255,255,0.1); padding: 4px 8px; border-radius: 4px; background: rgba(0,0,0,0.1); display: inline-block;">${h.cause || ''}</div>
                <div class="edit-tooltip">Cliquer pour modifier la cause</div>
            </td>
            <td class="editable-cell" onclick="makeCellEditable(this, ${idx}, 2)">
                ${h.start || ''}${startMetaHtml}
                <div class="edit-tooltip">Cliquer pour modifier l'heure de d√©but</div>
            </td>
            <td class="editable-cell" onclick="makeCellEditable(this, ${idx}, 3)">
                ${h.end || ''}${endMetaHtml}
                <div class="edit-tooltip">Cliquer pour modifier l'heure de fin</div>
            </td>
            <td style="color:${(h.duration || 0) > 300 ? 'var(--danger)' : 'var(--warning)'};">
                ${formatDuration(h.duration || 0)} ${isMissedStop(h) ? '(rat√©)' : (normalizeTextNoAccent(h.type) === "special" || h.type === "sp√©cial" ? '(sp√©cial)' : '')}
            </td>
            <td>
                <div class="team-cell ${teamClass}">√âquipe ${h.equipe}</div>
            </td>
            <td class="editable-cell" onclick="makeCellEditable(this, ${idx}, 5)">
                <div style="color: #FFD700; font-weight: bold;">${h.teamLeader || ''}</div>
                <div class="edit-tooltip">Cliquer pour modifier le Team Leader</div>
            </td>
            <td class="delete-cell" style="text-align:center;">
                <button class="delete-btn" onclick="deleteStop(${idx}); event.stopPropagation();">üóëÔ∏è</button>
            </td>
        
        `;
        tbody.appendChild(tr);
    });



    // Afficher un arr√™t sp√©cial en cours (si actif) dans le tableau
    if (activeSpecialForShift) {
        const tr = document.createElement('tr');
        tr.style.background = 'rgba(255,193,7,0.10)';
        tr.style.border = '1px solid rgba(255,193,7,0.25)';

        const nowTs = Date.now();
        const dur = Math.max(0, Math.floor((nowTs - activeSpecialForShift.timestamp) / 1000));
        const teamClass = `team-${activeSpecialForShift.equipe}`;
        let activeStartReal = '';
        try{
            const dt0 = activeSpecialForShift.startDateTime ? new Date(activeSpecialForShift.startDateTime) : new Date(activeSpecialForShift.timestamp);
            if (dt0 && !isNaN(dt0.getTime())) activeStartReal = formatDateDDMMYYYY(dt0);
        }catch(e){}

        tr.innerHTML = `
            <td>‚≠ê ${activeSpecialForShift.date}</td>
            <td><div style="border: 1px solid rgba(255,255,255,0.15); padding: 4px 8px; border-radius: 4px; background: rgba(0,0,0,0.1); display:inline-block;">${activeSpecialForShift.cause}</div></td>
            <td>${activeSpecialForShift.start}<div class="real-date" title="${activeStartReal}">${activeStartReal}</div></td>
            <td style="font-weight:800;">EN COURS</td>
            <td style="color:var(--warning); font-weight:800;">${formatDuration(dur)} (sp√©cial)</td>
            <td><div class="team-cell ${teamClass}">√âquipe ${activeSpecialForShift.equipe}</div></td>
            <td style="opacity:0.8;">‚è≥</td>
            <td class="delete-cell" style="text-align:center; opacity:0.6;">‚Äî</td>
        
        `;
        tbody.insertBefore(tr, tbody.firstChild);
    }

    // Afficher le nombre de r√©sultats (si recherche active)
    const info = document.getElementById('internalSearchInfo');
    if (info) {
        info.textContent = internalTableSearchQuery ? `${displayed.length} r√©sultat(s)` : '';
    }

    // Stats calcul√©es sur tout le shift (pas juste l'affichage)
    const totalDuration = shiftStops.reduce((a, b) => a + (b.duration || 0), 0) + (activeSpecialDuration || 0);
    const pauseData = calculateTotalPauseMinutes();
    const totalPauseMinutes = pauseData.total;
    const pauseSeconds = totalPauseMinutes * 60;
    const netDurationSeconds = Math.max(0, totalDuration - pauseSeconds);
    const netDurationMinutes = Math.round(netDurationSeconds / 60);

    document.getElementById("count").innerText = shiftStops.length + (activeSpecialCount || 0);
    document.getElementById("totalTime").innerText = formatDuration(totalDuration);
    document.getElementById("netTotalMinutes").innerText = `${netDurationMinutes} min`;
    document.getElementById("netTotalSeconds").innerText = formatDuration(netDurationSeconds);

    // Arr√™ts rat√©s (sur tout le shift)
    const missedStopsCount = shiftStops.filter(h => isMissedStop(h)).length;
    document.getElementById("missedStopsCount").innerText = missedStopsCount;

    refreshAbsenceStats();
    mettreAJourRendementAuto();
    try { updateCausesTraceabilityTables(filterStopsByShift(history, shiftDate, shiftType, equipe)); } catch(e) {}
    updateAllCharts();

    // Mettre √† jour les calculs de production
    updateProductionCalculations();
}

function formatDuration(seconds) {
    if (seconds < 60) return `${seconds}s`;
    const minutes = Math.floor(seconds / 60);
    const secs = seconds % 60;
    if (minutes < 60) return `${minutes}m ${secs}s`;
    const hours = Math.floor(minutes / 60);
    const mins = minutes % 60;
    return `${hours}h ${mins}m`;
}

function setCause(cause) {
    const causeInput = document.getElementById("cause");
    if (causeInput) {
        causeInput.value = cause;
        causeInput.focus();
    }
}

function updateAbsenceBreakdown() {
    const container = document.getElementById("absenceBreakdownBody");
    if (!container) return;

    const now = new Date();
    const shiftDate = getShiftDate(now);
    const teamAbsences = absenceHistory.filter(a => a.equipe === equipe && a.date === shiftDate);
    
    container.innerHTML = '';
    
    const breakdown = {};
    
    teamAbsences.forEach(absence => {
        const key = `${absence.type}|${absence.poste || 'Non sp√©cifi√©'}`;
        if (!breakdown[key]) {
            breakdown[key] = {
                type: absence.type,
                poste: absence.poste || 'Non sp√©cifi√©',
                days: 0
            };
        }
        breakdown[key].days += absence.durationDays || 0;
    });
    
    Object.values(breakdown).forEach(item => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${item.type}</td>
            <td>${item.poste}</td>
            <td>${item.days} jours</td>
        `;
        container.appendChild(tr);
    });
}

function refreshAbsenceStats() {
    const now = new Date();
    const shiftDate = getShiftDate(now);
    const teamAbsences = absenceHistory.filter(a => a.equipe === equipe);
    const filteredShift = teamAbsences.filter(a => a.date === shiftDate);
    
    const totalAbsences = teamAbsences.length;
    const uniqueDates = new Set(teamAbsences.map(a => a.date));
    const totalDaysAbsent = uniqueDates.size;
    const totalDaysShift = filteredShift.reduce((a, b) => a + (b.durationDays || 0), 0);
    
    document.getElementById("todayAbsenceCount").innerText = filteredShift.length;
    document.getElementById("absenceTotalDays").innerText = `${totalDaysShift}j`;
    document.getElementById("totalAbsenceCount").innerText = totalAbsences;
    document.getElementById("absenceDaysCount").innerText = totalDaysAbsent;
    
    updateAbsenceBreakdown();
}

function getPauseTime(id, defaultValue) {
    return LS.getItem(id) || defaultValue;
}

function updatePauseTimes() {
    const p1s = document.getElementById("p1Start").value;
    const p1e = document.getElementById("p1End").value;
    const p2s = document.getElementById("p2Start").value;
    const p2e = document.getElementById("p2End").value;
    const p3s = document.getElementById("p3Start").value;
    const p3e = document.getElementById("p3End").value;
    
    LS.setItem("PAUSE_1_START", p1s);
    LS.setItem("PAUSE_1_END", p1e);
    LS.setItem("PAUSE_2_START", p2s);
    LS.setItem("PAUSE_2_END", p2e);
    LS.setItem("PAUSE_3_START", p3s);
    LS.setItem("PAUSE_3_END", p3e);
    
    refreshTable();
    schedulePauseAlarms();
    if (db) saveToIndexedDB();
}

function calculateDuration(startStr, endStr) {
    if (!startStr || !endStr) return 0;
    const [startH, startM] = startStr.split(':').map(Number);
    const [endH, endM] = endStr.split(':').map(Number);
    const startTimeInMinutes = startH * 60 + startM;
    const endTimeInMinutes = endH * 60 + endM;
    let duration = endTimeInMinutes - startTimeInMinutes;
    if (duration < 0) return 0;
    return duration;
}

function calculateTotalPauseMinutes() {
    const p1s = getPauseTime("PAUSE_1_START", defaultPauses.p1Start);
    const p1e = getPauseTime("PAUSE_1_END", defaultPauses.p1End);
    const p2s = getPauseTime("PAUSE_2_START", defaultPauses.p2Start);
    const p2e = getPauseTime("PAUSE_2_END", defaultPauses.p2End);
    const p3s = getPauseTime("PAUSE_3_START", defaultPauses.p3Start);
    const p3e = getPauseTime("PAUSE_3_END", defaultPauses.p3End);
    
    const duration1 = calculateDuration(p1s, p1e);
    const duration2 = calculateDuration(p2s, p2e);
    const duration3 = calculateDuration(p3s, p3e);
    
    return {
        total: duration1 + duration2 + duration3,
        details: [
            { start: p1s, end: p1e, duration: duration1, name: "Pause 1" },
            { start: p2s, end: p2e, duration: duration2, name: "Pause 2" },
            { start: p3s, end: p3e, duration: duration3, name: "Pause 3" }
        ]
    };
}

// =============================================
// GESTION DES ALARMES DE PAUSE
// =============================================

function schedulePauseAlarms() {
    cancelPauseAlarms();
    
    const alarmsEnabled = document.getElementById("enableAlarms").checked;
    if (!alarmsEnabled) return;
    
    const alarmMinutes = parseInt(document.getElementById("alarmMinutes").value) || 2;
    const now = new Date();
    const currentTime = now.getHours() * 60 + now.getMinutes();
    const pauseData = calculateTotalPauseMinutes();
    
    pauseData.details.forEach((pause, index) => {
        if (!pause.start || !pause.end) return;
        
        const [startHour, startMinute] = pause.start.split(':').map(Number);
        const [endHour, endMinute] = pause.end.split(':').map(Number);
        
        const startTimeInMinutes = startHour * 60 + startMinute;
        const endTimeInMinutes = endHour * 60 + endMinute;
        
        // Alarme avant le d√©but de la pause
        const timeToStart = startTimeInMinutes - currentTime;
        if (timeToStart > 0 && timeToStart <= alarmMinutes) {
            const timeout = setTimeout(() => {
                triggerPauseAlarm('D√©but', pause.start, pause.name);
            }, (timeToStart * 60 * 1000) - (alarmMinutes * 60 * 1000));
            
            pauseAlarmTimeouts.push(timeout);
        }
        
        // Alarme avant la fin de la pause
        const timeToEnd = endTimeInMinutes - currentTime;
        if (timeToEnd > 0 && timeToEnd <= alarmMinutes) {
            const timeout = setTimeout(() => {
                triggerPauseAlarm('Fin', pause.end, pause.name);
            }, (timeToEnd * 60 * 1000) - (alarmMinutes * 60 * 1000));
            
            pauseAlarmTimeouts.push(timeout);
        }
    });
}

function triggerPauseAlarm(type, time, pauseName) {
    const existingAlarm = activeAlarms.find(a => a.pauseName === pauseName && a.type === type);
    if (existingAlarm) return;
    
    const alarmId = Date.now();
    const alarm = {
        id: alarmId,
        type: type,
        time: time,
        pauseName: pauseName,
        timestamp: Date.now()
    };
    
    activeAlarms.push(alarm);
    
    const alarmSound = document.getElementById("pauseReminderSound");
    if (alarmSound) {
        alarmSound.currentTime = 0;
        alarmSound.play().catch(e => console.log("Erreur alarme pause:", e));
    }
    
    showAlarmIndicator(type, time, pauseName);
    
    if (navigator.vibrate) {
        navigator.vibrate([200, 100, 200, 100, 200, 100, 200]);
    }
    
    const autoStopTimeout = setTimeout(() => {
        stopAlarm(alarmId);
    }, 120000);
    
    alarm.autoStopTimeout = autoStopTimeout;
}

function showAlarmIndicator(type, time, pauseName) {
    const indicator = document.getElementById("pauseAlarmIndicator");
    const alarmTitle = document.getElementById("alarmTitle");
    const alarmMessage = document.getElementById("alarmMessage");
    
    if (type === 'D√©but') {
        alarmTitle.textContent = "‚è∞ ALARME D√âBUT DE PAUSE";
        alarmMessage.innerHTML = `<strong>${pauseName}</strong> commence dans ${document.getElementById("alarmMinutes").value} minutes<br>√† ${time}`;
    } else {
        alarmTitle.textContent = "‚è∞ ALARME FIN DE PAUSE";
        alarmMessage.innerHTML = `<strong>${pauseName}</strong> se termine dans ${document.getElementById("alarmMinutes").value} minutes<br>√† ${time}`;
    }
    
    indicator.style.display = 'block';
}

function stopAlarm(alarmId) {
    const alarmSound = document.getElementById("pauseReminderSound");
    if (alarmSound) {
        alarmSound.pause();
        alarmSound.currentTime = 0;
    }
    
    const indicator = document.getElementById("pauseAlarmIndicator");
    indicator.style.display = 'none';
    
    const alarmIndex = activeAlarms.findIndex(a => a.id === alarmId);
    if (alarmIndex !== -1) {
        if (activeAlarms[alarmIndex].autoStopTimeout) {
            clearTimeout(activeAlarms[alarmIndex].autoStopTimeout);
        }
        activeAlarms.splice(alarmIndex, 1);
    }
    
    if (navigator.vibrate) {
        navigator.vibrate(0);
    }
}

function snoozeAlarm() {
    const alarmSound = document.getElementById("pauseReminderSound");
    if (alarmSound) {
        alarmSound.pause();
        alarmSound.currentTime = 0;
    }
    
    const indicator = document.getElementById("pauseAlarmIndicator");
    indicator.style.display = 'none';
    
    if (navigator.vibrate) {
        navigator.vibrate(0);
    }
    
    setTimeout(() => {
        if (alarmSound) {
            alarmSound.currentTime = 0;
            alarmSound.play().catch(e => console.log("Erreur alarme pause:", e));
        }
        
        indicator.style.display = 'block';
        
        if (navigator.vibrate) {
            navigator.vibrate([200, 100, 200, 100, 200, 100, 200]);
        }
    }, 300000);
}

function cancelPauseAlarms() {
    pauseAlarmTimeouts.forEach(timeout => clearTimeout(timeout));
    pauseAlarmTimeouts = [];
    
    activeAlarms.forEach(alarm => {
        if (alarm.autoStopTimeout) {
            clearTimeout(alarm.autoStopTimeout);
        }
    });
    activeAlarms = [];
    
    const alarmSound = document.getElementById("pauseReminderSound");
    if (alarmSound) {
        alarmSound.pause();
        alarmSound.currentTime = 0;
    }
    
    const indicator = document.getElementById("pauseAlarmIndicator");
    indicator.style.display = 'none';
    
    if (navigator.vibrate) {
        navigator.vibrate(0);
    }
}

function toggleAlarms() {
    const alarmsEnabled = document.getElementById("enableAlarms").checked;
    if (alarmsEnabled) {
        schedulePauseAlarms();
        showNotification("üîî Alarmes de pause activ√©es", "success");
    } else {
        cancelPauseAlarms();
        showNotification("üîï Alarmes de pause d√©sactiv√©es", "warning");
    }
}

function testAlarm() {
    const alarmMinutes = parseInt(document.getElementById("alarmMinutes").value) || 2;
    const now = new Date();
    const testTime = new Date(now.getTime() + 1000);
    
    const hours = testTime.getHours().toString().padStart(2, '0');
    const minutes = testTime.getMinutes().toString().padStart(2, '0');
    const timeStr = `${hours}:${minutes}`;
    
    triggerPauseAlarm('D√©but', timeStr, "Pause test");
    showNotification("üîî Test d'alarme d√©clench√©", "info");
}

// =============================================
// GESTION DES ARR√äTS RAT√âS
// =============================================

document.getElementById("missedStopBtn").onclick = openMissedStopModal;

// Mode suppression (delete)
const _toggleDeleteBtn = document.getElementById("toggleDeleteModeBtn");
if (_toggleDeleteBtn) _toggleDeleteBtn.onclick = toggleDeleteMode;
applyDeleteModeUI();


// =============================================
// GESTION DES ARR√äTS SP√âCIAUX
// =============================================

const _specialStopBtn = document.getElementById("specialStopBtn");
if (_specialStopBtn) _specialStopBtn.onclick = openSpecialStopModal;
// --- ARR√äT SP√âCIAL "EN COURS" (d√©but + reprise manuels) ---
let activeSpecialStop = JSON.parse(LS.getItem("SPECIAL_ACTIVE") || "null");
let activeSpecialInterval = null;

function onLiveSpecialCauseChange() {
    const sel = document.getElementById("liveSpecialCause");
    const custom = document.getElementById("liveSpecialCustomCause");
    if (sel && custom) {
        custom.style.display = (sel.value === "Autre") ? "block" : "none";
        if (sel.value !== "Autre") custom.value = "";
    }
}

function openSpecialLiveModal() {
    if (activeSpecialStop) {
        alert("‚ö†Ô∏è Un arr√™t sp√©cial est d√©j√† en cours. Cliquez sur REPRISE pour le terminer.");
        return;
    }
    // Pr√©-remplir avec l'√©quipe courante + derni√®re cause
    const lastCause = LS.getItem("LAST_SPECIAL_CAUSE") || "";
    const lastTeam = LS.getItem("LAST_SPECIAL_TEAM") || equipe || "A";
    const teamEl = document.getElementById("liveSpecialEquipe");
    if (teamEl) teamEl.value = lastTeam;

    const causeSel = document.getElementById("liveSpecialCause");
    const custom = document.getElementById("liveSpecialCustomCause");
    if (causeSel) {
        // Si la cause n'existe pas dans la liste => mettre "Autre" et remplir le champ libre
        const exists = Array.from(causeSel.options).some(o => o.value === lastCause);
        if (lastCause && exists) {
            causeSel.value = lastCause;
            if (custom) { custom.style.display = "none"; custom.value = ""; }
        } else if (lastCause) {
            causeSel.value = "Autre";
            if (custom) { custom.style.display = "block"; custom.value = lastCause; }
        } else {
            causeSel.value = "";
            if (custom) { custom.style.display = "none"; custom.value = ""; }
        }
    }
    document.getElementById("specialLiveModal").style.display = "block";
}

function closeSpecialLiveModal() {
    const modal = document.getElementById("specialLiveModal");
    if (modal) modal.style.display = "none";
}

function startSpecialStopLive() {
    if (activeSpecialStop) {
        alert("‚ö†Ô∏è Un arr√™t sp√©cial est d√©j√† en cours.");
        return;
    }
    const now = new Date();
    const shiftDate = (typeof getShiftDate === "function") ? getShiftDate(now) : now.toISOString().slice(0,10);
    const startTime = now.toTimeString().substring(0, 5);

    const causeSel = document.getElementById("liveSpecialCause");
    const customVal = (document.getElementById("liveSpecialCustomCause")?.value || "").trim();
    const selected = causeSel ? (causeSel.value || "") : "";
    const cause = (selected === "Autre") ? customVal : (customVal || selected);

    const team = document.getElementById("liveSpecialEquipe")?.value || equipe || "A";

    if (!cause) {
        alert("‚ö†Ô∏è Merci de choisir/√©crire une cause.");
        return;
    }

    activeSpecialStop = {
        date: shiftDate,
        cause: cause,
        start: startTime,
        end: "",
        duration: 0,
        equipe: team,
        timestamp: now.getTime(),
        type: "sp√©cial",
        inProgress: true,
        startDateTime: now.toISOString()
    };

    LS.setItem("SPECIAL_ACTIVE", JSON.stringify(activeSpecialStop));
    LS.setItem("LAST_SPECIAL_CAUSE", cause);
    LS.setItem("LAST_SPECIAL_TEAM", team);

    closeSpecialLiveModal();
    updateSpecialActiveUI(true);
    refreshTable();
    try { updateActiveChart(); } catch(e) {}
    updateProductionCalculations();
}

function resumeSpecialStopLive() {
    if (!activeSpecialStop) {
        alert("‚ÑπÔ∏è Aucun arr√™t sp√©cial en cours.");
        return;
    }
    const now = new Date();
    const endTime = now.toTimeString().substring(0, 5);
    const durationSeconds = Math.max(0, Math.floor((now.getTime() - activeSpecialStop.timestamp) / 1000));

    const record = {
        date: activeSpecialStop.date,
        cause: activeSpecialStop.cause,
        start: activeSpecialStop.start,
        end: endTime,
        duration: durationSeconds,
        equipe: activeSpecialStop.equipe,
        timestamp: activeSpecialStop.timestamp,
        type: "sp√©cial",
        startDateTime: activeSpecialStop.startDateTime,
        endDateTime: now.toISOString()
    };

    history.push(record);
    LS.setItem("HISTO", JSON.stringify(history));
    if (db) saveToIndexedDB();

    activeSpecialStop = null;
    LS.removeItem("SPECIAL_ACTIVE");
    updateSpecialActiveUI(false);
    refreshTable();
    try { updateActiveChart(); } catch(e) {}
    updateProductionCalculations();

    alert(`‚úÖ Arr√™t sp√©cial termin√© !
P√©riode: ${record.start} - ${record.end} (${Math.round(durationSeconds/60)} min)
Cause: ${record.cause}
√âquipe: ${record.equipe}`);
}

function formatMMSS(sec) {
    const s = Math.max(0, Math.floor(sec));
    const h = Math.floor(s / 3600);
    const m = Math.floor((s % 3600) / 60);
    const r = s % 60;
    if (h > 0) return `${h}h ${m}m`;
    if (m > 0) return `${m}m ${r}s`;
    return `${r}s`;
}

function updateSpecialActiveUI(started) {
    const banner = document.getElementById("specialActiveBanner");
    const textEl = document.getElementById("specialActiveText");
    const startBtn = document.getElementById("specialStartNowBtn");
    const resumeBtn = document.getElementById("specialResumeBtn");
    const resumeBig = document.getElementById("specialResumeBigBtn");
    const changeBtn = document.getElementById("specialChangeBtn");

    const stopBtn = document.getElementById("stopBtn");
    const goBtn = document.getElementById("goBtn");

    const has = !!activeSpecialStop;

    if (startBtn) startBtn.disabled = has;
    if (resumeBtn) {
        resumeBtn.disabled = !has;
        resumeBtn.style.opacity = has ? "1" : "0.6";
    }
    if (banner) banner.style.display = has ? "block" : "none";

    // Option: √©viter conflit avec arr√™t normal
    if (stopBtn) stopBtn.disabled = has;
    if (goBtn) goBtn.disabled = has;

    if (activeSpecialInterval) {
        clearInterval(activeSpecialInterval);
        activeSpecialInterval = null;
    }

    if (has) {
        const tick = () => {
            const now = Date.now();
            const elapsed = Math.max(0, Math.floor((now - activeSpecialStop.timestamp) / 1000));
            if (textEl) {
                textEl.innerHTML = `
                  <div><strong>Cause :</strong> ${activeSpecialStop.cause}</div>
                  <div><strong>√âquipe :</strong> ${activeSpecialStop.equipe}</div>
                  <div><strong>D√©but :</strong> ${activeSpecialStop.start} (Shift: ${activeSpecialStop.date})</div>
                  <div><strong>Dur√©e en cours :</strong> ${formatMMSS(elapsed)}</div>
                `;
            }
        };
        tick();
        activeSpecialInterval = setInterval(tick, 1000);

        if (resumeBig) resumeBig.onclick = resumeSpecialStopLive;
        if (resumeBtn) resumeBtn.onclick = resumeSpecialStopLive;

        if (changeBtn) {
            changeBtn.onclick = () => {
                // Permet de changer la cause pendant que c'est en cours
                const newCause = prompt("Modifier la cause de l'arr√™t sp√©cial en cours :", activeSpecialStop.cause || "");
                if (newCause && newCause.trim()) {
                    activeSpecialStop.cause = newCause.trim();
                    LS.setItem("SPECIAL_ACTIVE", JSON.stringify(activeSpecialStop));
                    LS.setItem("LAST_SPECIAL_CAUSE", activeSpecialStop.cause);
                }
            };
        }

        if (started) {
            // feedback l√©ger
            try { navigator.vibrate && navigator.vibrate([60, 40, 60]); } catch(e) {}
        }
    }
}

// Boutons principaux
document.getElementById("specialStartNowBtn").onclick = openSpecialLiveModal;
document.getElementById("specialResumeBtn").onclick = resumeSpecialStopLive;
document.getElementById("specialResumeBigBtn").onclick = resumeSpecialStopLive;

// Restaurer si un arr√™t sp√©cial √©tait en cours
setTimeout(() => {
    try {
        activeSpecialStop = JSON.parse(LS.getItem("SPECIAL_ACTIVE") || "null");
        updateSpecialActiveUI(false);
    } catch(e) {}
}, 0);


function openSpecialStopModal() {
    const now = new Date();
    const today = getActiveShiftDateISO();
    const currentTime = now.toTimeString().substring(0, 5);

    document.getElementById("specialDate").value = today;
    document.getElementById("specialStart").value = currentTime;
    document.getElementById("specialDurationH").value = 0;
    document.getElementById("specialDurationM").value = 30;
    document.getElementById("specialCause").value = "";
    document.getElementById("specialCustomCause").style.display = "block";
    document.getElementById("specialCustomCause").value = "";
    document.getElementById("specialEquipe").value = document.getElementById("equipe")?.value || "A";

    updateSpecialTimes();
    document.getElementById("specialStopModal").style.display = "flex";
}

function closeSpecialStopModal() {
    document.getElementById("specialStopModal").style.display = "none";
}

function presetSpecialStop2300() {
    const date = document.getElementById("specialDate").value || new Date().toISOString().split('T')[0];
    document.getElementById("specialDate").value = date;
    document.getElementById("specialStart").value = "23:00";
    document.getElementById("specialDurationH").value = 3;
    document.getElementById("specialDurationM").value = 0;
    updateSpecialTimes();
}

function presetSpecialStopNow() {
    const now = new Date();
    const today = getActiveShiftDateISO();
    const currentTime = now.toTimeString().substring(0, 5);
    document.getElementById("specialDate").value = today;
    document.getElementById("specialStart").value = currentTime;
    document.getElementById("specialDurationH").value = 0;
    document.getElementById("specialDurationM").value = 30;
    updateSpecialTimes();
}

function presetSpecialStopFree() {
    const now = new Date();
    const today = getActiveShiftDateISO();
    const currentTime = now.toTimeString().substring(0, 5);
    document.getElementById("specialDate").value = today;
    document.getElementById("specialStart").value = currentTime;
    document.getElementById("specialDurationH").value = 0;
    document.getElementById("specialDurationM").value = 30;
    document.getElementById("specialCause").value = "";
    document.getElementById("specialCustomCause").value = "";
    updateSpecialTimes();
}

function onSpecialCauseChange() {
    const causeSelect = document.getElementById("specialCause");
    const custom = document.getElementById("specialCustomCause");

    // Le champ libre reste toujours visible (vous pouvez modifier/compl√©ter)
    custom.style.display = "block";

    // Si l'utilisateur choisit une cause dans la liste, on la copie dans le champ libre
    if (causeSelect.value && causeSelect.value !== "OTHER") {
        custom.value = causeSelect.value;
    }

    // Si "Autre", on laisse le champ libre tel quel et on met le focus
    if (causeSelect.value === "OTHER") {
        custom.focus();
    }

    updateSpecialTimes();
}

function updateSpecialTimes() {
    const date = document.getElementById("specialDate").value;
    const start = document.getElementById("specialStart").value;
    const h = parseInt(document.getElementById("specialDurationH").value) || 0;
    const m = parseInt(document.getElementById("specialDurationM").value) || 0;
    const totalMinutes = Math.max(0, h * 60 + m);

    const endDisplay = document.getElementById("specialEndDisplay");
    const hint = document.getElementById("specialEndHint");

    if (!date || !start || totalMinutes <= 0) {
        endDisplay.value = "";
        hint.textContent = "Renseignez la date, l'heure de d√©but et la dur√©e.";
        return;
    }

    const [sh, sm] = start.split(':').map(Number);
    const startDt = new Date(date);
    startDt.setHours(sh, sm, 0, 0);

    const endDt = new Date(startDt.getTime() + totalMinutes * 60000);
    const eh = endDt.getHours().toString().padStart(2, '0');
    const em = endDt.getMinutes().toString().padStart(2, '0');
    const endTimeStr = `${eh}:${em}`;

    const sameDay = startDt.toISOString().split('T')[0] === endDt.toISOString().split('T')[0];
    endDisplay.value = sameDay ? endTimeStr : `${endTimeStr} (+1j)`;
    hint.textContent = sameDay ? "" : `Fin le ${endDt.toLocaleDateString()}`;
}

function saveSpecialStop() {
    const date = document.getElementById("specialDate").value;
    const start = document.getElementById("specialStart").value;
    const h = parseInt(document.getElementById("specialDurationH").value) || 0;
    const m = parseInt(document.getElementById("specialDurationM").value) || 0;
    const totalMinutes = Math.max(0, h * 60 + m);

    const causeSelect = document.getElementById("specialCause");
    const customVal = (document.getElementById("specialCustomCause").value || "").trim();

    // Priorit√© au texte libre (pour ajouter librement)
    const cause = customVal || (causeSelect.value === "OTHER" ? customVal : causeSelect.value);

    const team = document.getElementById("specialEquipe").value;

    if (!date || !start || totalMinutes <= 0) {
        alert("Veuillez remplir la date, l'heure de d√©but et une dur√©e valide.");
        return;
    }

    if (!cause || cause.trim() === "") {
        alert("Veuillez saisir une cause pour l'arr√™t sp√©cial.");
        return;
    }

    const [sh, sm] = start.split(':').map(Number);
    const startDt = new Date(date);
    startDt.setHours(sh, sm, 0, 0);

    const endDt = new Date(startDt.getTime() + totalMinutes * 60000);
    const eh = endDt.getHours().toString().padStart(2, '0');
    const em = endDt.getMinutes().toString().padStart(2, '0');
    const endTimeStr = `${eh}:${em}`;

    const formattedDate = getShiftDate(startDt); // IMPORTANT: bas√© sur la vraie heure
    const durationSeconds = totalMinutes * 60;
    const timestamp = startDt.getTime();

    const specialStop = {
        date: formattedDate,
        cause: cause,
        start: start,
        end: endTimeStr,
        duration: durationSeconds,
        equipe: team,
        timestamp: timestamp,
        type: "sp√©cial",
        startDateTime: startDt.toISOString(),
        endDateTime: endDt.toISOString()
    };

    history.push(specialStop);

    LS.setItem("HISTO", JSON.stringify(history));
    if (db) saveToIndexedDB();

    refreshTable();
    updateProductionCalculations();
    closeSpecialStopModal();

    alert(`‚úÖ Arr√™t sp√©cial enregistr√© !
Date (shift): ${formattedDate}
P√©riode: ${start} - ${endTimeStr} (${totalMinutes} min)
Cause: ${cause}
√âquipe: ${team}`);
}


function openMissedStopModal() {
    const now = new Date();
    const today = getActiveShiftDateISO();
    const currentTime = now.toTimeString().substring(0, 5);
    
    const fiveMinutesAgo = new Date(now.getTime() - 5 * 60000);
    const fiveMinutesAgoTime = fiveMinutesAgo.toTimeString().substring(0, 5);
    
    document.getElementById("missedDate").value = today;
    document.getElementById("missedStart").value = fiveMinutesAgoTime;
    document.getElementById("missedEnd").value = currentTime;
    document.getElementById("missedDuration").value = 5;
    document.getElementById("missedCause").value = "";
    document.getElementById("missedCustomCause").style.display = "none";
    document.getElementById("missedCustomCause").value = "";
    document.getElementById("missedEquipe").value = equipe;
    
    updateMissedStopSummary();
    
    document.getElementById("missedStopModal").style.display = "flex";
}

function closeMissedStopModal() {
    document.getElementById("missedStopModal").style.display = "none";
}

function updateMissedTimes() {
    const duration = parseInt(document.getElementById("missedDuration").value) || 5;
    const startTime = document.getElementById("missedStart").value;
    
    if (startTime) {
        const [hours, minutes] = startTime.split(':').map(Number);
        const startDate = new Date();
        startDate.setHours(hours, minutes, 0, 0);
        
        const endDate = new Date(startDate.getTime() + duration * 60000);
        const endHours = endDate.getHours().toString().padStart(2, '0');
        const endMinutes = endDate.getMinutes().toString().padStart(2, '0');
        
        document.getElementById("missedEnd").value = `${endHours}:${endMinutes}`;
    }
    
    updateMissedStopSummary();
}

function updateMissedStopSummary() {
    const date = document.getElementById("missedDate").value;
    const start = document.getElementById("missedStart").value;
    const end = document.getElementById("missedEnd").value;
    const duration = document.getElementById("missedDuration").value;
    const causeSelect = document.getElementById("missedCause");
    const cause = causeSelect.value === "OTHER" 
        ? document.getElementById("missedCustomCause").value 
        : causeSelect.value;
    const team = document.getElementById("missedEquipe").value;
    
    const dateObj = new Date(date);
    const formattedDate = dateObj.toLocaleDateString('fr-FR', {
        weekday: 'long',
        day: 'numeric',
        month: 'long'
    });
    
    document.getElementById("missedSummaryDate").textContent = formattedDate;
    document.getElementById("missedSummaryTime").textContent = `${start} - ${end}`;
    document.getElementById("missedSummaryDuration").textContent = `${duration} minutes`;
    document.getElementById("missedSummaryCause").textContent = cause || "-";
    document.getElementById("missedSummaryEquipe").textContent = `√âquipe ${team}`;
}

document.getElementById("missedCause").onchange = function() {
    const customCauseField = document.getElementById("missedCustomCause");
    if (this.value === "OTHER") {
        customCauseField.style.display = "block";
    } else {
        customCauseField.style.display = "none";
        customCauseField.value = "";
    }
    updateMissedStopSummary();
};

document.getElementById("missedCustomCause").oninput = updateMissedStopSummary;
document.getElementById("missedDate").onchange = updateMissedStopSummary;
document.getElementById("missedStart").onchange = updateMissedStopSummary;
document.getElementById("missedEnd").onchange = updateMissedStopSummary;
document.getElementById("missedDuration").oninput = updateMissedStopSummary;
document.getElementById("missedEquipe").onchange = updateMissedStopSummary;

function saveMissedStop() {
    const dateISO = document.getElementById("missedDate").value;
    const start = document.getElementById("missedStart").value;
    const end = document.getElementById("missedEnd").value;
    const durationMinutesInput = parseInt(document.getElementById("missedDuration").value || "0", 10);
    const causeSelect = document.getElementById("missedCause");
    const team = document.getElementById("missedEquipe").value;

    // Cause (liste ou personnalis√©e)
    const cause = (causeSelect.value === "Autre")
        ? (document.getElementById("missedCustomCause").value || "").trim()
        : (causeSelect.value || "").trim();

    if (!dateISO || !start || !end) {
        alert("Veuillez remplir la date, le d√©but et la fin.");
        return;
    }
    if (!cause) {
        alert("Veuillez saisir une cause pour l'arr√™t.");
        return;
    }

    // Le champ date correspond √† la DATE DU SHIFT (d√©but du shift)
    const shiftType = currentShiftType;
    const formattedShiftDate = formatShiftDate(parseISODateLocal(dateISO));

    // Construire les Date r√©elles (g√®re Nuit 22->06 : 02:00 = lendemain)
    const startDt = buildDateTimeFromShiftDateISO(dateISO, start, shiftType);
    let endDt = buildDateTimeFromShiftDateISO(dateISO, end, shiftType);

    // S√©curit√© si fin < d√©but (ajouter +1j)
    if (endDt.getTime() < startDt.getTime()) {
        endDt.setDate(endDt.getDate() + 1);
    }

    // Dur√©e (minutes) : si non fournie, calculer depuis d√©but/fin
    let durationSeconds = 0;
    if (durationMinutesInput && durationMinutesInput > 0) {
        durationSeconds = durationMinutesInput * 60;
    } else {
        durationSeconds = calculateDurationInSeconds(start + ":00", end + ":00");
        // si traverse minuit, calculateDurationInSeconds g√®re d√©j√†
    }
    if (!durationSeconds || durationSeconds <= 0) {
        alert("Dur√©e invalide. V√©rifiez d√©but/fin ou dur√©e.");
        return;
    }

    const missedStop = {
        date: formattedShiftDate,
        shiftType: shiftType,
        cause: cause,
        start: start,
        end: end,
        duration: durationSeconds,
        equipe: team,
        timestamp: startDt.getTime(),
        isMissed: true,
        type: "rat√©",
        startDateTime: startDt.toISOString(),
        endDateTime: endDt.toISOString()
    };

    history.push(missedStop);

    LS.setItem("HISTO", JSON.stringify(history));
    if (db) saveToIndexedDB();

    refreshTable();
    try { updateActiveChart(); } catch(e) {}

    closeModal("missedStopModal");

    // Reset
    document.getElementById("missedDuration").value = "";
    showNotification("‚úÖ Arr√™t rat√© ajout√©", "success");
}

// =============================================
// NOTIFICATIONS
// =============================================

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'warning' ? 'var(--warning)' : type === 'success' ? 'var(--success)' : 'var(--primary)'};
        color: white;
        padding: 15px;
        border-radius: 8px;
        z-index: 10000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        animation: slideIn 0.3s ease-out;
        max-width: 300px;
    `;
    
    notification.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 20px;">${type === 'warning' ? '‚ö†Ô∏è' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è'}</span>
            <div>
                <div style="font-size: 14px; margin-top: 5px;">${message}</div>
            </div>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease-out';
        setTimeout(() => notification.remove(), 300);
    }, 5000);
}


// =============================================
// AUTO STOP BADGE (Arr√™t de cha√Æne) ‚Äî Ÿäÿ∏Ÿáÿ± ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ÿπŸÜÿØ ÿßŸÑÿ™ŸàŸÇŸÅ ŸàŸäÿÆÿ™ŸÅŸä ÿπŸÜÿØ ÿßŸÑÿ•ŸÇŸÑÿßÿπ
// =============================================

let autoStopState = (() => {
  try {
    const raw = LS.getItem("AUTO_STOP_STATE");
    return raw ? JSON.parse(raw) : { active:false };
  } catch(e) { return { active:false }; }
})();

let autoStopTimer = null;
let autoStopHidden = false;

function formatHMS(sec){
  sec = Math.max(0, Math.floor(sec||0));
  const h = String(Math.floor(sec/3600)).padStart(2,"0");
  const m = String(Math.floor((sec%3600)/60)).padStart(2,"0");
  const s = String(sec%60).padStart(2,"0");
  return `${h}:${m}:${s}`;
}

function persistAutoStop(){
  try { LS.setItem("AUTO_STOP_STATE", JSON.stringify(autoStopState||{active:false})); } catch(e){}
}

function setAutoStopActive({startMs, cause, by, source} = {}){
  autoStopState = {
    active: true,
    startMs: Number(startMs || Date.now()),
    cause: (cause || "Non sp√©cifi√©"),
    by: (by || ""),
    source: (source || "local"),
    updatedAt: Date.now()
  };
  autoStopHidden = false;
  persistAutoStop();
  renderAutoStopBadge();
  // ÿ•ÿ±ÿ≥ÿßŸÑ ÿ≠ÿßŸÑÿ© ŸÖÿ≠ÿØÿ´ÿ© ŸÑŸÑÿ£ŸàŸÜŸÑÿßŸäŸÜ ÿ®ÿ≥ÿ±ÿπÿ© (ŸÅŸÇÿ∑ ÿ•ÿ∞ÿß ÿßŸÑÿ™ÿ∫ŸäŸäÿ± ŸÖÿ≠ŸÑŸä)
  try { if ((source||'local') === 'local' && typeof onlineTick === "function") setTimeout(() => onlineTick(true), 250); } catch(e){}
}

function setAutoStopInactive({source} = {}){
  autoStopState = { active:false, updatedAt: Date.now(), source: source || "local" };
  autoStopHidden = false;
  try { LS.removeItem("AUTO_STOP_STATE"); } catch(e){}
  renderAutoStopBadge();
  try { if ((source||'local') === 'local' && typeof onlineTick === "function") setTimeout(() => onlineTick(true), 250); } catch(e){}
}

function renderAutoStopBadge(){
  const badge = document.getElementById("autoStopBadge");
  if (!badge) return;

  if (!autoStopState || !autoStopState.active || autoStopHidden){
    badge.style.display = "none";
    if (autoStopTimer) { clearInterval(autoStopTimer); autoStopTimer = null; }
    return;
  }

  badge.style.display = "flex";

  const elapsedEl = document.getElementById("autoStopElapsed");
  const causeEl = document.getElementById("autoStopCause");
  const byEl = document.getElementById("autoStopBy");

  if (causeEl) causeEl.textContent = autoStopState.cause || "‚Äî";

  const byTxt = autoStopState.by ? `De: ${autoStopState.by}` : "";
  if (byEl) byEl.textContent = byTxt;

  const tick = () => {
    const sec = (Date.now() - (autoStopState.startMs || Date.now())) / 1000;
    if (elapsedEl) elapsedEl.textContent = formatHMS(sec);
  };
  tick();

  if (!autoStopTimer){
    autoStopTimer = setInterval(tick, 1000);
  }
}

function maybeRestoreAutoStop(){
  try {
    const raw = LS.getItem("AUTO_STOP_STATE");
    if (raw) autoStopState = JSON.parse(raw);
  } catch(e){}
  renderAutoStopBadge();
}

// ÿ≤ÿ± ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ: ŸäŸÅÿ™ÿ≠ ÿßŸÑŸÖŸÑÿÆÿµ/ÿßŸÑŸÖÿ§ÿ¥ÿ±ÿßÿ™ ÿßŸÑŸÖŸàÿ¨ŸàÿØÿ© ŸÅŸä ÿßŸÑÿµŸÅÿ≠ÿ©
document.addEventListener("DOMContentLoaded", () => {
  const hideBtn = document.getElementById("autoStopHideBtn");
  const detailsBtn = document.getElementById("autoStopDetailsBtn");

  if (hideBtn){
    hideBtn.onclick = () => {
      autoStopHidden = true;
      renderAutoStopBadge();
    };
  }

  if (detailsBtn){
    detailsBtn.onclick = () => {
      // ŸÜÿ≤ŸàŸÑ ÿ•ŸÑŸâ ŸÖÿ§ÿ¥ÿ±ÿßÿ™ ÿßŸÑÿ™ŸàŸÇŸÅ (stats) + ŸÖÿ§ŸÇÿ™
      const anchor = document.getElementById("timerDisplay") || document.getElementById("count") || document.getElementById("main");
      if (anchor && anchor.scrollIntoView) anchor.scrollIntoView({ behavior: "smooth", block: "center" });
    };
  }

  maybeRestoreAutoStop();

  // ÿπŸÜÿØ ÿßŸÑÿπŸàÿØÿ© ŸÖŸÜ ŸÖŸÉÿßŸÑŸÖÿ©/ÿ™ÿ®ÿØŸäŸÑ ÿ™ÿ∑ÿ®ŸäŸÇ: ÿ£ÿπÿØ ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑÿ≠ÿßŸÑÿ© ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ŸÜÿ¥ÿ∑ÿ©
  document.addEventListener("visibilitychange", () => {
    if (!document.hidden) maybeRestoreAutoStop();
  });
  window.addEventListener("focus", maybeRestoreAutoStop);
  window.addEventListener("online", maybeRestoreAutoStop);
});

// =============================================
// GESTION √âV√âNEMENTS PRINCIPAUX
// =============================================

document.getElementById("equipe").onchange = e => {
    equipe = e.target.value;
    refreshTable();
    if (db) saveToIndexedDB();
};

document.getElementById("stopBtn").onclick = () => {
    if (start) {
        alert("Un arr√™t est d√©j√† en cours !");
        return;
    }
    
    start = new Date();
    document.getElementById("alarm").play().catch(e => console.log("Audio error:", e));
    if (navigator.vibrate) navigator.vibrate([200]);
    timerInterval = setInterval(updateTimer, 1000);
    updateTimer();

    // Badge automatique (Ÿäÿ∏Ÿáÿ± ŸÅŸä ŸÉŸÑ ÿßŸÑÿ£ÿ¨Ÿáÿ≤ÿ© ÿπÿ®ÿ± Supabase/P2P)
    try {
        const causeNow = document.getElementById("cause").value || "Non sp√©cifi√©";
        const byNow = (document.getElementById('onlineUserName')?.value || document.getElementById("teamLeader")?.value || teamLeader || peerId || "");
        setAutoStopActive({ startMs: start.getTime(), cause: causeNow, by: byNow, source: 'local' });
    } catch(e) {}
    
    // Diffuser automatiquement aux appareils connect√©s
    if (connections.size > 0) {
        setTimeout(broadcastCurrentStop, 1000);
    }
};

document.getElementById("goBtn").onclick = () => {
    if (!start) {
        alert("Aucun arr√™t en cours !");
        return;
    }
    
    let end = new Date();
    let seconds = Math.floor((end - start) / 1000);
    let cause = document.getElementById("cause").value || "Non sp√©cifi√©";
    let currentTeamLeader = document.getElementById("teamLeader").value || teamLeader || "";
    
    let row = {
        date: getShiftContext(start).shiftDate,
        shiftType: getShiftContext(start).shiftType,
        cause: cause,
        start: formatHHMM(start),
        end: formatHHMM(end),
        duration: seconds,
        equipe: equipe,
        startDateTime: start.toISOString(),
        endDateTime: end.toISOString(),
teamLeader: currentTeamLeader,
        timestamp: start.getTime()
    };
    
    history.push(row);
    LS.setItem("HISTO", JSON.stringify(history));
    if (db) saveToIndexedDB();
    
    clearInterval(timerInterval);
    document.getElementById("timerDisplay").textContent = "00:00:00";
    document.getElementById("alarm").pause();
    document.getElementById("alarm").currentTime = 0;
    document.getElementById("resumeSound").play().catch(e => console.log("Audio error:", e));
    
    // Diffuser la fin d'arr√™t
    if (connections.size > 0) {
        connections.forEach((conn, peerId) => {
            conn.send({
                type: 'stop_end',
                from: peer.id,
                timestamp: Date.now(),
                startMs: row.timestamp,
                endMs: end.getTime(),
                cause: cause,
                duration: seconds,
                equipe: equipe
            });
        });
    }
    
    sendWhatsAppResume(cause, seconds, row.start, row.end, currentTeamLeader);

    // ÿ•ÿÆŸÅÿßÿ° badge ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ÿπŸÜÿØ ÿßŸÑÿ•ŸÇŸÑÿßÿπ
    try { setAutoStopInactive({ source: 'local' }); } catch(e) {}
    
    start = null;
    refreshTable();
    try { updateActiveChart(); } catch(e) {}
    document.getElementById("cause").value = "";
};

function logAbsence() {
    const type = document.getElementById("absenceType").value;
    const poste = document.getElementById("absencePoste").value.trim();
    const daysInput = document.getElementById("absenceDays").value;
    const hoursInput = document.getElementById("absenceHours").value;
    const now = new Date();
    const shiftDate = getShiftDate(now);
    
    if (!type) {
        alert("Veuillez s√©lectionner un type d'absence.");
        return;
    }
    
    if (!poste) {
        alert("Veuillez saisir le poste/op√©rateur.");
        return;
    }
    
    let durationDays = 0;
    let durationHours = 0;
    const HOURS_PER_DAY = 7.6;
    
    if (daysInput && !isNaN(parseFloat(daysInput)) && parseFloat(daysInput) > 0) {
        durationDays = parseFloat(daysInput);
        durationHours = durationDays * HOURS_PER_DAY;
    } else if (hoursInput && !isNaN(parseFloat(hoursInput)) && parseFloat(hoursInput) > 0) {
        durationHours = parseFloat(hoursInput);
        durationDays = durationHours / HOURS_PER_DAY;
    } else {
        alert("Veuillez saisir une dur√©e valide en jours ou en heures.");
        return;
    }

    const absence = {
        date: shiftDate,
        type: type,
        poste: poste,
        durationDays: Math.round(durationDays * 10) / 10,
        durationHours: Math.round(durationHours * 10) / 10,
        equipe: equipe,
        timestamp: Date.now()
    };

    absenceHistory.push(absence);
    LS.setItem("ABSENCES", JSON.stringify(absenceHistory));
    if (db) saveToIndexedDB();

    document.getElementById("absenceType").value = "";
    document.getElementById("absencePoste").value = "";
    document.getElementById("absenceDays").value = "";
    document.getElementById("absenceHours").value = "";

    refreshAbsenceStats();
    alert(`Absence ${type} pour ${poste} enregistr√©e : ${absence.durationDays} jours (${absence.durationHours}h) pour l'√©quipe ${equipe}.`);
}

// =============================================
// EFFACER LES DONN√âES
// =============================================

document.getElementById("clearBtn").onclick = () => {
    document.getElementById("clearModal").style.display = "flex";
};

function clearHistory(type) {
    const now = new Date();
    const shiftDate = getShiftDate(now);
    
    switch(type) {
        case 'today':
            history = history.filter(h => h.date !== shiftDate);
            absenceHistory = absenceHistory.filter(a => a.date !== shiftDate);
            break;
        case 'equipe':
            history = history.filter(h => h.equipe !== equipe);
            absenceHistory = absenceHistory.filter(a => a.equipe !== equipe);
            break;
        case 'all':
            history = [];
            absenceHistory = [];
            break;
    }
    
    LS.setItem("HISTO", JSON.stringify(history));
    LS.setItem("ABSENCES", JSON.stringify(absenceHistory));
    
    if (db) {
        saveToIndexedDB().then(() => {
            console.log('Base de donn√©es mise √† jour apr√®s effacement');
        });
    }
    
    refreshTable();
    
    document.getElementById("clearModal").style.display = "none";
    
    alert(`Donn√©es effac√©es avec succ√®s (${type === 'today' ? 'shift actuel' : type === 'equipe' ? 'mon √©quipe' : 'toutes'})`);
}

function cancelClear() {
    document.getElementById("clearModal").style.display = "none";
}

// =============================================
// INDEXEDDB - SAUVEGARDE ROBUSTE
// =============================================

function openDatabase() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open('StellantisTrackerDB', 3); // Version 3 pour ajouter cycleTime
        
        request.onerror = () => reject(request.error);
        request.onsuccess = () => {
            db = request.result;
            resolve(db);
        };
        
        request.onupgradeneeded = (event) => {
            const db = event.target.result;
            
            if (!db.objectStoreNames.contains('arrets')) {
                const arretsStore = db.createObjectStore('arrets', { 
                    keyPath: 'id',
                    autoIncrement: true 
                });
                arretsStore.createIndex('timestamp', 'timestamp', { unique: false });
                arretsStore.createIndex('equipe', 'equipe', { unique: false });
            }
            
            if (!db.objectStoreNames.contains('absences')) {
                const absencesStore = db.createObjectStore('absences', { 
                    keyPath: 'id',
                    autoIncrement: true 
                });
                absencesStore.createIndex('timestamp', 'timestamp', { unique: false });
                absencesStore.createIndex('equipe', 'equipe', { unique: false });
            }
            
            if (!db.objectStoreNames.contains('settings')) {
                db.createObjectStore('settings', { keyPath: 'key' });
            }
        };
    });
}

async function saveToIndexedDB() {
    if (!db) {
        await openDatabase();
    }
    
    try {
        const transaction = db.transaction(['arrets', 'absences', 'settings'], 'readwrite');
        
        const arretsStore = transaction.objectStore('arrets');
        arretsStore.clear();
        history.forEach(arret => {
            arretsStore.put({
                ...arret,
                id: arret.timestamp || Date.now(),
                synced: false
            });
        });
        
        const absencesStore = transaction.objectStore('absences');
        absencesStore.clear();
        absenceHistory.forEach(absence => {
            absencesStore.put({
                ...absence,
                id: absence.timestamp || Date.now(),
                synced: false
            });
        });
        
        const settingsStore = transaction.objectStore('settings');
        const pauses = {
            p1Start: document.getElementById("p1Start").value,
            p1End: document.getElementById("p1End").value,
            p2Start: document.getElementById("p2Start").value,
            p2End: document.getElementById("p2End").value,
            p3Start: document.getElementById("p3Start").value,
            p3End: document.getElementById("p3End").value
        };
        
        settingsStore.put({ key: 'pauses', value: pauses });
        settingsStore.put({ key: 'equipe', value: equipe });
        settingsStore.put({ key: 'selectedShift', value: currentShiftType });
        settingsStore.put({ key: 'shiftConfigs', value: shiftConfigs });
        settingsStore.put({ key: 'objectifs', value: objectifs });
        settingsStore.put({ key: 'teamLeader', value: teamLeader });
        settingsStore.put({ key: 'cycleTimeSeconds', value: cycleTimeSeconds });
        
        // Sauvegarde des param√®tres P2P
        if (peer && peer.id) {
            settingsStore.put({ 
                key: 'peerId', 
                value: peer.id 
            });
            settingsStore.put({ 
                key: 'connections', 
                value: Array.from(connections.keys()) 
            });
        }
        
        // Sauvegarde des messages de chat
        settingsStore.put({
            key: 'chatMessages',
            value: chatMessages
        });

        // Sauvegarde des posts (journal)
        settingsStore.put({
            key: 'posts',
            value: posts
        });
        
        await transaction.complete;
        return true;
    } catch (error) {
        console.error('Erreur de sauvegarde IndexedDB:', error);
        return false;
    }
}

async function restoreFromIndexedDB() {
    if (!db) {
        await openDatabase();
    }
    
    try {
        const transaction = db.transaction(['arrets', 'absences', 'settings'], 'readonly');
        
        const arretsStore = transaction.objectStore('arrets');
        const absencesStore = transaction.objectStore('absences');
        const settingsStore = transaction.objectStore('settings');
        
        const [arrets, absences, pausesSetting, equipeSetting, shiftSetting, shiftConfigsSetting, objectifsSetting, teamLeaderSetting, peerIdSetting, chatMessagesSetting, cycleTimeSetting] = await Promise.all([
            new Promise(resolve => {
                const request = arretsStore.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => resolve([]);
            }),
            new Promise(resolve => {
                const request = absencesStore.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => resolve([]);
            }),
            new Promise(resolve => {
                const request = settingsStore.get('pauses');
                request.onsuccess = () => resolve(request.result?.value);
                request.onerror = () => resolve(null);
            }),
            new Promise(resolve => {
                const request = settingsStore.get('equipe');
                request.onsuccess = () => resolve(request.result?.value);
                request.onerror = () => resolve(null);
            }),
            new Promise(resolve => {
                const request = settingsStore.get('selectedShift');
                request.onsuccess = () => resolve(request.result?.value);
                request.onerror = () => resolve(null);
            }),
            new Promise(resolve => {
                const request = settingsStore.get('shiftConfigs');
                request.onsuccess = () => resolve(request.result?.value);
                request.onerror = () => resolve(null);
            }),
            new Promise(resolve => {
                const request = settingsStore.get('objectifs');
                request.onsuccess = () => resolve(request.result?.value);
                request.onerror = () => resolve(null);
            }),
            new Promise(resolve => {
                const request = settingsStore.get('teamLeader');
                request.onsuccess = () => resolve(request.result?.value);
                request.onerror = () => resolve(null);
            }),
            new Promise(resolve => {
                const request = settingsStore.get('peerId');
                request.onsuccess = () => resolve(request.result?.value);
                request.onerror = () => resolve(null);
            }),
            new Promise(resolve => {
                const request = settingsStore.get('chatMessages');
                request.onsuccess = () => resolve(request.result?.value);
                request.onerror = () => resolve([]);
            }),
            new Promise(resolve => {
                const request = settingsStore.get('posts');
                request.onsuccess = () => resolve(request.result?.value);
                request.onerror = () => resolve([]);
            }),
            new Promise(resolve => {
                const request = settingsStore.get('cycleTimeSeconds');
                request.onsuccess = () => resolve(request.result?.value);
                request.onerror = () => resolve(null);
            })
        ]);
        
        if (arrets && arrets.length > 0) {
            history = arrets.map(item => {
                const { id, synced, ...rest } = item;
                return rest;
            });
            LS.setItem("HISTO", JSON.stringify(history));
        }
        
        if (absences && absences.length > 0) {
            absenceHistory = absences.map(item => {
                const { id, synced, ...rest } = item;
                return rest;
            });
            LS.setItem("ABSENCES", JSON.stringify(absenceHistory));
        }
        
        if (pausesSetting) {
            document.getElementById("p1Start").value = pausesSetting.p1Start;
            document.getElementById("p1End").value = pausesSetting.p1End;
            document.getElementById("p2Start").value = pausesSetting.p2Start;
            document.getElementById("p2End").value = pausesSetting.p2End;
            document.getElementById("p3Start").value = pausesSetting.p3Start;
            document.getElementById("p3End").value = pausesSetting.p3End;
            updatePauseTimes();
        }
        
        if (equipeSetting) {
            equipe = equipeSetting;
            document.getElementById("equipe").value = equipe;
        }
        
        if (shiftSetting) {
            currentShiftType = shiftSetting;
        }
        
        if (shiftConfigsSetting) {
            shiftConfigs = shiftConfigsSetting;
        }
        
        if (objectifsSetting) {
            objectifs = objectifsSetting;
            updateObjectifsDisplay();
        }
        
        if (teamLeaderSetting) {
            teamLeader = teamLeaderSetting;
            document.getElementById("teamLeader").value = teamLeader;
            document.getElementById("teamLeader").style.color = "#FFD700";
        }
        
        if (peerIdSetting) {
            fixedPeerId = peerIdSetting;
            document.getElementById('peerIdInput').value = fixedPeerId;
        }
        
        if (chatMessagesSetting && chatMessagesSetting.length > 0) {
            chatMessages = chatMessagesSetting;
            LS.setItem("CHAT_MESSAGES", JSON.stringify(chatMessages));
        }

        if (postsSetting && postsSetting.length > 0) {
            posts = postsSetting;
            LS.setItem("POSTS", JSON.stringify(posts));
        }
        
        if (cycleTimeSetting) {
            cycleTimeSeconds = cycleTimeSetting;
            const cycleMinutes = Math.floor(cycleTimeSeconds / 60);
            const cycleSeconds = cycleTimeSeconds % 60;
            const _ctInpSet = document.getElementById("cycleTimeInput");
            if (_ctInpSet) _ctInpSet.value = `${cycleMinutes}:${cycleSeconds.toString().padStart(2, '0')}`;
        }
        
        return true;
    } catch (error) {
        console.error('Erreur de restauration IndexedDB:', error);
        return false;
    }
}

function startAutoSave() {
    saveInterval = setInterval(() => {
        if (Date.now() - lastSaveTime > 30000) {
            if (db) saveToIndexedDB();
            lastSaveTime = Date.now();
        }
    }, 10000);
}

// =============================================
// NETTOYAGE DES ANCIENNES DONN√âES
// =============================================

function cleanupOldData() {
    const now = new Date();
    const cutoffDate = new Date(now);
    cutoffDate.setDate(cutoffDate.getDate() - 30);
    
    const cutoffShiftDateStr = getShiftDate(cutoffDate);
    const cutoffShiftDate = shiftDateToDate(cutoffShiftDateStr);
    
    history = history.filter(h => {
        const stopDate = shiftDateToDate(h.date);
        return stopDate >= cutoffShiftDate;
    });
    
    absenceHistory = absenceHistory.filter(a => {
        const absenceDate = shiftDateToDate(a.date);
        return absenceDate >= cutoffShiftDate;
    });
    
    LS.setItem("HISTO", JSON.stringify(history));
    LS.setItem("ABSENCES", JSON.stringify(absenceHistory));
    if (db) saveToIndexedDB();
    
    console.log(`Nettoyage effectu√©. Gard√© ${history.length} arr√™ts et ${absenceHistory.length} absences.`);
}

// =============================================
// SYNCHRONISATION P2P AVEC PEERJS (AVEC ID FIXE)
// =============================================

function initializePeerJS() {
    try {
        // R√©cup√©rer ou g√©n√©rer un ID fixe
        fixedPeerId = LS.getItem('FIXED_PEER_ID');
        if (!fixedPeerId) {
            // G√©n√©rer un ID fixe bas√© sur l'√©quipe + timestamp unique
            const team = document.getElementById("equipe").value;
            const uniqueId = Math.random().toString(36).substring(2, 10);
            fixedPeerId = `${team}-${uniqueId}`;
            LS.setItem('FIXED_PEER_ID', fixedPeerId);
        }
        
        // Configuration PeerJS avec serveurs STUN gratuits
        peer = new Peer(fixedPeerId, {
            host: '0.peerjs.com',
            port: 443,
            path: '/',
            secure: true,
            config: {
                'iceServers': [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' },
                    { urls: 'stun:stun2.l.google.com:19302' },
                    { urls: 'stun:stun3.l.google.com:19302' },
                    { urls: 'stun:stun4.l.google.com:19302' }
                ]
            },
            debug: 2
        });

        peer.on('open', function(id) {
            console.log('PeerJS connect√© avec ID fixe:', id);
            peerId = id;
            document.getElementById('peerIdInput').value = peerId;
            updatePeerStatus('connect√©', '#25D366');
            showNotification("‚úÖ Connect√© P2P avec ID fixe: " + peerId, "success");
            
            // D√©marrer la synchronisation automatique toutes les 3 secondes
            startAutoSync();
        });

        peer.on('connection', function(conn) {
            console.log('Nouvelle connexion entrante:', conn.peer);
            setupConnection(conn);
        });

        peer.on('error', function(err) {
            console.error('Erreur PeerJS:', err);
            if (err.type === 'peer-unavailable') {
                showNotification("‚ö†Ô∏è Appareil distant non disponible", "warning");
            } else if (err.type === 'network') {
                showNotification("üåê Probl√®me r√©seau - V√©rifiez la connexion", "warning");
            } else {
                showNotification("‚ùå Erreur connexion P2P: " + err.message, "danger");
            }
            updatePeerStatus('erreur', '#d90429');
        });

        peer.on('disconnected', function() {
            console.log('D√©connect√© du serveur PeerJS');
            updatePeerStatus('d√©connect√©', '#ff9f1c');
            setTimeout(() => {
                if (peer && peer.disconnected) {
                    peer.reconnect();
                }
            }, 5000);
        });

        // Initialiser les boutons P2P
        document.getElementById('copyPeerIdBtn').onclick = copyPeerId;
        document.getElementById('connectPeerBtn').onclick = connectToPeer;
        document.getElementById('syncDataBtn').onclick = synchronizeData;
        document.getElementById('broadcastBtn').onclick = broadcastCurrentStop;

    } catch (error) {
        console.error('Erreur initialisation PeerJS:', error);
        showNotification("‚ùå PeerJS non support√© par ce navigateur", "danger");
    }
}

function startAutoSync() {
    // Synchronisation automatique toutes les 3 secondes
    setInterval(() => {
        if (connections.size > 0 && !isSyncing) {
            autoSynchronizeData();
        }
    }, 3000);
}

function autoSynchronizeData() {
    if (connections.size === 0) return;
    
    isSyncing = true;
    
    // Pr√©parer les donn√©es de synchronisation
    const syncData = {
        type: 'auto_sync',
        from: peerId,
        timestamp: Date.now(),
        history: history.slice(-50), // Envoyer seulement les 50 derniers arr√™ts
        absenceHistory: absenceHistory.slice(-20), // Envoyer seulement les 20 derni√®res absences
        objectifs: objectifs,
        teamLeader: teamLeader,
        currentShift: currentShiftType,
        selectedShiftDate: selectedShiftDate,
        cycleTimeSeconds: cycleTimeSeconds
    };
    
    // Envoyer √† tous les appareils connect√©s
    connections.forEach((conn, peerId) => {
        try {
            conn.send(syncData);
        } catch (e) {
            console.error('Erreur auto-sync:', e);
        }
    });
    
    setTimeout(() => {
        isSyncing = false;
    }, 500);
}

function updatePeerStatus(status, color) {
    const statusElement = document.getElementById('peerStatus');
    statusElement.textContent = status;
    statusElement.style.color = color;
    document.getElementById('connectedPeersCount').textContent = connections.size;
}

function copyPeerId() {
    const peerIdInput = document.getElementById('peerIdInput');
    peerIdInput.select();
    peerIdInput.setSelectionRange(0, 99999);
    document.execCommand('copy');
    showNotification("‚úÖ ID copi√© dans le presse-papier", "success");
}

function connectToPeer() {
    const remotePeerId = document.getElementById('connectToPeerInput').value.trim();
    
    if (!remotePeerId) {
        showNotification("‚ö†Ô∏è Veuillez entrer un ID d'appareil", "warning");
        return;
    }
    
    if (remotePeerId === peerId) {
        showNotification("‚ö†Ô∏è Vous ne pouvez pas vous connecter √† vous-m√™me", "warning");
        return;
    }
    
    if (connections.has(remotePeerId)) {
        showNotification("‚ÑπÔ∏è D√©j√† connect√© √† cet appareil", "info");
        return;
    }
    
    try {
        const conn = peer.connect(remotePeerId, {
            reliable: true,
            serialization: 'json'
        });
        
        setupConnection(conn);
        showNotification("üîó Connexion en cours √†: " + remotePeerId, "info");
        
    } catch (error) {
        console.error('Erreur connexion:', error);
        showNotification("‚ùå Impossible de se connecter: " + error.message, "danger");
    }
}

function setupConnection(conn) {
    conn.on('open', function() {
        console.log('Connexion √©tablie avec:', conn.peer);
        connections.set(conn.peer, conn);
        updatePeerStatus('connect√©', '#25D366');
        showNotification("‚úÖ Connect√© √†: " + conn.peer, "success");
        
        // Envoyer les infos de base
        conn.send({
            type: 'handshake',
            peerId: peerId,
            team: document.getElementById("equipe").value,
            teamLeader: document.getElementById("teamLeader").value || teamLeader
        });
    });

    conn.on('data', function(data) {
        console.log('Donn√©es re√ßues:', data);
        handleIncomingData(data, conn.peer);
    });

    conn.on('close', function() {
        console.log('Connexion ferm√©e avec:', conn.peer);
        connections.delete(conn.peer);
        updatePeerStatus('connect√©', '#25D366');
        showNotification("üì¥ D√©connect√© de: " + conn.peer, "warning");
    });

    conn.on('error', function(err) {
        console.error('Erreur connexion:', err);
        showNotification("‚ùå Erreur avec " + conn.peer + ": " + err.message, "danger");
    });
}

function handleIncomingData(data, senderId) {
    if (!data || !data.type) return;
    
    switch(data.type) {
        case 'handshake':
            showNotification("ü§ù " + senderId + " connect√© (" + data.team + ")", "info");
            break;
            
        case 'sync_request':
            // Envoyer nos donn√©es en r√©ponse
            sendSyncData(senderId);
            break;
            
        case 'sync_data':
            if (!isSyncing) {
                mergeSyncData(data);
            }
            break;
            
        case 'auto_sync':
            handleAutoSyncData(data);
            break;
            
        case 'stop_event':
            handleRemoteStopEvent(data);
            break;
            
        case 'stop_end':
            handleRemoteStopEnd(data);
            break;
            
        case 'absence_event':
            handleRemoteAbsenceEvent(data);
            break;
            
        case 'chat_message':
            handleIncomingChatMessage(data);
            break;
    }
}

function handleAutoSyncData(data) {
    if (!data.history || !data.absenceHistory) return;
    
    let newItems = 0;
    let updatedItems = 0;
    
    // Fusionner l'historique des arr√™ts
    data.history.forEach(remoteStop => {
        const existingIndex = history.findIndex(localStop => 
            localStop.timestamp === remoteStop.timestamp && 
            localStop.equipe === remoteStop.equipe
        );
        
        if (existingIndex === -1) {
            // Nouvel arr√™t - ajouter
            history.push(remoteStop);
            newItems++;
        } else if (remoteStop.timestamp > history[existingIndex].timestamp) {
            // Version plus r√©cente - mettre √† jour
            history[existingIndex] = remoteStop;
            updatedItems++;
        }
    });
    
    // Fusionner l'historique des absences
    data.absenceHistory.forEach(remoteAbsence => {
        const existingIndex = absenceHistory.findIndex(localAbsence => 
            localAbsence.timestamp === remoteAbsence.timestamp && 
            localAbsence.equipe === remoteAbsence.equipe
        );
        
        if (existingIndex === -1) {
            absenceHistory.push(remoteAbsence);
            newItems++;
        } else if (remoteAbsence.timestamp > absenceHistory[existingIndex].timestamp) {
            absenceHistory[existingIndex] = remoteAbsence;
            updatedItems++;
        }
    });
    
    // Fusionner les objectifs
    if (data.objectifs && (!objectifs.timestamp || data.objectifs.timestamp > objectifs.timestamp)) {
        objectifs = data.objectifs;
    }
    
    // Fusionner le team leader si plus r√©cent
    if (data.teamLeader && data.teamLeader !== teamLeader) {
        teamLeader = data.teamLeader;
        document.getElementById("teamLeader").value = teamLeader;
        LS.setItem("TEAM_LEADER", teamLeader);
    }
    
    // Fusionner le temps de cycle
    if (data.cycleTimeSeconds && data.cycleTimeSeconds !== cycleTimeSeconds) {
        cycleTimeSeconds = data.cycleTimeSeconds;
        const cycleMinutes = Math.floor(cycleTimeSeconds / 60);
        const cycleSeconds = cycleTimeSeconds % 60;
        const _ctInpSet = document.getElementById("cycleTimeInput");
            if (_ctInpSet) _ctInpSet.value = `${cycleMinutes}:${cycleSeconds.toString().padStart(2, '0')}`;
    }
    
    // Sauvegarder les donn√©es fusionn√©es
    LS.setItem("HISTO", JSON.stringify(history));
    LS.setItem("ABSENCES", JSON.stringify(absenceHistory));
    
    if (db) saveToIndexedDB();
    
    if (newItems > 0 || updatedItems > 0) {
        // Rafra√Æchir l'affichage silencieusement
        refreshTable();
        refreshAbsenceStats();
        updateProductionCalculations();
    }
}

function synchronizeData() {
    if (connections.size === 0) {
        showNotification("‚ö†Ô∏è Aucun appareil connect√©", "warning");
        return;
    }
    
    isSyncing = true;
    showNotification("üîÑ Synchronisation en cours...", "info");
    
    // Demander les donn√©es √† tous les appareils connect√©s
    connections.forEach((conn, peerId) => {
        conn.send({
            type: 'sync_request',
            from: peerId,
            timestamp: Date.now()
        });
    });
    
    // Envoyer nos donn√©es √† tous les appareils
    setTimeout(() => {
        connections.forEach((conn, peerId) => {
            sendSyncData(peerId);
        });
        
        setTimeout(() => {
            isSyncing = false;
            showNotification("‚úÖ Synchronisation termin√©e", "success");
            refreshTable();
            refreshAbsenceStats();
            updateProductionCalculations();
        }, 1000);
    }, 500);
}

function sendSyncData(targetPeerId) {
    if (!connections.has(targetPeerId)) return;
    
    const conn = connections.get(targetPeerId);
    
    // Pr√©parer les donn√©es de synchronisation
    const syncData = {
        type: 'sync_data',
        from: peerId,
        timestamp: Date.now(),
        history: history,
        absenceHistory: absenceHistory,
        objectifs: objectifs,
        teamLeader: teamLeader,
        currentShift: currentShiftType,
        selectedShiftDate: selectedShiftDate,
        cycleTimeSeconds: cycleTimeSeconds
    };
    
    conn.send(syncData);
}

function mergeSyncData(data) {
    if (!data.history || !data.absenceHistory) return;
    
    let newItems = 0;
    let updatedItems = 0;
    
    // Fusionner l'historique des arr√™ts
    data.history.forEach(remoteStop => {
        const existingIndex = history.findIndex(localStop => 
            localStop.timestamp === remoteStop.timestamp && 
            localStop.equipe === remoteStop.equipe
        );
        
        if (existingIndex === -1) {
            // Nouvel arr√™t - ajouter
            history.push(remoteStop);
            newItems++;
        } else if (remoteStop.timestamp > history[existingIndex].timestamp) {
            // Version plus r√©cente - mettre √† jour
            history[existingIndex] = remoteStop;
            updatedItems++;
        }
    });
    
    // Fusionner l'historique des absences
    data.absenceHistory.forEach(remoteAbsence => {
        const existingIndex = absenceHistory.findIndex(localAbsence => 
            localAbsence.timestamp === remoteAbsence.timestamp && 
            localAbsence.equipe === remoteAbsence.equipe
        );
        
        if (existingIndex === -1) {
            absenceHistory.push(remoteAbsence);
            newItems++;
        } else if (remoteAbsence.timestamp > absenceHistory[existingIndex].timestamp) {
            absenceHistory[existingIndex] = remoteAbsence;
            updatedItems++;
        }
    });
    
    // Fusionner les objectifs
    if (data.objectifs && (!objectifs.timestamp || data.objectifs.timestamp > objectifs.timestamp)) {
        objectifs = data.objectifs;
    }
    
    // Fusionner le team leader si plus r√©cent
    if (data.teamLeader && data.teamLeader !== teamLeader) {
        teamLeader = data.teamLeader;
        document.getElementById("teamLeader").value = teamLeader;
        LS.setItem("TEAM_LEADER", teamLeader);
    }
    
    // Fusionner le temps de cycle
    if (data.cycleTimeSeconds && data.cycleTimeSeconds !== cycleTimeSeconds) {
        cycleTimeSeconds = data.cycleTimeSeconds;
        const cycleMinutes = Math.floor(cycleTimeSeconds / 60);
        const cycleSeconds = cycleTimeSeconds % 60;
        const _ctInpSet = document.getElementById("cycleTimeInput");
            if (_ctInpSet) _ctInpSet.value = `${cycleMinutes}:${cycleSeconds.toString().padStart(2, '0')}`;
    }
    
    // Sauvegarder les donn√©es fusionn√©es
    LS.setItem("HISTO", JSON.stringify(history));
    LS.setItem("ABSENCES", JSON.stringify(absenceHistory));
    LS.setItem("OBJECTIFS", JSON.stringify(objectifs));
    
    if (db) saveToIndexedDB();
    
    if (newItems > 0 || updatedItems > 0) {
        showNotification(`üîÑ ${newItems} nouveaux, ${updatedItems} mis √† jour`, "success");
        refreshTable();
        refreshAbsenceStats();
        updateProductionCalculations();
    }
}

function broadcastCurrentStop() {
    if (connections.size === 0) {
        showNotification("‚ö†Ô∏è Aucun appareil √† notifier", "warning");
        return;
    }
    
    if (!start) {
        showNotification("‚ö†Ô∏è Aucun arr√™t en cours", "warning");
        return;
    }
    
    const stopData = {
        type: 'stop_event',
        from: peerId,
        timestamp: Date.now(),
        startTime: start.toLocaleTimeString(),
        startMs: start.getTime(),
        cause: document.getElementById("cause").value || "Non sp√©cifi√©",
        equipe: equipe,
        teamLeader: document.getElementById("teamLeader").value || teamLeader
    };
    
    connections.forEach((conn, peerId) => {
        conn.send(stopData);
    });
    
    showNotification("üì° Arr√™t diffus√© √† " + connections.size + " appareil(s)", "success");
}

function handleRemoteStopEvent(data) {
    if (!data.startTime || !data.cause) return;
    
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 80px;
        right: 20px;
        background: rgba(13, 27, 42, 0.95);
        color: white;
        padding: 15px;
        border-radius: 8px;
        z-index: 9999;
        box-shadow: 0 4px 20px rgba(255, 159, 28, 0.4);
        animation: slideIn 0.3s ease-out;
        max-width: 300px;
        border-left: 4px solid var(--warning);
        backdrop-filter: blur(10px);
    `;
    
    notification.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
            <span style="font-size: 24px;">üì°</span>
            <div>
                <strong style="color: var(--warning);">ARR√äT DISTANT</strong>
                <div style="font-size: 12px; color: #ccc;">De: ${data.from}</div>
            </div>
            <button onclick="this.parentElement.parentElement.remove()" 
                    style="margin-left: auto; background: none; border: none; color: #ccc; cursor: pointer; font-size: 18px;">
                √ó
            </button>
        </div>
        <div style="font-size: 13px;">
            <div><strong>√âquipe:</strong> ${data.equipe}</div>
            <div><strong>Cause:</strong> ${data.cause}</div>
            <div><strong>D√©but:</strong> ${data.startTime}</div>
            ${data.teamLeader ? `<div><strong>Team Leader:</strong> ${data.teamLeader}</div>` : ''}
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Son de notification
    const sound = document.getElementById("pauseStartAlarm");
    if (sound) {
        sound.currentTime = 0;
        sound.play().catch(e => console.log("Audio error:", e));
    }
    
    // Badge automatique: Ÿäÿ∏Ÿáÿ± ÿπŸÜÿØ ÿ•ÿ¥ÿπÿßÿ± ÿßŸÑÿ™ŸàŸÇŸÅ (ÿ≠ÿ™Ÿâ ŸÑŸà ŸÖÿß ÿ®ÿØÿ£ŸÜÿß ŸÖÿ§ŸÇÿ™ ŸÖÿ≠ŸÑŸä)
    try {
        const startMs = data.startMs || Date.now();
        const by = data.teamLeader ? `${data.teamLeader}` : (data.from || "");
        setAutoStopActive({ startMs, cause: data.cause, by, source: 'remote' });
    } catch(e) {}

    // Auto-suppression apr√®s 10 secondes
    setTimeout(() => {
        if (notification.parentElement) {
            notification.style.animation = 'slideOut 0.3s ease-out';
            setTimeout(() => notification.remove(), 300);
        }
    }, 10000);
}

function handleRemoteStopEnd(data) {
    showNotification("‚úÖ Arr√™t termin√© sur l'appareil: " + data.from, "success");
    try { setAutoStopInactive({ source: 'remote' }); } catch(e) {}
}

function handleRemoteAbsenceEvent(data) {
    showNotification("üë• Absence enregistr√©e sur: " + data.from, "info");
}

// =============================================
// WHATSAPP ET EXPORTS
// =============================================

function sendWhatsAppResume(cause, duration, startTime, endTime, teamLeader) {
    const now = new Date();
    const shiftDate = getShiftDate(now);
    const config = shiftConfigs[currentShiftType];
    
    let msg = `*‚úÖ REPRISE CHA√éNE - √âquipe ${equipe}*\n`;
    msg += `*Shift:* ${shiftDate} (${config.name})\n`;
    msg += `*Heure de reprise:* ${new Date().toLocaleTimeString()}\n`;
    msg += `*Arr√™t:* ${startTime} - ${endTime}\n`;
    msg += `*Dur√©e:* ${formatDuration(duration)}\n`;
    msg += `*Cause:* ${cause}\n`;
    if (teamLeader) msg += `*Team Leader:* ${teamLeader}\n`;
    msg += `*√âquipe:* ${equipe}\n`;
    
    msg += `\n_Cha√Æne de production en cours..._`;
    sendWhatsApp(msg);
}

function sendWhatsAppCurrent() {
    const now = new Date();
    const shiftDate = getShiftDate(now);
    const config = shiftConfigs[currentShiftType];
    
    const filteredStops = history.filter(h => h.date === shiftDate && h.equipe === equipe);
    const filteredAbsences = absenceHistory.filter(a => a.date === shiftDate && a.equipe === equipe);

    if (filteredStops.length === 0 && filteredAbsences.length === 0) {
        alert(`Aucun arr√™t ni absence enregistr√© pour le shift ${config.name} du ${shiftDate} pour cette √©quipe.`);
        return;
    }
    
    const totalDurationGross = filteredStops.reduce((a, b) => a + b.duration, 0);
    const pauseData = calculateTotalPauseMinutes();
    const totalPauseMinutes = pauseData.total;
    const pauseSeconds = totalPauseMinutes * 60;
    const totalDurationNet = Math.max(0, totalDurationGross - pauseSeconds);
    
    const totalAbsenceDays = filteredAbsences.reduce((a, b) => a + b.durationDays, 0);
    const totalAbsenceHours = filteredAbsences.reduce((a, b) => a + b.durationHours, 0);
    const uniquePosts = new Set(filteredAbsences.map(a => a.poste)).size;

    let msg = `*üìä RAPPORT ACTUEL - √âquipe ${equipe}*\n`;
    msg += `*Shift:* ${shiftDate} (${config.name})\n`;
    msg += `*Heure:* ${new Date().toLocaleTimeString()}\n`;
    msg += `\n*--- ARR√äTS CHA√éNE ---\n`;
    msg += `*Total arr√™ts:* ${filteredStops.length}\n`;
    msg += `*Temps total (Net):* ${formatDuration(totalDurationNet)}\n`;
    msg += `*Temps total (Brut):* ${formatDuration(totalDurationGross)}\n`;
    
    // Ajout du Team Leader au rapport actuel
    const latestStop = filteredStops[filteredStops.length - 1];
    if (latestStop && latestStop.teamLeader) {
        msg += `*Team Leader:* ${latestStop.teamLeader}\n`;
    }
    
    msg += `\n*--- ABSENCES DU SHIFT ---\n`;
    msg += `*Nb Absences (√âv√©nements):* ${filteredAbsences.length}\n`;
    msg += `*Nb Postes concern√©s:* ${uniquePosts}\n`;
    msg += `*Total Jours Absences:* ${totalAbsenceDays}j\n`;
    msg += `*Total Heures Absences:* ${totalAbsenceHours}h\n`;
    
    if (filteredAbsences.length > 0) {
        msg += `*D√©tail des absences :*\n`;
        filteredAbsences.forEach(a => {
            msg += ` ‚Ä¢ ${a.poste} - ${a.type} (${a.durationDays}j / ${a.durationHours}h)\n`;
        });
    }

    sendWhatsApp(msg);
}

function sendWhatsAppStartShift() {
    const now = new Date();
    const currentShiftDate = getShiftDate(now);
    const config = shiftConfigs[currentShiftType];
    
    const yesterday = new Date(now);
    yesterday.setDate(yesterday.getDate() - 1);
    const yesterdayShiftDate = getShiftDate(yesterday);
    
    const yesterdayStops = history.filter(h => h.equipe === equipe && h.date === yesterdayShiftDate);
    const todayAbsences = absenceHistory.filter(a => a.equipe === equipe && a.date === currentShiftDate);
    
    const yesterdayDuration = yesterdayStops.reduce((a, b) => a + b.duration, 0);
    const pauseData = calculateTotalPauseMinutes();
    const pauseSeconds = pauseData.total * 60;
    const yesterdayNetDuration = Math.max(0, yesterdayDuration - pauseSeconds);
    
    const plannedAbsences = todayAbsences.filter(a => 
        a.type === "CA" || a.type === "CM" || a.type === "CR"
    );
    

    // --- OBJECTIF PRODUCTION (fin de shift) ---
    let _objectiveUnits = null;
    let _cycleStr = null;
    let _netMinutes = null;
    let _stopsNetMinutes = null;
    try {
        const ctxObj = getActiveShiftContext(now);
        const cfgObj = (shiftConfigs && shiftConfigs[ctxObj.shiftType]) ? shiftConfigs[ctxObj.shiftType] : null;
        if (cfgObj) {
            const shiftDateISO = shiftDateStrToISO(ctxObj.shiftDate) || new Date().toISOString().slice(0,10);
            const startHH = String(cfgObj.start).padStart(2,'0') + ":00";
            const endHH   = String(cfgObj.end).padStart(2,'0') + ":00";
            const shiftStart = buildDateTimeFromShiftDateISO(shiftDateISO, startHH, ctxObj.shiftType);
            const shiftEnd   = buildDateTimeFromShiftDateISO(shiftDateISO, endHH,   ctxObj.shiftType);

            const totalSec = Math.max(1, (shiftEnd.getTime() - shiftStart.getTime()) / 1000);

            const pauseShiftSecRaw = _computePauseSecondsFromSettings(shiftStart, shiftEnd, ctxObj.shiftDate);
            const pauseShiftSec = (pauseShiftSecRaw && pauseShiftSecRaw > 0) ? pauseShiftSecRaw : 30*60;

            const stopShiftSecGross = _computeStopSecondsOverlap(shiftStart, shiftEnd, ctxObj.shiftType, ctxObj.shiftDate);
            const stopShiftSecNet = Math.max(0, stopShiftSecGross - pauseShiftSec);

            // Temps net dispo (shift - pauses)
            const availShiftSec = Math.max(0, totalSec - pauseShiftSec);

            // Production nette th√©orique (enlevant les arr√™ts nets enregistr√©s)
            const netProdSecEnd = Math.max(0, availShiftSec - stopShiftSecNet);

            const ct = Math.max(1, Math.floor(cycleTimeSeconds || DEFAULT_CYCLE_TIME_SECONDS));
            _objectiveUnits = Math.floor(netProdSecEnd / ct);

            _netMinutes = Math.round(availShiftSec / 60);
            _stopsNetMinutes = Math.round(stopShiftSecNet / 60);

            const mm = Math.floor(ct / 60);
            const ss = String(ct % 60).padStart(2,'0');
            _cycleStr = `${mm}:${ss}`;
        }
    } catch(e) {
        // ignore
    }

    let msg = `*üåÖ RAPPORT D√âBUT DE SHIFT - √âquipe ${equipe}*\n`;
    msg += `*Shift:* ${currentShiftDate} (${config.name})\n`;
    msg += `*Heure:* ${new Date().toLocaleTimeString()}\n`;
    
    // Ajout du Team Leader actuel au rapport d√©but de shift
    const currentTeamLeader = document.getElementById("teamLeader").value || teamLeader;
    if (currentTeamLeader) {
        msg += `*Team Leader:* ${currentTeamLeader}\n`;
    }
    
    if (_objectiveUnits !== null) {
        msg += `*Objectif production fin de shift:* ${_objectiveUnits} v√©hicules\n`;
        if (_cycleStr !== null && _netMinutes !== null) {
            msg += `*Base calcul:* ${_netMinutes} min net | *Cycle:* ${_cycleStr}`;
            if (_stopsNetMinutes !== null) msg += ` | *Arr√™ts nets (enregistr√©s):* ${_stopsNetMinutes} min`;
            msg += `\n`;
        }
    }

    msg += `\n*--- PERFORMANCE SHIFT PR√âC√âDENT ---\n`;
    msg += `*Date du shift:* ${yesterdayShiftDate}\n`;
    msg += `*Arr√™ts:* ${yesterdayStops.length}\n`;
    msg += `*Temps d'arr√™t net:* ${formatDuration(yesterdayNetDuration)}\n`;
    if (yesterdayStops.length > 0) {
        const avgDuration = Math.round(yesterdayNetDuration / yesterdayStops.length);
        msg += `*Dur√©e moyenne par arr√™t:* ${formatDuration(avgDuration)}\n`;
        const causes = {};
        yesterdayStops.forEach(h => {
            causes[h.cause] = (causes[h.cause] || 0) + h.duration;
        });
        const topCause = Object.entries(causes).sort(([,a], [,b]) => b - a)[0];
        if (topCause) {
            msg += `*Cause principale:* ${topCause[0]} (${formatDuration(topCause[1])})\n`;
        }
    } else {
        msg += `*Aucun arr√™t enregistr√© hier*\n`;
    }
    
    msg += `\n*--- PLANIFICATION DU SHIFT ---\n`;
    msg += `*Absences pr√©vues:* ${plannedAbsences.length}\n`;
    if (plannedAbsences.length > 0) {
        msg += `*D√©tail des absences :*\n`;
        plannedAbsences.forEach(a => {
            msg += ` ‚Ä¢ ${a.poste} - ${a.type} (${a.durationDays}j)\n`;
        });
        const totalAbsenceDays = plannedAbsences.reduce((a, b) => a + b.durationDays, 0);
        msg += `*Total jours d'absence:* ${totalAbsenceDays}j\n`;
    } else {
        msg += `*Aucune absence pr√©vue aujourd'hui*\n`;
    }
    
    msg += `\n_üìà Bon shift √† toute l'√©quipe !_`;
    sendWhatsApp(msg);
}

document.getElementById("whStartBtn").onclick = sendWhatsAppStartShift;

function sendWhatsApp(message) {
    const encodedMsg = encodeURIComponent(message);
    window.open(`https://wa.me/?text=${encodedMsg}`, '_blank');
}

// =============================================
// FIREBASE RESET ROOM (TEAM) + ARCHIVE R√âSUM√â
// =============================================
function closePostSendModal(){
  try{ document.getElementById('postSendModal').style.display='none'; }catch(e){}
}

function firebaseReadyForPurge(){
  return !!(window.onlineConnected && window.onlineMode==='firebase' && window.onlineFirebaseDb && window.onlineFirebaseRoom);
}

function firebaseRoomName(){
  return (window.onlineFirebaseRoom || (document.getElementById('onlineRoom')?.value||'')).toString().trim();
}

async function purgeFirebaseRoom(opts={keepArchives:true}){
  if(!firebaseReadyForPurge()){
    alert('‚ö†Ô∏è Connectez-vous en Mode en ligne ‚Üí Firebase (Room) avant le nettoyage.');
    return;
  }
  if(!window.onlineFirebaseAdmin){
    alert('‚ö†Ô∏è Vous √™tes en mode Viewer. Activez Admin/Write pour pouvoir effacer Firebase.');
    return;
  }

  const room = firebaseRoomName();
  if(!room){ alert('Room vide.'); return; }

  // optional archive
  if(opts.keepArchives && window.__lastShiftReportPayload){
    try{
      const p = window.__lastShiftReportPayload;
      const d = new Date();
      const key = d.toISOString().slice(0,10);
      const path = `archives/${key}/finShift_${Date.now()}`;
      await window.onlineFirebaseDb.ref(`rooms/${room}/${path}`).set({
        ...p,
        savedAt: window.firebase?.database?.ServerValue?.TIMESTAMP || Date.now()
      });
    }catch(e){ console.log('Archive failed', e); }
  }

  // purge heavy nodes
  const base = `rooms/${room}`;
  const targets = [
    'state',
    'stops',
    'stations',
    'posts',
    'calls',
    'presence',
    'defectsByDate'
  ];

  for(const t of targets){
    try{ await window.onlineFirebaseDb.ref(`${base}/${t}`).remove(); }catch(e){ console.log('Remove failed', t, e); }
  }

  // local purge to keep device light too
  try{ history=[]; absenceHistory=[]; chatMessages=[]; posts=[]; }catch(e){}
  try{ LS.setItem('HISTO', JSON.stringify(history||[])); }catch(e){}
  try{ LS.setItem('ABSENCES', JSON.stringify(absenceHistory||[])); }catch(e){}
  try{ if(typeof refreshTable==='function') refreshTable(); }catch(e){}
  try{ if(typeof refreshAbsenceStats==='function') refreshAbsenceStats(); }catch(e){}
  try{ if(typeof updateAllCharts==='function') updateAllCharts(); }catch(e){}

  closePostSendModal();
  alert('‚úÖ Nettoyage Firebase termin√© (Room: ' + room + ').');
}

function confirmFirebasePurgeAfterSend(){
  const keep = document.getElementById('purgeKeepArchives')?.checked ?? true;
  const room = firebaseRoomName() || '(Room)';
  if(!confirm('‚ö†Ô∏è Confirmation: effacer l\'historique Firebase pour toute l\'√©quipe dans ' + room + ' ?')) return;
  purgeFirebaseRoom({keepArchives: keep});
}

function resetFirebaseRoomTeam(){
  const room = firebaseRoomName() || '(Room)';
  if(!confirm('‚ö†Ô∏è Ceci va effacer FIREBASE (Room) pour toute l\'√©quipe: ' + room + '\n\nOK ?')) return;
  // show modal to allow archive choice
  try{ document.getElementById('clearModal').style.display='none'; }catch(e){}
  try{ document.getElementById('postSendModal').style.display='flex'; }catch(e){}
}


document.getElementById("csvBtn").onclick = () => {
    // Export "quotidien": uniquement les arr√™ts du jour (date de shift)
    const now = new Date();
    const ctx = (typeof getActiveShiftContext === "function")
      ? getActiveShiftContext(now)
      : { shiftDate: (typeof formatShiftDate === "function" ? formatShiftDate(now) : now.toISOString().slice(0,10)), shiftType: (typeof currentShiftType !== "undefined" ? currentShiftType : "") };

    const shiftDateStr = String(ctx.shiftDate || "");
    const shiftDateISO = (typeof shiftDateStrToISO === "function")
      ? (shiftDateStrToISO(shiftDateStr) || now.toISOString().slice(0,10))
      : now.toISOString().slice(0,10);

    const team = (typeof equipe !== "undefined" ? equipe : "");
    const filtered = (history || []).filter(h => String(h.equipe || "") === String(team) && String(h.date || "") === shiftDateStr);

    if (filtered.length === 0) {
        alert("Aucun arr√™t enregistr√© pour " + shiftDateStr + " (√©quipe " + team + ").");
        return;
    }

    let csv = "DateShift,Cause,D√©but,Fin,Dur√©e(s),√âquipe,Team Leader,Type,Shift,ShiftDateISO,Temps Cycle (s)\n";

    filtered.forEach(h => {
        const t = (h.type === "rat√©") ? "Arr√™t rat√©" : (h.type === "sp√©cial" ? "Arr√™t sp√©cial" : "Arr√™t normal");
        const st = (typeof getStopShiftType === "function") ? getStopShiftType(h) : (h.shiftType || (typeof currentShiftType !== "undefined" ? currentShiftType : ""));
        const config = (typeof shiftConfigs !== "undefined" && shiftConfigs && shiftConfigs[st]) ? shiftConfigs[st] : ((typeof shiftConfigs !== "undefined" && shiftConfigs) ? shiftConfigs[currentShiftType] : null);
        const shiftInfo = config ? config.name : st;

        const cause = String(h.cause || "").replace(/"/g, '""');
        const start = h.start || "";
        const end = h.end || "";
        const duration = (typeof h.duration === "number") ? h.duration : (parseInt(h.duration, 10) || 0);
        const tl = String(h.teamLeader || "").replace(/"/g, '""');
        const ct = (typeof cycleTimeSeconds !== "undefined") ? cycleTimeSeconds : "";

        csv += `${shiftDateStr},"${cause}",${start},${end},${duration},${team},"${tl}",${t},"${shiftInfo}",${shiftDateISO},${ct}\n`;
    });

    const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);

    // Nom de fichier: Arrets_YYYY-MM-DD_EquipeA_ShiftNuit.csv
    const stNow = String(ctx.shiftType || "");
    a.download = `Arrets_${shiftDateISO}_Equipe${team}_Shift${stNow}.csv`;

    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
};

document.getElementById("csvAbsencesBtn").onclick = () => {
    const filtered = absenceHistory.filter(a => a.equipe === equipe);
    let csv = "Date,Type_Absence,Poste_Op√©rateur,Dur√©e(Jours),Dur√©e(Heures),√âquipe,Timestamp,Shift\n";
    filtered.forEach(a => {
        const config = shiftConfigs[currentShiftType];
        const shiftInfo = `Shift ${a.date} (${config.name})`;
        csv += `${a.date},${a.type},"${a.poste.replace(/"/g, '""')}",${a.durationDays},${a.durationHours},${a.equipe},${new Date(a.timestamp).toLocaleString()},"${shiftInfo}"\n`;
    });
    let blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
    let a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `Absences_Stellantis_Equipe${equipe}_Shift${currentShiftType}_${new Date().toISOString().slice(0,10)}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
};

document.getElementById("whBtn").onclick = sendWhatsAppCurrent;

document.getElementById("whShiftBtn").onclick = () => {
    try{ document.getElementById('periodSelect').value = 'today'; }catch(e){}
    try{ if(typeof selectReportTeam==='function') selectReportTeam(equipe); }catch(e){}
    document.getElementById('shiftModal').style.display = 'flex';
};

function selectReportTeam(team) {
    const clickedBtn = document.querySelector(`[onclick*="selectReportTeam('${team}')"]`);
    if (clickedBtn) {
        const buttons = document.querySelectorAll('#shiftModal .filter-btn');
        buttons.forEach(btn => btn.classList.remove('active'));
        clickedBtn.classList.add('active');
    }
    currentReportTeam = team;
}

function closeShiftModal() {
    document.getElementById('shiftModal').style.display = 'none';
}

function sendShiftReport() {
    const period = document.getElementById('periodSelect').value;
    const team = currentReportTeam || equipe;

    let filteredStops = history.filter(h => h.equipe === team);
    let filteredAbsences = absenceHistory.filter(a => a.equipe === team);

    // Filtrer par p√©riode SHIFT
    filteredStops = filterByShiftPeriod(filteredStops, period);
    filteredAbsences = filterByShiftPeriod(filteredAbsences, period);

    if (filteredStops.length === 0 && filteredAbsences.length === 0) {
        alert("Aucun arr√™t ni absence enregistr√© pour cette p√©riode pour l'√©quipe " + team + ".");
        return;
    }

    // Calcul dur√©es
    const totalDurationGross = filteredStops.reduce((a, b) => a + b.duration, 0);
    const pauseData = calculateTotalPauseMinutes();
    const pauseSeconds = (pauseData.total || 0) * 60;
    const totalDurationNet = Math.max(0, totalDurationGross - pauseSeconds);

    const totalAbsenceDays = filteredAbsences.reduce((a, b) => a + b.durationDays, 0);
    const totalAbsenceHours = filteredAbsences.reduce((a, b) => a + b.durationHours, 0);
    const uniquePosts = new Set(filteredAbsences.map(a => a.poste)).size;

    let periodText = {
        'today': 'Shift actuel (Aujourd\'hui)',
        'week': '4 derniers shifts',
        'month': '4 derniers shifts',
        'all': 'Tous shifts'
    }[period] || period;

    // ISO Week
    function isoWeekKey(d){
      const dt = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      const dayNum = dt.getUTCDay() || 7;
      dt.setUTCDate(dt.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(dt.getUTCFullYear(),0,1));
      const weekNo = Math.ceil((((dt - yearStart) / 86400000) + 1) / 7);
      const ww = String(weekNo).padStart(2,'0');
      return `${dt.getUTCFullYear()}-S${ww}`;
    }

    const now = new Date();
    const weekKey = isoWeekKey(now);

    // Team leader
    const latestTeamLeader = filteredStops.length > 0 ? filteredStops[filteredStops.length - 1].teamLeader : '';

    // Top causes (net seconds by cause)
    const byCause = {};
    filteredStops.forEach(h => { byCause[h.cause] = (byCause[h.cause] || 0) + (h.duration || 0); });
    const topCauses = Object.entries(byCause).sort(([,a],[,b]) => b-a).slice(0,5);

    let msg = `*üìã RAPPORT FIN DE SHIFT - √âquipe ${team}*\n`;
    msg += `*P√©riode:* ${periodText}\n`;
    msg += `*Date:* ${now.toLocaleDateString()}\n`;
    msg += `*Heure:* ${now.toLocaleTimeString()}\n`;
    msg += `*Semaine:* ${weekKey}\n`;

    try{
      const config = shiftConfigs[currentShiftType];
      if(config && config.name) msg += `*Shift:* ${config.name} (Type ${currentShiftType})\n`;
    }catch(e){}

    if (latestTeamLeader) msg += `*Team Leader:* ${latestTeamLeader}\n`;

    msg += `\n*--- ARR√äTS CHA√éNE ---*\n`;
    msg += `*Total arr√™ts:* ${filteredStops.length}\n`;
    msg += `*Temps total (Net):* ${formatDuration(totalDurationNet)}\n`;
    msg += `*Temps total (Brut):* ${formatDuration(totalDurationGross)}\n`;
    if(topCauses.length){
      msg += `\n*Top Causes:*\n`;
      topCauses.forEach(([c,sec])=>{ msg += ` ‚Ä¢ ${c}: ${formatDuration(sec)}\n`; });
    }

    msg += `\n*--- ABSENCES ---*\n`;
    msg += `*Nb Absences (√âv√©nements):* ${filteredAbsences.length}\n`;
    msg += `*Nb Postes concern√©s:* ${uniquePosts}\n`;
    msg += `*Total Jours Absences:* ${totalAbsenceDays}j\n`;
    msg += `*Total Heures Absences:* ${totalAbsenceHours}h\n`;

    if (filteredAbsences.length > 0) {
        msg += `*R√©partition par Type :*\n`;
        const byType = {};
        filteredAbsences.forEach(a => {
            byType[a.type] = (byType[a.type] || {days: 0, count: 0});
            byType[a.type].days += a.durationDays;
            byType[a.type].count++;
        });
        Object.entries(byType).forEach(([type, data]) => {
            msg += ` ‚Ä¢ ${type}: ${data.count}x - ${data.days}j\n`;
        });
    }

    // Open WhatsApp
    sendWhatsApp(msg);

    // Close report modal
    closeShiftModal();

    // Show post-send modal (to cleanup firebase)
    try{
      document.getElementById('postSendModal').style.display = 'flex';
      window.__lastShiftReportPayload = {
        team, period, weekKey,
        createdAt: Date.now(),
        msg,
        stats: {
          stops: filteredStops.length,
          netSeconds: totalDurationNet,
          grossSeconds: totalDurationGross,
          absences: filteredAbsences.length,
          absDays: totalAbsenceDays,
          absHours: totalAbsenceHours,
          topCauses
        }
      };
    }catch(e){}
}


// =============================================
// SAUVEGARDE MANUELLE (LOCAL + INDEXEDDB + DIFFUSION EN LIGNE)
// =============================================

async function saveStopChanges(sourceBtnId = "manualSaveBtn") {
    const btn = document.getElementById(sourceBtnId);
    const otherId = (sourceBtnId === "manualSaveBtn") ? "saveChangesBtn" : "manualSaveBtn";
    const otherBtn = document.getElementById(otherId);

    const originalText = btn ? btn.innerHTML : "";

    try {
        if (btn) {
            btn.innerHTML = 'üíæ Sauvegarde en cours...';
            btn.disabled = true;
        }
        if (otherBtn) otherBtn.disabled = true;

        // 1) Persistance locale
        LS.setItem("HISTO", JSON.stringify(history));
        LS.setItem("ABSENCES", JSON.stringify(absenceHistory));
        LS.setItem("OBJECTIFS", JSON.stringify(objectifs || {}));
        LS.setItem("TEAM_LEADER", teamLeader || "");
        try { LS.setItem("ONLINE_LOCAL_UPDATED_AT", String(Date.now())); } catch(e) {}

        // 2) IndexedDB (offline durable)
        await saveToIndexedDB();

        // 3) Diffusion en ligne (Supabase / Socket) - forcer l'envoi
        try {
            if (typeof onlineTick === "function" && onlineConnected) {
                onlineTick(true);
            }
        } catch(e) {}

        // 4) Diffusion P2P (si connect√©)
        try {
            if (typeof sendSyncData === "function" && typeof connections !== "undefined" && connections && connections.size > 0) {
                connections.forEach((conn, peerId) => {
                    try { sendSyncData(peerId); } catch(e) {}
                });
            }
        } catch(e) {}

        document.getElementById("autoSaveSound").play().catch(() => {});
        showNotification("‚úÖ Modifications sauvegard√©es", "success");

        // Rafra√Æchir affichage
        refreshTable();

    } catch (error) {
        console.error('Erreur de sauvegarde:', error);
        showNotification('‚ùå Erreur lors de la sauvegarde: ' + (error?.message || error), "warning");
        alert('Erreur lors de la sauvegarde: ' + (error?.message || error));
    } finally {
        if (btn) {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
        if (otherBtn) otherBtn.disabled = false;
    }
}

document.getElementById("manualSaveBtn").onclick = () => saveStopChanges("manualSaveBtn");
const saveChangesBtn = document.getElementById("saveChangesBtn");
if (saveChangesBtn) saveChangesBtn.onclick = () => saveStopChanges("saveChangesBtn");

// =============================================
// GESTION DE LA VISIBILIT√â
// =============================================

document.addEventListener('visibilitychange', async () => {
    if (document.hidden) {
        console.log('Page cach√©e - Sauvegarde urgente');
        if (db) await saveToIndexedDB();
        cancelPauseAlarms();
        
        if (start) {
            console.log('Arr√™t en cours - mise en pause virtuelle');
        }
        
    } else {
        console.log('Page visible - Restauration');
        if (db) await restoreFromIndexedDB();
        refreshTable();
        refreshAbsenceStats();
        try { updateCausesTraceabilityTables(history); } catch(e) {}
    updateAllCharts();
        schedulePauseAlarms();
        
        if (start) {
            const now = new Date();
            const diff = Math.floor((now - start) / 1000);
            if (diff > 300) {
                if (confirm("Un arr√™t √©tait en cours pendant votre absence. Voulez-vous le terminer maintenant?")) {
                    document.getElementById("goBtn").click();
                }
            }
        }
    }
});

// =============================================
// GRAPHIQUES PARETO
// =============================================

function getTabText(tabName) {
    const map = {
        'paretoHours': 'üïí Tendance Temporelle',
        'paretoCauses': 'üìä Pareto 80/20 Causes',
        'paretoStops': 'üìà Pareto Nombre Arr√™ts',
        'paretoAbsences': 'üë• Pareto Absences',
        'teamPerformance': '‚≠ê Performance √âquipes',
        'postsBoard': 'üìù Posts',
        'aiReport': 'üß† Rapport PDF + 5 Pourquoi'
    };
    return map[tabName] || '';
}

function showTab(tabName) {
    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.chart-container').forEach(container => container.classList.remove('active'));
    
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(tab => {
        if (tab.textContent.includes(getTabText(tabName))) {
            tab.classList.add('active');
        }
    });
    
    const container = document.getElementById(`${tabName}ChartContainer`);
    if (container) {
        container.classList.add('active');
    }
    
    switch(tabName) {
        case 'paretoHours':
            updateParetoHoursChart();
            break;
        case 'paretoCauses':
            updateParetoCausesChart();
            break;
        case 'paretoStops':
            updateParetoStopsChart();
            break;
        case 'teamPerformance':
            updateTeamPerformanceChart();
            break;
        case 'paretoAbsences':
            updateParetoAbsencesChart();
            break;
        case 'postsBoard':
            renderPostsBoard();
            break;
        case 'aiReport':
            updateAIReport();
            break;
    }
}

function updateAllCharts() {
    const activeContainer = document.querySelector('.chart-container.active');
    if (!activeContainer) return;
    
    const containerId = activeContainer.id;
    if (containerId.includes('Hours')) updateParetoHoursChart();
    else if (containerId.includes('Causes')) updateParetoCausesChart();
    else if (containerId.includes('Stops')) updateParetoStopsChart();
    else if (containerId.includes('Performance')) updateTeamPerformanceChart();
    else if (containerId.includes('Absences')) updateParetoAbsencesChart();
}

// FILTRES
function filterHours(team) {
    document.querySelectorAll('#paretoHoursChartContainer .filter-group:first-child .filter-btn').forEach(btn => btn.classList.remove('active'));
    const clickedBtn = document.querySelector(`[onclick*="filterHours('${team}')"]`);
    if (clickedBtn) clickedBtn.classList.add('active');
    currentFilter.hours = team;
    updateParetoHoursChart();
}

function filterCauses(team) {
    document.querySelectorAll('#paretoCausesChartContainer .filter-group:first-child .filter-btn').forEach(btn => btn.classList.remove('active'));
    const clickedBtn = document.querySelector(`[onclick*="filterCauses('${team}')"]`);
    if (clickedBtn) clickedBtn.classList.add('active');
    currentFilter.causes = team;
    updateParetoCausesChart();
}

function filterStops(team) {
    document.querySelectorAll('#paretoStopsChartContainer .filter-group:first-child .filter-btn').forEach(btn => btn.classList.remove('active'));
    const clickedBtn = document.querySelector(`[onclick*="filterStops('${team}')"]`);
    if (clickedBtn) clickedBtn.classList.add('active');
    currentFilter.stops = team;
    updateParetoStopsChart();
}

function filterAbsences(team) {
    document.querySelectorAll('#paretoAbsencesChartContainer .filter-group:first-child .filter-btn').forEach(btn => btn.classList.remove('active'));
    const clickedBtn = document.querySelector(`[onclick*="filterAbsences('${team}')"]`);
    if (clickedBtn) clickedBtn.classList.add('active');
    currentFilter.absences = team;
    updateParetoAbsencesChart();
}

function setChartPeriod(period) {
    const activeContainer = document.querySelector('.chart-container.active');
    const periodButtons = activeContainer.querySelectorAll('.filter-group:nth-child(2) .filter-btn');
    periodButtons.forEach(btn => btn.classList.remove('active'));
    
    const clickedBtn = event.target;
    clickedBtn.classList.add('active');
    
    currentFilter.period = period;
    
    try { updateCausesTraceabilityTables(history); } catch(e) {}
    updateAllCharts();
}

function filterPerformance(period) {
    document.querySelectorAll('#teamPerformanceChartContainer .filter-group:first-child .filter-btn').forEach(btn => btn.classList.remove('active'));
    const clickedBtn = document.querySelector(`[onclick*="filterPerformance('${period}')"]`);
    if (clickedBtn) clickedBtn.classList.add('active');
    currentFilter.performance = period;
    updateTeamPerformanceChart();
}

function filterMetric(metric) {
    document.querySelectorAll('#teamPerformanceChartContainer .filter-group:nth-child(2) .filter-btn').forEach(btn => btn.classList.remove('active'));
    const clickedBtn = document.querySelector(`[onclick*="filterMetric('${metric}')"]`);
    if (clickedBtn) clickedBtn.classList.add('active');
    currentFilter.metric = metric;
    updateTeamPerformanceChart();
}

function updateCausesTraceabilityTables(stops) {
    // stops = liste d√©j√† filtr√©e (√©quipe + p√©riode)
    const tbody = document.getElementById('causesTraceBody');
    const missedTbody = document.getElementById('missedStopsTraceBody');

    // Si la zone n'existe pas (onglet non affich√©), ne rien faire
    if (!tbody && !missedTbody) return;

    const arr = Array.isArray(stops) ? stops : [];

    // --- Grille des causes ---
    if (tbody) {
        const map = new Map();
        arr.forEach(s => {
            const cause = (s.cause || 'Non sp√©cifi√©').trim();
            if (!map.has(cause)) {
                map.set(cause, { cause, duration: 0, count: 0, missed: 0, examples: [] });
            }
            const item = map.get(cause);
            item.duration += (s.duration || 0);
            item.count += 1;
            if (isMissedStop(s)) item.missed += 1;

            // Exemples horaires (max 4)
            if (item.examples.length < 4) {
                const tag = isMissedStop(s) ? '‚è±Ô∏è ' : '';
                const start = s.start || '-';
                const end = s.end || '-';
                item.examples.push(`${tag}${start}-${end}`);
            }
        });

        const rows = Array.from(map.values()).sort((a,b) => b.duration - a.duration);
        const top = rows.slice(0, 15); // "afficher plus" -> top 15

        tbody.innerHTML = '';
        top.forEach(r => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.06);">${escapeHtml(r.cause)}</td>
                <td style="padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.06); text-align:right;">${formatDuration(r.duration)}</td>
                <td style="padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.06); text-align:right;">${r.count}</td>
                <td style="padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.06); text-align:right; color: var(--warning); font-weight: 800;">${r.missed}</td>
                <td style="padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.06); color:#9aa4b2;">${escapeHtml(r.examples.join(' ‚Ä¢ '))}</td>
            `;
            tbody.appendChild(tr);
        });

        if (rows.length > 15) {
            const trMore = document.createElement('tr');
            trMore.innerHTML = `<td colspan="5" style="padding:10px; color:#9aa4b2; text-align:center;">‚Ä¶ +${rows.length - 15} autres causes non affich√©es.</td>`;
            tbody.appendChild(trMore);
        }

        if (top.length === 0) {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td colspan="5" style="padding:10px; color:#9aa4b2; text-align:center;">Aucune donn√©e sur ce filtre.</td>`;
            tbody.appendChild(tr);
        }
    }

    // --- Liste des arr√™ts rat√©s ---
    if (missedTbody) {
        const missed = arr.filter(s => isMissedStop(s)).sort((a,b) => (b.timestamp || 0) - (a.timestamp || 0));
        const maxRows = 30;

        missedTbody.innerHTML = '';
        missed.slice(0, maxRows).forEach(s => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.06);">${escapeHtml(s.date || '')}</td>
                <td style="padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.06);">${escapeHtml(s.start || '')}</td>
                <td style="padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.06);">${escapeHtml(s.end || '')}</td>
                <td style="padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.06); text-align:right;">${formatDuration(s.duration || 0)}</td>
                <td style="padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.06);">${escapeHtml(s.cause || '')}</td>
                <td style="padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.06);">√âquipe ${escapeHtml(s.equipe || '')}</td>
            `;
            missedTbody.appendChild(tr);
        });

        if (missed.length === 0) {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td colspan="6" style="padding:10px; color:#9aa4b2; text-align:center;">Aucun arr√™t rat√© sur ce filtre.</td>`;
            missedTbody.appendChild(tr);
        } else if (missed.length > maxRows) {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td colspan="6" style="padding:10px; color:#9aa4b2; text-align:center;">‚Ä¶ ${missed.length - maxRows} autres arr√™ts rat√©s non affich√©s.</td>`;
            missedTbody.appendChild(tr);
        }
    }
}

// NOUVEAU DESIGN PARETO CAUSES - BARRES ET 80/20% CLAIRS
function updateParetoCausesChart() {
    const ctxShift = getActiveShiftContext(new Date());
    let filtered = history;

    // Filtre √©quipe (si demand√©)
    if (currentFilter.causes !== 'all') {
        filtered = filtered.filter(h => h.equipe === currentFilter.causes);
    }

    // Toujours: seulement le shift s√©lectionn√© (date + type)
    filtered = filtered.filter(h => h.date === ctxShift.shiftDate && getStopShiftType(h) === ctxShift.shiftType);

    // Mettre √† jour la grille tra√ßabilit√© (inclut les arr√™ts rat√©s)
    updateCausesTraceabilityTables(filtered);
    
    let causesData = {};
    filtered.forEach(h => {
        const cause = h.cause || 'Non sp√©cifi√©';
        causesData[cause] = (causesData[cause] || 0) + h.duration;
    });
    
    let sortedCauses = Object.entries(causesData)
        .sort(([,a], [,b]) => b - a);
    
    const topCauses = sortedCauses.slice(0, 8); // Limit√© √† 8 causes pour plus de clart√©
    
    const totalDuration = topCauses.reduce((sum, [, duration]) => sum + duration, 0);
    let cumulativeDuration = 0;
    let cumulativePercentage = [];
    
    const barData = topCauses.map(([, duration]) => duration);
    topCauses.forEach(([, duration]) => {
        cumulativeDuration += duration;
        cumulativePercentage.push((cumulativeDuration / totalDuration) * 100);
    });
    
    let labels = topCauses.map(([cause]) => cause.length > 20 ? cause.substring(0, 20) + '...' : cause);
    
    const ctx = document.getElementById('paretoCausesChart').getContext('2d');
    
    if (charts.paretoCauses) charts.paretoCauses.destroy();
    
    // Nouveau design avec barres color√©es et 80/20 tr√®s visible
    const barColors = [
        'rgba(42, 157, 143, 0.9)',   // Vert
        'rgba(26, 125, 255, 0.9)',   // Bleu
        'rgba(255, 159, 28, 0.9)',   // Orange
        'rgba(216, 4, 41, 0.9)',     // Rouge
        'rgba(148, 0, 211, 0.9)',    // Violet
        'rgba(50, 205, 50, 0.9)',    // Vert clair
        'rgba(30, 144, 255, 0.9)',   // Bleu clair
        'rgba(255, 69, 0, 0.9)'      // Rouge-orange
    ];
    
    charts.paretoCauses = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Dur√©e Totale (secondes)',
                    data: barData,
                    backgroundColor: barColors,
                    borderColor: barColors.map(color => color.replace('0.9', '1')),
                    borderWidth: 2,
                    borderRadius: 6,
                    yAxisID: 'y'
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(13, 27, 42, 0.95)',
                    titleColor: '#2a9d8f',
                    bodyColor: '#e0e1dd',
                    borderColor: '#2a9d8f',
                    borderWidth: 1,
                    cornerRadius: 8,
                    callbacks: {
                        label: function(context) {
                            const value = context.parsed.y;
                            const percentage = (value / totalDuration * 100).toFixed(1);
                            return [`Dur√©e: ${formatDuration(value)}`, `Part: ${percentage}%`];
                        },
                        afterLabel: function(context) {
                            const index = context.dataIndex;
                            if (index < cumulativePercentage.length) {
                                return `Cumul: ${cumulativePercentage[index].toFixed(1)}%`;
                            }
                            return '';
                        }
                    }
                },
                annotation: {
                    annotations: {
                        line80: {
                            type: 'line',
                            yMin: 80,
                            yMax: 80,
                            borderColor: 'rgba(217, 4, 41, 0.9)',
                            borderWidth: 3,
                            borderDash: [10, 5],
                            label: {
                                enabled: true,
                                content: '80% - R√®gle Pareto',
                                position: 'end',
                                backgroundColor: 'rgba(217, 4, 41, 0.9)',
                                color: '#fff',
                                font: {
                                    size: 11,
                                    weight: 'bold'
                                }
                            }
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    type: 'linear',
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Dur√©e totale (secondes)',
                        color: '#2a9d8f',
                        font: {
                            size: 14,
                            weight: 'bold'
                        }
                    },
                    grid: { 
                        color: 'rgba(255,255,255,0.1)',
                        drawBorder: false
                    },
                    ticks: { 
                        color: '#e0e1dd',
                        font: {
                            size: 12
                        }
                    }
                },
                y1: {
                    type: 'linear',
                    position: 'right',
                    min: 0,
                    max: 100,
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: '% Cumul√© (80/20)',
                        color: '#ff9f1c',
                        font: {
                            size: 14,
                            weight: 'bold'
                        }
                    },
                    grid: { drawOnChartArea: false },
                    ticks: { 
                        color: '#ff9f1c',
                        font: {
                            size: 12
                        },
                        callback: function(value) {
                            if (value === 80) return '80% Pareto';
                            return value + "%";
                        }
                    }
                },
                x: {
                    grid: { 
                        color: 'rgba(255,255,255,0.1)',
                        drawBorder: false
                    },
                    ticks: { 
                        color: '#e0e1dd',
                        font: {
                            size: 11
                        },
                        maxRotation: 45,
                        minRotation: 45
                    }
                }
            },
            animation: {
                duration: 1000,
                easing: 'easeOutQuart'
            }
        }
    });
    
    // Ajouter manuellement les pourcentages cumul√©s
    setTimeout(() => {
        const chartInstance = charts.paretoCauses;
        const meta = chartInstance.getDatasetMeta(0);
        
        // Dessiner les pourcentages cumul√©s au-dessus des barres
        chartInstance.ctx.save();
        chartInstance.ctx.font = 'bold 11px Arial';
        chartInstance.ctx.fillStyle = '#ff9f1c';
        chartInstance.ctx.textAlign = 'center';
        
        meta.data.forEach((bar, index) => {
            if (index < cumulativePercentage.length) {
                const percentage = cumulativePercentage[index];
                const x = bar.x;
                const y = bar.y - 10;
                
                // Changer la couleur si on d√©passe 80%
                if (percentage >= 80) {
                    chartInstance.ctx.fillStyle = '#d90429';
                } else {
                    chartInstance.ctx.fillStyle = '#ff9f1c';
                }
                
                chartInstance.ctx.fillText(`${percentage.toFixed(1)}%`, x, y);
            }
        });
        
        chartInstance.ctx.restore();
    }, 500);
}

// NOUVEAU DESIGN PARETO ABSENCES - BARRES ET 80/20% CLAIRS
function updateParetoAbsencesChart() {
    let filtered = absenceHistory;
    if (currentFilter.absences !== 'all') {
        filtered = absenceHistory.filter(a => a.equipe === currentFilter.absences);
    }
    
    // Filtrer par p√©riode shift
    if (currentFilter.period && currentFilter.period !== 'all') {
        filtered = filterByShiftPeriod(filtered, currentFilter.period, 'date');
    }

    let absencesData = {};
    filtered.forEach(a => {
        absencesData[a.type] = (absencesData[a.type] || 0);
        absencesData[a.type] += a.durationDays;
    });
    
    let sortedAbsences = Object.entries(absencesData)
        .sort(([,a], [,b]) => b - a);
    
    const topAbsences = sortedAbsences.slice(0, 8); // Limit√© √† 8 types pour plus de clart√©
    
    const totalDays = topAbsences.reduce((sum, [, days]) => sum + days, 0);
    let cumulativeDays = 0;
    let cumulativePercentage = [];
    
    const barData = topAbsences.map(([, days]) => days);
    topAbsences.forEach(([, days]) => {
        cumulativeDays += days;
        cumulativePercentage.push((cumulativeDays / totalDays) * 100);
    });
    
    let labels = topAbsences.map(([type]) => {
        // Raccourcir les libell√©s longs
        const shortTypes = {
            'AA': 'Absence Autoris√©e',
            'AI': 'Absence Irr√©guli√®re',
            'CM': 'Cong√©s M√©dical',
            'CR': 'Cong√©s R√©cup√©ration',
            'CA': 'Cong√©s Annuels',
            'SU': 'Suspendu'
        };
        return shortTypes[type] || (type.length > 15 ? type.substring(0, 15) + '...' : type);
    });
    
    const ctx = document.getElementById('paretoAbsencesChart').getContext('2d');
    
    if (charts.paretoAbsences) charts.paretoAbsences.destroy();
    
    // Nouveau design avec barres color√©es
    const barColors = [
        'rgba(14, 165, 233, 0.9)',   // Bleu info
        'rgba(26, 125, 255, 0.9)',   // Bleu primaire
        'rgba(42, 157, 143, 0.9)',   // Vert
        'rgba(255, 159, 28, 0.9)',   // Orange
        'rgba(148, 0, 211, 0.9)',    // Violet
        'rgba(50, 205, 50, 0.9)',    // Vert clair
        'rgba(30, 144, 255, 0.9)',   // Bleu clair
        'rgba(255, 69, 0, 0.9)'      // Rouge-orange
    ];
    
    charts.paretoAbsences = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Jours d\'Absence',
                    data: barData,
                    backgroundColor: barColors,
                    borderColor: barColors.map(color => color.replace('0.9', '1')),
                    borderWidth: 2,
                    borderRadius: 6,
                    yAxisID: 'y'
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(13, 27, 42, 0.95)',
                    titleColor: '#0ea5e9',
                    bodyColor: '#e0e1dd',
                    borderColor: '#0ea5e9',
                    borderWidth: 1,
                    cornerRadius: 8,
                    callbacks: {
                        label: function(context) {
                            const value = context.parsed.y;
                            const percentage = (value / totalDays * 100).toFixed(1);
                            return [`Jours: ${value.toFixed(1)}`, `Part: ${percentage}%`];
                        },
                        afterLabel: function(context) {
                            const index = context.dataIndex;
                            if (index < cumulativePercentage.length) {
                                return `Cumul: ${cumulativePercentage[index].toFixed(1)}%`;
                            }
                            return '';
                        }
                    }
                },
                annotation: {
                    annotations: {
                        line80: {
                            type: 'line',
                            yMin: 80,
                            yMax: 80,
                            borderColor: 'rgba(217, 4, 41, 0.9)',
                            borderWidth: 3,
                            borderDash: [10, 5],
                            label: {
                                enabled: true,
                                content: '80% - R√®gle Pareto',
                                position: 'end',
                                backgroundColor: 'rgba(217, 4, 41, 0.9)',
                                color: '#fff',
                                font: {
                                    size: 11,
                                    weight: 'bold'
                                }
                            }
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    type: 'linear',
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Jours d\'absence',
                        color: '#0ea5e9',
                        font: {
                            size: 14,
                            weight: 'bold'
                        }
                    },
                    grid: { 
                        color: 'rgba(255,255,255,0.1)',
                        drawBorder: false
                    },
                    ticks: { 
                        color: '#e0e1dd',
                        font: {
                            size: 12
                        }
                    }
                },
                y1: {
                    type: 'linear',
                    position: 'right',
                    min: 0,
                    max: 100,
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: '% Cumul√© (80/20)',
                        color: '#ff9f1c',
                        font: {
                            size: 14,
                            weight: 'bold'
                        }
                    },
                    grid: { drawOnChartArea: false },
                    ticks: { 
                        color: '#ff9f1c',
                        font: {
                            size: 12
                        },
                        callback: function(value) {
                            if (value === 80) return '80% Pareto';
                            return value + "%";
                        }
                    }
                },
                x: {
                    grid: { 
                        color: 'rgba(255,255,255,0.1)',
                        drawBorder: false
                    },
                    ticks: { 
                        color: '#e0e1dd',
                        font: {
                            size: 11
                        },
                        maxRotation: 45,
                        minRotation: 45
                    }
                }
            },
            animation: {
                duration: 1000,
                easing: 'easeOutQuart'
            }
        }
    });
    
    // Ajouter manuellement les pourcentages cumul√©s
    setTimeout(() => {
        const chartInstance = charts.paretoAbsences;
        const meta = chartInstance.getDatasetMeta(0);
        
        // Dessiner les pourcentages cumul√©s au-dessus des barres
        chartInstance.ctx.save();
        chartInstance.ctx.font = 'bold 11px Arial';
        chartInstance.ctx.textAlign = 'center';
        
        meta.data.forEach((bar, index) => {
            if (index < cumulativePercentage.length) {
                const percentage = cumulativePercentage[index];
                const x = bar.x;
                const y = bar.y - 10;
                
                // Changer la couleur si on d√©passe 80%
                if (percentage >= 80) {
                    chartInstance.ctx.fillStyle = '#d90429';
                } else {
                    chartInstance.ctx.fillStyle = '#ff9f1c';
                }
                
                chartInstance.ctx.fillText(`${percentage.toFixed(1)}%`, x, y);
            }
        });
        
        chartInstance.ctx.restore();
    }, 500);
}


// =============================================
// PARETO 80/20 ‚Äì Pertes de production (v√©hicules) par cause
// (int√©gr√© dans "CALCUL DE PRODUCTION DE V√âHICULES")
// =============================================
function updateParetoProductionLossChart() {
    try {
        const canvas = document.getElementById('paretoProductionLossChart');
        const summaryEl = document.getElementById('paretoProductionLossSummary');
        if (!canvas) return;

        const ctxShift = getActiveShiftContext(new Date());
        const ct = Math.max(1, Math.floor((cycleTimeSeconds || DEFAULT_CYCLE_TIME_SECONDS || 1)));

        // Cas: jour sans production
        if (typeof isNoProductionDay === "function" && isNoProductionDay(ctxShift.shiftDate)) {
            if (charts.paretoProdLoss) {
                try { charts.paretoProdLoss.destroy(); } catch(e) {}
                charts.paretoProdLoss = null;
            }
            const cctx = canvas.getContext('2d');
            cctx.clearRect(0, 0, canvas.width, canvas.height);
            if (summaryEl) summaryEl.innerHTML = "‚õî Jour sans production : aucun Pareto √† afficher.";
            return;
        }

        let filtered = Array.isArray(history) ? history.slice() : [];

        // Filtre √©quipe (coh√©rent avec _computeStopSecondsOverlap)
        if (typeof equipe !== "undefined" && equipe) {
            filtered = filtered.filter(h => h && h.equipe === equipe);
        }

        // Filtre shift s√©lectionn√© (date + type)
        filtered = filtered.filter(h => h && h.date === ctxShift.shiftDate && getStopShiftType(h) === ctxShift.shiftType);

        // Agr√©ger les pertes (v√©hicules) par cause
        const lossByCause = {};
        for (const h of filtered) {
            const cause = (h && h.cause) ? h.cause : 'Non sp√©cifi√©';
            const dur = Math.max(0, Number(h.duration) || 0); // secondes
            const lost = dur / ct; // v√©hicules perdus (approx)
            lossByCause[cause] = (lossByCause[cause] || 0) + lost;
        }

        let sorted = Object.entries(lossByCause)
            .filter(([, v]) => (Number(v) || 0) > 0.0001)
            .sort((a, b) => (b[1] || 0) - (a[1] || 0));

        // Limiter pour lisibilit√©
        const top = sorted.slice(0, 8);

        const totalLost = top.reduce((sum, [, v]) => sum + (Number(v) || 0), 0);

        // Si rien √† afficher
        if (!top.length || totalLost <= 0) {
            if (charts.paretoProdLoss) {
                try { charts.paretoProdLoss.destroy(); } catch(e) {}
                charts.paretoProdLoss = null;
            }
            const cctx = canvas.getContext('2d');
            cctx.clearRect(0, 0, canvas.width, canvas.height);
            if (summaryEl) summaryEl.innerHTML = "‚Äî Aucun arr√™t (ou dur√©e nulle) pour ce shift / √©quipe.";
            return;
        }

        // Cumul %
        let cum = 0;
        const cumPct = [];
        top.forEach(([, v]) => {
            cum += (Number(v) || 0);
            cumPct.push((cum / totalLost) * 100);
        });

        // Seuil 80% => combien de causes expliquent ~80% des pertes
        let idx80 = cumPct.findIndex(p => p >= 80);
        if (idx80 < 0) idx80 = top.length - 1;
        const nbCauses80 = idx80 + 1;
        const lost80 = top.slice(0, nbCauses80).reduce((s, [, v]) => s + (Number(v) || 0), 0);
        const pct80 = (lost80 / totalLost) * 100;

        const labels = top.map(([cause]) => {
            const c = String(cause || '');
            return c.length > 18 ? (c.substring(0, 18) + '‚Ä¶') : c;
        });

        const barData = top.map(([, v]) => Math.round((Number(v) || 0) * 10) / 10); // 1 d√©cimale
        const lineData = cumPct.map(v => Math.round(v * 10) / 10);
        const line80 = labels.map(() => 80);

        // Couleurs (r√©utiliser un style proche des autres graphes)
        const barColors = [
            'rgba(42, 157, 143, 0.9)',
            'rgba(26, 125, 255, 0.9)',
            'rgba(255, 159, 28, 0.9)',
            'rgba(216, 4, 41, 0.9)',
            'rgba(148, 0, 211, 0.9)',
            'rgba(50, 205, 50, 0.9)',
            'rgba(30, 144, 255, 0.9)',
            'rgba(255, 69, 0, 0.9)'
        ];

        const ctx = canvas.getContext('2d');
        if (charts.paretoProdLoss) {
            try { charts.paretoProdLoss.destroy(); } catch(e) {}
        }

        charts.paretoProdLoss = new Chart(ctx, {
            data: {
                labels: labels,
                datasets: [
                    {
                        type: 'bar',
                        label: 'V√©hicules perdus',
                        data: barData,
                        backgroundColor: labels.map((_, i) => barColors[i % barColors.length]),
                        borderWidth: 0,
                        borderRadius: 6,
                        yAxisID: 'y'
                    },
                    {
                        type: 'line',
                        label: '% cumul√©',
                        data: lineData,
                        yAxisID: 'y1',
                        tension: 0.25,
                        pointRadius: 3,
                        pointHoverRadius: 4,
                        borderWidth: 2,
                        fill: false
                    },
                    {
                        type: 'line',
                        label: 'Seuil 80%',
                        data: line80,
                        yAxisID: 'y1',
                        pointRadius: 0,
                        borderWidth: 2,
                        borderDash: [8, 6],
                        fill: false
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(13, 27, 42, 0.95)',
                        titleColor: '#e0e1dd',
                        bodyColor: '#e0e1dd',
                        borderColor: 'rgba(255,215,0,0.55)',
                        borderWidth: 1,
                        callbacks: {
                            label: function(context) {
                                const ds = context.dataset || {};
                                const label = ds.label || '';
                                const v = context.parsed && typeof context.parsed.y === 'number' ? context.parsed.y : context.parsed;
                                if (label.includes('%')) return `${label}: ${Number(v).toFixed(1)}%`;
                                if (label.includes('80')) return `Seuil: 80%`;
                                return `${label}: ${Number(v).toFixed(1)} v√©hicule(s)`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'V√©hicules perdus (approx)' }
                    },
                    y1: {
                        beginAtZero: true,
                        position: 'right',
                        min: 0,
                        max: 100,
                        grid: { drawOnChartArea: false },
                        ticks: {
                            callback: function(value) { return value + '%'; }
                        },
                        title: { display: true, text: '% cumul√©' }
                    }
                }
            }
        });

        // R√©sum√© texte (pour lecture rapide)
        const top1 = top[0] || ['-', 0];
        const top1Cause = String(top1[0] || '-');
        const top1Lost = Number(top1[1] || 0);

        const shiftLabel = `${ctxShift.shiftDate} (${ctxShift.shiftType})`;
        const ctLabel = (typeof _formatMMSSFromSeconds === "function") ? _formatMMSSFromSeconds(ct) : `${ct}s`;

        if (summaryEl) {
            summaryEl.innerHTML = `
                <div style="display:flex; flex-direction:column; gap:4px;">
                  <div>üìÖ Shift: <b>${shiftLabel}</b> ‚Äî ‚è±Ô∏è Temps de cycle: <b>${ctLabel}</b></div>
                  <div>üìâ Pertes totales (Top ${top.length} causes): <b>${totalLost.toFixed(1)}</b> v√©hicule(s)</div>
                  <div>‚≠ê Principale cause: <b>${top1Cause}</b> ‚Üí <b>${top1Lost.toFixed(1)}</b> v√©hicule(s)</div>
                  <div>‚úÖ R√®gle 80/20: <b>${nbCauses80}</b> cause(s) expliquent <b>${pct80.toFixed(1)}%</b> des pertes (‚âà <b>${lost80.toFixed(1)}</b> v√©hicules)</div>
                  <div style="color:#9aa4b2; font-size:11px;">Astuce: si les valeurs semblent ‚Äúfractionn√©es‚Äù, c‚Äôest normal (conversion dur√©e √∑ cycle). Pour une version ‚Äúenti√®re‚Äù, on peut arrondir au v√©hicule.</div>
                </div>
            `;
        }

    } catch (e) {
        // silencieux
    }
}

function updateParetoHoursChart() {
    const ctxShift = getActiveShiftContext(new Date());
    let filtered = history;
    if (currentFilter.hours !== 'all') {
        filtered = filtered.filter(h => h.equipe === currentFilter.hours);
    }
    filtered = filtered.filter(h => h.date === ctxShift.shiftDate && getStopShiftType(h) === ctxShift.shiftType);

let hoursData = {};
    for (let i = 0; i < 24; i++) {
        hoursData[i] = 0;
    }
    
    filtered.forEach(h => {
        try {
            const hour = parseInt(h.start.split(':')[0]);
            if (!isNaN(hour) && hour >= 0 && hour < 24) {
                hoursData[hour] = (hoursData[hour] || 0) + h.duration;
            }
        } catch (e) {
            console.log('Erreur parsing heure:', h.start);
        }
    });
    
    let hoursArray = Object.entries(hoursData)
        .map(([hour, duration]) => ({hour: parseInt(hour), duration}))
        .sort((a, b) => b.duration - a.duration);
    
    const topHours = hoursArray.slice(0, 10);
    
    let labels = topHours.map(item => `${item.hour}h`);
    let data = topHours.map(item => item.duration);
    
    const ctx = document.getElementById('paretoHoursChart').getContext('2d');
    
    if (charts.paretoHours) charts.paretoHours.destroy();
    
    charts.paretoHours = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Dur√©e des arr√™ts (s)',
                data: data,
                backgroundColor: 'rgba(255, 159, 28, 0.85)', 
                borderColor: 'rgba(255, 159, 28, 1)',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    labels: { color: '#e0e1dd' }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `Dur√©e: ${formatDuration(context.parsed.y)}`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Dur√©e totale des arr√™ts (secondes)',
                        color: '#e0e1dd'
                    },
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    ticks: { color: '#e0e1dd' }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Heure de la journ√©e',
                        color: '#e0e1dd'
                    },
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    ticks: { color: '#e0e1dd' }
                }
            }
        }
    });
}

function updateParetoStopsChart() {
    const ctxShift = getActiveShiftContext(new Date());
    let filtered = history;
    if (currentFilter.stops !== 'all') {
        filtered = filtered.filter(h => h.equipe === currentFilter.stops);
    }
    filtered = filtered.filter(h => h.date === ctxShift.shiftDate && getStopShiftType(h) === ctxShift.shiftType);

let causesData = {};
    filtered.forEach(h => {
        const cause = h.cause || 'Non sp√©cifi√©';
        causesData[cause] = (causesData[cause] || 0) + 1;
    });
    
    let sortedCauses = Object.entries(causesData)
        .sort(([,a], [,b]) => b - a);
    
    const topCauses = sortedCauses.slice(0, 10);
    
    const totalStops = topCauses.reduce((sum, [, count]) => sum + count, 0);
    let cumulativeStops = 0;
    let cumulativePercentage = [];
    
    const barData = topCauses.map(([, count]) => count);
    topCauses.forEach(([, count]) => {
        cumulativeStops += count;
        cumulativePercentage.push((cumulativeStops / totalStops) * 100);
    });
    
    let labels = topCauses.map(([cause]) => cause.length > 15 ? cause.substring(0, 15) + '...' : cause);
    
    const ctx = document.getElementById('paretoStopsChart').getContext('2d');
    
    if (charts.paretoStops) charts.paretoStops.destroy();
    
    charts.paretoStops = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Seuil 80% (Pareto)',
                    data: labels.map(() => 80), 
                    type: 'line',
                    borderColor: 'rgba(217, 4, 41, 0.9)', 
                    borderWidth: 3, 
                    borderDash: [8, 4], 
                    pointRadius: 0, 
                    fill: false,
                    yAxisID: 'y1',
                    order: 1 
                },
                {
                    label: 'Pourcentage Cumul√© (%)',
                    data: cumulativePercentage,
                    type: 'line',
                    borderColor: 'rgba(255, 159, 28, 1)', 
                    backgroundColor: 'rgba(255, 159, 28, 0.2)',
                    fill: true,
                    tension: 0.3,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    order: 2, 
                    yAxisID: 'y1'
                },
                {
                    label: 'Nombre d\'Arr√™ts',
                    data: barData,
                    backgroundColor: 'rgba(26, 125, 255, 0.85)', 
                    borderColor: 'rgba(26, 125, 255, 1)',
                    borderWidth: 1,
                    order: 3, 
                    yAxisID: 'y'
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    labels: { color: '#e0e1dd' }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            if (context.datasetIndex === 2) {
                                return `Arr√™ts: ${context.parsed.y}`;
                            } else if (context.datasetIndex === 1) {
                                return `Cumul: ${context.parsed.y.toFixed(1)}%`;
                            } else {
                                return `Seuil 80%`;
                            }
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    type: 'linear',
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Nombre d\'arr√™ts',
                        color: '#e0e1dd'
                    },
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    ticks: { 
                        color: '#e0e1dd',
                        stepSize: 1
                    }
                },
                y1: {
                    type: 'linear',
                    position: 'right',
                    max: 100,
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Pourcentage Cumul√© (%)',
                        color: '#ff9f1c'
                    },
                    grid: { drawOnChartArea: false }, 
                    ticks: { 
                        color: '#ff9f1c', 
                        callback: function(value) { return value + "%"; } 
                    }
                },
                x: {
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    ticks: { 
                        color: '#e0e1dd',
                        maxRotation: 45,
                        minRotation: 45
                    }
                }
            }
        }
    });
}

function updateTeamPerformanceChart() {
    const teams = ['A', 'B', 'C', 'D'];
    let labels = teams.map(t => `√âquipe ${t}`);
    let data = [];
    let colors = [];
    let borderColors = [];
    const ctxShift = getActiveShiftContext(new Date());
    
    const colorSchemes = {
        duration: [
            'rgba(26, 125, 255, 0.85)', 'rgba(42, 157, 143, 0.85)', 
            'rgba(255, 159, 28, 0.85)', 'rgba(216, 4, 41, 0.85)'
        ],
        stops: [
            'rgba(106, 90, 205, 0.85)', 'rgba(60, 179, 113, 0.85)', 
            'rgba(238, 130, 238, 0.85)', 'rgba(255, 140, 0, 0.85)'
        ],
        efficiency: [
            'rgba(50, 205, 50, 0.85)', 'rgba(30, 144, 255, 0.85)', 
            'rgba(255, 69, 0, 0.85)', 'rgba(148, 0, 211, 0.85)'
        ]
    };
    
    const borderColorSchemes = {
        duration: [
            'rgba(26, 125, 255, 1)', 'rgba(42, 157, 143, 1)', 
            'rgba(255, 159, 28, 1)', 'rgba(216, 4, 41, 1)'
        ],
        stops: [
            'rgba(106, 90, 205, 1)', 'rgba(60, 179, 113, 1)', 
            'rgba(238, 130, 238, 1)', 'rgba(255, 140, 0, 1)'
        ],
        efficiency: [
            'rgba(50, 205, 50, 1)', 'rgba(30, 144, 255, 1)', 
            'rgba(255, 69, 0, 1)', 'rgba(148, 0, 211, 1)'
        ]
    };
    
    teams.forEach((team, index) => {
        let teamData = history.filter(h => h.equipe === team && h.date === ctxShift.shiftDate && getStopShiftType(h) === ctxShift.shiftType);
        
        // Filtrer par p√©riode shift
        if (currentFilter.performance !== 'all') {
            teamData = filterByShiftPeriod(teamData, currentFilter.performance);
        }
        
        if (currentFilter.metric === 'duration') {
            const totalDuration = teamData.reduce((a, b) => a + b.duration, 0);
            data.push(totalDuration);
            colors.push(colorSchemes.duration[index]);
            borderColors.push(borderColorSchemes.duration[index]);
        } else if (currentFilter.metric === 'stops') {
            data.push(teamData.length);
            colors.push(colorSchemes.stops[index]);
            borderColors.push(borderColorSchemes.stops[index]);
        } else if (currentFilter.metric === 'efficiency') {
            if (teamData.length === 0) {
                data.push(0);
            } else {
                const totalDuration = teamData.reduce((a, b) => a + b.duration, 0);
                const avgDuration = totalDuration / teamData.length;
                const efficiency = Math.max(0, 100 - (avgDuration / 60));
                data.push(Math.round(efficiency * 10) / 10);
            }
            colors.push(colorSchemes.efficiency[index]);
            borderColors.push(borderColorSchemes.efficiency[index]);
        }
    });
    
    const ctx = document.getElementById('teamPerformanceChart').getContext('2d');
    
    if (charts.teamPerformance) charts.teamPerformance.destroy();
    
    let title = {
        'duration': 'Dur√©e totale des arr√™ts (secondes)',
        'stops': 'Nombre total d\'arr√™ts',
        'efficiency': 'Score d\'efficacit√© (0-100)'
    }[currentFilter.metric];
    
    let yAxisTitle = {
        'duration': 'Secondes',
        'stops': 'Nombre d\'arr√™ts',
        'efficiency': 'Score'
    }[currentFilter.metric];

    charts.teamPerformance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: title,
                data: data,
                backgroundColor: colors,
                borderColor: borderColors,
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    labels: { color: '#e0e1dd' }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            if (currentFilter.metric === 'duration') {
                                return `Dur√©e: ${formatDuration(context.parsed.y)}`;
                            } else if (currentFilter.metric === 'stops') {
                                return `Arr√™ts: ${context.parsed.y}`;
                            } else if (currentFilter.metric === 'efficiency') {
                                return `Score: ${context.parsed.y}`;
                            }
                            return context.dataset.label + ': ' + context.parsed.y;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: yAxisTitle,
                        color: '#e0e1dd'
                    },
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    ticks: { color: '#e0e1dd' }
                },
                x: {
                    ticks: { color: '#e0e1dd' }
                }
            }
        }
    });
}


// =============================================
// POSTS (Journal d'√©quipe)
// =============================================
function normalizeArray(a) { return Array.isArray(a) ? a : []; }

function ensureEntityIds() {
    // Stops
    history = normalizeArray(history);
    history.forEach((s, i) => {
        if (!s.id) s.id = `stop_${s.timestamp || Date.now()}_${i}_${Math.random().toString(36).slice(2, 8)}`;
        if (!s.updatedAt) s.updatedAt = s.timestamp || Date.now();
    });

    // Absences
    absenceHistory = normalizeArray(absenceHistory);
    absenceHistory.forEach((a, i) => {
        if (!a.id) a.id = `abs_${a.timestamp || Date.now()}_${i}_${Math.random().toString(36).slice(2, 8)}`;
        if (!a.updatedAt) a.updatedAt = a.timestamp || Date.now();
    });

    // Chat
    chatMessages = normalizeArray(chatMessages);
    chatMessages.forEach((m, i) => {
        if (!m.id) m.id = `msg_${m.timestamp || Date.now()}_${i}_${Math.random().toString(36).slice(2, 8)}`;
        if (!m.updatedAt) m.updatedAt = m.timestamp || Date.now();
    });

    // Posts
    posts = normalizeArray(posts);
    posts.forEach((p, i) => {
        if (!p.id) p.id = `post_${p.timestamp || Date.now()}_${i}_${Math.random().toString(36).slice(2, 8)}`;
        if (!p.updatedAt) p.updatedAt = p.timestamp || Date.now();
    });
}

function persistPosts() {
    LS.setItem("POSTS", JSON.stringify(posts));
    if (db) saveToIndexedDB();
}

function escapeHtml(str) {
    return String(str || '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
}

function renderPostsBoard() {
    ensureEntityIds();
    const list = document.getElementById('postsList');
    if (!list) return;

    // Source: si Firebase (collaboration), utiliser le cache Firebase; sinon posts locaux
    const source = (Array.isArray(window.firebasePostsCache) && window.firebasePostsCache.length)
        ? window.firebasePostsCache
        : posts;

    // Trier du plus r√©cent au plus ancien
    const sorted = [...source].sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0)).slice(0, 200);
if (sorted.length === 0) {
        list.innerHTML = `<div style="text-align:center; color:#9aa4b2; padding:18px; border:1px dashed rgba(255,255,255,0.15); border-radius:12px;">
            Aucun post pour le moment. Publiez une mise √† jour (incident, action, point s√©curit√©‚Ä¶).
        </div>`;
        return;
    }

    list.innerHTML = sorted.map(p => {
        const dt = p.timestamp ? new Date(p.timestamp).toLocaleString('fr-FR') : '';
        const author = escapeHtml(p.author || 'Anonyme');
        const txt = escapeHtml(p.text || '');
        return `
        <div style="padding:12px; margin-bottom:10px; border-radius:12px; background: rgba(0,0,0,0.18); border:1px solid rgba(255,255,255,0.10);">
            <div style="display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;">
                <div style="color:#e0e1dd; font-weight:700;">${author}</div>
                <div style="color:#9aa4b2; font-size:11px;">${dt}</div>
            </div>
            <div style="margin-top:8px; color:#e0e1dd; white-space:pre-wrap;">${txt}</div>
        </div>`;
    }).join('');
}

function addPost() {
    const authorEl = document.getElementById('postAuthor');
    const textEl = document.getElementById('postText');

        // Auto-post √† la fin d'arr√™t (pour partager cause + action en temps r√©el)
        const autoToggle = document.getElementById('autoPostStopsToggle');
        if (autoToggle) {
            const saved = LS.getItem("AUTO_POST_STOPS");
            autoToggle.checked = (saved === null) ? true : (saved === "1");
            autoToggle.addEventListener('change', () => {
                LS.setItem("AUTO_POST_STOPS", autoToggle.checked ? "1" : "0");
                showNotification(autoToggle.checked ? "‚úÖ Auto-post activ√©" : "‚ÑπÔ∏è Auto-post d√©sactiv√©", "info");
            });
        }

    if (!authorEl || !textEl) return;

    const author = (authorEl.value || '').trim() || teamLeader || 'Anonyme';
    const text = (textEl.value || '').trim();
    if (!text) {
        showNotification("‚ö†Ô∏è √âcrivez un message avant de publier", "warning");
        return;
    }

    ensureEntityIds();
    const now = Date.now();
    const post = {
        id: `post_${now}_${Math.random().toString(36).slice(2, 8)}`,
        author,
        text,
        timestamp: now,
        updatedAt: now
    };

    // Collaboration Firebase: push dans rooms/<room>/posts (multi-auteur)
    if (onlineConnected && onlineMode === "firebase" && onlineFirebaseDb && onlineFirebaseRoom) {
        try {
            const ref = onlineFirebaseDb.ref(`rooms/${onlineFirebaseRoom}/posts`).push();
            const payload = {
                ...post,
                _fbid: ref.key,
                serverAt: firebase.database.ServerValue.TIMESTAMP,
                uid: onlineFirebaseUid || "",
                room: onlineFirebaseRoom || ""
            };
            ref.set(payload);
            // Affichage imm√©diat (optimiste)
            window.firebasePostsCache = Array.isArray(window.firebasePostsCache) ? window.firebasePostsCache : [];
            window.firebasePostsCache.push({ ...payload, timestamp: payload.timestamp || Date.now() });
        } catch (e) {
            console.error("Erreur push post Firebase:", e);
            posts.push(post);
            persistPosts();
        }
    } else {
        posts.push(post);
        persistPosts();
    }

    textEl.value = '';
    renderPostsBoard();
    touchLocalRealtimeUpdate("post");
    showNotification("‚úÖ Post publi√©", "success");
}

function isAutoPostStopsEnabled() {
    const v = LS.getItem("AUTO_POST_STOPS");
    return (v === null) ? true : (v === "1");
}

// Cr√©e un post ‚Äúarr√™t‚Äù (cause + dur√©e) pour lancer la discussion / solutions
function autoCreatePostForStop(stop) {
    try {
        if (!isAutoPostStopsEnabled()) return;
        if (!stop || typeof stop !== "object") return;
        if (!("cause" in stop) || !("start" in stop) || !("end" in stop) || !("duration" in stop)) return;

        ensureStopId(stop);

        // √©viter doublons (si d√©j√† post√©)
        try {
            const exists = (posts || []).some(p => p && p.stopId === stop._id);
            if (exists) return;
        } catch(_) {}

        const durMin = Math.round((stop.duration || 0) / 60);
        const eq = stop.equipe ? `√âquipe ${stop.equipe}` : "√âquipe ?";
        const date = stop.date || getShiftDate(new Date());
        const typeTxt = (stop.type === "sp√©cial") ? "Arr√™t sp√©cial" : (stop.isMissed || stop.type === "rat√©") ? "Arr√™t rat√©" : "Arr√™t";
        const by = stop.teamLeader || stop.by || teamLeader || (LS.getItem("ONLINE_USER") || "").trim() || "Anonyme";

        const text =
`‚õî ${typeTxt} ‚Äî ${eq}
üìÖ Date: ${date}
‚è±Ô∏è P√©riode: ${stop.start} ‚Üí ${stop.end} (${durMin} min)
üîé Cause: ${stop.cause}

‚úÖ Solution / Action (√† compl√©ter par l'√©quipe):
- ...
`;

        const now = Date.now();
        const post = {
            id: `post_${now}_${Math.random().toString(36).slice(2, 8)}`,
            author: by,
            text,
            timestamp: now,
            updatedAt: now,
            kind: "stop",
            stopId: stop._id
        };

        posts.push(post);
        persistPosts();
        renderPostsBoard();
        touchLocalRealtimeUpdate("post");

        // Petite alerte locale (pas trop intrusive)
        showNotification("üì£ Arr√™t publi√© en post (discussion solutions)", "info");
    } catch(e) {
        console.error("autoCreatePostForStop error:", e);
    }
}


function initializePostsBoard() {
    try {
        const authorEl = document.getElementById('postAuthor');
        const btn = document.getElementById('addPostBtn');
        const textEl = document.getElementById('postText');

        if (authorEl) {
            authorEl.value = LS.getItem("ONLINE_USER") || teamLeader || authorEl.value || "";
            authorEl.addEventListener('change', () => {
                // pas obligatoire, mais pratique
                LS.setItem("ONLINE_USER", authorEl.value.trim());
            });
        }
        if (btn) btn.onclick = addPost;

        // Ctrl+Entr√©e pour publier
        if (textEl) {
            textEl.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') addPost();
            });
        }

        renderPostsBoard();
    } catch (e) {
        console.error("Erreur init posts:", e);
    }
}

// =============================================
// MODE EN LIGNE (Socket.IO) ‚Äî collaboration temps r√©el
// =============================================
let onlineSocket = null;
let onlineConnected = false;
let onlineWatcher = null;
let onlineLastHash = "";
let onlineLocalUpdatedAt = parseInt(LS.getItem("ONLINE_LOCAL_UPDATED_AT") || "0", 10) || Date.now();

// ---- Mode: "supabase" (sans serveur) OU "socket" (serveur Socket.IO)
let onlineMode = (LS.getItem("ONLINE_MODE") || "supabase");
let onlineSupabase = null;
let onlineChannel = null;
let onlineRoomActive = "";
let onlineUserActive = "";



// ---- Firebase RTDB mode
let onlineFirebaseApp = null;
let onlineFirebaseDb = null;
let onlineFirebaseAuth = null;
let onlineFirebaseRoom = "";
let onlineFirebaseUser = "";
let onlineFirebaseUid = "";
let onlineFirebasePresenceRef = null;
let onlineFirebasePresenceListRef = null;
let onlineFirebaseStateRef = null;
let onlineFirebaseStateListener = null;
let onlineFirebasePresenceListener = null;
let onlineFirebaseConfigStr = (LS.getItem("FIREBASE_CONFIG_JSON") || "");
let onlineFirebaseAdmin = (LS.getItem("FIREBASE_ADMIN_MODE") === "1");

function simpleHash(str) {
    let h = 5381;
    for (let i = 0; i < str.length; i++) {
        h = ((h << 5) + h) ^ str.charCodeAt(i); // h*33 ^ c
    }
    return (h >>> 0).toString(16);
}

function getRealtimeSnapshot() {
    // Limiter la taille (on envoie les √©l√©ments r√©cents)
    const payload = {
        updatedAt: onlineLocalUpdatedAt,
        history: normalizeArray(history).slice(-300),
        absenceHistory: normalizeArray(absenceHistory).slice(-200),
        chatMessages: normalizeArray(chatMessages).slice(-300),
        posts: normalizeArray(posts).slice(-200),
        objectifs: objectifs || {},
        teamLeader: teamLeader || "",
        currentShift: currentShiftType || "",
        selectedShiftDate: selectedShiftDate || null,
        cycleTimeSeconds: cycleTimeSeconds || null,
        currentStop: (autoStopState && typeof autoStopState === 'object') ? autoStopState : { active:false }
    };
    return payload;
}

function updateOnlineUI() {
    const status = document.getElementById('onlineStatus');
    if (status) {
        status.textContent = onlineConnected ? "Connect√©" : "Non connect√©";
        status.style.color = onlineConnected ? "#25D366" : "#0ea5e9";
    }
}

function setOnlinePeersCount(n) {
    const el = document.getElementById('onlinePeersCount');
    if (el) el.textContent = String(n || 0);
}

function touchLocalRealtimeUpdate(reason) {
    onlineLocalUpdatedAt = Date.now();
    LS.setItem("ONLINE_LOCAL_UPDATED_AT", String(onlineLocalUpdatedAt));
    // Si connect√©, on force une synchro rapide (watcher d√©tectera aussi)
    if (onlineConnected) {
        // petit "poke" pour envoyer sans attendre
        setTimeout(() => onlineTick(true), 50);
    }
}

function mergeById(localArr, remoteArr) {
    const out = new Map();
    normalizeArray(localArr).forEach(item => out.set(item.id, item));
    normalizeArray(remoteArr).forEach(item => {
        if (!item || !item.id) return;
        const cur = out.get(item.id);
        if (!cur) {
            out.set(item.id, item);
        } else {
            const curTs = cur.updatedAt || cur.timestamp || 0;
            const newTs = item.updatedAt || item.timestamp || 0;
            if (newTs >= curTs) out.set(item.id, item);
        }
    });
    return Array.from(out.values());
}

function applyRemoteState(state) {
    if (!state) return;

    ensureEntityIds();

    // Collections
    history = mergeById(history, state.history);
    absenceHistory = mergeById(absenceHistory, state.absenceHistory);
    chatMessages = mergeById(chatMessages, state.chatMessages);
    posts = mergeById(posts, state.posts);

    // Champs "globaux" : prendre la version la plus r√©cente
    const remoteUpdatedAt = state.updatedAt || 0;
    if (remoteUpdatedAt > onlineLocalUpdatedAt) {
        if (state.objectifs) objectifs = state.objectifs;
        if (typeof state.teamLeader === 'string') teamLeader = state.teamLeader;
        if (state.cycleTimeSeconds) cycleTimeSeconds = state.cycleTimeSeconds;
        if (state.currentShift) currentShiftType = state.currentShift;
        if (state.selectedShiftDate !== undefined) selectedShiftDate = state.selectedShiftDate;

        // Arr√™t en cours (badge automatique)
        try {
            if (state.currentStop && typeof state.currentStop === 'object') {
                const remote = state.currentStop;
                const localTs = (autoStopState && autoStopState.updatedAt) ? autoStopState.updatedAt : 0;
                const remoteTs = remote.updatedAt || 0;
                if (remoteTs >= localTs) {
                    autoStopState = remote;
                    autoStopHidden = false;
                    if (autoStopState.active) {
                        persistAutoStop();
                    } else {
                        try { LS.removeItem("AUTO_STOP_STATE"); } catch(e) {}
                    }
                    renderAutoStopBadge();
                }
            }
        } catch(e) {}


        onlineLocalUpdatedAt = remoteUpdatedAt;
        LS.setItem("ONLINE_LOCAL_UPDATED_AT", String(onlineLocalUpdatedAt));
    }

    // Persist
    LS.setItem("HISTO", JSON.stringify(history));
    LS.setItem("ABSENCES", JSON.stringify(absenceHistory));
    LS.setItem("CHAT_MESSAGES", JSON.stringify(chatMessages));
    LS.setItem("POSTS", JSON.stringify(posts));
    LS.setItem("OBJECTIFS", JSON.stringify(objectifs || {}));
    LS.setItem("TEAM_LEADER", teamLeader || "");
    if (db) saveToIndexedDB();

    // UI refresh
    try {
        if (teamLeader) {
            const tl = document.getElementById("teamLeader");
            if (tl) {
                tl.value = teamLeader;
                tl.style.color = "#FFD700";
            }
        }
        refreshTable();
        refreshAbsenceStats();
        try { updateCausesTraceabilityTables(history); } catch(e) {}
    updateAllCharts();
        renderPostsBoard();
        updateChatNotification();
    } catch (e) {
        console.error("Erreur refresh apr√®s merge:", e);
    }
}

function onlineTick(forceSend = false) {
    if (!onlineConnected) return;
    if (onlineMode === "socket" && !onlineSocket) return;
    if (onlineMode === "supabase" && !onlineSupabase) return;
    if (onlineMode === "firebase" && !onlineFirebaseDb) return;

    // Hash sur un snapshot r√©duit (√©vite le gros stringify)
    const snap = {
        u: onlineLocalUpdatedAt,
        h: normalizeArray(history).slice(-120),
        a: normalizeArray(absenceHistory).slice(-80),
        c: normalizeArray(chatMessages).slice(-120),
        p: normalizeArray(posts).slice(-80),
        o: objectifs || {},
        t: teamLeader || "",
        s: currentShiftType || "",
        d: selectedShiftDate || null,
        cy: cycleTimeSeconds || null,
        st: (autoStopState && typeof autoStopState === 'object') ? autoStopState : {active:false}
    };
    const hash = simpleHash(JSON.stringify(snap));

    if (!forceSend && hash === onlineLastHash) return;
    onlineLastHash = hash;

    // Mettre √† jour "updatedAt" quand changement local d√©tect√©
    if (forceSend) {
        onlineLocalUpdatedAt = Date.now();
        LS.setItem("ONLINE_LOCAL_UPDATED_AT", String(onlineLocalUpdatedAt));
    }

    // Envoyer l'√©tat
    const room = (document.getElementById('onlineRoom')?.value || '').trim();
    if (!room) return;

    const payload = {
        room,
        state: getRealtimeSnapshot()
    };

    try {
        onlineSendState(payload);
    } catch (e) {
        console.error("Erreur envoi √©tat:", e);
    }
}


function connectOnline() {
    const mode = (document.getElementById('onlineMode')?.value || onlineMode || "supabase");
    onlineMode = mode;
    LS.setItem("ONLINE_MODE", onlineMode);

    // Sauvegarder room/user
    const room = (document.getElementById('onlineRoom')?.value || '').trim();
    const user = (document.getElementById('onlineUserName')?.value || '').trim() || teamLeader || 'Utilisateur';
    if (room) LS.setItem("ONLINE_ROOM", room);
    if (user) LS.setItem("ONLINE_USER", user);

    if (onlineMode === "socket") return connectOnlineSocket();
    if (onlineMode === "firebase") return connectOnlineFirebase();
    return connectOnlineSupabase();
}

function disconnectOnline() {
    // Nettoyer watcher + connexions
    try { if (onlineWatcher) clearInterval(onlineWatcher); } catch(e) {}
    onlineWatcher = null;

    disconnectOnlineSocket(true);
    disconnectOnlineSupabase(true);
    disconnectOnlineFirebase(true);

    onlineConnected = false;
    updateOnlineUI();
    setOnlinePeersCount(0);
    showNotification("‚ÑπÔ∏è D√©connect√© du mode en ligne", "info");
}

function onlineSendState(payload) {
    if (!payload || !payload.state) return;

    if (onlineMode === "socket") {
        try {
            if (onlineSocket && onlineSocket.connected) {
                onlineSocket.emit('state_update', payload);
            }
        } catch (e) {
            console.error("Erreur envoi √©tat Socket.IO:", e);
        }
        return;
    }

    if (onlineMode === "firebase") {
        try {
            if (!onlineFirebaseDb || !onlineFirebaseRoom) return;
            if (!onlineFirebaseAdmin) return; // viewer mode
            onlineFirebaseDb.ref(`rooms/${onlineFirebaseRoom}/state`).set({
                state: payload.state,
                serverAt: firebase.database.ServerValue.TIMESTAMP
            });
        } catch (e) {
            console.error("Erreur envoi √©tat Firebase:", e);
        }
        return;
    }

    // Supabase: persister ÿ¢ÿÆÿ± ÿ≠ÿßŸÑÿ© ŸÅŸä ÿ¨ÿØŸàŸÑ rooms_state
    try {
        if (!onlineSupabase || !onlineRoomActive) return;
        onlineSupabase
            .from('rooms_state')
            .upsert({ room: onlineRoomActive, state: payload.state, updated_at: new Date().toISOString() }, { onConflict: 'room' })
            .then(() => {})
            .catch((e) => console.error("Erreur upsert Supabase:", e));
    } catch (e) {
        console.error("Erreur envoi √©tat Supabase:", e);
    }
}

async function connectOnlineSupabase() {
    const url = (document.getElementById('onlineSupabaseUrl')?.value || '').trim();
    const key = (document.getElementById('onlineSupabaseKey')?.value || '').trim();
    const room = (document.getElementById('onlineRoom')?.value || '').trim();
    const user = (document.getElementById('onlineUserName')?.value || '').trim() || teamLeader || 'Utilisateur';

    if (!url || !key) {
        showNotification("‚ùå ÿ∂ÿπ Supabase URL Ÿà anon key", "error");
        return;
    }
    if (!room) {
        showNotification("‚ùå ÿßŸÉÿ™ÿ® Room (ŸÖÿ´ÿßŸÑ: LIGNE-1-A)", "error");
        return;
    }
    if (!window.supabase || !window.supabase.createClient) {
        showNotification("‚ùå ŸÖŸÉÿ™ÿ®ÿ© Supabase ŸÑŸÖ ÿ™Ÿèÿ≠ŸÖŸëŸÑ. ÿ¨ÿ±Ÿëÿ® ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿµŸÅÿ≠ÿ©.", "error");
        return;
    }

    // Sauvegarder
    LS.setItem("SUPABASE_URL", url);
    LS.setItem("SUPABASE_ANON_KEY", key);

    // Nettoyage ancien
    disconnectOnlineSocket(true);
    disconnectOnlineFirebase(true);
    disconnectOnlineSupabase(true);

    onlineMode = "supabase";
    onlineSupabase = window.supabase.createClient(url, key);
    onlineRoomActive = room;
    onlineUserActive = user;

    const channelName = `room:${room}`;
    onlineChannel = onlineSupabase.channel(channelName, {
        config: {
            presence: { key: user }
        }
    });

    // Presence -> compter les connect√©s
    onlineChannel.on('presence', { event: 'sync' }, () => {
        try {
            const pres = onlineChannel.presenceState();
            const count = Object.keys(pres || {}).length;
            setOnlinePeersCount(count);
        } catch(e) {}
    });

    // Ecouter changements DB (Realtime) sur rooms_state pour ce room
    onlineChannel.on('postgres_changes',
        { event: '*', schema: 'public', table: 'rooms_state', filter: `room=eq.${room}` },
        (payload) => {
            const st = payload?.new?.state;
            if (st) applyRemoteState(st);
        }
    );

    // Subscribe
    onlineChannel.subscribe(async (status) => {
        if (status === 'SUBSCRIBED') {
            onlineConnected = true;
            updateOnlineUI();

            // Track presence
            try { await onlineChannel.track({ user: onlineUserActive, at: new Date().toISOString() }); } catch(e) {}

            // Charger ÿ¢ÿÆÿ± ÿ≠ÿßŸÑÿ© ŸÖŸÜ DB
            try {
                const { data, error } = await onlineSupabase
                    .from('rooms_state')
                    .select('state')
                    .eq('room', room)
                    .maybeSingle();
                if (!error && data?.state) applyRemoteState(data.state);
            } catch (e) {}

            // Watcher
            if (onlineWatcher) clearInterval(onlineWatcher);
            onlineWatcher = setInterval(() => onlineTick(false), 1200);

            showNotification(`‚úÖ Connect√© (Supabase): ${room}`, "success");
        } else if (status === 'CHANNEL_ERROR') {
            onlineConnected = false;
            updateOnlineUI();
            showNotification("‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ŸÇŸÜÿßÿ© Supabase Realtime", "error");
        }
    });
}

function disconnectOnlineSupabase(silent=false) {
    try {
        if (onlineChannel) onlineChannel.unsubscribe();
    } catch(e) {}
    onlineChannel = null;
    onlineSupabase = null;
    onlineRoomActive = "";
    onlineUserActive = "";
    if (!silent) {
        onlineConnected = false;
        updateOnlineUI();
        setOnlinePeersCount(0);
        showNotification("‚ÑπÔ∏è D√©connect√© (Supabase)", "info");
    }
}

// Socket wrapper with silent option
function disconnectOnlineSocket(silent=false) {
    try {
        if (onlineSocket) onlineSocket.disconnect();
    } catch(e) {}
    onlineSocket = null;
    if (!silent) {
        onlineConnected = false;
        updateOnlineUI();
        setOnlinePeersCount(0);
        showNotification("‚ÑπÔ∏è D√©connect√© (Socket.IO)", "info");
    }
}


// Firebase wrapper with silent option
function disconnectOnlineFirebase(silent=false) {
    try { if (onlineWatcher) clearInterval(onlineWatcher); } catch(e) {}
    onlineWatcher = null;

    try {
        if (onlineFirebaseStateRef && onlineFirebaseStateListener) {
            onlineFirebaseStateRef.off('value', onlineFirebaseStateListener);
        }
    } catch(e) {}
    try {
        if (onlineFirebasePresenceListRef && onlineFirebasePresenceListener) {
            onlineFirebasePresenceListRef.off('value', onlineFirebasePresenceListener);
        }
    } catch(e) {}

    // Presence cleanup
    try {
        if (onlineFirebasePresenceRef) {
            onlineFirebasePresenceRef.remove();
        }
    } catch(e) {}

    onlineFirebasePresenceRef = null;
    onlineFirebasePresenceListRef = null;
    onlineFirebaseStateRef = null;
    onlineFirebaseStateListener = null;
    onlineFirebasePresenceListener = null;
    onlineFirebaseDb = null;
    onlineFirebaseAuth = null;
    onlineFirebaseRoom = "";
    onlineFirebaseUser = "";
    onlineFirebaseUid = "";

    if (!silent) {
        onlineConnected = false;
        updateOnlineUI();
        setOnlinePeersCount(0);
        showNotification("‚ÑπÔ∏è D√©connect√© (Firebase)", "info");
    }
}

async function connectOnlineFirebase() {
    // Assurer mode firebase
    onlineMode = "firebase";
    LS.setItem("ONLINE_MODE", onlineMode);

    disconnectOnlineSocket(true);
    disconnectOnlineSupabase(true);
    disconnectOnlineFirebase(true);

    const room = (document.getElementById('onlineRoom')?.value || '').trim();
    const user = (document.getElementById('onlineUserName')?.value || '').trim() || teamLeader || 'Utilisateur';
    const cfgStr = (document.getElementById('onlineFirebaseConfig')?.value || '').trim();

    const adminMode = !!(document.getElementById('onlineFirebaseAdminMode')?.checked);
    onlineFirebaseAdmin = adminMode;
    LS.setItem("FIREBASE_ADMIN_MODE", adminMode ? "1" : "0");

    if (!room) {
        showNotification("‚ùå ÿßŸÉÿ™ÿ® Room (ŸÖÿ´ÿßŸÑ: LIGNE-1-A)", "error");
        return;
    }
    if (!cfgStr) {
        showNotification("‚ùå ÿ∂ÿπ firebaseConfig JSON", "error");
        return;
    }
    if (!window.firebase || !window.firebase.initializeApp) {
        showNotification("‚ùå ŸÖŸÉÿ™ÿ®ÿ© Firebase ŸÑŸÖ ÿ™Ÿèÿ≠ŸÖŸëŸÑ. ÿ¨ÿ±Ÿëÿ® ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿµŸÅÿ≠ÿ©.", "error");
        return;
    }

    // Parse config JSON
    let cfg = null;
    try {
        cfg = JSON.parse(cfgStr);
    } catch (e) {
        showNotification("‚ùå firebaseConfig ŸÑÿßÿ≤ŸÖ ŸäŸÉŸàŸÜ JSON ÿµÿ≠Ÿäÿ≠", "error");
        return;
    }
    if (!cfg.databaseURL || !cfg.apiKey) {
        showNotification("‚ùå firebaseConfig ŸÜÿßŸÇÿµ (databaseURL / apiKey)", "error");
        return;
    }

    // Save config
    LS.setItem("FIREBASE_CONFIG_JSON", cfgStr);
    onlineFirebaseConfigStr = cfgStr;

    // Init or re-init named app
    try {
        const existing = (firebase.apps || []).find(a => a.name === 'online');
        if (existing) {
            // If config changed, delete and recreate
            try {
                const oldCfg = JSON.stringify(existing.options || {});
                if (simpleHash(oldCfg) !== simpleHash(JSON.stringify(cfg))) {
                    await existing.delete();
                }
            } catch(_) {}
        }
    } catch(_) {}

    let app = null;
    try {
        app = (firebase.apps || []).find(a => a.name === 'online') || firebase.initializeApp(cfg, 'online');
    } catch (e) {
        // If already exists
        try { app = firebase.app('online'); } catch(_) {}
    }
    if (!app) {
        showNotification("‚ùå Firebase app ÿ∫Ÿäÿ± ÿ¨ÿßŸáÿ≤", "error");
        return;
    }

    onlineFirebaseApp = app;
    onlineFirebaseAuth = firebase.auth(app);
    onlineFirebaseDb = firebase.database(app);
    onlineFirebaseRoom = room;
    onlineFirebaseUser = user;

    // Sign in anonymously (needed for auth-based rules + presence)
    try {
        await onlineFirebaseAuth.signInAnonymously();
    } catch (e) {
        console.error("Firebase signInAnonymously error:", e);
        showNotification("‚ùå ŸÅÿ¥ŸÑ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ (Anonymous). ŸÅÿπŸëŸÑ Anonymous Auth ŸÅŸä Firebase.", "error");
        return;
    }

    onlineFirebaseUid = onlineFirebaseAuth.currentUser?.uid || "";
    if (!onlineFirebaseUid) {
        showNotification("‚ùå UID ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ±. ÿ¨ÿ±Ÿëÿ® ÿ•ÿπÿßÿØÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ.", "error");
        return;
    }

    // Presence
    try {
        onlineFirebasePresenceRef = onlineFirebaseDb.ref(`rooms/${room}/presence/${onlineFirebaseUid}`);
        onlineFirebasePresenceRef.onDisconnect().remove();
        await onlineFirebasePresenceRef.set({
            user,
            at: firebase.database.ServerValue.TIMESTAMP
        });

        onlineFirebasePresenceListRef = onlineFirebaseDb.ref(`rooms/${room}/presence`);
        onlineFirebasePresenceListener = (snap) => {
            try { setOnlinePeersCount(snap.numChildren()); } catch(_) {}
        };
        onlineFirebasePresenceListRef.on('value', onlineFirebasePresenceListener);
    } catch (e) {
        console.error("Firebase presence error:", e);
    }

    // Listen room state
    try {
        onlineFirebaseStateRef = onlineFirebaseDb.ref(`rooms/${room}/state`);
        onlineFirebaseStateListener = (snap) => {
            const v = snap.val();
            if (!v) return;
            if (v.state) applyRemoteState(v.state);
            else applyRemoteState(v);
        };
        onlineFirebaseStateRef.on('value', onlineFirebaseStateListener);
    } catch (e) {
        console.error("Firebase state listener error:", e);
    }

    // Watcher
    if (onlineWatcher) clearInterval(onlineWatcher);
    onlineWatcher = setInterval(() => onlineTick(false), 1200);

    onlineConnected = true;
    updateOnlineUI();
    showNotification(`‚úÖ Connect√© (Firebase): ${room} ${adminMode ? "(Responsable)" : "(Viewer)"}`, "success");
}


function connectOnlineSocket() {
    // Assurer mode socket
    onlineMode = "socket";
    LS.setItem("ONLINE_MODE", onlineMode);
    disconnectOnlineSocket(true);
    disconnectOnlineSupabase(true);

    disconnectOnlineFirebase(true);
    const url = (document.getElementById('onlineServerUrl')?.value || '').trim();
    const room = (document.getElementById('onlineRoom')?.value || '').trim();
    const user = (document.getElementById('onlineUserName')?.value || '').trim() || teamLeader || 'Utilisateur';

    if (!url) {
        showNotification("‚ö†Ô∏è Renseignez l'URL du serveur", "warning");
        return;
    }
    if (!room) {
        showNotification("‚ö†Ô∏è Renseignez le Room", "warning");
        return;
    }
    if (typeof io !== 'function') {
        showNotification("‚ùå Socket.IO non charg√© (internet bloqu√© ?)", "danger");
        return;
    }

    LS.setItem("ONLINE_SERVER_URL", url);
    LS.setItem("ONLINE_ROOM", room);
    LS.setItem("ONLINE_USER", user);

    ensureEntityIds();

    // Fermer ancienne connexion si besoin
    try { if (onlineSocket) onlineSocket.disconnect(); } catch (_) {}

    onlineSocket = io(url, {
        transports: ['websocket'],
        reconnection: true,
        reconnectionAttempts: Infinity,
        reconnectionDelay: 600
    });

    onlineSocket.on('connect', () => {
        onlineConnected = true;
        updateOnlineUI();
        onlineSocket.emit('join_room', { room, user });

        // Demander l'√©tat courant du room
        onlineSocket.emit('get_state', { room });

        // D√©marrer le watcher (1.2s)
        if (onlineWatcher) clearInterval(onlineWatcher);
        onlineWatcher = setInterval(() => onlineTick(false), 1200);

        showNotification(`‚úÖ Connect√© en ligne: ${room}`, "success");
    });

    onlineSocket.on('room_state', (payload) => {
        if (!payload || !payload.state) return;
        applyRemoteState(payload.state);
        if (payload.peersCount !== undefined) setOnlinePeersCount(payload.peersCount);
    });

    onlineSocket.on('state_update', (payload) => {
        if (!payload || !payload.state) return;
        applyRemoteState(payload.state);
        if (payload.peersCount !== undefined) setOnlinePeersCount(payload.peersCount);
    });

    onlineSocket.on('peers', (payload) => {
        if (payload && payload.peersCount !== undefined) setOnlinePeersCount(payload.peersCount);
    });

    onlineSocket.on('disconnect', () => {
        onlineConnected = false;
        updateOnlineUI();
        setOnlinePeersCount(0);
    });

    onlineSocket.on('connect_error', (err) => {
        console.error("connect_error:", err);
        onlineConnected = false;
        updateOnlineUI();
        showNotification("‚ö†Ô∏è Connexion en ligne impossible (URL/serveur)", "warning");
    });
}

function disconnectOnlineSocketLegacy() {
    try {
        if (onlineWatcher) clearInterval(onlineWatcher);
        onlineWatcher = null;
        if (onlineSocket) onlineSocket.disconnect();
    } catch (e) {
        console.error(e);
    }
    onlineSocket = null;
    onlineConnected = false;
    updateOnlineUI();
    setOnlinePeersCount(0);
    showNotification("‚ÑπÔ∏è D√©connect√© du mode en ligne", "info");
}

function initializeOnlineSyncUI() {
    try {
        const modeEl = document.getElementById('onlineMode');
        const sbUrlEl = document.getElementById('onlineSupabaseUrl');
        const sbKeyEl = document.getElementById('onlineSupabaseKey');
        const sockUrlEl = document.getElementById('onlineServerUrl');
        const fbCfgEl = document.getElementById('onlineFirebaseConfig');
        const fbAdminEl = document.getElementById('onlineFirebaseAdminMode');
        const roomEl = document.getElementById('onlineRoom');
        const userEl = document.getElementById('onlineUserName');

        // Pr√©-remplir champs depuis localStorage
        if (modeEl) modeEl.value = LS.getItem("ONLINE_MODE") || "supabase";
        if (sbUrlEl) sbUrlEl.value = LS.getItem("SUPABASE_URL") || "";
        if (sbKeyEl) sbKeyEl.value = LS.getItem("SUPABASE_ANON_KEY") || "";
        if (sockUrlEl) sockUrlEl.value = LS.getItem("ONLINE_SERVER_URL") || "";
        if (fbCfgEl) fbCfgEl.value = LS.getItem("FIREBASE_CONFIG_JSON") || "";
        if (fbAdminEl) fbAdminEl.checked = (LS.getItem("FIREBASE_ADMIN_MODE") === "1");
        if (roomEl) roomEl.value = LS.getItem("ONLINE_ROOM") || "";
        if (userEl) userEl.value = LS.getItem("ONLINE_USER") || teamLeader || "";

        function refreshOnlineModeUI() {
            const mode = (modeEl?.value || "supabase");
            onlineMode = mode;
            LS.setItem("ONLINE_MODE", onlineMode);

            const sbFields = document.getElementById('onlineSupabaseFields');
            const sockFields = document.getElementById('onlineSocketFields');
            const fbFields = document.getElementById('onlineFirebaseFields');
            if (sbFields) sbFields.style.display = (mode === "supabase") ? "block" : "none";
            if (sockFields) sockFields.style.display = (mode === "socket") ? "block" : "none";
            if (fbFields) fbFields.style.display = (mode === "firebase") ? "block" : "none";
        }

        if (modeEl) modeEl.onchange = refreshOnlineModeUI;
        refreshOnlineModeUI();

        document.getElementById('onlineConnectBtn').onclick = connectOnline;
        document.getElementById('onlineDisconnectBtn').onclick = disconnectOnline;

        // Auto‚ÄëConnect (persist)
        const acEl = document.getElementById('onlineAutoConnect');
        if (acEl) {
            acEl.checked = (LS.getItem("ONLINE_AUTOCONNECT") === "1");
            acEl.onchange = () => {
                try { LS.setItem("ONLINE_AUTOCONNECT", acEl.checked ? "1" : "0"); } catch(e) {}
            };
        }

        updateOnlineUI();

        // Auto‚ÄëConnect on load if enabled and config looks ready
        try {
            const wantAuto = acEl && acEl.checked;
            const already = (typeof onlineConnected !== "undefined") ? onlineConnected : false;
            const roomNow = (document.getElementById('onlineRoom')?.value || LS.getItem("ONLINE_ROOM") || "").trim();
            const modeNow = (document.getElementById('onlineMode')?.value || LS.getItem("ONLINE_MODE") || "supabase");
            const fbCfgNow = (document.getElementById('onlineFirebaseConfig')?.value || LS.getItem("FIREBASE_CONFIG_JSON") || "").trim();

            const okFirebase = (modeNow !== "firebase") || !!fbCfgNow;
            if (wantAuto && !already && roomNow && okFirebase) {
                setTimeout(() => { try { connectOnline(); } catch(e) {} }, 350);
            }
        } catch(e) {}

    } catch (e) {
        console.error("Erreur init online UI:", e);
    }
}


// =============================================
// INITIALISATION FINALE
// =============================================

document.addEventListener('DOMContentLoaded', async () => {
    try {
        await openDatabase();
        await restoreFromIndexedDB();
    } catch (error) {
        console.log('IndexedDB non support√© ou erreur:', error);
    }
    
    // Initialiser les pauses
    document.getElementById("p1Start").value = getPauseTime("PAUSE_1_START", defaultPauses.p1Start);
    document.getElementById("p1End").value = getPauseTime("PAUSE_1_END", defaultPauses.p1End);
    document.getElementById("p2Start").value = getPauseTime("PAUSE_2_START", defaultPauses.p2Start);
    document.getElementById("p2End").value = getPauseTime("PAUSE_2_END", defaultPauses.p2End);
    document.getElementById("p3Start").value = getPauseTime("PAUSE_3_START", defaultPauses.p3Start);
    document.getElementById("p3End").value = getPauseTime("PAUSE_3_END", defaultPauses.p3End);
    
    // Initialiser le Team Leader
    if (teamLeader) {
        document.getElementById("teamLeader").value = teamLeader;
        document.getElementById("teamLeader").style.color = "#FFD700";
    }
    
    // Initialiser le temps de cycle
    const savedCycleTime = LS.getItem("CYCLE_TIME_SECONDS");
    if (savedCycleTime) {
        cycleTimeSeconds = parseInt(savedCycleTime);
        const cycleMinutes = Math.floor(cycleTimeSeconds / 60);
        const cycleSeconds = cycleTimeSeconds % 60;
        const _ctInpSet = document.getElementById("cycleTimeInput");
            if (_ctInpSet) _ctInpSet.value = `${cycleMinutes}:${cycleSeconds.toString().padStart(2, '0')}`;
    }
    
    // Configurer les contr√¥les d'alarme
    document.getElementById("testAlarmBtn").onclick = testAlarm;
    document.getElementById("snoozeAlarmBtn").onclick = snoozeAlarm;
    document.getElementById("stopAlarmBtn").onclick = () => {
        if (activeAlarms.length > 0) {
            stopAlarm(activeAlarms[0].id);
        }
    };
    
    // Configurer les objectifs
    const _saveObjBtn = document.getElementById("saveObjectifsBtn");
    if (_saveObjBtn) _saveObjBtn.onclick = saveObjectifs;
    
    // Configurer le calcul de production
    const _ctInp = document.getElementById("cycleTimeInput");
    if (_ctInp) {
        _ctInp.addEventListener("change", updateProductionCalculations);
        _ctInp.addEventListener("input", updateProductionCalculations);
    }

    // Boutons temps de cycle
    const _saveCycleBtn = document.getElementById("saveCycleTimeBtn");
    if (_saveCycleBtn) _saveCycleBtn.onclick = saveCycleTime;

    const _delCycleBtn = document.getElementById("deleteCycleTimeBtn");
    if (_delCycleBtn) _delCycleBtn.onclick = deleteCycleTime;

    // Indicateur "non sauvegard√©"
    updateCycleTimeDirtyUI();

    // Mise √† jour temps r√©el (objectif + production auto)
    if (!_objectiveTicker) {
        _objectiveTicker = setInterval(() => { try { updateShiftObjectiveDashboard(); } catch(e) {} }, 1000);
    }
    
    // Configurer le planificateur instantan√© (manuel)
    const _manInp = document.getElementById("manualProducedNow");
    if (_manInp) {
        _manInp.addEventListener("input", updateInstantProductionPlanner);
        _manInp.addEventListener("focus", loadManualProducedNowForActiveShift);
    }
    // Premi√®re mise √† jour
    setTimeout(()=>{ try{ loadManualProducedNowForActiveShift(); updateInstantProductionPlanner(); }catch(e){} }, 300);

    // Restaurer le shift s√©lectionn√©
    const savedShift = LS.getItem('selectedShift');
    if (savedShift && shiftConfigs[savedShift]) {
        selectShift(savedShift);
    } else {
        // D√©terminer automatiquement le shift actuel
        const now = new Date();
        getShiftDate(now); // Cela met √† jour currentShiftType automatiquement
        selectShift(currentShiftType);
    }
    
    // Initialiser PeerJS P2P avec ID fixe
    initializePeerJS();
    
    // Initialiser le chat
    initializeChat();

    // Initialiser les posts + synchro en ligne
    initializePostsBoard();
    initializeOnlineSyncUI();
    
    // Initialiser les stats d'absences
    refreshAbsenceStats();
    
    // Nettoyer les anciennes donn√©es
    cleanupOldData();
    
    // Planifier les alarmes de pause
    schedulePauseAlarms();
    setInterval(schedulePauseAlarms, 60000);
    
    // V√©rifier le nettoyage toutes les heures
    setInterval(cleanupOldData, 3600000);
    
    // D√©marrer la sauvegarde automatique
    startAutoSave();
    
    // Initialiser les objectifs et EPO
    updateObjectifsDisplay();
    mettreAJourRendementAuto();
    
    // Initialiser les calculs de production
    updateProductionCalculations();
    
    // Rafra√Æchir l'affichage
    refreshTable();
    
    // Afficher le premier onglet
    showTab('paretoHours');

    // Init disponibilit√© (temps r√©el)
    try{
        mettreAJourDisponibiliteTempsReel();
        setInterval(mettreAJourDisponibiliteTempsReel, 30 * 1000); // toutes les 30s
    }catch(e){}
});

// Synchronisation automatique
setInterval(() => {
    LS.setItem("HISTO", JSON.stringify(history));
    LS.setItem("ABSENCES", JSON.stringify(absenceHistory));
    LS.setItem("CHAT_MESSAGES", JSON.stringify(chatMessages));
    LS.setItem("POSTS", JSON.stringify(posts));
}, 30000);

// =====================================================================
// AJOUT IA - RAPPORT AUTOMATIQUE (5 POURQUOI / PDCA / PLAN D'ACTION / PDF)
// =====================================================================
let aiCharts = {
    paretoCause: null,
    period: null
};

let aiState = JSON.parse(LS.getItem("AI_REPORT_DATA") || "{}");
let aiActionPlan = Array.isArray(aiState.actionPlan) ? aiState.actionPlan : [];

// ----- UTILITAIRES DATE (dd/mm/yyyy) -----
function aiParseShiftDate(shiftDateStr) {
    if (!shiftDateStr || typeof shiftDateStr !== 'string') return null;
    const parts = shiftDateStr.split('/');
    if (parts.length !== 3) return null;
    const day = parseInt(parts[0], 10);
    const month = parseInt(parts[1], 10);
    const year = parseInt(parts[2], 10);
    if ([day, month, year].some(n => isNaN(n))) return null;
    const d = new Date(year, month - 1, day);
    d.setHours(12, 0, 0, 0); // midi pour stabilit√©
    return d;
}

function aiGetISOWeek(date) {
    // ISO week: https://en.wikipedia.org/wiki/ISO_week_date (impl√©mentation standard)
    const tmp = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
    const dayNum = tmp.getUTCDay() || 7;
    tmp.setUTCDate(tmp.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(tmp.getUTCFullYear(), 0, 1));
    const weekNo = Math.ceil((((tmp - yearStart) / 86400000) + 1) / 7);
    return { year: tmp.getUTCFullYear(), week: weekNo };
}

function aiPeriodKeyAndLabel(dateObj, groupBy) {
    const y = dateObj.getFullYear();
    const m = dateObj.getMonth() + 1;
    if (groupBy === 'week') {
        const w = aiGetISOWeek(dateObj);
        const ww = String(w.week).padStart(2, '0');
        return { key: `${w.year}-W${ww}`, label: `S${ww}/${w.year}`, sort: (w.year * 100) + w.week };
    }
    if (groupBy === 'month') {
        const mm = String(m).padStart(2, '0');
        return { key: `${y}-${mm}`, label: `${mm}/${y}`, sort: (y * 100) + m };
    }
    // year
    return { key: `${y}`, label: `${y}`, sort: y };
}

function aiIsPauseCause(cause) {
    if (!cause) return false;
    const c = String(cause).toLowerCase();
    return c.includes('pause') || c.includes('caf√©') || c.includes('midi');
}

// =============================
// DISPONIBILIT√â (AUTO - TEMPS R√âEL)
// Base = Temps √©coul√© du shift - Pause forfaitaire (ex: 30 min)
// Puis on enl√®ve Arr√™ts + Pannes (hors pauses) => Disponibilit√© %
// =============================
function _clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

function _calcDowntimeMinutes(now, bounds){
    try{
        if(!bounds) return 0;
        const endRef = (now > bounds.end) ? bounds.end : (now < bounds.start ? bounds.start : now);

        const filteredStops = history.filter(h => h.equipe === equipe && h.date === bounds.shiftDate);
        let sec = 0;

        for(const s of filteredStops){
            if (aiIsPauseCause(s.cause)) continue;

            // Si start/end ISO pr√©sents => overlap exact
            if (s.startDateTime && s.endDateTime) {
                const st = new Date(s.startDateTime);
                const en = new Date(s.endDateTime);
                sec += overlapSeconds(st, en, bounds.start, endRef);
            } else {
                sec += (s.duration || 0);
            }
        }
        return sec / 60;
    }catch(e){ return 0; }
}

function calculerDisponibiliteTempsReel(){
    const now = new Date();
    const bounds = getCurrentShiftBounds(now);
    if(!bounds) {
        return { dispo: null, planned: 0, available: 0, downtime: 0, elapsed: 0, pauseUsed: 0, fullPlanned: 0, totalPause: 0, totalShift: 0, inShift: false };
    }

    const totalShift = (bounds.end.getTime() - bounds.start.getTime()) / 60000;
    const pauseData = calculateTotalPauseMinutes();
    const totalPause = (pauseData && typeof pauseData.total === "number") ? pauseData.total : 0;
    const fullPlanned = Math.max(0, totalShift - totalPause);

    // minutes √©coul√©es dans le shift (cap√©es √† la dur√©e totale)
    const rawElapsed = (now.getTime() - bounds.start.getTime()) / 60000;
    const elapsed = _clamp(rawElapsed, 0, totalShift);

    // Pause FORFAITAIRE utilis√©e (max = totalPause)
    // Ex: si tu dis "280 - 30 = 250", ici pauseUsed = 30 (si totalPause=30)
    const pauseUsed = _clamp(Math.min(totalPause, elapsed), 0, totalPause);

    // temps planifi√© (√©coul√©) = temps √©coul√© - pauseUsed
    const planned = Math.max(0, elapsed - pauseUsed);

    // arr√™ts + pannes r√©els (hors pauses) dans le cr√©neau √©coul√©
    const downtime = Math.max(0, _calcDowntimeMinutes(now, bounds));

    const available = Math.max(0, planned - downtime);
    const dispo = (planned > 0) ? (available / planned) * 100 : null;

    const inShift = (now >= bounds.start && now <= bounds.end);

    return { dispo, planned, available, downtime, elapsed, pauseUsed, fullPlanned, totalPause, totalShift, inShift };
}

function mettreAJourDisponibiliteTempsReel(){
    try{
        const r = calculerDisponibiliteTempsReel();
        const el = document.getElementById("disponibilite");
        const det = document.getElementById("dispoDetails");

        if(el){
            el.textContent = (r.dispo === null) ? "--%" : (Math.round(r.dispo * 10) / 10) + "%";
        }

        if(det){
            const totalShiftTxt = Math.round(r.totalShift);
            const fullPlannedTxt = Math.round(r.fullPlanned);
            const totalPauseTxt = Math.round(r.totalPause);

            const elapsedTxt = Math.round(r.elapsed);
            const pauseUsedTxt = Math.round(r.pauseUsed);
            const plannedTxt = Math.round(r.planned);
            const downtimeTxt = Math.round(r.downtime);
            const availableTxt = Math.round(r.available);

            det.innerHTML = `
                üßæ <b>Total shift</b>: ${totalShiftTxt} min | ‚òï <b>Pause forfaitaire</b>: ${totalPauseTxt} min | üìå <b>Planifi√© total</b>: ${fullPlannedTxt} min<br>
                ‚è±Ô∏è <b>√âcoul√©</b>: ${elapsedTxt} min | ‚òï <b>Pause prise</b>: ${pauseUsedTxt} min | üìå <b>Planifi√© (√©coul√©)</b>: ${plannedTxt} min<br>
                ‚õî <b>Arr√™ts & pannes</b>: ${downtimeTxt} min | ‚úÖ <b>Disponible</b>: ${availableTxt} min
                ${(!r.inShift && r.elapsed === 0) ? `<br><span style="color:#fbbf24;">‚ÑπÔ∏è Shift non commenc√© (disponibilit√© affich√©e en ‚Äú--%‚Äù).</span>` : ``}
            `;
        }
    }catch(e){}
}


function aiFormatSeconds(seconds) {
    seconds = Math.max(0, Math.round(seconds || 0));
    if (seconds < 60) return `${seconds}s`;
    const minutes = Math.floor(seconds / 60);
    const secs = seconds % 60;
    if (minutes < 60) return `${minutes}m ${secs}s`;
    const hours = Math.floor(minutes / 60);
    const mins = minutes % 60;
    return `${hours}h ${mins}m`;
}

// ----- FILTRAGE DONN√âES -----
function aiGetFilteredStops() {
    // Base: historique global
    let stops = Array.isArray(history) ? [...history] : [];

    // Team filter
    const team = document.getElementById('aiTeamSelect')?.value || 'all';
    if (team !== 'all') {
        stops = stops.filter(s => s.equipe === team);
    }

    // P√©riode shift (r√©utilise la fonction existante)
    const shiftPeriod = document.getElementById('aiShiftPeriodSelect')?.value || 'today';
    stops = filterByShiftPeriod(stops, shiftPeriod);

    // Exclure pauses (option)
    const excludePauses = document.getElementById('aiExcludePauses')?.checked ?? true;
    let stopsNoPause = excludePauses ? stops.filter(s => !aiIsPauseCause(s.cause)) : stops;

    // Filtre p√©riode pr√©cise (week/month/year) bas√© sur la date shift
    const groupBy = document.getElementById('aiGroupBySelect')?.value || 'week';
    const periodValue = document.getElementById('aiPeriodValueSelect')?.value || 'all';
    if (periodValue && periodValue !== 'all') {
        stopsNoPause = stopsNoPause.filter(s => {
            const d = aiParseShiftDate(s.date);
            if (!d) return false;
            const { key } = aiPeriodKeyAndLabel(d, groupBy);
            return key === periodValue;
        });
        // On applique le m√™me filtre √† stops (brut) aussi pour coh√©rence KPI
        stops = stops.filter(s => {
            const d = aiParseShiftDate(s.date);
            if (!d) return false;
            const { key } = aiPeriodKeyAndLabel(d, groupBy);
            return key === periodValue;
        });
    }

    return { stops, stopsNoPause, team, shiftPeriod, groupBy, periodValue, excludePauses };
}

// ----- AGR√âGATIONS -----
function aiAggregateCauses(stops) {
    const map = new Map();
    stops.forEach(s => {
        const cause = (s.cause || 'Non sp√©cifi√©').trim();
        const prev = map.get(cause) || { cause, duration: 0, count: 0 };
        prev.duration += (s.duration || 0);
        prev.count += 1;
        map.set(cause, prev);
    });
    return Array.from(map.values()).sort((a, b) => b.duration - a.duration);
}

function aiAggregatePeriods(stops, groupBy, metric) {
    const map = new Map();
    stops.forEach(s => {
        const d = aiParseShiftDate(s.date);
        if (!d) return;
        const { key, label, sort } = aiPeriodKeyAndLabel(d, groupBy);
        const prev = map.get(key) || { key, label, sort, duration: 0, stops: 0 };
        prev.duration += (s.duration || 0);
        prev.stops += 1;
        map.set(key, prev);
    });

    const arr = Array.from(map.values());
    arr.forEach(x => x.value = (metric === 'stops') ? x.stops : x.duration);
    return arr;
}

// ----- TEMPLATES "IA" (HEURISTIQUES) -----
function aiDetectCategory(cause) {
    const c = (cause || '').toLowerCase();
    if (c.includes('composant') || c.includes('chariot') || c.includes('logist') || c.includes('attente')) return 'logistique';
    if (c.includes('machine') || c.includes('panne') || c.includes('r√©glage') || c.includes('maintenance') || c.includes('pneumatique') || c.includes('√©lectrique')) return 'machine';
    if (c.includes('qualit√©') || c.includes('qualite')) return 'qualite';
    if (c.includes('absence') || c.includes('op√©rateur') || c.includes('operateur')) return 'manpower';
    if (c.includes('s√©curit√©') || c.includes('securite') || c.includes('incident')) return 'securite';
    if (c.includes('changement') || c.includes('outillage')) return 'outillage';
    return 'autre';
}

function aiGetTemplates(category, topCause) {
    const templates = {
        logistique: {
            whys: [
                `Parce que la production a √©t√© bloqu√©e par "${topCause}".`,
                `Parce qu‚Äôun r√©approvisionnement bord de ligne / flux n‚Äôa pas √©t√© r√©alis√© dans le d√©lai standard.`,
                `Parce que le signal (Kanban / appel logistique) n‚Äôa pas √©t√© d√©clench√©, trait√© ou visible √† temps.`,
                `Parce que les standards (tourn√©e, niveau mini/maxi, r√¥le/relai) ne sont pas suffisamment robustes ou pas respect√©s.`,
                `Parce que le pilotage (rituel, indicateurs, audit, escalade) n‚Äôest pas standardis√© pour pr√©venir les ruptures.`
            ],
            root: `Standardiser et fiabiliser le processus d‚Äôapprovisionnement bord de ligne (signal ‚Üí prise en charge ‚Üí livraison) avec contr√¥le visuel et responsabilit√©s claires.`,
            pdca: {
                plan: `Objectif: r√©duire les arr√™ts li√©s √† l‚Äôapprovisionnement ("${topCause}") sur la p√©riode.
Cible: -30% temps d‚Äôarr√™t sur 4 semaines.
P√©rim√®tre: bord de ligne + logistique (tourn√©e, kanban, mini/maxi).`,
                do: `Actions imm√©diates: v√©rifier niveaux mini/maxi, identifier les r√©f√©rences critiques, s√©curiser un stock tampon, clarifier qui d√©clenche l‚Äôappel et qui livre.
Actions terrain: marquage visuel, check-list de tourn√©e, standard d‚Äôescalade.`,
                check: `Suivre chaque shift: nb d‚Äôarr√™ts "${topCause}", dur√©e totale, d√©lai de r√©approvisionnement.
V√©rifier: respect tourn√©e, conformit√© mini/maxi, taux de rupture.`,
                act: `Standardiser (SOP), former, auditer 1x/sem, int√©grer au rituel quotidien.
Mettre √† jour les standards si les r√©sultats sont atteints.`
            },
            actions: [
                { action: "Identifier r√©f√©rences/components critiques + niveau mini/maxi", owner: "Logistique / M√©thodes", due: "", priority: "Haute", status: "Ouvert", notes: "" },
                { action: "Mettre en place signal visuel (Kanban) + r√®gles d‚Äôescalade", owner: "Production / Logistique", due: "", priority: "Haute", status: "Ouvert", notes: "" },
                { action: "Revoir fr√©quence tourn√©e / chemin / charge chariot", owner: "Logistique", due: "", priority: "Moyenne", status: "Ouvert", notes: "" },
                { action: "Former op√©rateurs sur le d√©clenchement d‚Äôappel + standard", owner: "Team Leader", due: "", priority: "Moyenne", status: "Ouvert", notes: "" }
            ],
            intervention: `Intervention: alerte logistique, v√©rification bord de ligne, s√©curisation temporaire (stock tampon / priorisation), relance et red√©marrage apr√®s r√©approvisionnement et validation TL.`
        },
        machine: {
            whys: [
                `Parce que la ligne s‚Äôest arr√™t√©e suite √† "${topCause}".`,
                `Parce qu‚Äôun organe machine / r√©glage n‚Äôa pas tenu les conditions nominales (usure, d√©faut, capteur, param√®tre).`,
                `Parce que l‚Äôanomalie n‚Äôa pas √©t√© d√©tect√©e/√©vit√© par les contr√¥les standard (TPM, check d√©but de shift).`,
                `Parce que le plan de maintenance pr√©ventive / pi√®ces / standards r√©glage n‚Äôest pas suffisant ou pas respect√©.`,
                `Parce que le retour d‚Äôexp√©rience (Rex) et la standardisation ne bouclent pas entre Prod/Maintenance/M√©thodes.`
            ],
            root: `Renforcer TPM + maintenance pr√©ventive cibl√©e + standard de r√©glage/d√©marrage et boucler le REX (check-list + actions robustes).`,
            pdca: {
                plan: `Objectif: r√©duire les arr√™ts machine ("${topCause}").
Cible: -25% dur√©e totale sur 4 semaines.
P√©rim√®tre: poste concern√© + maintenance + m√©thodes.`,
                do: `Actions: diagnostic + 5 pourquoi terrain, contr√¥le pi√®ces d‚Äôusure, standard r√©glage, check-list d√©but de shift, d√©clenchement maintenance pr√©ventive.
S√©curisation: stock pi√®ces critiques + temps de r√©action.`,
                check: `KPI: MTBF/MTTR, nb d‚Äôarr√™ts "${topCause}", dur√©e, pi√®ce remplac√©e.
Audit: conformit√© check-list + respect gammes.`,
                act: `Standardiser gammes, former, verrouiller param√®tres, planifier maintenance.
Capitaliser Rex (1 page) et d√©ployer sur postes similaires.`
            },
            actions: [
                { action: "Identifier le composant machine en cause + diagnostic (maintenance)", owner: "Maintenance", due: "", priority: "Haute", status: "Ouvert", notes: "" },
                { action: "Mettre √† jour la check-list TPM / d√©but shift", owner: "Maintenance / TL", due: "", priority: "Haute", status: "Ouvert", notes: "" },
                { action: "S√©curiser pi√®ces d‚Äôusure critiques (mini stock)", owner: "Maintenance / Magasin", due: "", priority: "Moyenne", status: "Ouvert", notes: "" },
                { action: "Standardiser r√©glage / red√©marrage + formation", owner: "M√©thodes / TL", due: "", priority: "Moyenne", status: "Ouvert", notes: "" }
            ],
            intervention: `Intervention: s√©curisation zone, arr√™t en s√©curit√©, appel maintenance, diagnostic rapide, red√©marrage apr√®s validation et contr√¥le du poste.`
        },
        qualite: {
            whys: [
                `Parce que l‚Äôarr√™t est li√© √† "${topCause}".`,
                `Parce qu‚Äôun d√©faut a √©t√© d√©tect√© (produit / process) n√©cessitant un arr√™t pour tri/r√©glage.`,
                `Parce que le process n‚Äôa pas contenu la variation (param√®tre, mati√®re, outillage, m√©thode).`,
                `Parce que les contr√¥les au poste / standards de r√©glage/contr√¥le ne sont pas suffisants ou pas respect√©s.`,
                `Parce que les causes de variabilit√© ne sont pas √©limin√©es durablement (standardisation + audit + REX).`
            ],
            root: `Stabiliser le process (param√®tres/contr√¥les) et standardiser la r√©action qualit√© (tri, r√©glage, validation) avec suivi des d√©rives.`,
            pdca: {
                plan: `Objectif: diminuer les arr√™ts qualit√© ("${topCause}") et √©viter la r√©currence.
Cible: 0 r√©currence sur 2 semaines + baisse dur√©e totale.`,
                do: `Actions: identifier d√©faut principal, v√©rifier param√®tre process, renforcer contr√¥le (fr√©quence), standard de r√©action (andons, tri).`,
                check: `KPI: nb d‚Äôarr√™ts qualit√©, dur√©e, taux d√©faut.
Audit: conformit√© contr√¥le + validation r√©glage.`,
                act: `Standardiser la r√©action qualit√© + mettre √† jour instructions et former.
Boucler Rex et d√©ployer sur postes similaires.`
            },
            actions: [
                { action: "D√©finir d√©faut principal + check param√®tre process", owner: "Qualit√© / M√©thodes", due: "", priority: "Haute", status: "Ouvert", notes: "" },
                { action: "Renforcer contr√¥le au poste (fr√©quence, crit√®res)", owner: "Qualit√©", due: "", priority: "Moyenne", status: "Ouvert", notes: "" },
                { action: "Standard de r√©action (tri, andon, validation red√©marrage)", owner: "Qualit√© / TL", due: "", priority: "Haute", status: "Ouvert", notes: "" }
            ],
            intervention: `Intervention: blocage s√©curis√©, alerte qualit√©, tri/contr√¥le, r√©glage si n√©cessaire, red√©marrage apr√®s validation qualit√©.`
        },
        manpower: {
            whys: [
                `Parce que la ligne s‚Äôest arr√™t√©e √† cause de "${topCause}".`,
                `Parce que la ressource op√©rateur n‚Äô√©tait pas disponible au poste au moment critique.`,
                `Parce que la gestion des remplacements/relai n‚Äôa pas couvert l‚Äôal√©a (absence, pause, formation).`,
                `Parce que la polyvalence / planning / standard de relai n‚Äôest pas assez robuste.`,
                `Parce que le syst√®me d‚Äôanticipation (planification, vivier, polyvalence) n‚Äôest pas suffisamment pilot√©.`
            ],
            root: `Renforcer polyvalence + standard de relai + plan de couverture des absences (anticipation + escalade).`,
            pdca: {
                plan: `Objectif: limiter les arr√™ts li√©s aux absences.
Cible: 0 arr√™t li√© √† l‚Äôabsence sur 2 semaines.
P√©rim√®tre: planning + polyvalence + relai.`,
                do: `Actions: matrice polyvalence, relai standard, point d√©but shift sur manquants, plan de remplacement (A/B).`,
                check: `KPI: nb d‚Äôarr√™ts "${topCause}", temps total, taux couverture.
Audit: respect standard de relai.`,
                act: `Standardiser (rituel + check-list), former polyvalence, ajuster planning.
Mettre √† jour matrice comp√©tences.`
            },
            actions: [
                { action: "Mettre √† jour matrice polyvalence + besoins prioritaires", owner: "TL / RH", due: "", priority: "Haute", status: "Ouvert", notes: "" },
                { action: "D√©finir standard relai (pause/absence) + check-list", owner: "TL", due: "", priority: "Moyenne", status: "Ouvert", notes: "" },
                { action: "Point quotidien d√©but de shift: couverture postes critiques", owner: "TL", due: "", priority: "Moyenne", status: "Ouvert", notes: "" }
            ],
            intervention: `Intervention: r√©affectation / relai imm√©diat, appel renfort, s√©curisation du poste, red√©marrage d√®s pr√©sence op√©rateur et validation TL.`
        },
        securite: {
            whys: [
                `Parce que la ligne s‚Äôest arr√™t√©e suite √† "${topCause}".`,
                `Parce qu‚Äôun risque s√©curit√© a √©t√© d√©tect√© n√©cessitant une mise en s√©curit√© imm√©diate.`,
                `Parce que la condition dangereuse n‚Äôa pas √©t√© pr√©venue par les standards (5S, protections, check).`,
                `Parce que les audits / contr√¥les s√©curit√© ne d√©tectent pas assez t√¥t les d√©rives.`,
                `Parce que la culture s√©curit√© (signalement, standardisation, actions) doit √™tre renforc√©e et pilot√©e.`
            ],
            root: `√âliminer le risque √† la source et standardiser les contr√¥les s√©curit√© (audit, 5S, formation, actions).`,
            pdca: {
                plan: `Objectif: 0 incident et 0 arr√™t s√©curit√©.
P√©rim√®tre: zone concern√©e + 5S + protections.
Cible: actions imm√©diates sous 48h.`,
                do: `Actions: mise en s√©curit√©, analyse cause, correction technique/organisationnelle, briefing s√©curit√©.`,
                check: `Audit s√©curit√© + 5S, suivi des √©carts, v√©rification efficacit√©.`,
                act: `Standardiser, former, int√©grer au rituel et audits r√©guliers.`
            },
            actions: [
                { action: "Analyser le risque + supprimer danger √† la source", owner: "HSE / Production", due: "", priority: "Haute", status: "Ouvert", notes: "" },
                { action: "Mettre √† jour standard 5S / check s√©curit√©", owner: "HSE / TL", due: "", priority: "Moyenne", status: "Ouvert", notes: "" }
            ],
            intervention: `Intervention: arr√™t s√©curis√© imm√©diat, balisage, alerte HSE, correction, red√©marrage apr√®s validation s√©curit√©.`
        },
        outillage: {
            whys: [
                `Parce que l‚Äôarr√™t est li√© √† "${topCause}".`,
                `Parce que le changement d‚Äôoutillage / r√©glage a pris plus de temps que pr√©vu ou a g√©n√©r√© une anomalie.`,
                `Parce que le standard SMED / pr√©paration n‚Äô√©tait pas complet ou pas respect√©.`,
                `Parce que les moyens / pi√®ces / check-list n‚Äô√©taient pas pr√™ts et valid√©s avant changement.`,
                `Parce que la standardisation et la formation sur le changement n‚Äôest pas suffisamment robuste.`
            ],
            root: `Renforcer SMED (pr√©paration, check-list, kits, validation) pour r√©duire variabilit√© du changement.`,
            pdca: {
                plan: `Objectif: r√©duire temps et arr√™ts outillage.
Cible: -20% dur√©e sur 1 mois.
P√©rim√®tre: poste + m√©thodes.`,
                do: `Actions: pr√©parer kits, check-list, standard SMED, formation.`,
                check: `KPI: dur√©e changement, nb d‚Äôarr√™ts, conformit√© check-list.`,
                act: `Standardiser, auditer, d√©ployer sur autres postes.`
            },
            actions: [
                { action: "Cr√©er kit outillage + check-list SMED", owner: "M√©thodes", due: "", priority: "Haute", status: "Ouvert", notes: "" },
                { action: "Former op√©rateurs au standard changement", owner: "TL / M√©thodes", due: "", priority: "Moyenne", status: "Ouvert", notes: "" }
            ],
            intervention: `Intervention: pr√©paration outillage, coordination √©quipe, validation r√©glage, red√©marrage apr√®s contr√¥le.`
        },
        autre: {
            whys: [
                `Parce que la production a √©t√© interrompue par "${topCause}".`,
                `Parce qu‚Äôune condition anormale a emp√™ch√© la continuit√© de production.`,
                `Parce que le standard de d√©tection/r√©action n‚Äôa pas permis d‚Äô√©viter ou r√©duire l‚Äôarr√™t.`,
                `Parce que les causes r√©elles ne sont pas suffisamment document√©es (Rex) et standardis√©es.`,
                `Parce que le pilotage (standard + formation + audit) doit √™tre renforc√©.`
            ],
            root: `Clarifier la cause r√©elle et standardiser la pr√©vention (check-list, r√¥les, escalade) afin d‚Äô√©viter la r√©currence.`,
            pdca: {
                plan: `Objectif: comprendre et √©liminer la cause "${topCause}".
Cible: 0 r√©currence sur 2 semaines.
P√©rim√®tre: poste concern√©.`,
                do: `Actions: observation terrain, collecte faits, test de solutions, mise √† jour standard.`,
                check: `KPI: nb d‚Äôarr√™ts, dur√©e, r√©currence.
V√©rifier application standard.`,
                act: `Standardiser solution, former, auditer, capitaliser Rex.`
            },
            actions: [
                { action: "Clarifier la cause r√©elle (fait ‚Üí cause) avec l'√©quipe terrain", owner: "TL / M√©thodes", due: "", priority: "Haute", status: "Ouvert", notes: "" },
                { action: "D√©finir et tester contre-mesure", owner: "M√©thodes / Maintenance", due: "", priority: "Moyenne", status: "Ouvert", notes: "" }
            ],
            intervention: `Intervention: coordination terrain, collecte faits (heure, poste, sympt√¥me), escalade (maintenance/logistique/qualit√©), red√©marrage apr√®s validation.`
        }
    };


    return templates[category] || templates.autre;
}

function aiGetEvidenceTemplate(category, topCause) {
    const header = `Constat principal li√© √† la cause: "${topCause}".`;
    const common = `‚Ä¢ Heure / poste / zone: ...
‚Ä¢ Sympt√¥me observ√© (factuel): ...
‚Ä¢ Action imm√©diate r√©alis√©e (s√©curisation / alerte / relance): ...
‚Ä¢ Personnes/√©quipes contact√©es: ...
‚Ä¢ Pi√®ces/infos utiles (n¬∞ s√©rie, n¬∞ OF, n¬∞ chariot, code d√©faut): ...
‚Ä¢ Photos / preuves (si possible): ...`;

    const byCat = {
        machine: `‚Ä¢ Code d√©faut / alarme: ...
‚Ä¢ √âtat machine (capteur, v√©rin, moteur, s√©curit√©): ...
‚Ä¢ Action maintenance (diagnostic, pi√®ce, r√©glage): ...`,
        logistique: `‚Ä¢ R√©f√©rence composant / point de consommation: ...
‚Ä¢ Niveau mini/maxi constat√©: ...
‚Ä¢ D√©lai de r√©appro / tourn√©e / n¬∞ chariot: ...
‚Ä¢ Action logistique (urgence / stock tampon): ...`,
        qualite: `‚Ä¢ D√©faut constat√© (description): ...
‚Ä¢ Pi√®ce/lot concern√©: ...
‚Ä¢ Tri/retouche r√©alis√©(e): ...
‚Ä¢ D√©cision qualit√© (OK/NOK) + crit√®res: ...`,
        manpower: `‚Ä¢ Poste impact√© / besoin critique: ...
‚Ä¢ Manquant/renfort (polyvalence): ...
‚Ä¢ Standard de relai appliqu√© (oui/non): ...`,
        securite: `‚Ä¢ Risque s√©curit√© d√©tect√©: ...
‚Ä¢ Mise en s√©curit√© r√©alis√©e: ...
‚Ä¢ Validation HSE (si applicable): ...`,
        outillage: `‚Ä¢ Outillage concern√©: ...
‚Ä¢ Pr√©paration SMED (kits/check-list): ...
‚Ä¢ R√©glages effectu√©s + validation: ...`,
        autre: `‚Ä¢ Contexte (√©v√©nement, changement, al√©a): ...
‚Ä¢ Hypoth√®se cause + √©l√©ments observ√©s: ...`
    };

    const extra = byCat[category] || byCat.autre;
    return `${header}

${common}

${extra}

Conclusion / prochaine √©tape: ...`;
}

 // ----- UI: ACTION PLAN -----
function aiRenderActionPlan() {
    const tbody = document.getElementById('aiActionPlanBody');
    if (!tbody) return;
    tbody.innerHTML = '';

    if (!Array.isArray(aiActionPlan)) aiActionPlan = [];

    aiActionPlan.forEach((row, idx) => {
        const tr = document.createElement('tr');

        const priorities = ["Haute", "Moyenne", "Basse"];
        const status = ["Ouvert", "En cours", "Bloqu√©", "Fait"];

        tr.innerHTML = `
            <td><div class="ai-editable small" contenteditable="true" data-field="action" data-idx="${idx}">${row.action || ''}</div></td>
            <td><div class="ai-editable small" contenteditable="true" data-field="owner" data-idx="${idx}">${row.owner || ''}</div></td>
            <td><div class="ai-editable small" contenteditable="true" data-field="due" data-idx="${idx}">${row.due || ''}</div></td>
            <td>
                <select data-field="priority" data-idx="${idx}" style="width:100%; padding:8px; border-radius:8px; border:1px solid rgba(0,0,0,0.12);">
                    ${priorities.map(p => `<option value="${p}" ${row.priority===p?'selected':''}>${p}</option>`).join('')}
                </select>
            </td>
            <td>
                <select data-field="status" data-idx="${idx}" style="width:100%; padding:8px; border-radius:8px; border:1px solid rgba(0,0,0,0.12);">
                    ${status.map(s => `<option value="${s}" ${row.status===s?'selected':''}>${s}</option>`).join('')}
                </select>
            </td>
            <td><div class="ai-editable small" contenteditable="true" data-field="notes" data-idx="${idx}">${row.notes || ''}</div></td>
            <td class="no-print" style="text-align:center;">
                <button class="ai-btn" style="background: rgba(217,4,41,0.9); color:white; padding:8px 10px;" onclick="aiRemoveActionRow(${idx})">üóëÔ∏è</button>
            </td>
        `;

        tbody.appendChild(tr);
    });

    // Listeners: contenteditable -> update model
    tbody.querySelectorAll('[contenteditable="true"]').forEach(el => {
        el.addEventListener('input', () => {
            const idx = parseInt(el.getAttribute('data-idx'), 10);
            const field = el.getAttribute('data-field');
            if (!aiActionPlan[idx]) return;
            aiActionPlan[idx][field] = el.textContent;
        });
    });
    tbody.querySelectorAll('select').forEach(sel => {
        sel.addEventListener('change', () => {
            const idx = parseInt(sel.getAttribute('data-idx'), 10);
            const field = sel.getAttribute('data-field');
            if (!aiActionPlan[idx]) return;
            aiActionPlan[idx][field] = sel.value;
        });
    });
}

function aiAddActionRow() {
    if (!Array.isArray(aiActionPlan)) aiActionPlan = [];
    aiActionPlan.push({ action: "", owner: "", due: "", priority: "Moyenne", status: "Ouvert", notes: "" });
    aiRenderActionPlan();
}

function aiRemoveActionRow(index) {
    if (!Array.isArray(aiActionPlan)) return;
    aiActionPlan.splice(index, 1);
    aiRenderActionPlan();
}

function aiResetActionPlan() {
    // Re-g√©n√®re √† partir de la cause principale
    const data = aiGetFilteredStops();
    const causeAgg = aiAggregateCauses(data.stopsNoPause);
    const top = causeAgg[0]?.cause || "Non sp√©cifi√©";
    const category = aiDetectCategory(top);
    const tpl = aiGetTemplates(category, top);
    aiActionPlan = (tpl.actions || []).map(x => ({...x}));
    aiRenderActionPlan();
    showNotification("‚úÖ Plan d'action r√©initialis√© (auto) selon la cause principale", "success");
}

// ----- TABLE TOP CAUSES -----

function aiRenderTopCausesTable(causeAgg) {
    const tbody = document.getElementById('aiTopCausesTableBody');
    if (!tbody) return;
    tbody.innerHTML = '';

    const top = causeAgg.slice(0, 12);
    const total = causeAgg.reduce((sum, x) => sum + x.duration, 0) || 1;
    let cum = 0;

    top.forEach(x => {
        cum += x.duration;
        const pct = (x.duration / total) * 100;
        const pctCum = (cum / total) * 100;
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${escapeHtml(x.cause)}</td>
            <td>${x.count}</td>
            <td>${aiFormatSeconds(x.duration)}</td>
            <td>${pct.toFixed(1)}%</td>
            <td>${pctCum.toFixed(1)}%</td>
        `;
        tbody.appendChild(tr);
    });
}


// ----- CHARTS -----

function aiUpdateCharts(stopsNoPause, groupBy, metric) {
    // Helpers
    const computeCumPct = (values) => {
        const total = values.reduce((a,b) => a + b, 0) || 1;
        let cum = 0;
        return values.map(v => {
            cum += v;
            return (cum / total) * 100;
        });
    };

    // =========================
    // 1) PARETO CAUSES (DUR√âE)
    // =========================
    const causeAggFull = aiAggregateCauses(stopsNoPause);
    const causeAgg = causeAggFull.slice(0, 10);
    const causeLabels = causeAgg.map(x => x.cause.length > 26 ? x.cause.slice(0, 26) + "‚Ä¶" : x.cause);
    const causeValues = causeAgg.map(x => x.duration);
    const causeCumPct = computeCumPct(causeValues);

    const ctx1 = document.getElementById('aiParetoCauseChart')?.getContext('2d');
    if (ctx1) {
        if (aiCharts.paretoCause) aiCharts.paretoCause.destroy();

        aiCharts.paretoCause = new Chart(ctx1, {
            data: {
                labels: causeLabels,
                datasets: [
                    {
                        type: 'bar',
                        label: 'Dur√©e (s)',
                        data: causeValues,
                        yAxisID: 'y',
                        backgroundColor: 'rgba(26, 125, 255, 0.25)',
                        borderColor: 'rgba(26, 125, 255, 0.9)',
                        borderWidth: 2,
                        borderRadius: 6
                    },
                    {
                        type: 'line',
                        label: '% cumul√©',
                        data: causeCumPct,
                        yAxisID: 'y1',
                        borderColor: 'rgba(255, 159, 28, 0.95)',
                        backgroundColor: 'rgba(255, 159, 28, 0.20)',
                        borderWidth: 3,
                        pointRadius: 3,
                        tension: 0.25
                    },
                    {
                        type: 'line',
                        label: 'Seuil 80%',
                        data: new Array(causeLabels.length).fill(80),
                        yAxisID: 'y1',
                        borderColor: 'rgba(217, 4, 41, 0.9)',
                        borderWidth: 2,
                        borderDash: [8, 6],
                        pointRadius: 0
                    }
                ]
            },
            options: {
                responsive: true,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { display: true },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const dsLabel = context.dataset.label || '';
                                if (dsLabel.includes('Dur√©e')) {
                                    return `Dur√©e: ${aiFormatSeconds(context.parsed.y)}`;
                                }
                                if (dsLabel.includes('%')) {
                                    return `${dsLabel}: ${context.parsed.y.toFixed(1)}%`;
                                }
                                return `${dsLabel}: ${context.parsed.y}`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Dur√©e (secondes)', color: '#0f172a' },
                        ticks: { color: '#0f172a' },
                        grid: { color: 'rgba(0,0,0,0.08)' }
                    },
                    y1: {
                        beginAtZero: true,
                        min: 0,
                        max: 100,
                        position: 'right',
                        title: { display: true, text: '% cumul√© (Pareto)', color: '#0f172a' },
                        ticks: { color: '#0f172a', callback: (v) => v + '%' },
                        grid: { drawOnChartArea: false }
                    },
                    x: {
                        ticks: { color: '#0f172a' },
                        grid: { display: false }
                    }
                }
            }
        });
    }

    // =========================
    // 2) PARETO PAR P√âRIODE
    // =========================
    const periodAgg = aiAggregatePeriods(stopsNoPause, groupBy, metric);
    periodAgg.sort((a,b) => b.value - a.value); // tri Pareto
    const periodTop = periodAgg.slice(0, 12);

    const pLabels = periodTop.map(x => x.label);
    const pValues = periodTop.map(x => x.value);
    const pCumPct = computeCumPct(pValues);

    const metricLabel = metric === 'stops' ? "Arr√™ts" : "Dur√©e (s)";
    const ctx2 = document.getElementById('aiPeriodChart')?.getContext('2d');

    if (ctx2) {
        if (aiCharts.period) aiCharts.period.destroy();

        aiCharts.period = new Chart(ctx2, {
            data: {
                labels: pLabels,
                datasets: [
                    {
                        type: 'bar',
                        label: metricLabel,
                        data: pValues,
                        yAxisID: 'y',
                        backgroundColor: 'rgba(42, 157, 143, 0.25)',
                        borderColor: 'rgba(42, 157, 143, 0.9)',
                        borderWidth: 2,
                        borderRadius: 6
                    },
                    {
                        type: 'line',
                        label: '% cumul√©',
                        data: pCumPct,
                        yAxisID: 'y1',
                        borderColor: 'rgba(255, 159, 28, 0.95)',
                        backgroundColor: 'rgba(255, 159, 28, 0.20)',
                        borderWidth: 3,
                        pointRadius: 3,
                        tension: 0.25
                    },
                    {
                        type: 'line',
                        label: 'Seuil 80%',
                        data: new Array(pLabels.length).fill(80),
                        yAxisID: 'y1',
                        borderColor: 'rgba(217, 4, 41, 0.9)',
                        borderWidth: 2,
                        borderDash: [8, 6],
                        pointRadius: 0
                    }
                ]
            },
            options: {
                responsive: true,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { display: true },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const dsLabel = context.dataset.label || '';
                                if (dsLabel === metricLabel) {
                                    if (metric === 'stops') return `Arr√™ts: ${context.parsed.y}`;
                                    return `Dur√©e: ${aiFormatSeconds(context.parsed.y)}`;
                                }
                                if (dsLabel.includes('%')) {
                                    return `${dsLabel}: ${context.parsed.y.toFixed(1)}%`;
                                }
                                return `${dsLabel}: ${context.parsed.y}`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: metric === 'stops' ? "Nombre d'arr√™ts" : "Dur√©e (secondes)", color: '#0f172a' },
                        ticks: { color: '#0f172a' },
                        grid: { color: 'rgba(0,0,0,0.08)' }
                    },
                    y1: {
                        beginAtZero: true,
                        min: 0,
                        max: 100,
                        position: 'right',
                        title: { display: true, text: '% cumul√© (Pareto)', color: '#0f172a' },
                        ticks: { color: '#0f172a', callback: (v) => v + '%' },
                        grid: { drawOnChartArea: false }
                    },
                    x: {
                        ticks: { color: '#0f172a' },
                        grid: { display: false }
                    }
                }
            }
        });
    }

    // Notes
    const paretoNote = document.getElementById('aiParetoNote');
    if (paretoNote) {
        paretoNote.textContent = "Pareto (dur√©e) + % cumul√© + seuil 80% sur le p√©rim√®tre s√©lectionn√©.";
    }
    const periodNote = document.getElementById('aiPeriodNote');
    if (periodNote) {
        const unitLabel = groupBy === 'week' ? 'semaines' : (groupBy === 'month' ? 'mois' : 'ann√©es');
        periodNote.textContent = `Pareto des ${unitLabel} (Top 12) + % cumul√© + seuil 80%.`;
    }

    return causeAggFull;
}


// ----- CONTENU RAPPORT -----
function updateAIReport() {
    // appel√© quand l'onglet est ouvert
    aiRefreshPeriodValueOptions();
    aiGenerateOrRefresh(false);
}

function aiRefreshPeriodValueOptions() {
    const select = document.getElementById('aiPeriodValueSelect');
    if (!select) return;

    const groupBy = document.getElementById('aiGroupBySelect')?.value || 'week';
    const team = document.getElementById('aiTeamSelect')?.value || 'all';
    const shiftPeriod = document.getElementById('aiShiftPeriodSelect')?.value || 'today';
    const excludePauses = document.getElementById('aiExcludePauses')?.checked ?? true;

    // Construire la liste des p√©riodes disponibles √† partir des arr√™ts filtr√©s
    let stops = Array.isArray(history) ? [...history] : [];
    if (team !== 'all') stops = stops.filter(s => s.equipe === team);
    stops = filterByShiftPeriod(stops, shiftPeriod);
    if (excludePauses) stops = stops.filter(s => !aiIsPauseCause(s.cause));

    const keys = new Map(); // key -> {label, sort}
    stops.forEach(s => {
        const d = aiParseShiftDate(s.date);
        if (!d) return;
        const { key, label, sort } = aiPeriodKeyAndLabel(d, groupBy);
        keys.set(key, { key, label, sort });
    });

    const list = Array.from(keys.values()).sort((a,b) => a.sort - b.sort);

    // Conserver s√©lection si possible
    const current = select.value || 'all';
    select.innerHTML = `<option value="all">Toutes</option>` + list.map(x => `<option value="${x.key}">${x.label}</option>`).join('');
    if (list.some(x => x.key === current)) select.value = current;
}

function aiGenerateOrRefresh(forceResetEdits = false) {
    const { stops, stopsNoPause, team, shiftPeriod, groupBy, periodValue, excludePauses } = aiGetFilteredStops();

    // Meta
    const now = new Date();
    const teamLabel = team === 'all' ? 'Toutes √©quipes' : `√âquipe ${team}`;
    const periodLabelMap = { today: 'Shift actuel', week: '4 derniers shifts', month: '4 derniers shifts', all: 'Tous shifts' };
    let periodLabel = periodLabelMap[shiftPeriod] || shiftPeriod;
    if (periodValue && periodValue !== 'all') {
        // Afficher label humain
        const d = aiParseShiftDate(stops[0]?.date || getShiftDate(new Date()));
        // On reconstruit label √† partir de la cl√©
        const listSel = document.getElementById('aiPeriodValueSelect');
        const selectedText = listSel?.options?.[listSel.selectedIndex]?.textContent;
        periodLabel += ` | ${selectedText || periodValue}`;
    }

    const meta = document.getElementById('aiReportMeta');
    if (meta) {
        const shiftInfo = (typeof currentShiftType !== 'undefined' && shiftConfigs && shiftConfigs[currentShiftType]) ? shiftConfigs[currentShiftType].name : '';
        meta.innerHTML = `
            <div><strong>Date/heure:</strong> ${now.toLocaleString('fr-FR')}</div>
            <div><strong>P√©rim√®tre:</strong> ${teamLabel} ‚Ä¢ ${periodLabel}</div>
            <div><strong>Shift (r√©f√©rence):</strong> ${shiftInfo || 'N/A'} ‚Ä¢ Team Leader: ${(teamLeader || '').trim() || '‚Äî'}</div>
        `;
    }

    const badgeTeam = document.getElementById('aiBadgeTeam');
    if (badgeTeam) badgeTeam.textContent = `√âquipe: ${teamLabel}`;
    const badgePeriod = document.getElementById('aiBadgePeriod');
    if (badgePeriod) badgePeriod.textContent = `P√©riode: ${periodLabel}`;
    const badgeGenerated = document.getElementById('aiBadgeGenerated');
    if (badgeGenerated) badgeGenerated.textContent = `G√©n√©r√©: ${now.toLocaleDateString('fr-FR')} ${now.toLocaleTimeString('fr-FR').slice(0,5)}`;

    // KPI
    const totalStops = stops.length;
    const gross = stops.reduce((sum, s) => sum + (s.duration || 0), 0);
    const noPause = stopsNoPause.reduce((sum, s) => sum + (s.duration || 0), 0);
    const causeAgg = aiAggregateCauses(stopsNoPause);
    const topCause = causeAgg[0]?.cause || '‚Äî';

    document.getElementById('aiKpiStops').textContent = totalStops;
    document.getElementById('aiKpiDurationGross').textContent = aiFormatSeconds(gross);
    document.getElementById('aiKpiDurationNoPause').textContent = aiFormatSeconds(noPause);
    document.getElementById('aiKpiTopCause').textContent = (topCause.length > 22 ? topCause.slice(0, 22) + "‚Ä¶" : topCause);

    // Charts
    const metric = document.getElementById('aiMetricSelect')?.value || 'duration';
    const aggForTable = aiUpdateCharts(stopsNoPause, groupBy, metric);
    aiRenderTopCausesTable(aggForTable);

    // Synth√®se + 5 why + PDCA + actions (auto)
    const category = aiDetectCategory(topCause);
    const tpl = aiGetTemplates(category, topCause);

    // S'il n'y a pas d'arr√™ts, mettre du texte neutre
    const summaryEl = document.getElementById('aiSummary');
    const whyEls = [1,2,3,4,5].map(i => document.getElementById(`aiWhy${i}`));
    const rootEl = document.getElementById('aiRootCause');
    const pdcaPlanEl = document.getElementById('aiPDCAPlan');
    const pdcaDoEl = document.getElementById('aiPDCAdo');
    const pdcaCheckEl = document.getElementById('aiPDCAcheck');
    const pdcaActEl = document.getElementById('aiPDCAact');
    const interventionEl = document.getElementById('aiIntervention');
    const evidenceEl = document.getElementById('aiEvidence');
    const validationFieldIds = [
        'aiValTLName','aiValTLDate','aiValTLComment',
        'aiValProdName','aiValProdDate','aiValProdComment',
        'aiValMaintName','aiValMaintDate','aiValMaintComment',
        'aiValLogName','aiValLogDate','aiValLogComment',
        'aiValQualName','aiValQualDate','aiValQualComment'
    ];

    if (totalStops === 0) {
        const emptyText = "Aucun arr√™t enregistr√© sur le p√©rim√®tre s√©lectionn√©. Aucune analyse 5 pourquoi g√©n√©r√©e.";
        if (summaryEl && (forceResetEdits || !summaryEl.textContent.trim())) summaryEl.textContent = emptyText;
        whyEls.forEach(el => { if (el && (forceResetEdits || !el.textContent.trim())) el.textContent = "‚Äî"; });
        if (rootEl && (forceResetEdits || !rootEl.textContent.trim())) rootEl.textContent = "‚Äî";
        if (pdcaPlanEl && (forceResetEdits || !pdcaPlanEl.textContent.trim())) pdcaPlanEl.textContent = "‚Äî";
        if (pdcaDoEl && (forceResetEdits || !pdcaDoEl.textContent.trim())) pdcaDoEl.textContent = "‚Äî";
        if (pdcaCheckEl && (forceResetEdits || !pdcaCheckEl.textContent.trim())) pdcaCheckEl.textContent = "‚Äî";
        if (pdcaActEl && (forceResetEdits || !pdcaActEl.textContent.trim())) pdcaActEl.textContent = "‚Äî";
        if (interventionEl && (forceResetEdits || !interventionEl.textContent.trim())) interventionEl.textContent = "‚Äî";
        if (evidenceEl && (forceResetEdits || !evidenceEl.textContent.trim())) evidenceEl.textContent = "‚Äî";
        validationFieldIds.forEach(id => {
            const el = document.getElementById(id);
            if (el && (forceResetEdits || !el.textContent.trim())) el.textContent = "‚Äî";
        });

        aiActionPlan = [];
        aiRenderActionPlan();
        return;
    }

    const topCauseDuration = causeAgg[0]?.duration || 0;
    const share = noPause > 0 ? (topCauseDuration / noPause) * 100 : 0;

    const synth = 
`Sur la p√©riode s√©lectionn√©e (${teamLabel} ‚Ä¢ ${periodLabel}), ${totalStops} arr√™t(s) ont √©t√© enregistr√©s.
Temps total: ${aiFormatSeconds(gross)} (brut) / ${aiFormatSeconds(noPause)} (hors pauses).
Cause principale: "${topCause}" (~${share.toFixed(1)}% du temps d'arr√™t hors pauses).

D√©cision: lancer une analyse 5 pourquoi + plan d'action PDCA sur la cause principale, puis v√©rifier l'efficacit√© via KPI (nb d'arr√™ts + dur√©e) sur les prochains shifts.`;

    if (summaryEl && (forceResetEdits || !summaryEl.textContent.trim() || aiState.autoGenerated)) {
        summaryEl.textContent = synth;
    }

    // 5 Why
    const whys = tpl.whys || [];
    for (let i = 0; i < 5; i++) {
        const el = whyEls[i];
        if (!el) continue;
        if (forceResetEdits || !el.textContent.trim() || aiState.autoGenerated) {
            el.textContent = whys[i] || "‚Äî";
        }
    }
    if (rootEl && (forceResetEdits || !rootEl.textContent.trim() || aiState.autoGenerated)) {
        rootEl.textContent = tpl.root || "‚Äî";
    }

    // PDCA
    if (pdcaPlanEl && (forceResetEdits || !pdcaPlanEl.textContent.trim() || aiState.autoGenerated)) pdcaPlanEl.textContent = tpl.pdca?.plan || "‚Äî";
    if (pdcaDoEl && (forceResetEdits || !pdcaDoEl.textContent.trim() || aiState.autoGenerated)) pdcaDoEl.textContent = tpl.pdca?.do || "‚Äî";
    if (pdcaCheckEl && (forceResetEdits || !pdcaCheckEl.textContent.trim() || aiState.autoGenerated)) pdcaCheckEl.textContent = tpl.pdca?.check || "‚Äî";
    if (pdcaActEl && (forceResetEdits || !pdcaActEl.textContent.trim() || aiState.autoGenerated)) pdcaActEl.textContent = tpl.pdca?.act || "‚Äî";

    // Intervention
    if (interventionEl && (forceResetEdits || !interventionEl.textContent.trim() || aiState.autoGenerated)) {
        interventionEl.textContent = tpl.intervention || "Intervention: alerte, diagnostic, s√©curisation, red√©marrage apr√®s validation.";
    }

    // Constats / preuves terrain
    if (evidenceEl && (forceResetEdits || !evidenceEl.textContent.trim() || aiState.autoGenerated)) {
        evidenceEl.textContent = aiGetEvidenceTemplate(category, topCause);
    }

    // Validation responsables (pr√©-remplissage minimal)
    const nowDateStr = now.toLocaleDateString('fr-FR');
    const setIfEmpty = (id, val) => {
        const el = document.getElementById(id);
        if (!el) return;
        if (forceResetEdits || aiState.autoGenerated || !el.textContent.trim()) {
            el.textContent = val;
        }
    };

    setIfEmpty('aiValTLName', (teamLeader || '').trim() || '‚Äî');
    setIfEmpty('aiValTLDate', nowDateStr);
    setIfEmpty('aiValTLComment', "Vu / √† valider");

    setIfEmpty('aiValProdName', "√Ä renseigner");
    setIfEmpty('aiValProdDate', "‚Äî");
    setIfEmpty('aiValProdComment', "OK/NOK + commentaire");

    setIfEmpty('aiValMaintName', "√Ä renseigner");
    setIfEmpty('aiValMaintDate', "‚Äî");
    setIfEmpty('aiValMaintComment', "Diagnostic / action / OK/NOK");

    setIfEmpty('aiValLogName', "√Ä renseigner");
    setIfEmpty('aiValLogDate', "‚Äî");
    setIfEmpty('aiValLogComment', "Appro / stock / OK/NOK");

    setIfEmpty('aiValQualName', "√Ä renseigner");
    setIfEmpty('aiValQualDate', "‚Äî");
    setIfEmpty('aiValQualComment', "Tri / d√©cision OK/NOK");

    // Action plan
    if (!Array.isArray(aiActionPlan) || aiActionPlan.length === 0 || forceResetEdits || aiState.autoGenerated) {
        aiActionPlan = (tpl.actions || []).map(x => ({...x}));
    }
    aiRenderActionPlan();

    // Mise √† jour flag
    aiState.autoGenerated = false;
}

// ----- SAUVEGARDE / RESTAURATION -----
function aiCollectReportData() {
    const getText = (id) => (document.getElementById(id)?.textContent || '').trim();

    const data = {
        team: document.getElementById('aiTeamSelect')?.value || 'all',
        shiftPeriod: document.getElementById('aiShiftPeriodSelect')?.value || 'today',
        groupBy: document.getElementById('aiGroupBySelect')?.value || 'week',
        metric: document.getElementById('aiMetricSelect')?.value || 'duration',
        periodValue: document.getElementById('aiPeriodValueSelect')?.value || 'all',
        excludePauses: document.getElementById('aiExcludePauses')?.checked ?? true,
        title: getText('aiReportTitle'),
        summary: getText('aiSummary'),
        why1: getText('aiWhy1'),
        why2: getText('aiWhy2'),
        why3: getText('aiWhy3'),
        why4: getText('aiWhy4'),
        why5: getText('aiWhy5'),
        root: getText('aiRootCause'),
        pdcaPlan: getText('aiPDCAPlan'),
        pdcaDo: getText('aiPDCAdo'),
        pdcaCheck: getText('aiPDCAcheck'),
        pdcaAct: getText('aiPDCAact'),
        intervention: getText('aiIntervention'),
        evidence: getText('aiEvidence'),

        valTLName: getText('aiValTLName'),
        valTLDate: getText('aiValTLDate'),
        valTLComment: getText('aiValTLComment'),

        valProdName: getText('aiValProdName'),
        valProdDate: getText('aiValProdDate'),
        valProdComment: getText('aiValProdComment'),

        valMaintName: getText('aiValMaintName'),
        valMaintDate: getText('aiValMaintDate'),
        valMaintComment: getText('aiValMaintComment'),

        valLogName: getText('aiValLogName'),
        valLogDate: getText('aiValLogDate'),
        valLogComment: getText('aiValLogComment'),

        valQualName: getText('aiValQualName'),
        valQualDate: getText('aiValQualDate'),
        valQualComment: getText('aiValQualComment'),

        actionPlan: Array.isArray(aiActionPlan) ? aiActionPlan : [],
        savedAt: Date.now()
    };
    return data;
}

function aiSaveReport() {
    const data = aiCollectReportData();
    LS.setItem("AI_REPORT_DATA", JSON.stringify(data));
    aiState = data;
    showNotification("‚úÖ Rapport IA sauvegard√© (local)", "success");
}

function aiRestoreReport() {
    try {
        const saved = JSON.parse(LS.getItem("AI_REPORT_DATA") || "{}");
        if (!saved || typeof saved !== 'object') return;

        // Restaurer contr√¥les
        if (saved.team) document.getElementById('aiTeamSelect').value = saved.team;
        if (saved.shiftPeriod) document.getElementById('aiShiftPeriodSelect').value = saved.shiftPeriod;
        if (saved.groupBy) document.getElementById('aiGroupBySelect').value = saved.groupBy;
        if (saved.metric) document.getElementById('aiMetricSelect').value = saved.metric;
        if (typeof saved.excludePauses === 'boolean') document.getElementById('aiExcludePauses').checked = saved.excludePauses;

        aiRefreshPeriodValueOptions();
        if (saved.periodValue) document.getElementById('aiPeriodValueSelect').value = saved.periodValue;

        // Restaurer contenu
        const setText = (id, val) => {
            const el = document.getElementById(id);
            if (el && typeof val === 'string' && val.trim()) el.textContent = val;
        };

        setText('aiReportTitle', saved.title);
        setText('aiSummary', saved.summary);
        setText('aiWhy1', saved.why1);
        setText('aiWhy2', saved.why2);
        setText('aiWhy3', saved.why3);
        setText('aiWhy4', saved.why4);
        setText('aiWhy5', saved.why5);
        setText('aiRootCause', saved.root);
        setText('aiPDCAPlan', saved.pdcaPlan);
        setText('aiPDCAdo', saved.pdcaDo);
        setText('aiPDCAcheck', saved.pdcaCheck);
        setText('aiPDCAact', saved.pdcaAct);
        setText('aiIntervention', saved.intervention);
        setText('aiEvidence', saved.evidence);

        setText('aiValTLName', saved.valTLName);
        setText('aiValTLDate', saved.valTLDate);
        setText('aiValTLComment', saved.valTLComment);

        setText('aiValProdName', saved.valProdName);
        setText('aiValProdDate', saved.valProdDate);
        setText('aiValProdComment', saved.valProdComment);

        setText('aiValMaintName', saved.valMaintName);
        setText('aiValMaintDate', saved.valMaintDate);
        setText('aiValMaintComment', saved.valMaintComment);

        setText('aiValLogName', saved.valLogName);
        setText('aiValLogDate', saved.valLogDate);
        setText('aiValLogComment', saved.valLogComment);

        setText('aiValQualName', saved.valQualName);
        setText('aiValQualDate', saved.valQualDate);
        setText('aiValQualComment', saved.valQualComment);

        aiActionPlan = Array.isArray(saved.actionPlan) ? saved.actionPlan : [];
        aiRenderActionPlan();

        aiState = saved;
    } catch (e) {
        console.log("Erreur restauration rapport IA:", e);
    }
}


// ----- PDF EXPORT -----
function aiIsMobileDevice() {
    try {
        const ua = navigator.userAgent || "";
        return /Android|iPhone|iPad|iPod/i.test(ua) || window.innerWidth < 720;
    } catch (e) {
        return window.innerWidth < 720;
    }
}

function aiExportPDF() {
    const element = document.getElementById('aiReportPrintable');
    if (!element) return;

    if (typeof html2pdf === 'undefined') {
        alert("Librairie PDF non charg√©e (html2pdf). V√©rifiez la connexion internet ou le CDN.");
        return;
    }

    // Sauvegarder avant export (option)
    try { aiSaveReport(); } catch (e) {}

    const today = new Date();
    const fileName = `Rapport_Arrets_${today.toISOString().slice(0,10)}.pdf`;

    const isMobile = aiIsMobileDevice();

    // Sur mobile (Android / MI Browser), un PDF trop lourd peut s'afficher blanc dans certains lecteurs.
    // => on g√©n√®re un PDF plus l√©ger automatiquement.
    const scale = isMobile ? 1.25 : 2;
    const quality = isMobile ? 0.82 : 0.95;
    const margin = isMobile ? 6 : 8; // en mm (voir jsPDF.unit)

    document.body.classList.add('ai-exporting');

    const opt = {
        margin: margin,
        filename: fileName,
        image: { type: 'jpeg', quality: quality },
        html2canvas: { scale: scale, useCORS: true, backgroundColor: '#ffffff', logging: false },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait', compress: true },
        pagebreak: { mode: ['css', 'legacy'] }
    };

    // Laisser le navigateur "peindre" les canvases/DOM (compat mobile)
    setTimeout(() => {
        html2pdf().set(opt).from(element).save()
        .then(() => {
            document.body.classList.remove('ai-exporting');
            if (isMobile) {
                showNotification("üìÑ PDF g√©n√©r√© (optimis√© mobile). Si l'aper√ßu est blanc, ouvrez-le avec Google Drive / Adobe Reader, ou utilisez 'Imprimer / PDF syst√®me'.", "success");
            } else {
                showNotification("üìÑ PDF g√©n√©r√© et t√©l√©charg√©", "success");
            }
        })
        .catch((err) => {
            document.body.classList.remove('ai-exporting');
            console.log(err);
            alert("Erreur export PDF. Astuce: essayez 'Imprimer / PDF syst√®me' (plus compatible) ou faites l'export sur PC (Chrome/Edge).");
        });
    }, 250);
}

function aiPrintSystemPDF() {
    // Option plus compatible: utilise l'impression syst√®me (Android -> 'Enregistrer en PDF')
    try { aiSaveReport(); } catch (e) {}

    document.body.classList.add('ai-printing');

    const cleanup = () => {
        document.body.classList.remove('ai-printing');
        window.removeEventListener('afterprint', cleanup);
        window.removeEventListener('focus', cleanup);
    };

    window.addEventListener('afterprint', cleanup);
    window.addEventListener('focus', cleanup);

    // Laisser le temps d'appliquer la classe avant d'ouvrir le print dialog
    setTimeout(() => {
        try { window.print(); } catch (e) {
            cleanup();
            alert("Impression non support√©e sur ce navigateur. Essayez Chrome/Edge.");
        }
    }, 200);
}

// ----- INITIALISATION IA REPORT -----

function aiInitReportModule() {
    const genBtn = document.getElementById('aiGenerateBtn');
    const saveBtn = document.getElementById('aiSaveBtn');
    const pdfBtn = document.getElementById('aiPdfBtn');
    const printBtn = document.getElementById('aiPrintBtn');

    if (genBtn) genBtn.onclick = () => {
        aiState.autoGenerated = true;
        aiGenerateOrRefresh(true);
        showNotification("ü§ñ Analyse g√©n√©r√©e (modifiable)", "success");
    };
    if (saveBtn) saveBtn.onclick = aiSaveReport;
    if (pdfBtn) pdfBtn.onclick = aiExportPDF;
    if (printBtn) printBtn.onclick = aiPrintSystemPDF;

    // Events sur contr√¥les -> mise √† jour des options/rapport
    ['aiTeamSelect', 'aiShiftPeriodSelect', 'aiGroupBySelect', 'aiMetricSelect', 'aiExcludePauses'].forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        el.addEventListener('change', () => {
            aiRefreshPeriodValueOptions();
            aiGenerateOrRefresh(false);
        });
    });

    const pv = document.getElementById('aiPeriodValueSelect');
    if (pv) {
        pv.addEventListener('change', () => {
            aiGenerateOrRefresh(false);
        });
    }

    // Restore saved state if present
    aiRestoreReport();

    // Render plan in case
    aiRenderActionPlan();
}

// Ne d√©pend pas de votre init existante, on ajoute juste un listener
document.addEventListener('DOMContentLoaded', () => {
    try {
        aiInitReportModule();
        // Pr√©-charger options de p√©riode
        aiRefreshPeriodValueOptions();
    } catch(e) {
        console.log("IA report init error:", e);
    }
});

</script>

<!-- =========================================================
     PATCH AUTO: FIX INDEXEDDB VERSION ERROR (ANDROID/CHROME)
     Objectif: √©viter "requested version (3) is less than the existing version (5)"
     On ouvre la DB sans forcer une version (utilise la version existante).
     ========================================================= -->
<script>
;(function(){
  try {
    // Red√©finir openDatabase de mani√®re r√©tro-compatible (sans downgrade)
    function openDatabaseSafe() {
      return new Promise((resolve, reject) => {
        let request;
        try {
          // ‚ö†Ô∏è IMPORTANT: ne pas sp√©cifier de version => ouvre la version existante
          request = indexedDB.open('StellantisTrackerDB');
        } catch (err) {
          reject(err);
          return;
        }

        request.onerror = () => reject(request.error);
        request.onsuccess = () => {
          try { db = request.result; } catch(e) {}
          resolve(request.result);
        };

        // Si la DB n'existe pas encore (premi√®re ouverture), on cr√©e les stores
        request.onupgradeneeded = (event) => {
          const dbx = event.target.result;

          if (!dbx.objectStoreNames.contains('arrets')) {
            const arretsStore = dbx.createObjectStore('arrets', { keyPath: 'id', autoIncrement: true });
            arretsStore.createIndex('timestamp', 'timestamp', { unique: false });
            arretsStore.createIndex('equipe', 'equipe', { unique: false });
          }

          if (!dbx.objectStoreNames.contains('absences')) {
            const absencesStore = dbx.createObjectStore('absences', { keyPath: 'id', autoIncrement: true });
            absencesStore.createIndex('timestamp', 'timestamp', { unique: false });
            absencesStore.createIndex('equipe', 'equipe', { unique: false });
          }

          if (!dbx.objectStoreNames.contains('settings')) {
            dbx.createObjectStore('settings', { keyPath: 'key' });
          }
        };
      });
    }

    // Remplacer la fonction existante si elle force une version trop basse.
    // IMPORTANT: on remplace √† la fois la propri√©t√© window et le binding global.
    try { window.openDatabase = openDatabaseSafe; } catch(e) {}
    try { openDatabase = openDatabaseSafe; } catch(e) {}

  } catch (e) {
    console.log("Patch IndexedDB: √©chec (non bloquant)", e);
  }
})();
</script>


<!-- Auto badge: Ÿäÿ∏Ÿáÿ± ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ÿπŸÜÿØ Arr√™t de cha√Æne ŸàŸäÿÆÿ™ŸÅŸä ÿπŸÜÿØ Reprise -->
<div id="autoStopBadge" aria-live="polite">
  <div class="icon">‚õî</div>
  <div class="meta">
    <div class="title">ARR√äT DE CHA√éNE EN COURS</div>
    <div class="line"><span class="time" id="autoStopElapsed">00:00:00</span> ‚Ä¢ <span id="autoStopCause">‚Äî</span></div>
    <div class="line" id="autoStopBy" style="color: rgba(255,255,255,0.70); font-size: 11px;"></div>
  </div>
  <div class="actions">
    <button type="button" id="autoStopDetailsBtn" title="ŸÅÿ™ÿ≠ ŸÖŸÑÿÆÿµ ÿßŸÑÿ™ŸàŸÇŸÅ">‚è±Ô∏è</button>
    <button type="button" id="autoStopHideBtn" title="ÿ•ÿÆŸÅÿßÿ° ÿßŸÑÿ£ŸäŸÇŸàŸÜÿ© (ŸÖÿ§ŸÇÿ™ÿßŸã)">‚úï</button>
  </div>
</div>


<!-- Bloc IA PDCA -->
<div style="border:1px solid #ccc; padding:15px; margin-top:30px;">
  <h2>üß† G√©n√©rateur d'analyse PDCA (IA)</h2>
  <input type="text" id="cleapi" placeholder="Entrez votre cl√© OpenAI ici (sk-...)" style="width:100%; padding:8px; margin-bottom:10px;" />
  <input type="text" id="pdcaProxyUrl" placeholder="(Optionnel) URL proxy backend (ex : http://localhost:3000/pdca) ‚Äî recommand√© (√©vite CORS et prot√®ge la cl√©)" style="width:100%; padding:8px; margin-bottom:10px;" />
  <textarea id="donnees" placeholder="Ex : Arr√™t machine B - 20 min √† cause d'une fuite d'huile..." style="width:100%; height:120px;"></textarea><br>
  <label><input type="radio" name="langue" value="fran√ßais" checked> Fran√ßais</label>
  <label><input type="radio" name="langue" value="arabe"> Arabe</label><br><br>
  <button id="btnGenererPDCA" onclick="genererAnalysePDCA()" style="padding:12px 22px; font-size:20px; font-weight:900; color:#000; background:#fff; border:2px solid #111; border-radius:14px; width:100%;">G√©n√©rer le rapport PDCA</button>
  <pre id="resultat" style="background:#fff; color:#000; padding:12px; white-space:pre-wrap; margin-top:12px; border:2px solid #111; border-radius:14px; font-size:19px; font-weight:600; line-height:1.55; max-height:45vh; overflow:auto;"></pre>
</div>

<script>
  // ‚ö†Ô∏è IMPORTANT :
  // L'API OpenAI n'est g√©n√©ralement pas appelable directement depuis un fichier HTML (navigateur) √† cause du CORS
  // et parce qu'exposer une cl√© "sk-..." c√¥t√© client n'est pas s√©curis√©.
  // -> Utilise id√©alement un petit "proxy" backend (Node/Cloudflare Worker/Supabase Edge Function) qui appelle OpenAI.
  //
  // Ce script ajoute :
  // - gestion d'erreurs visible (au lieu de "rien ne se passe")
  // - timeout
  // - mod√®le et endpoint √† jour (Responses API) + fallback Chat Completions

  let cleAPI = "";

  function extractTextFromResponsesAPI(resp) {
    // SDK renvoie resp.output_text, mais en REST brut on reconstruit.
    if (resp && typeof resp.output_text === "string" && resp.output_text.trim()) return resp.output_text.trim();

    const parts = [];
    if (resp && Array.isArray(resp.output)) {
      for (const item of resp.output) {
        if (!item) continue;
        if (item.type === "message" && Array.isArray(item.content)) {
          for (const c of item.content) {
            if (!c) continue;
            // Formats possibles selon mod√®les / versions
            if ((c.type === "output_text" || c.type === "text") && typeof c.text === "string") parts.push(c.text);
            if (c.type === "output_text" && typeof c.content === "string") parts.push(c.content);
          }
        }
      }
    }
    const txt = parts.join("\n").trim();
    return txt || JSON.stringify(resp, null, 2);
  }

  async function postJSON(url, body, headers = {}, timeoutMs = 60000) {
    const controller = new AbortController();
    const t = setTimeout(() => controller.abort(), timeoutMs);

    try {
      const res = await fetch(url, {
        method: "POST",
        headers: Object.assign({ "Content-Type": "application/json" }, headers),
        body: JSON.stringify(body),
        signal: controller.signal
      });

      const raw = await res.text();
      let json;
      try { json = JSON.parse(raw); } catch { json = { raw }; }

      if (!res.ok) {
        const msg = json?.error?.message || json?.message || `HTTP ${res.status}`;
        const details = json?.error?.type ? ` (${json.error.type})` : "";
        throw new Error(`${msg}${details}`);
      }

      return json;
    } finally {
      clearTimeout(t);
    }
  }
  // ===== PDCA OFFLINE (works on Android without proxy) =====
  function _pdcaDetectStation(text){
    const t = text || "";
    const m = t.match(/poste\s*([0-9]+\s*[A-Z]?)/i) || t.match(/station\s*([0-9]+\s*[A-Z]?)/i) || t.match(/ÿ®Ÿàÿ≥ÿ™\s*([0-9]+\s*[A-Z]?)/i);
    return m ? m[1].trim() : "";
  }
  function _pdcaContains(text, words){
    const t = (text||"").toLowerCase();
    return words.some(w => t.includes(w));
  }
  function genererPDCAOffline(problemText, lang){
    const station = _pdcaDetectStation(problemText);
    const now = new Date();
    const dateStr = (lang === "arabe") ? now.toLocaleString("ar-DZ") : now.toLocaleString("fr-FR");

    const isRobot  = _pdcaContains(problemText, ["robot","ÿ±Ÿàÿ®Ÿàÿ™","automate","automation","bras"]);
    const isOil    = _pdcaContains(problemText, ["huile","oil","ÿ≤Ÿäÿ™","fuite","leak"]);
    const isBreak  = _pdcaContains(problemText, ["brise","cass","casse","broken","ŸÉÿ≥ÿ±","ŸÖŸÉÿ≥Ÿàÿ±"]);
    const isSensor = _pdcaContains(problemText, ["capteur","sensor","ÿ≠ÿ≥ÿßÿ≥","sonde"]);
    const isElec   = _pdcaContains(problemText, ["√©lect","elect","alimentation","power","ŸÉŸáÿ±ÿ®","ÿ™Ÿäÿßÿ±","ŸÇÿßÿ∑ÿπ","fusible"]);

    let why1 = "Un arr√™t s'est produit sur le poste.";
    if (isRobot)  why1 = "Le robot s'est mis en d√©faut / s'est arr√™t√©.";
    if (isBreak)  why1 = "Une pi√®ce/outil s'est cass√©(e) provoquant l'arr√™t.";
    if (isOil)    why1 = "Une fuite / manque d'huile a provoqu√© l'arr√™t.";
    if (isSensor) why1 = "Un capteur a envoy√© une information erron√©e provoquant l'arr√™t.";
    if (isElec)   why1 = "Un probl√®me √©lectrique/alimentation a provoqu√© l'arr√™t.";

    let why2 = "Parce qu'un composant a dysfonctionn√© (m√©canique/√©lectrique/automatisme).";
    if (isBreak)  why2 = "Parce qu'un composant m√©canique a cass√© (usure/effort).";
    if (isOil)    why2 = "Parce qu'il y avait une perte de lubrification (fuite/absence).";
    if (isSensor) why2 = "Parce que le capteur (ou son c√¢ble) est instable/d√©fectueux.";
    if (isElec)   why2 = "Parce qu'il y a une mauvaise connexion / protection / alimentation instable.";

    let why3 = "Parce que la d√©faillance n'a pas √©t√© d√©tect√©e ou trait√©e assez t√¥t.";
    if (isBreak)  why3 = "Parce qu'il y avait une usure/fragilit√© non rep√©r√©e (inspection insuffisante).";
    if (isOil)    why3 = "Parce que la fuite n'a pas √©t√© rep√©r√©e √† temps (inspection insuffisante).";
    if (isSensor) why3 = "Parce que le c√¢blage/fixation/protection n'est pas standardis√©(e).";
    if (isElec)   why3 = "Parce que les contr√¥les (serrage/tests) ne sont pas syst√©matiques.";

    let why4 = "Parce que la maintenance pr√©ventive et les contr√¥les standards ne sont pas appliqu√©s r√©guli√®rement.";
    let why5 = "Parce qu'il manque un standard clair (plan PM), une checklist et un suivi KPI/audit.";

    const fr = `### Analyse PDCA (mode hors‚Äëligne) ‚Äì 5 Pourquoi
Date/heure : ${dateStr}

#### Contexte
**Probl√®me identifi√© :** ${problemText || "Arr√™t non renseign√©."}${station ? `
**Poste :** ${station}` : ""}

---
## 1) PLAN (Planifier)
**Objectif :** r√©duire les arr√™ts li√©s √† ce probl√®me et s√©curiser la production.

**KPI √† suivre :**
- Dur√©e d'arr√™t (min/heure)
- Nombre d'arr√™ts (par poste / par shift)
- V√©hicules perdus / heure
- MTBF / MTTR (si disponible)

### Analyse ‚Äì 5 Pourquoi
1) Pourquoi y a‚Äët‚Äëil arr√™t ? ‚Üí ${why1}
2) Pourquoi cela arrive ? ‚Üí ${why2}
3) Pourquoi ce composant a‚Äët‚Äëil dysfonctionn√© ? ‚Üí ${why3}
4) Pourquoi ce point n‚Äôa pas √©t√© √©vit√© ? ‚Üí ${why4}
5) Pourquoi ce standard manque ? ‚Üí ${why5}

**Hypoth√®ses/contr√¥les √† v√©rifier (checklist) :**
- Historique des arr√™ts similaires (m√™me poste / m√™me robot)
- √âtat visuel : fuites, usure, bruit, temp√©rature
- Capteurs / c√¢blage / connecteurs (fixation, protection)
- Param√®tres robot/machine, alarmes, logs
- Maintenance pr√©ventive : fr√©quence, derni√®res interventions, pi√®ces

---
## 2) DO (Faire)
**Mesures imm√©diates (containment) :**
- S√©curiser la zone et remettre en √©tat (si possible)
- R√©initialiser/relancer selon proc√©dure standard
- Isoler la cause √©vidente (pi√®ce cass√©e, fuite, c√¢ble)

**Investigation :**
- Lire les alarmes et relever le code d√©faut
- Inspecter la zone robot : m√©canique, lubrification, capteurs
- V√©rifier serrages, c√¢bles, connecteurs, alimentations
- Si besoin, remplacer la pi√®ce suspecte et documenter

**Actions correctives propos√©es :**
- Remplacement/fiabilisation de la pi√®ce (pi√®ce + fixation + protection)
- Ajouter une inspection rapide au d√©but de chaque shift
- Mettre √† jour le plan PM + checklist op√©rateur/maintenance
- Stock mini de pi√®ces critiques (si casse r√©p√©titive)

---
## 3) CHECK (V√©rifier)
- Mesurer les KPI avant/apr√®s (24h, 1 semaine, 1 mois)
- V√©rifier disparition du d√©faut et stabilit√© (MTBF ‚Üë, arr√™ts ‚Üì)
- Confirmer par observation terrain + logs/alarms

---
## 4) ACT (Standardiser)
- Standardiser la proc√©dure (SOP) + formation op√©rateurs
- Ajouter un audit hebdomadaire (5 minutes) sur ce point
- Boucler le retour d‚Äôexp√©rience (QRQC / TOP 5 causes)

### Mini plan d‚Äôaction (tra√ßabilit√©)
| Qui | Quoi | Quand | Preuve |
|---|---|---|---|
| Maintenance | Diagnostiquer et corriger la cause racine | 48h | Rapport + photos |
| Chef d‚Äô√©quipe | Mettre une checklist au d√©marrage de shift | 3 jours | Checklist sign√©e |
| Op√©rateur | V√©rifier points visuels (fuite / c√¢ble) | Quotidien | Case coch√©e |
| Qualit√©/Prod | Suivre KPI + confirmer gain | Hebdo | Courbe KPI |
`;

    const ar = `### ÿ™ŸÇÿ±Ÿäÿ± PDCA (Ÿàÿ∂ÿπ ÿ®ÿØŸàŸÜ ÿ•ŸÜÿ™ÿ±ŸÜÿ™) ‚Äì 5 ŸÑŸÖÿßÿ∞ÿß
ÿßŸÑÿ™ÿßÿ±ŸäÿÆ/ÿßŸÑŸàŸÇÿ™: ${dateStr}

#### ÿßŸÑÿ≥ŸäÿßŸÇ
**ŸàÿµŸÅ ÿßŸÑŸÖÿ¥ŸÉŸÑ:** ${problemText || "ŸÑŸÖ Ÿäÿ™ŸÖ ÿ•ÿØÿÆÿßŸÑ ŸàÿµŸÅ ÿßŸÑÿ™ŸàŸÇŸÅ."}${station ? `
**ÿßŸÑÿ®Ÿàÿ≥ÿ™/ÿßŸÑŸÖÿ≠ÿ∑ÿ©:** ${station}` : ""}

---
## 1) PLAN (ÿßŸÑÿ™ÿÆÿ∑Ÿäÿ∑)
**ÿßŸÑŸáÿØŸÅ:** ÿ™ŸÇŸÑŸäŸÑ ÿßŸÑÿ™ŸàŸÇŸÅÿßÿ™ ÿßŸÑŸÖÿ±ÿ™ÿ®ÿ∑ÿ© ÿ®Ÿáÿ∞ÿß ÿßŸÑŸÖÿ¥ŸÉŸÑ Ÿàÿ™ÿ£ŸÖŸäŸÜ ÿßŸÑÿ•ŸÜÿ™ÿßÿ¨.

**ŸÖÿ§ÿ¥ÿ±ÿßÿ™ ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ© (KPI):**
- ŸÖÿØÿ© ÿßŸÑÿ™ŸàŸÇŸÅ (ÿØŸÇŸäŸÇÿ©/ÿ≥ÿßÿπÿ©)
- ÿπÿØÿØ ÿßŸÑÿ™ŸàŸÇŸÅÿßÿ™ (ÿ≠ÿ≥ÿ® ÿßŸÑÿ®Ÿàÿ≥ÿ™/ÿßŸÑŸàÿ±ÿØŸäŸëÿ©)
- ÿßŸÑÿ≥Ÿäÿßÿ±ÿßÿ™ ÿßŸÑÿ∂ÿßÿ¶ÿπÿ© / ÿßŸÑÿ≥ÿßÿπÿ©
- MTBF / MTTR (ÿ•ŸÜ ÿ™ŸàŸÅŸëÿ±)

### ÿ™ÿ≠ŸÑŸäŸÑ 5 ŸÑŸÖÿßÿ∞ÿß
1) ŸÑŸÖÿßÿ∞ÿß ÿ≠ÿØÿ´ ÿßŸÑÿ™ŸàŸÇŸÅÿü ‚Üí ${why1}
2) ŸÑŸÖÿßÿ∞ÿß ÿ≠ÿØÿ´ ÿ∞ŸÑŸÉÿü ‚Üí ${why2}
3) ŸÑŸÖÿßÿ∞ÿß ÿ™ÿπÿ∑ŸÑ Ÿáÿ∞ÿß ÿßŸÑÿ¨ÿ≤ÿ°ÿü ‚Üí ${why3}
4) ŸÑŸÖÿßÿ∞ÿß ŸÑŸÖ Ÿäÿ™ŸÖ ŸÖŸÜÿπŸá ŸÖÿ≥ÿ®ŸÇÿßŸãÿü ‚Üí ${why4}
5) ŸÑŸÖÿßÿ∞ÿß ŸäŸàÿ¨ÿØ ŸÜŸÇÿµ ŸÅŸä ÿßŸÑŸÖÿπŸäÿßÿ±/ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿü ‚Üí ${why5}

**ŸÜŸÇÿßÿ∑ ÿ™ÿ≠ŸÇŸÇ (Checklist):**
- ÿ™ÿßÿ±ŸäÿÆ ÿ™ŸàŸÇŸÅÿßÿ™ ŸÖÿ¥ÿßÿ®Ÿáÿ© (ŸÜŸÅÿ≥ ÿßŸÑÿ®Ÿàÿ≥ÿ™/ÿßŸÑÿ±Ÿàÿ®Ÿàÿ™)
- ŸÅÿ≠ÿµ ÿ®ÿµÿ±Ÿä: ÿ™ÿ≥ÿ±ÿ®ÿå ÿßŸáÿ™ÿ±ÿßÿ°ÿå ÿ∂ÿ¨Ÿäÿ¨ÿå ÿ≠ÿ±ÿßÿ±ÿ©
- ÿßŸÑÿ≠ÿ≥ÿßÿ≥ÿßÿ™/ÿßŸÑÿ£ÿ≥ŸÑÿßŸÉ/ÿßŸÑŸÉŸàŸÜŸÉÿ™ÿ±ÿßÿ™ (ÿ™ÿ´ÿ®Ÿäÿ™ Ÿàÿ≠ŸÖÿßŸäÿ©)
- ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ±Ÿàÿ®Ÿàÿ™/ÿßŸÑÿ¢ŸÑÿ©ÿå ÿßŸÑÿ•ŸÜÿ∞ÿßÿ±ÿßÿ™ÿå ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™
- ÿßŸÑÿµŸäÿßŸÜÿ© ÿßŸÑŸàŸÇÿßÿ¶Ÿäÿ©: ÿ¢ÿÆÿ± ÿ™ÿØÿÆŸÑÿå ÿ™Ÿàÿßÿ™ÿ±ÿå ŸÇÿ∑ÿπ ÿßŸÑÿ∫Ÿäÿßÿ±

---
## 2) DO (ÿßŸÑÿ™ŸÜŸÅŸäÿ∞)
**ÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™ ŸÅŸàÿ±Ÿäÿ© (Containment):**
- ÿ™ÿ£ŸÖŸäŸÜ ÿßŸÑŸÖŸÉÿßŸÜ Ÿàÿ•ÿ±ÿ¨ÿßÿπ ÿßŸÑŸàÿ∂ÿπ ÿßŸÑÿ∑ÿ®ŸäÿπŸä ÿ•ŸÜ ÿ£ŸÖŸÉŸÜ
- ÿ•ÿπÿßÿØÿ© ÿ™ÿ¥ÿ∫ŸäŸÑ ÿ≠ÿ≥ÿ® ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ° ÿßŸÑŸÖÿπÿ™ŸÖÿØ
- ÿπÿ≤ŸÑ ÿßŸÑÿ≥ÿ®ÿ® ÿßŸÑŸàÿßÿ∂ÿ≠ (ŸÉÿ≥ÿ±ÿå ÿ™ÿ≥ÿ±ÿ®ÿå ÿ≥ŸÑŸÉ ŸÖŸÅÿµŸàŸÑ)

**ÿßŸÑÿ™ÿ≠ŸÇŸäŸÇ:**
- ŸÇÿ±ÿßÿ°ÿ© ÿßŸÑÿ•ŸÜÿ∞ÿßÿ±ÿßÿ™ Ÿàÿ™ÿ≥ÿ¨ŸäŸÑ ŸÉŸàÿØ ÿßŸÑÿπÿ∑ŸÑ
- ŸÅÿ≠ÿµ ÿßŸÑÿ±Ÿàÿ®Ÿàÿ™: ŸÖŸäŸÉÿßŸÜŸäŸÉÿå ÿ™ÿ≤ŸäŸäÿ™ÿå ÿ≠ÿ≥ÿßÿ≥ÿßÿ™
- ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ±ÿ®ÿ∑ ÿßŸÑŸÉŸáÿ±ÿ®ÿßÿ¶Ÿä/ÿßŸÑÿ¥ÿØ/ÿßŸÑÿ™ÿ∫ÿ∞Ÿäÿ©
- ÿ•ŸÜ ŸÑÿ≤ŸÖ: ÿ™ÿ®ÿØŸäŸÑ ÿßŸÑŸÇÿ∑ÿπÿ© ÿßŸÑŸÖÿ¥ŸÉŸàŸÉ ŸÅŸäŸáÿß ŸÖÿπ ÿ™Ÿàÿ´ŸäŸÇ

**ÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™ ÿ™ÿµÿ≠Ÿäÿ≠Ÿäÿ© ŸÖŸÇÿ™ÿ±ÿ≠ÿ©:**
- ÿ™ŸÇŸàŸäÿ©/ÿ™ÿ®ÿØŸäŸÑ ÿßŸÑŸÇÿ∑ÿπÿ© + ÿ™ÿ≠ÿ≥ŸäŸÜ ÿßŸÑÿ™ÿ´ÿ®Ÿäÿ™ ŸàÿßŸÑÿ≠ŸÖÿßŸäÿ©
- ÿ•ÿ∂ÿßŸÅÿ© ŸÅÿ≠ÿµ ÿ≥ÿ±Ÿäÿπ ŸÅŸä ÿ®ÿØÿßŸäÿ© ŸÉŸÑ Ÿàÿ±ÿØŸäÿ©
- ÿ™ÿ≠ÿØŸäÿ´ ÿÆÿ∑ÿ© ÿßŸÑÿµŸäÿßŸÜÿ© + ŸÇÿßÿ¶ŸÖÿ© ÿ™ÿ≠ŸÇŸÇ ŸÑŸÑŸÖÿ¥ÿ∫ŸÑ/ÿßŸÑÿµŸäÿßŸÜÿ©
- ŸÖÿÆÿ≤ŸàŸÜ ÿµÿ∫Ÿäÿ± ŸÑŸÇÿ∑ÿπ ÿ≠ÿ±ÿ¨ÿ© (ÿ•ÿ∞ÿß ÿ™ŸÉÿ±ÿ± ÿßŸÑŸÉÿ≥ÿ±)

---
## 3) CHECK (ÿßŸÑÿ™ÿ≠ŸÇŸÇ)
- ŸÇŸäÿßÿ≥ KPI ŸÇÿ®ŸÑ/ÿ®ÿπÿØ (24 ÿ≥ÿßÿπÿ©ÿå ÿ£ÿ≥ÿ®Ÿàÿπÿå ÿ¥Ÿáÿ±)
- ÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßÿÆÿ™ŸÅÿßÿ° ÿßŸÑÿπÿ∑ŸÑ Ÿàÿßÿ≥ÿ™ŸÇÿ±ÿßÿ± ÿßŸÑÿπŸÖŸÑŸäÿ© (MTBF ‚Üëÿå ÿßŸÑÿ™ŸàŸÇŸÅÿßÿ™ ‚Üì)
- ÿ™ÿ£ŸÉŸäÿØ ÿπÿ®ÿ± ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿ© + ÿ≥ÿ¨ŸÑÿßÿ™ ÿßŸÑÿ•ŸÜÿ∞ÿßÿ±ÿßÿ™

---
## 4) ACT (ÿßŸÑÿ™ÿ´ÿ®Ÿäÿ™/ÿßŸÑÿ™ŸÇŸäŸäÿ≥)
- ÿ™Ÿàÿ´ŸäŸÇ ÿ•ÿ¨ÿ±ÿßÿ° ŸÇŸäÿßÿ≥Ÿä (SOP) + ÿ™ÿØÿ±Ÿäÿ® ÿßŸÑŸÖÿ¥ÿ∫ŸÑŸäŸÜ
- ÿ™ÿØŸÇŸäŸÇ ÿ£ÿ≥ÿ®ŸàÿπŸä ÿ≥ÿ±Ÿäÿπ (5 ÿØŸÇÿßÿ¶ŸÇ) ÿπŸÑŸâ Ÿáÿ∞Ÿá ÿßŸÑŸÜŸÇÿ∑ÿ©
- ÿ∫ŸÑŸÇ ÿßŸÑÿØÿ±ÿ≥ ÿßŸÑŸÖÿ≥ÿ™ŸÅÿßÿØ (QRQC / TOP 5 ÿ£ÿ≥ÿ®ÿßÿ®)

### ÿÆÿ∑ÿ© ÿπŸÖŸÑ ÿµÿ∫Ÿäÿ±ÿ© (ŸÑŸÑÿ™ÿ™ÿ®ÿπ)
| ŸÖŸÜ | ŸÖÿßÿ∞ÿß | ŸÖÿ™Ÿâ | ÿØŸÑŸäŸÑ |
|---|---|---|---|
| ÿßŸÑÿµŸäÿßŸÜÿ© | ÿ™ÿ¥ÿÆŸäÿµ Ÿàÿ™ÿµÿ≠Ÿäÿ≠ ÿßŸÑÿ≥ÿ®ÿ® ÿßŸÑÿ¨ÿ∞ÿ±Ÿä | 48 ÿ≥ÿßÿπÿ© | ÿ™ŸÇÿ±Ÿäÿ± + ÿµŸàÿ± |
| ÿ±ÿ¶Ÿäÿ≥ ÿßŸÑŸÅÿ±ŸäŸÇ | Ÿàÿ∂ÿπ Checklist ÿ®ÿØÿßŸäÿ© ÿßŸÑŸàÿ±ÿØŸäÿ© | 3 ÿ£ŸäÿßŸÖ | ŸÇÿßÿ¶ŸÖÿ© ŸÖŸàŸÇÿπÿ© |
| ÿßŸÑŸÖÿ¥ÿ∫ŸÑ | ŸÅÿ≠ÿµ ÿ®ÿµÿ±Ÿä (ÿ™ÿ≥ÿ±ÿ®/ÿ≥ŸÑŸÉ) | ŸäŸàŸÖŸä | ÿÆÿßŸÜÿ© ŸÖÿ§ÿ¥ÿ±ÿ© |
| ÿßŸÑÿ¨ŸàÿØÿ©/ÿßŸÑÿ•ŸÜÿ™ÿßÿ¨ | ŸÖÿ™ÿßÿ®ÿπÿ© KPI Ÿàÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ™ÿ≠ÿ≥ŸÜ | ÿ£ÿ≥ÿ®ŸàÿπŸä | ÿ™ŸÇÿ±Ÿäÿ± KPI |
`;

    return (lang === "arabe") ? ar : fr;
  }
// ===== End PDCA OFFLINE =====
async function genererAnalysePDCA() {
    const keyInput = document.getElementById("cleapi");
    const donneesEl = document.getElementById("donnees");
    const outEl = document.getElementById("resultat");
    const btn = document.getElementById("btnGenererPDCA") || document.querySelector('button[onclick="genererAnalysePDCA()"]');

    // UI
    if (btn) btn.disabled = true;
    outEl.textContent = "‚è≥ G√©n√©ration du rapport PDCA en cours...";

    try {
      const proxyUrl = (document.getElementById("pdcaProxyUrl")?.value || "").trim();
      const usingProxy = !!proxyUrl;

      cleAPI = (keyInput?.value || "").trim();
      // Si on passe par un proxy, la cl√© doit √™tre c√¥t√© serveur (recommand√©).
      if (!usingProxy) {
        // Accepte sk-... et sk-proj-...
        if (!cleAPI || !cleAPI.startsWith("sk-")) {
          throw new Error("Cl√© API invalide. Elle doit commencer par sk- (ex: sk-proj-...).");
        }
      }
const donnees = (donneesEl?.value || "").trim();
      if (!donnees) {
        throw new Error("Merci de saisir des donn√©es (arr√™t/cause/dur√©e) avant de g√©n√©rer.");
      }

      const langue = document.querySelector('input[name="langue"]:checked')?.value || "fran√ßais";

      const prompt = `Tu es un expert qualit√© (industrie automobile). R√©dige une analyse PDCA compl√®te avec la m√©thode des 5 pourquoi √† partir des donn√©es suivantes. 
Contraintes:
- R√©dige des √©tapes concr√®tes, mesurables, orient√©es terrain.
- Donne des KPI de suivi (ex: dur√©e arr√™t, nb arr√™ts, TRS, rebut si pertinent).
- Termine par un mini plan d'action (qui / quoi / quand / preuve).
R√©ponds en ${langue}.

DONN√âES:
${donnees}`;

      
      // PDCA_OFFLINE_AUTO: Android browsers cannot call OpenAI API directly (CORS). If no proxy, generate offline report.
      const selectedLang = (document.querySelector('input[name="langue"]:checked')?.value || "fran√ßais").toLowerCase();
      const langKey = (selectedLang.includes("arab") || selectedLang.includes("arabe")) ? "arabe" : "fran√ßais";
      const isAndroid = /Android/i.test(navigator.userAgent || "");
      const dataText = (donneesEl?.value || "").trim();

      if (!usingProxy && isAndroid) {
        outEl.textContent = genererPDCAOffline(dataText, langKey);
        outEl.scrollIntoView({behavior:"smooth", block:"start"});
        return;
      }
      // If user did not enter a key and no proxy, still generate offline.
      if (!usingProxy && (!cleAPI || cleAPI.length < 20)) {
        outEl.textContent = genererPDCAOffline(dataText, langKey);
        outEl.scrollIntoView({behavior:"smooth", block:"start"});
        return;
      }
// Si un proxy est fourni, on l'utilise en priorit√© (√©vite CORS et prot√®ge la cl√©)
      if (usingProxy) {
        const proxyPayload = {
          model: "gpt-4o-mini",
          instructions: "Tu es un expert en am√©lioration continue (Lean / 5 Why / PDCA) et qualit√© industrielle.",
          input: prompt,
          max_output_tokens: 900
        };
        const proxyResp = await postJSON(proxyUrl, proxyPayload, {}, 90000);
        // Le proxy peut renvoyer soit le JSON brut OpenAI (Responses), soit {text:"..."}
        const proxyText = (proxyResp && typeof proxyResp.text === "string") ? proxyResp.text : extractTextFromResponsesAPI(proxyResp);
        outEl.textContent = proxyText;
        return;
      }

      // 1) Responses API (recommand√©)
      // https://platform.openai.com/docs/api-reference/responses
      const bodyResponses = {
        model: "gpt-4o-mini",
        instructions: "Tu es un expert en am√©lioration continue (Lean / 5 Why / PDCA) et qualit√© industrielle.",
        input: prompt,
        max_output_tokens: 900,
        // store: false // si tu veux d√©sactiver le stockage c√¥t√© API
      };

      let json;
      try {
        json = await postJSON("https://api.openai.com/v1/responses", bodyResponses, { "Authorization": `Bearer ${cleAPI}` }, 90000);
        outEl.textContent = extractTextFromResponsesAPI(json);
        return;
      } catch (e1) {
        // Fallback 2) Chat Completions (si Responses non dispo)
        const bodyChat = {
          model: "gpt-4o-mini",
          messages: [
            { role: "system", content: "Tu es un expert en am√©lioration continue et qualit√© industrielle (5 Pourquoi + PDCA)." },
            { role: "user", content: prompt }
          ],
          temperature: 0.3
        };

        json = await postJSON("https://api.openai.com/v1/chat/completions", bodyChat, { "Authorization": `Bearer ${cleAPI}` }, 90000);

        const content = json?.choices?.[0]?.message?.content;
        if (!content) throw e1; // garde l'erreur initiale si rien
        outEl.textContent = content;
        return;
      }

    } catch (err) {
      
      // PDCA_OFFLINE_FALLBACK
      try {
        const proxyUrl = (document.getElementById("pdcaProxyUrl")?.value || "").trim();
        const usingProxy = !!proxyUrl;
        const selectedLang = (document.querySelector('input[name="langue"]:checked')?.value || "fran√ßais").toLowerCase();
        const langKey = (selectedLang.includes("arab") || selectedLang.includes("arabe")) ? "arabe" : "fran√ßais";
        const dataText = (document.getElementById("donnees")?.value || "").trim();

        const msg = (err && (err.message || err.toString())) ? (err.message || err.toString()) : "";
        const looksLikeCors = /failed to fetch|cors|networkerror|TypeError/i.test(msg);

        if (!usingProxy && looksLikeCors) {
          outEl.textContent = genererPDCAOffline(dataText, langKey) + "\n\n(‚ö†Ô∏è ŸÖŸÑÿßÿ≠ÿ∏ÿ©/Note: ÿßŸÑŸÖÿ™ÿµŸÅÿ≠ ŸÖŸÜÿπ ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä ŸÖÿ®ÿßÿ¥ÿ±ÿ©. Ÿáÿ∞ÿß ÿ™ŸÇÿ±Ÿäÿ± ÿ£ŸàŸÅŸÑÿßŸäŸÜ.)";
          return;
        }
      } catch(e) {}
// Erreurs r√©seau/CORS : tr√®s fr√©quent en appel direct depuis un HTML.
      const msg = (err && (err.message || String(err))) || "Erreur inconnue.";
      const isCorsLikely =
        (err && err.name === "TypeError") ||
        /Failed to fetch|NetworkError|CORS|blocked/i.test(msg);

      if (isCorsLikely) {
        outEl.textContent =
`‚ùå Impossible d'appeler l'API depuis le navigateur (probable CORS / r√©seau).
D√©tails: ${msg}

‚úÖ Solution recommand√©e (s√©curis√©e) :
- Cr√©er un petit proxy backend (Node/Express, Cloudflare Worker, Supabase Edge Function...)
- Le proxy re√ßoit tes "donn√©es" et appelle OpenAI avec la cl√© (cl√© c√¥t√© serveur, PAS dans le navigateur)
- Ensuite ton HTML appelle ton proxy.

Si tu veux, je te donne un fichier "server.js" pr√™t √† l'emploi (Express) + la route /pdca.`;
      } else {
        outEl.textContent = `‚ùå Erreur: ${msg}`;
      }
      console.error("PDCA IA - erreur:", err);
    } finally {
      if (btn) btn.disabled = false;
    }
  }
</script>
<!-- Fin bloc IA -->


<!-- Modal ÿßÿÆÿ™Ÿäÿßÿ± ÿ≠ÿßŸÑÿ© ÿßŸÑŸäŸàŸÖ (Ÿäÿ∏Ÿáÿ± ŸÅŸÇÿ∑ ÿ•ÿ∞ÿß ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑÿ≠ÿßŸÑÿ© ŸÑŸÑŸäŸàŸÖ) -->
<div id="workModeModal" style="display:none; position:fixed; inset:0; background: rgba(0,0,0,0.75); z-index:999999; padding:18px;">
  <div style="max-width:520px; margin: 10vh auto; background:#111827; border:1px solid rgba(255,255,255,0.15); border-radius:18px; padding:16px;">
    <div style="font-size:18px; font-weight:900; color:#fff; margin-bottom:8px;">üóìÔ∏è ÿßŸÑŸäŸàŸÖ: ŸáŸÑ ŸäŸàÿ¨ÿØ ÿπŸÖŸÑÿü</div>
    <div style="color:#cbd5e1; font-size:13px; line-height:1.4; margin-bottom:12px;">
      ÿßÿÆÿ™ÿ± ÿ≠ÿßŸÑÿ© ÿßŸÑŸäŸàŸÖ ŸÑŸÉŸä ÿ™ŸÉŸàŸÜ ÿßŸÑÿ≠ÿ≥ÿßÿ®ÿßÿ™ ÿµÿ≠Ÿäÿ≠ÿ© (ÿ•ŸÜÿ™ÿßÿ¨ / ÿπÿ∑ŸÑÿ© / ÿ™ŸàŸÇŸÅ ŸÉŸÑŸä).
    </div>
    <div style="display:grid; grid-template-columns:1fr; gap:10px;">
      <button data-workmode="production" class="wmBtn" style="padding:14px; border-radius:16px; border:0; font-size:16px; font-weight:900; background:#1f8a3b; color:#fff;">üü¢ ŸÜÿπŸÖÿå ŸäŸàÿ¨ÿØ ÿπŸÖŸÑ (Production)</button>
      <button data-workmode="holiday" class="wmBtn" style="padding:14px; border-radius:16px; border:0; font-size:16px; font-weight:900; background:#c79c00; color:#000;">üü° ÿπÿ∑ŸÑÿ© / Weekend / F√©ri√© (Pas de production)</button>
      <button data-workmode="machine_off" class="wmBtn" style="padding:14px; border-radius:16px; border:0; font-size:16px; font-weight:900; background:#c1121f; color:#fff;">üî¥ Machine arr√™t total (Pas de production)</button>
    </div>
    <div style="margin-top:10px; display:flex; gap:10px;">
      <button id="wmLaterBtn" style="flex:1; padding:12px; border-radius:14px; border:1px solid rgba(255,255,255,0.2); background:transparent; color:#fff; font-weight:800;">ÿßŸÑÿ¢ŸÜ ŸÑÿß</button>
      <button id="wmOpenSettingsBtn" style="flex:1; padding:12px; border-radius:14px; border:0; background:#374151; color:#fff; font-weight:900;">ŸÅÿ™ÿ≠ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™</button>
    </div>
  </div>
</div>

<div id="simpleToast" style="position:fixed; left:50%; bottom:18px; transform:translateX(-50%); background:#111827; color:#fff; padding:10px 14px; border-radius:999px; border:1px solid rgba(255,255,255,0.18); font-weight:900; display:none; z-index:999999;"></div>


<script>
;(function(){
  const form = document.getElementById('googleSearchForm');
  const input = document.getElementById('googleSearchInput');
  const modeApp = document.getElementById('searchModeApp');
  const modeGoogle = document.getElementById('searchModeGoogle');
  const allHistory = document.getElementById('searchAllHistory');
  const resultsBox = document.getElementById('appSearchResults');

  if(!form || !input) return;

  function esc(s){
    return String(s ?? '').replace(/[&<>"']/g, (c)=>({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[c]));
  }

  function getMode(){
    return (modeGoogle && modeGoogle.checked) ? 'google' : 'app';
  }

  function openGoogle(query){
    const url = 'https://www.google.com/search?q=' + encodeURIComponent(query || '');
    const w = window.open(url, '_blank');
    if(!w) window.location.href = url;
  }
  window.openGoogleSearch = openGoogle;

  function applyToShiftTableSearch(q){
    try{
      // Basculer le filtre arr√™ts sur "Tous" pour ne rien cacher
      if (typeof setStopTypeFilter === 'function') setStopTypeFilter('all');
      const tInput = document.getElementById('internalTableSearch');
      if(tInput){
        tInput.value = q;
        if (typeof setInternalTableSearch === 'function') setInternalTableSearch(q);
        tInput.scrollIntoView({behavior:'smooth', block:'center'});
        setTimeout(()=>tInput.focus(), 250);
      }
    }catch(e){ console.error(e); }
  }
  window.applyToShiftTableSearch = applyToShiftTableSearch;

  function showResults(html){
    if(!resultsBox) return;
    resultsBox.innerHTML = html;
    resultsBox.style.display = 'block';
  }
  function hideResults(){
    if(!resultsBox) return;
    resultsBox.style.display = 'none';
    resultsBox.innerHTML = '';
  }

  function searchInApp(query){
    const q = (query || '').trim().toLowerCase();
    if(!q){ hideResults(); input.focus(); return; }

    const useAll = allHistory ? !!allHistory.checked : true;
    const data = (typeof history !== 'undefined' && Array.isArray(history)) ? history : [];
    let pool = data;

    // Si l'utilisateur veut ŸÅŸÇÿ∑ "ÿßŸÑshift ÿßŸÑÿ≠ÿßŸÑŸä"
    if(!useAll){
      try{
        const now = new Date();
        const shiftDate = (typeof getShiftDate === 'function') ? getShiftDate(now) : '';
        pool = pool.filter(h => (h?.date === shiftDate) && (h?.equipe === window.equipe));
      }catch(e){ /* ignore */ }
    }

    let matches = pool.filter(h => {
      const text = `${h?.date||''} ${h?.cause||''} ${h?.start||''} ${h?.end||''} ${h?.equipe||''} ${h?.teamLeader||''} ${h?.type||''}`.toLowerCase();
      return text.includes(q);
    });

    // Trier par date+heure (desc)
    const key = (h)=> `${h?.date||''} ${(h?.start||'').toString().padStart(5,'0')}`;
    matches.sort((a,b)=> key(b).localeCompare(key(a)));

    const limit = 60;
    const shown = matches.slice(0, limit);

    const head = `
      <div class="as-head">
        <div class="as-title">ŸÜÿ™ÿßÿ¶ÿ¨ ÿØÿßÿÆŸÑ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ: ${matches.length} (ÿπÿ±ÿ∂ ${shown.length}${matches.length>limit?'+':''})</div>
        <button class="as-btn" type="button" onclick="applyToShiftTableSearch(${JSON.stringify(query)})">ŸÅŸÑÿ™ÿ± ÿ¨ÿØŸàŸÑ ÿßŸÑÿ¥ŸäŸÅÿ™</button>
      </div>
    `;

    const list = shown.map(h=>{
      const missed = (h?.type === 'rat√©');
      const date = esc(h?.date || '');
      const cause = esc(h?.cause || '');
      const start = esc(h?.start || '');
      const end = esc(h?.end || '');
      const team = esc(h?.equipe || '');
      const tl = esc(h?.teamLeader || '');

      return `
        <div class="as-item">
          <div class="as-line1">
            ${missed ? '<span class="tag missed">‚è±Ô∏è Rat√©</span>' : ''}
            <span class="tag team">√âquipe ${team}</span>
            <span>${date}</span>
            <span>${start}${end ? ' ‚Üí ' + end : ''}</span>
            ${tl ? `<span>TL: ${tl}</span>` : ''}
          </div>
          <div class="as-cause">${cause || '(Sans cause)'}</div>
        </div>
      `;
    }).join('');

    const foot = `
      <div style="margin-top:8px; font-size:12px; color:#111;">
        ‚úÖ Ÿáÿ∞ÿß ÿßŸÑÿ®ÿ≠ÿ´ ŸäÿπŸÖŸÑ ÿ®ÿØŸàŸÜ ÿ•ŸÜÿ™ÿ±ŸÜÿ™. <br>
        üí° ÿ≤ÿ± <b>ŸÅŸÑÿ™ÿ± ÿ¨ÿØŸàŸÑ ÿßŸÑÿ¥ŸäŸÅÿ™</b> ŸäŸÅŸÑÿ™ÿ± ŸÅŸÇÿ∑ ÿ¨ÿØŸàŸÑ ÿßŸÑÿ¥ŸäŸÅÿ™ ÿßŸÑÿ≠ÿßŸÑŸä.
      </div>
    `;

    showResults(head + `<div class="as-list">${list || '<div style="padding:10px;font-weight:900;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÜÿ™ÿßÿ¶ÿ¨</div>'}</div>` + foot);
    // scroll results into view
    try{ resultsBox.scrollIntoView({behavior:'smooth', block:'start'}); }catch(e){}
  }
  window.searchInApp = searchInApp;

  // Hide results when switching to Google
  function syncModeUI(){
    if(getMode()==='google') hideResults();
  }
  if(modeGoogle) modeGoogle.addEventListener('change', syncModeUI);
  if(modeApp) modeApp.addEventListener('change', syncModeUI);

  form.addEventListener('submit', function(e){
    e.preventDefault();
    const q = (input.value || '').trim();
    if(!q){ input.focus(); return; }

    if(getMode()==='google'){
      openGoogle(q);
    }else{
      searchInApp(q);
    }
  });
})();
</script>


<!-- ‚úÖ Bouton Google ÿ´ÿßÿ®ÿ™ (Floating) -->
<style>
  #googleFloatBtn{
    position:fixed; bottom:18px; right:18px; z-index:99999;
    background:#ffffff; color:#000000;
    border:2px solid #000000;
    border-radius:999px;
    padding:12px 14px;
    font-weight:900;
    font-size:16px;
    box-shadow:0 10px 22px rgba(0,0,0,.25);
    cursor:pointer;
    user-select:none;
  }
  #googleFloatBtn:active{ transform: scale(0.98); }
  #googleFloatPanel{
    position:fixed; bottom:82px; right:18px; z-index:99999;
    background:#ffffff; color:#000000;
    border:2px solid #000000;
    border-radius:16px;
    padding:12px;
    width:min(340px, calc(100vw - 36px));
    display:none;
    box-shadow:0 14px 28px rgba(0,0,0,.25);
  }
  #googleFloatPanel .title{
    font-weight:900; font-size:16px; margin-bottom:8px;
  }
  
  #googleFloatPanel .float-mode-row{
    display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    margin-bottom:8px;
    font-weight:900;
  }
  #googleFloatPanel .float-mode-row label{
    display:flex; gap:6px; align-items:center;
    background:#f1f5f9;
    border:1px solid rgba(0,0,0,0.18);
    padding:6px 10px;
    border-radius:999px;
    color:#000;
    font-size:13px;
  }
  #googleFloatPanel .float-mode-row input{ transform: scale(1.1); }
#googleFloatQuery{
    width:100%;
    padding:10px 12px;
    border:2px solid #000000;
    border-radius:12px;
    font-size:16px;
    outline:none;
  }
  #googleFloatPanel .row{
    display:flex; gap:10px; margin-top:10px;
  }
  #googleFloatPanel button{
    flex:1;
    padding:10px 12px;
    border:2px solid #000000;
    border-radius:12px;
    font-size:16px;
    font-weight:900;
    background:#ffffff;
    color:#000000;
    cursor:pointer;
  }
  #googleFloatPanel .hint{
    margin-top:8px;
    font-size:12px;
    color:#111;
  }
</style>

<button id="googleFloatBtn" type="button" aria-label="Recherche Google">GOOGLE</button>

<div id="googleFloatPanel" role="dialog" aria-label="Recherche Google rapide">
  <div class="title">üîé Recherche</div>
  <div class="float-mode-row" role="group" aria-label="Mode">
    <label><input type="radio" name="floatSearchMode" value="app" checked> App</label>
    <label><input type="radio" name="floatSearchMode" value="google"> Google</label>
  </div>
  <input id="googleFloatQuery" type="search" placeholder="Tape ta recherche‚Ä¶" />
  <div class="row">
    <button id="googleFloatGo" type="button">Rechercher</button>
    <button id="googleFloatClose" type="button">Fermer</button>
  </div>
  <div class="hint">Mode App: recherche dans les causes enregistr√©es. Mode Google: Internet.</div>
</div>

<script>
;(function(){
  const btn = document.getElementById('googleFloatBtn');
  const panel = document.getElementById('googleFloatPanel');
  const q = document.getElementById('googleFloatQuery');
  const go = document.getElementById('googleFloatGo');
  const close = document.getElementById('googleFloatClose');

  const existingInput = document.getElementById('googleSearchInput');
  const existingSection = document.getElementById('googleSearchSection');

  function openGoogle(query){
    // Pr


/* ============================================================
   üéØ VERSION DIRECTION ‚Äì Sauvegarde / Tra√ßabilit√© / Rapport PDF
   (Ajouts non destructifs: 1 seul fichier HTML)
   ============================================================ */

;(function(){
  // --------- Audit log ----------
  const AUDIT_KEY = "AUDIT_LOG_V1";
  let auditLog = [];
  try { auditLog = JSON.parse(LS.getItem(AUDIT_KEY) || "[]") || []; } catch(e){ auditLog = []; }

  function nowIso(){ return new Date().toISOString(); }
  function fmtLocal(ts){
    try{
      const d = new Date(ts);
      const pad = (n)=> String(n).padStart(2,'0');
      return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }catch(e){ return String(ts||""); }
  }
  function getUserName(){
    try{
      return (document.getElementById("teamLeader")?.value || LS.getItem("TEAM_LEADER") || LS.getItem("ONLINE_USER") || "Inconnu").toString().trim() || "Inconnu";
    }catch(e){ return "Inconnu"; }
  }
  function getShiftCtx(){
    try{ return getActiveShiftContext(new Date()); }catch(e){ return { shiftType: (typeof currentShiftType!=="undefined"?currentShiftType:""), shiftDate: (typeof selectedShiftDate!=="undefined"?selectedShiftDate:"") }; }
  }
  function ensureStopId(stop){
    if(!stop) return null;
    if(stop._id) return stop._id;
    const base = stop.timestamp || Date.now();
    stop._id = `${base}-${Math.floor(Math.random()*1e9)}`;
    return stop._id;
  }
  function stopShort(stop){
    if(!stop) return "";
    const c = (stop.cause||"").toString().slice(0,60);
    return `[${stop.date||""} ${stop.start||""}‚Üí${stop.end||""}] ${c} (Eq ${stop.equipe||""})`;
  }
  function saveAudit(){
    try{
      LS.setItem(AUDIT_KEY, JSON.stringify(auditLog));
      if (typeof db !== "undefined" && db) { try { saveToIndexedDB(); } catch(e){} }
    }catch(e){}

    try{ initRealtimeCollabUI(); }catch(e){}
  }
  function addAudit(action, detail, meta){
    try{
      const ctx = getShiftCtx();
      const entry = {
        ts: Date.now(),
        user: getUserName(),
        shiftType: ctx.shiftType || "",
        shiftDate: ctx.shiftDate || "",
        action: action || "",
        detail: detail || "",
        meta: meta || {}
      };
      auditLog.push(entry);
      if (auditLog.length > 500) auditLog = auditLog.slice(-500);
      saveAudit();
      renderAudit();
    }catch(e){}
  }

  function renderAudit(){
    const tbody = document.getElementById("auditTbody");
    if(!tbody) return;
    tbody.innerHTML = "";
    const items = (auditLog||[]).slice().reverse().slice(0, 200);
    if(items.length === 0){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="4" style="padding:10px; color:#cbd5e1;">Aucune modification enregistr√©e.</td>`;
      tbody.appendChild(tr);
      return;
    }
    for(const a of items){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td style="padding:8px; border-bottom:1px solid rgba(255,255,255,0.08); white-space:nowrap;">${fmtLocal(a.ts)}</td>
        <td style="padding:8px; border-bottom:1px solid rgba(255,255,255,0.08);">${(a.user||"")}</td>
        <td style="padding:8px; border-bottom:1px solid rgba(255,255,255,0.08);">${(a.action||"")}</td>
        <td style="padding:8px; border-bottom:1px solid rgba(255,255,255,0.08); color:#e5e7eb;">${(a.detail||"")}</td>
      `;
      tbody.appendChild(tr);
    }
  }

  // --------- Intercepter les ajouts d'arr√™ts (history.push) ----------
  let _historyPushInstalled = false;

  function installHistoryInterceptor(){
    try{
      if(!Array.isArray(history)) return;
      if(history.__auditPatched) return;

      const origPush = history.push.bind(history);
      history.push = function(...items){
        const beforeLen = history.length;
        const res = origPush(...items);
        try{
          for(const it of items){
            if(!it || typeof it !== "object") continue;
            // Heuristique: un arr√™t a au moins cause + start + end + duration
            if(("cause" in it) && ("start" in it) && ("end" in it) && ("duration" in it)){
              ensureStopId(it);
              const kind = (it.isMissed || it.type === "rat√©") ? "‚è±Ô∏è Ajout arr√™t rat√©" :
                           (it.type === "sp√©cial") ? "‚≠ê Ajout arr√™t sp√©cial" : "‚ûï Ajout arr√™t";
              addAudit(kind, stopShort(it), { stopId: it._id, stopType: it.type || (it.isMissed? "rat√©":"normal") });
              try{ autoCreatePostForStop(it); }catch(e){}
            }
          }
        }catch(e){}
        return res;
      };
      history.__auditPatched = true;
      _historyPushInstalled = true;
    }catch(e){}
  }

  // --------- Intercepter les modifications (saveCellEdit) ----------
  function installEditInterceptor(){
    try{
      if(typeof saveCellEdit !== "function") return;
      if(saveCellEdit.__auditWrapped) return;

      const orig = saveCellEdit;
      saveCellEdit = function(newValue, rowIndex, cellIndex, cell){
        let oldVal = "";
        let stop = null;
        try{
          stop = history && history[rowIndex];
          if(stop) { ensureStopId(stop); oldVal = (typeof getCellValue==="function") ? getCellValue(stop, cellIndex) : ""; }
        }catch(e){}
        const res = orig.apply(this, arguments);
        try{
          const stop2 = history && history[rowIndex];
          if(stop2){
            ensureStopId(stop2);
            const newVal2 = (typeof getCellValue==="function") ? getCellValue(stop2, cellIndex) : newValue;
            const field = (cellIndex===0)?"Date":(cellIndex===1)?"Cause":(cellIndex===2)?"D√©but":(cellIndex===3)?"Fin":(cellIndex===5)?"Team Leader":"Champ";
            if(String(oldVal||"") !== String(newVal2||"")){
              addAudit("‚úèÔ∏è Modification", `${field}: "${oldVal}" ‚Üí "${newVal2}" ‚Ä¢ ${stopShort(stop2)}`, { stopId: stop2._id, field });
            }
          }
        }catch(e){}
        return res;
      };
      saveCellEdit.__auditWrapped = true;
    }catch(e){}
  }

  // --------- Intercepter la suppression (deleteStop) ----------
  function installDeleteInterceptor(){
    try{
      if(typeof deleteStop !== "function") return;
      if(deleteStop.__auditWrapped) return;

      const orig = deleteStop;
      deleteStop = function(rowIndex){
        const before = Array.isArray(history) ? history.length : 0;
        let snapshot = null;
        try{
          snapshot = history && history[rowIndex] ? JSON.parse(JSON.stringify(history[rowIndex])) : null;
          if(snapshot) ensureStopId(snapshot);
        }catch(e){}
        const res = orig.apply(this, arguments);
        const after = Array.isArray(history) ? history.length : 0;
        try{
          if(snapshot && after < before){
            addAudit("üóëÔ∏è Suppression", stopShort(snapshot), { stopId: snapshot._id });
          }
        }catch(e){}
        return res;
      };
      deleteStop.__auditWrapped = true;
    }catch(e){}
  }

  // --------- Sauvegarde (Export) ----------
  function downloadBlob(filename, blob){
    const a = document.createElement("a");
    const url = URL.createObjectURL(blob);
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 1500);
  }

  function buildBackupPayload(){
    // garantir des IDs
    try{
      if(Array.isArray(history)){
        history.forEach(ensureStopId);
      }
    }catch(e){}
    const payload = {
      version: "direction-v1",
      exportedAt: nowIso(),
      app: {
        shiftConfigs: (typeof shiftConfigs!=="undefined"?shiftConfigs:null),
        selectedShift: (typeof currentShiftType!=="undefined"?currentShiftType:null),
        selectedShiftDate: (typeof selectedShiftDate!=="undefined"?selectedShiftDate:null)
      },
      data: {
        history: (Array.isArray(history)?history:[]),
        absences: (typeof absenceHistory!=="undefined" && Array.isArray(absenceHistory))?absenceHistory:[],
        workModeMap: (typeof workModeMap!=="undefined"?workModeMap:{}),
        offDaysOfWeek: (typeof offDaysOfWeek!=="undefined"?offDaysOfWeek:[]),
        settings: {
          equipe: (typeof equipe!=="undefined"?equipe:null),
          teamLeader: LS.getItem("TEAM_LEADER") || "",
          cycleTimeSeconds: LS.getItem("CYCLE_TIME_SECONDS") || "",
          pauses: {
            p1s: LS.getItem("PAUSE_1_START") || "",
            p1e: LS.getItem("PAUSE_1_END") || "",
            p2s: LS.getItem("PAUSE_2_START") || "",
            p2e: LS.getItem("PAUSE_2_END") || "",
            p3s: LS.getItem("PAUSE_3_START") || "",
            p3e: LS.getItem("PAUSE_3_END") || ""
          },
          org: {
            company: LS.getItem("ORG_COMPANY") || "",
            site: LS.getItem("ORG_SITE") || "",
            line: LS.getItem("ORG_LINE") || "",
            signature: LS.getItem("ORG_SIGNATURE") || "",
            logoDataUrl: LS.getItem("ORG_LOGO_DATAURL") || ""
          }
        },
        audit: auditLog
      }
    };
    return payload;
  }

  function exportBackup(){
    try{
      const payload = buildBackupPayload();
      const ctx = getShiftCtx();
      const dateISO = (typeof shiftDateStrToISO==="function") ? (shiftDateStrToISO(ctx.shiftDate)||"") : "";
      const safeDate = (dateISO || String(ctx.shiftDate||"")).replaceAll("/", "-");
      const safeShift = String(ctx.shiftType||"Shift").replaceAll(" ", "_");
      const filename = `Backup_${safeShift}_${safeDate || "date"}.json`;
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
      downloadBlob(filename, blob);
      addAudit("üíæ Export", `Sauvegarde export√©e: ${filename}`);
      showNotification("‚úÖ Sauvegarde export√©e (JSON)", "success");
    }catch(e){
      alert("Erreur export: " + (e && e.message ? e.message : e));
    }
  }

  // --------- Restauration (Import) ----------
  function applyBackupPayload(payload){
    if(!payload || !payload.data) throw new Error("Fichier invalide");
    const data = payload.data;

    if(!Array.isArray(data.history)) throw new Error("Historique manquant");
    // Remplacer enti√®rement
    history = data.history;
    // r√©-installer l'intercepteur
    installHistoryInterceptor();

    try{ LS.setItem("HISTO", JSON.stringify(history)); }catch(e){}
    if(typeof absenceHistory!=="undefined"){
      absenceHistory = Array.isArray(data.absences)?data.absences:[];
      try{ LS.setItem("ABSENCES", JSON.stringify(absenceHistory)); }catch(e){}
    }
    if(typeof workModeMap!=="undefined" && data.workModeMap){
      workModeMap = data.workModeMap;
      try{ LS.setItem("WORK_MODE_MAP_V1", JSON.stringify(workModeMap)); }catch(e){}
    }
    if(typeof offDaysOfWeek!=="undefined" && Array.isArray(data.offDaysOfWeek)){
      offDaysOfWeek = data.offDaysOfWeek;
      try{ LS.setItem("OFF_DAYS_V1", JSON.stringify(offDaysOfWeek)); }catch(e){}
    }

    // settings
    if(data.settings){
      try{
        if(data.settings.teamLeader) LS.setItem("TEAM_LEADER", String(data.settings.teamLeader));
        if(data.settings.cycleTimeSeconds) LS.setItem("CYCLE_TIME_SECONDS", String(data.settings.cycleTimeSeconds));
        const p = data.settings.pauses || {};
        if(p.p1s) LS.setItem("PAUSE_1_START", String(p.p1s));
        if(p.p1e) LS.setItem("PAUSE_1_END", String(p.p1e));
        if(p.p2s) LS.setItem("PAUSE_2_START", String(p.p2s));
        if(p.p2e) LS.setItem("PAUSE_2_END", String(p.p2e));
        if(p.p3s) LS.setItem("PAUSE_3_START", String(p.p3s));
        if(p.p3e) LS.setItem("PAUSE_3_END", String(p.p3e));
        // Identit√© PDF (Entreprise / Site / Ligne / Signature / Logo)
        try{
          const org = data.settings.org || {};
          if(typeof org.company === "string") LS.setItem("ORG_COMPANY", org.company);
          if(typeof org.site === "string") LS.setItem("ORG_SITE", org.site);
          if(typeof org.line === "string") LS.setItem("ORG_LINE", org.line);
          if(typeof org.signature === "string") LS.setItem("ORG_SIGNATURE", org.signature);
          if(typeof org.logoDataUrl === "string") LS.setItem("ORG_LOGO_DATAURL", org.logoDataUrl);
        }catch(e){}

      }catch(e){}
    }

        try{ loadOrgIdentity(); }catch(e){}
    try{ updateLogoPreview(); }catch(e){}

    // audit
    if(Array.isArray(data.audit)){
      auditLog = data.audit;
      if(auditLog.length > 500) auditLog = auditLog.slice(-500);
      saveAudit();
    }

    // UI refresh
    try{ refreshTable(); }catch(e){}
    try{ updateProductionCalculations(); }catch(e){}
    try{ updateAllCharts(); }catch(e){}
    try{ updateTraceabilityTables(history); }catch(e){}
    try{ if (typeof db !== "undefined" && db) saveToIndexedDB(); }catch(e){}
  }

  function importBackupFromFile(file){
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const txt = reader.result;
        const payload = JSON.parse(txt);
        const ok = confirm("‚ö†Ô∏è Import sauvegarde\n\nCette action VA REMPLACER toutes les donn√©es locales (arr√™ts, absences, param√®tres) par celles du fichier.\n\nContinuer ?");
        if(!ok) return;
        applyBackupPayload(payload);
        addAudit("üì• Import", `Sauvegarde import√©e: ${file.name}`);
        showNotification("‚úÖ Sauvegarde import√©e", "success");
      }catch(e){
        alert("Import impossible: " + (e && e.message ? e.message : e));
      }
    };
    reader.onerror = () => alert("Erreur de lecture du fichier.");
    reader.readAsText(file);
  }

  // --------- Rapport PDF fin de shift ----------
  function num(v){ const n = Number(v); return isFinite(n)?n:0; }
  function sum(arr, fn){ let s=0; for(const x of arr){ s += fn(x); } return s; }

  function getShiftTimeRange(shiftType){
    const cfg = (shiftConfigs && shiftConfigs[shiftType]) ? shiftConfigs[shiftType] : null;
    if(!cfg) return { start:"", end:"" };
    const sh = String(cfg.start).padStart(2,'0') + ":00";
    const eh = String(cfg.end).padStart(2,'0') + ":00";
    return { start: sh, end: eh };
  }

  function generateShiftPdf(){
    try{
      const ctx = getShiftCtx();
      const shiftType = ctx.shiftType;
      const shiftDateStr = ctx.shiftDate;
      const shiftDateISO = (typeof shiftDateStrToISO==="function") ? shiftDateStrToISO(shiftDateStr) : "";
      const range = getShiftTimeRange(shiftType);

      // Filtrer: seulement le shift s√©lectionn√©
      const filt = (Array.isArray(history)?history:[]).filter(h=>{
        if(!h) return false;
        if(h.date !== shiftDateStr) return false;
        if(typeof getStopShiftType==="function"){
          const st = getStopShiftType(h);
          if(st && st !== shiftType) return false;
        }
        if(typeof equipe !== "undefined" && equipe !== "all"){
          if(h.equipe !== equipe) return false;
        }
        return true;
      });

      const totalStops = filt.length;
      const missedStops = filt.filter(s=> s && (s.isMissed || s.type==="rat√©")).length;
      const specialStops = filt.filter(s=> s && s.type==="sp√©cial").length;
      const normalStops = Math.max(0, totalStops - missedStops - specialStops);

      const totalSec = sum(filt, s=> num(s.duration));
      const totalMin = Math.round(totalSec/60);

      // Lire KPIs existants (si affich√©s)
      const netMinText = document.getElementById("netTotalMinutes")?.textContent || "";
      const netSecText = document.getElementById("netTotalSeconds")?.textContent || "";
      const lostVehiclesText = document.getElementById("lostVehicles")?.textContent || "";
      const producedVehiclesText = document.getElementById("producedVehicles")?.textContent || "";
const cycleSec = num(LS.getItem("CYCLE_TIME_SECONDS") || 0);

      // Agr√©gation causes
      const map = new Map();
      for(const s of filt){
        const cause = (s.cause || "Non sp√©cifi√©").toString().trim() || "Non sp√©cifi√©";
        if(!map.has(cause)) map.set(cause, { cause, sec:0, count:0, missed:0 });
        const o = map.get(cause);
        o.sec += num(s.duration);
        o.count += 1;
        if(s.isMissed || s.type==="rat√©") o.missed += 1;
      }
      const causes = Array.from(map.values()).sort((a,b)=> b.sec - a.sec);
      const top10 = causes.slice(0,10);

      // Construire HTML du rapport
      const container = document.getElementById("pdfReportContainer");
      if(!container) throw new Error("Zone PDF introuvable");

      const safe = (v)=> String(v??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
      const dateTitle = safe(shiftDateStr);
      const shiftTitle = safe(shiftType);
      const teamTitle = (typeof equipe!=="undefined" ? safe(equipe) : "");
      const user = safe(getUserName());

      const org = getOrgIdentity ? getOrgIdentity() : {
        company: (LS.getItem("ORG_COMPANY")||""),
        site: (LS.getItem("ORG_SITE")||""),
        line: (LS.getItem("ORG_LINE")||""),
        signature: (LS.getItem("ORG_SIGNATURE")||""),
        logoDataUrl: (LS.getItem("ORG_LOGO_DATAURL")||"")
      };
      const company = safe(org.company || "");
      const site = safe(org.site || "");
      const line = safe(org.line || "");
      const signature = safe((org.signature || user) || "");
      const logoDataUrl = (org.logoDataUrl || "");
      const logoImg = (logoDataUrl && logoDataUrl.startsWith("data:image")) 
        ? `<img src="${logoDataUrl}" style="height:56px; max-width:180px; object-fit:contain; border:1px solid #e5e7eb; border-radius:12px; padding:6px; background:#ffffff;" />`
        : "";

      const filenameDate = (shiftDateISO || shiftDateStr || "date").replaceAll("/","-");
      const filename = `Rapport_Shift_${shiftTitle}_${filenameDate}.pdf`;

      const causesRows = top10.map(c=>{
        const min = Math.round(c.sec/60);
        const pct = totalSec>0 ? Math.round((c.sec/totalSec)*100) : 0;
        return `<tr>
          <td style="padding:6px; border-bottom:1px solid #e5e7eb;">${safe(c.cause)}</td>
          <td style="padding:6px; border-bottom:1px solid #e5e7eb; text-align:right;">${c.count}</td>
          <td style="padding:6px; border-bottom:1px solid #e5e7eb; text-align:right;">${c.missed}</td>
          <td style="padding:6px; border-bottom:1px solid #e5e7eb; text-align:right;">${min} min</td>
          <td style="padding:6px; border-bottom:1px solid #e5e7eb; text-align:right;">${pct}%</td>
        </tr>`;
      }).join("");

      const fr = `
        <div style="font-family: Arial, sans-serif; color:#111827; background:#ffffff; padding:18px;">
          <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:12px;">
            <div>
              <div style="font-size:20px; font-weight:900;">Rapport Fin de Shift ‚Äì Arr√™ts Cha√Æne</div>
              <div style="margin-top:4px; color:#374151; font-size:12px;">G√©n√©r√© depuis l‚Äôapplication HTML (Android)</div>
            </div>
            <div style="text-align:right; font-size:12px; color:#111827;">
              <div><b>Utilisateur :</b> ${user}</div>
              <div><b>Date/heure :</b> ${fmtLocal(Date.now())}</div>
            </div>
          </div>

          <div style="margin-top:12px; border:1px solid #e5e7eb; border-radius:12px; padding:12px;">
            <div style="font-weight:900; margin-bottom:6px;">Contexte du shift</div>
            <div style="font-size:13px; color:#111827;">
              <div><b>Shift :</b> ${shiftTitle} &nbsp; <b>Plage :</b> ${safe(range.start)} ‚Üí ${safe(range.end)}</div>
              <div><b>Date du shift :</b> ${dateTitle} &nbsp; <b>√âquipe :</b> ${teamTitle}</div>
              <div style="margin-top:6px; color:#6b7280; font-size:12px;">
                Note : pour le shift Nuit, les heures apr√®s minuit appartiennent au jour suivant (date r√©elle affich√©e dans le tableau).
              </div>
            </div>
          </div>

          <div style="margin-top:12px; display:grid; grid-template-columns: repeat(2, 1fr); gap:10px;">
            <div style="border:1px solid #e5e7eb; border-radius:12px; padding:12px;">
              <div style="font-weight:900;">KPI Arr√™ts</div>
              <div style="margin-top:8px; font-size:13px;">
                <div><b>Nombre d‚Äôarr√™ts :</b> ${totalStops} (Normal: ${normalStops} ‚Ä¢ Rat√©s: ${missedStops} ‚Ä¢ Sp√©ciaux: ${specialStops})</div>
                <div><b>Temps total brut :</b> ${totalMin} min</div>
                <div><b>Temps net (si param√©tr√©) :</b> ${safe(netMinText)} / ${safe(netSecText)}</div>
              </div>
            </div>
            <div style="border:1px solid #e5e7eb; border-radius:12px; padding:12px;">
              <div style="font-weight:900;">Production (selon param√®tres)</div>
              <div style="margin-top:8px; font-size:13px;">
                <div><b>Temps de cycle :</b> ${cycleSec? (cycleSec + " s") : "‚Äî"}</div>
                <div><b>V√©hicules produits :</b> ${safe(producedVehiclesText)}</div>
                <div><b>V√©hicules perdus :</b> ${safe(lostVehiclesText)}</div>
</div>
            </div>
          </div>

          <div style="margin-top:12px; border:1px solid #e5e7eb; border-radius:12px; padding:12px;">
            <div style="font-weight:900; margin-bottom:8px;">Top causes (Pareto ‚Äì dur√©e)</div>
            <table style="width:100%; border-collapse:collapse; font-size:12px;">
              <thead>
                <tr style="background:#f3f4f6;">
                  <th style="padding:6px; text-align:left; border-bottom:1px solid #e5e7eb;">Cause</th>
                  <th style="padding:6px; text-align:right; border-bottom:1px solid #e5e7eb;">Nb</th>
                  <th style="padding:6px; text-align:right; border-bottom:1px solid #e5e7eb;">Rat√©s</th>
                  <th style="padding:6px; text-align:right; border-bottom:1px solid #e5e7eb;">Dur√©e</th>
                  <th style="padding:6px; text-align:right; border-bottom:1px solid #e5e7eb;">%</th>
                </tr>
              </thead>
              <tbody>${causesRows || `<tr><td colspan="5" style="padding:8px; color:#6b7280;">Aucune donn√©e</td></tr>`}</tbody>
            </table>
          </div>

          <div style="margin-top:12px; border:1px solid #e5e7eb; border-radius:12px; padding:12px;">
            <div style="font-weight:900; margin-bottom:6px;">Actions & PDCA</div>
            <div style="font-size:12px; color:#374151;">
              ‚Ä¢ Actions imm√©diates: ________________<br/>
              ‚Ä¢ Cause racine (5 Pourquoi): ________________<br/>
              ‚Ä¢ Plan d‚Äôaction (Qui / Quoi / Quand / Preuve): ________________<br/>
            </div>
          </div>

          <div style="margin-top:12px; font-size:10px; color:#6b7280; text-align:center;">
            Document interne ‚Äì Tra√ßabilit√© et am√©lioration continue
          </div>
        </div>
      `;

      const ar = `
        <div style="font-family: Arial, sans-serif; color:#111827; background:#ffffff; padding:18px; direction:rtl; text-align:right;">
          <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:12px;">
            <div style="text-align:right;">
              <div style="font-size:18px; font-weight:900;">ÿ™ŸÇÿ±Ÿäÿ± ŸÜŸáÿßŸäÿ© ÿßŸÑŸÖŸÜÿßŸàÿ®ÿ© ‚Äì ÿ™ŸàŸÇŸÅÿßÿ™ ÿßŸÑÿÆÿ∑</div>
              <div style="margin-top:6px; font-size:12px; color:#374151;">
                <b>ÿßŸÑŸÖŸÜÿßŸàÿ®ÿ©:</b> ${shiftTitle} &nbsp; <b>ÿßŸÑŸÅÿ™ÿ±ÿ©:</b> ${safe(range.start)} ‚Üí ${safe(range.end)}<br/>
                <b>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÖŸÜÿßŸàÿ®ÿ©:</b> ${dateTitle} &nbsp; <b>ÿßŸÑŸÅÿ±ŸäŸÇ:</b> ${teamTitle}<br/>
                ${company ? `<b>ÿßŸÑÿ¥ÿ±ŸÉÿ©:</b> ${company}<br/>` : ``}
                ${site ? `<b>ÿßŸÑŸÖŸàŸÇÿπ:</b> ${site}<br/>` : ``}
                ${line ? `<b>ÿßŸÑÿÆÿ∑:</b> ${line}<br/>` : ``}
                <b>ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ:</b> ${user} &nbsp; <b>ÿßŸÑÿ™ŸàŸÇŸäÿπ:</b> ${signature}
              </div>
            </div>
            <div style="text-align:left;">${logoImg}</div>
          </div>
          <div style="margin-top:10px; border:1px solid #e5e7eb; border-radius:12px; padding:12px; font-size:12px;">
            <b>ŸÖÿ§ÿ¥ÿ±ÿßÿ™ ÿßŸÑÿ™ŸàŸÇŸÅÿßÿ™:</b><br/>
            ÿπÿØÿØ ÿßŸÑÿ™ŸàŸÇŸÅÿßÿ™: ${totalStops} (ÿπÿßÿØŸä: ${normalStops} ‚Ä¢ ŸÅÿßÿ¶ÿ™: ${missedStops} ‚Ä¢ ÿÆÿßÿµ: ${specialStops})<br/>
            ÿßŸÑŸàŸÇÿ™ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä (ÿÆÿßŸÖ): ${totalMin} ÿØŸÇŸäŸÇÿ©<br/>
            ÿßŸÑŸàŸÇÿ™ ÿßŸÑÿµÿßŸÅŸä (ÿ•ÿ∞ÿß ÿ™ŸÖ ÿ∂ÿ®ÿ∑Ÿá): ${safe(netMinText)} / ${safe(netSecText)}
          </div>
          <div style="margin-top:10px; border:1px solid #e5e7eb; border-radius:12px; padding:12px; font-size:12px;">
            <b>ÿßŸÑÿ•ŸÜÿ™ÿßÿ¨:</b><br/>
            ŸàŸÇÿ™ ÿßŸÑÿØŸàÿ±ÿ©: ${cycleSec? (cycleSec + " ÿ´ÿßŸÜŸäÿ©") : "‚Äî"}<br/>
            ÿ≥Ÿäÿßÿ±ÿßÿ™ ŸÖŸÜÿ™ÿ¨ÿ©: ${safe(producedVehiclesText)}<br/>
            ÿ≥Ÿäÿßÿ±ÿßÿ™ ÿ∂ÿßÿ¶ÿπÿ©: ${safe(lostVehiclesText)}
          </div>
          <div style="margin-top:10px; border:1px solid #e5e7eb; border-radius:12px; padding:12px; font-size:12px;">
            <b>ÿ£ŸáŸÖ ÿßŸÑÿ£ÿ≥ÿ®ÿßÿ® (Pareto):</b><br/>
            <div style="color:#6b7280; margin-top:4px;">(ÿßŸÜÿ∏ÿ± ÿ¨ÿØŸàŸÑ ÿßŸÑÿ£ÿ≥ÿ®ÿßÿ® ŸÅŸä ÿßŸÑŸÇÿ≥ŸÖ ÿßŸÑŸÅÿ±ŸÜÿ≥Ÿä ÿ£ÿπŸÑÿßŸá)</div>
          </div>
        </div>
      `;

      container.innerHTML = fr + '<div style="page-break-after:always;"></div>' + ar;

      // G√©n√©rer PDF
      const opt = {
        margin: 8,
        filename,
        image: { type: 'jpeg', quality: 0.95 },
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
      };

      addAudit("üìÑ PDF", `G√©n√©ration rapport fin de shift: ${filename}`);
      html2pdf().set(opt).from(container).save();
      showNotification("üìÑ Rapport PDF g√©n√©r√©", "success");
    }catch(e){
      alert("PDF impossible: " + (e && e.message ? e.message : e));
    }
  }

  
  // --------- Identit√© PDF (Entreprise / Site / Ligne / Logo / Signature) ----------
  const ORG_KEYS = {
    company: "ORG_COMPANY",
    site: "ORG_SITE",
    line: "ORG_LINE",
    signature: "ORG_SIGNATURE",
    logo: "ORG_LOGO_DATAURL"
  };

  function getOrgIdentity(){
    return {
      company: (LS.getItem(ORG_KEYS.company) || "").toString(),
      site: (LS.getItem(ORG_KEYS.site) || "").toString(),
      line: (LS.getItem(ORG_KEYS.line) || "").toString(),
      signature: (LS.getItem(ORG_KEYS.signature) || "").toString(),
      logoDataUrl: (LS.getItem(ORG_KEYS.logo) || "").toString()
    };
  }

  function setOrgIdentity(partial){
    try{
      if(partial.company !== undefined) LS.setItem(ORG_KEYS.company, String(partial.company));
      if(partial.site !== undefined) LS.setItem(ORG_KEYS.site, String(partial.site));
      if(partial.line !== undefined) LS.setItem(ORG_KEYS.line, String(partial.line));
      if(partial.signature !== undefined) LS.setItem(ORG_KEYS.signature, String(partial.signature));
      if(partial.logoDataUrl !== undefined) LS.setItem(ORG_KEYS.logo, String(partial.logoDataUrl));
    }catch(e){}
  }

  function updateLogoPreview(){
    const img = document.getElementById("orgLogoPreview");
    const logoDataUrl = (LS.getItem(ORG_KEYS.logo) || "").toString();
    if(!img) return;
    if(logoDataUrl && logoDataUrl.startsWith("data:image")){
      img.src = logoDataUrl;
      img.style.display = "inline-block";
    }else{
      img.src = "";
      img.style.display = "none";
    }
  }

  function loadOrgIdentity(){
    const id = getOrgIdentity();
    const c = document.getElementById("orgCompany");
    const s = document.getElementById("orgSite");
    const l = document.getElementById("orgLine");
    const sig = document.getElementById("orgSignature");
    if(c) c.value = id.company || "";
    if(s) s.value = id.site || "";
    if(l) l.value = id.line || "";
    if(sig) sig.value = id.signature || "";
    updateLogoPreview();
  }

  function wireOrgIdentityUI(){
    const c = document.getElementById("orgCompany");
    const s = document.getElementById("orgSite");
    const l = document.getElementById("orgLine");
    const sig = document.getElementById("orgSignature");
    const logoFile = document.getElementById("orgLogoFile");
    const clearLogoBtn = document.getElementById("clearLogoBtn");
    const clearIdentityBtn = document.getElementById("clearIdentityBtn");

    const saveNow = ()=>{
      setOrgIdentity({
        company: c ? c.value : "",
        site: s ? s.value : "",
        line: l ? l.value : "",
        signature: sig ? sig.value : ""
      });
    };

    const onInput = ()=>{
      saveNow();
    };

    if(c) c.addEventListener("input", onInput);
    if(s) s.addEventListener("input", onInput);
    if(l) l.addEventListener("input", onInput);
    if(sig) sig.addEventListener("input", onInput);

    if(logoFile){
      logoFile.onchange = ()=>{
        const f = logoFile.files && logoFile.files[0];
        if(!f) return;
        const reader = new FileReader();
        reader.onload = ()=>{
          const dataUrl = String(reader.result || "");
          if(dataUrl.startsWith("data:image")){
            setOrgIdentity({ logoDataUrl: dataUrl });
            updateLogoPreview();
            try{ addAudit("üñºÔ∏è Logo", "Logo mis √† jour"); }catch(e){}
            try{ showNotification("Logo ajout√©", "success"); }catch(e){}
          }else{
            try{ showNotification("Fichier logo invalide", "error"); }catch(e){}
          }
          logoFile.value = "";
        };
        reader.readAsDataURL(f);
      };
    }

    if(clearLogoBtn){
      clearLogoBtn.onclick = ()=>{
        setOrgIdentity({ logoDataUrl: "" });
        updateLogoPreview();
        try{ addAudit("üßΩ Logo", "Logo supprim√©"); }catch(e){}
        try{ showNotification("Logo supprim√©", "warning"); }catch(e){}
      };
    }

    if(clearIdentityBtn){
      clearIdentityBtn.onclick = ()=>{
        if(!confirm("R√©initialiser Entreprise/Site/Ligne/Signature + Logo ?")) return;
        setOrgIdentity({ company:"", site:"", line:"", signature:"", logoDataUrl:"" });
        loadOrgIdentity();
        try{ addAudit("üßπ Identit√©", "R√©initialisation identit√© PDF"); }catch(e){}
        try{ showNotification("Identit√© r√©initialis√©e", "warning"); }catch(e){}
      };
    }
  }


// --------- UI wiring ----------
  function setupDirectionUI(){
    const exportBtn = document.getElementById("exportBackupBtn");
    const importBtn = document.getElementById("importBackupBtn");
    const pdfBtn = document.getElementById("exportShiftPdfBtn");
    const toggleAuditBtn = document.getElementById("toggleAuditBtn");
    const clearAuditBtn = document.getElementById("clearAuditBtn");
    const panel = document.getElementById("auditPanel");
    const fileInput = document.getElementById("importBackupFile");

    if(exportBtn) exportBtn.onclick = exportBackup;
    if(importBtn) importBtn.onclick = ()=>{ if(fileInput) fileInput.click(); };
    if(fileInput){
      fileInput.onchange = ()=>{
        const f = fileInput.files && fileInput.files[0];
        if(f) importBackupFromFile(f);
        fileInput.value = "";
      };
    }
    if(pdfBtn) pdfBtn.onclick = generateShiftPdf;

    if(toggleAuditBtn && panel){
      toggleAuditBtn.onclick = ()=>{
        const open = panel.style.display === "block";
        panel.style.display = open ? "none" : "block";
        toggleAuditBtn.textContent = open ? "üßæ Historique des modifications" : "üßæ Historique (ouvert)";
        if(!open) renderAudit();
      };
    }
    if(clearAuditBtn){
      clearAuditBtn.onclick = ()=>{
        if(!confirm("Vider l'historique des modifications ?")) return;
        auditLog = [];
        saveAudit();
        renderAudit();
        addAudit("üßπ Audit", "Historique vid√©");
        showNotification("Historique vid√©", "warning");
      };
    }
  }

  // init
  try{ installHistoryInterceptor(); }catch(e){}
  try{ installEditInterceptor(); }catch(e){}
  try{ installDeleteInterceptor(); }catch(e){}
  try{ setupDirectionUI(); }catch(e){}
  try{ loadOrgIdentity(); }catch(e){}
  try{ wireOrgIdentityUI(); }catch(e){}
  try{ renderAudit(); }catch(e){}

})();


// Prefer the unified helper if present
    if (typeof window.openGoogleSearch === 'function'){
      window.openGoogleSearch(query);
      return;
    }
    const url = 'https://www.google.com/search?q=' + encodeURIComponent(query || '');
    const w = window.open(url, '_blank');
    if (!w) window.location.href = url;
  }

  function getFloatMode(){
    const r = panel ? panel.querySelector('input[name="floatSearchMode"]:checked') : null;
    return r ? r.value : 'app';
  }

  function syncMainMode(mode){
    try{
      const mApp = document.getElementById('searchModeApp');
      const mGoogle = document.getElementById('searchModeGoogle');
      if (mApp && mGoogle){
        if (mode === 'google'){ mGoogle.checked = true; }
        else { mApp.checked = true; }
        mApp.dispatchEvent(new Event('change'));
        mGoogle.dispatchEvent(new Event('change'));
      }
    }catch(e){}
  }

  function show(){
    panel.style.display = 'block';
    // sync mode with main UI
    try{
      const mainGoogle = document.getElementById('searchModeGoogle');
      const mainApp = document.getElementById('searchModeApp');
      const floatGoogle = panel.querySelector('input[name="floatSearchMode"][value="google"]');
      const floatApp = panel.querySelector('input[name="floatSearchMode"][value="app"]');
      if (mainGoogle && mainGoogle.checked && floatGoogle) floatGoogle.checked = true;
      if (mainApp && mainApp.checked && floatApp) floatApp.checked = true;
    }catch(e){}
    // sync value with existing input if present
    if (existingInput && existingInput.value && !q.value) q.value = existingInput.value;
    setTimeout(()=>{ q.focus(); q.select && q.select(); }, 50);
  }
  function hide(){
    panel.style.display = 'none';
  }

  btn && btn.addEventListener('click', ()=>{
    // 1) open quick panel
    if (panel.style.display === 'block') { hide(); return; }
    show();
    // 2) also scroll to the section (for visibility)
    if (existingSection) existingSection.scrollIntoView({ behavior:'smooth', block:'start' });
    if (existingInput) setTimeout(()=>existingInput.focus(), 250);
  });

  close && close.addEventListener('click', hide);

  go && go.addEventListener('click', ()=>{
    const query = (q.value || '').trim();
    if (!query) { q.focus(); return; }
    if (existingInput) existingInput.value = query;

    const mode = getFloatMode();
    syncMainMode(mode);

    if (mode === 'google'){
      openGoogle(query);
    }else{
      if (typeof window.searchInApp === 'function'){
        window.searchInApp(query);
        if (existingSection) existingSection.scrollIntoView({ behavior:'smooth', block:'start' });
      }
    }
  });

q && q.addEventListener('keydown', (e)=>{
    if (e.key === 'Enter'){ e.preventDefault(); go && go.click(); }
    if (e.key === 'Escape'){ hide(); }
  });

  // Keep both inputs synchronized
  if (existingInput){
    q && q.addEventListener('input', ()=>{ existingInput.value = q.value; });
    existingInput.addEventListener('input', ()=>{ q.value = existingInput.value; });
  }

  // tap outside to close (mobile friendly)
  document.addEventListener('click', (e)=>{
    if (!panel || panel.style.display !== 'block') return;
    const t = e.target;
    if (t === panel || panel.contains(t) || t === btn) return;
    hide();
  }, true);
})();
</script>


<script>

/* === Cycle time split inputs (minutes + secondes) ===
   Objectif: √©viter le ":" sur clavier mobile (Android).
   On garde #cycleTimeInput (hidden) pour ne pas casser le JS existant. */
;(function(){
  function pad2(n){ return String(n).padStart(2,'0'); }

  function _getDefaultSec(){
    try{
      if (typeof cycleTimeSeconds === "number" && cycleTimeSeconds > 0) return Math.floor(cycleTimeSeconds);
    }catch(e){}
    try{
      const saved = parseInt((localStorage.getItem("CYCLE_TIME_SECONDS")||""),10);
      if(!isNaN(saved) && saved > 0) return saved;
    }catch(e){}
    return 267; // 4m27s
  }

  function setSplitFromSeconds(secTotal){
    secTotal = Math.max(1, Math.floor(secTotal || 267));
    const m = Math.floor(secTotal/60);
    const s = secTotal%60;

    const minEl = document.getElementById("cycleMinInput");
    const secEl = document.getElementById("cycleSecInput");
    if(minEl) minEl.value = String(m);
    if(secEl) secEl.value = String(s); // pas besoin de z√©ro √† gauche pour taper

    const hidden = document.getElementById("cycleTimeInput");
    if(hidden) hidden.value = `${m}:${pad2(s)}`;
  }

  function updateRateDisplays(){
    try{
      const secTotal = (typeof cycleTimeSeconds === "number" && cycleTimeSeconds > 0) ? cycleTimeSeconds : _getDefaultSec();
      const perHour = 3600 / secTotal;               // v√©hicules / heure
      const shiftTheoretical = (450*60) / secTotal;  // 450 min net (480-30), sans arr√™ts
      const phEl = document.getElementById("cycleRatePerHour");
      const shEl = document.getElementById("cycleShiftTheoretical");
      if(phEl) phEl.textContent = (Math.round(perHour)).toString();
      if(shEl) shEl.textContent = (Math.round(shiftTheoretical)).toString();
      const cadEl = document.getElementById("cadenceCibleValue");
      if(cadEl) cadEl.textContent = `${(Math.round(perHour))} v√©h/h`;
    }catch(e){}
  }

  function pushSplitToHidden(){
    const minEl = document.getElementById("cycleMinInput");
    const secEl = document.getElementById("cycleSecInput");
    const hidden = document.getElementById("cycleTimeInput");
    if(!minEl || !secEl || !hidden) return;

    let m = parseInt(minEl.value,10); if(isNaN(m) || m < 0) m = 0;
    let s = parseInt(secEl.value,10); if(isNaN(s) || s < 0) s = 0;

    // Normaliser secondes > 59
    if(s > 59){
      m += Math.floor(s/60);
      s = s % 60;
      minEl.value = String(m);
      secEl.value = String(s);
    }

    hidden.value = `${m}:${pad2(s)}`;

    // D√©clencher le recalcul existant
    try{ hidden.dispatchEvent(new Event("input", {bubbles:true})); }catch(e){}
    try{ hidden.dispatchEvent(new Event("change", {bubbles:true})); }catch(e){}

    try{ if(typeof updateProductionCalculations === "function") updateProductionCalculations(); }catch(e){}
    try{ if(typeof updateCycleTimeDirtyUI === "function") updateCycleTimeDirtyUI(); }catch(e){}
    try{ if(typeof updateShiftObjectiveDashboard === "function") updateShiftObjectiveDashboard(); }catch(e){}
    updateRateDisplays();
  }

  function init(){
    const minEl = document.getElementById("cycleMinInput");
    const secEl = document.getElementById("cycleSecInput");
    const hidden = document.getElementById("cycleTimeInput");
    if(!minEl || !secEl || !hidden) return;

    // Initialiser depuis cycleTimeSeconds / localStorage
    setSplitFromSeconds(_getDefaultSec());
    updateRateDisplays();

    minEl.addEventListener("input", pushSplitToHidden);
    secEl.addEventListener("input", pushSplitToHidden);
    minEl.addEventListener("change", pushSplitToHidden);
    secEl.addEventListener("change", pushSplitToHidden);

    // Patch deleteCycleTime pour resynchroniser les 2 champs
    try{
      if(typeof window.deleteCycleTime === "function" && !window.deleteCycleTime.__splitPatched){
        const orig = window.deleteCycleTime;
        const patched = function(){
          const r = orig.apply(this, arguments);
          try{ setSplitFromSeconds(_getDefaultSec()); }catch(e){}
          updateRateDisplays();
          return r;
        };
        patched.__splitPatched = true;
        window.deleteCycleTime = patched;
      }
    }catch(e){}
  }

  if(document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", init);
  }else{
    init();
  }
})();

/* =========================
   COLLAB TEMPS R√âEL : ARR√äTS + APPEL AU POSTE + POSTS MULTI-AUTEUR (Firebase)
   ========================= */
;(function(){
  // Cache Firebase pour posts (multi-auteur)
  window.firebasePostsCache = window.firebasePostsCache || [];

  let rtAttached = false;
  let rtRoom = null;
  let rtStationsRef = null;
  let rtPostsRef = null;
  let rtCallsRef = null;
  let rtTicker = null;

  let myActiveStopId = null;
  let myActiveStopStartedAt = null;
  let lastStationsObj = null;
  let durationTicker = null;

  const LS2 = window.localStorage;

  function esc(s){
    return String(s ?? "").replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
  }

  function getStationId(){
    const el = document.getElementById("stationIdInput");
    const v = (el?.value || LS2.getItem("STATION_ID") || "").trim();
    return v;
  }
  function getStationZone(){
    const el = document.getElementById("stationZoneInput");
    const v = (el?.value || LS2.getItem("STATION_ZONE") || "").trim();
    return v;
  }

  function setStationIdentity(stationId, zone){
    if (stationId) LS2.setItem("STATION_ID", stationId);
    if (zone !== undefined) LS2.setItem("STATION_ZONE", zone || "");
  }

  function getSelectedCause(){
    const sel = document.getElementById("stationCauseSelect");
    const other = document.getElementById("stationCauseOther");
    const v = (sel?.value || "").trim();
    const o = (other?.value || "").trim();
    if (v && v !== "Autre") return v;
    if (o) return o;
    if (v === "Autre") return "Autre";
    return "";
  }

  function beepOnce(){
    try{
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = "sine";
      o.frequency.value = 880;
      g.gain.value = 0.08;
      o.connect(g);
      g.connect(ctx.destination);
      o.start();
      setTimeout(()=>{ try{o.stop();}catch(e){} try{ctx.close();}catch(e){} }, 180);
    }catch(e){}
  }

  function showPivot(count){
    const wrap = document.getElementById("pivotStopsIndicator");
    const cEl = document.getElementById("pivotStopsCount");
    if(!wrap || !cEl) return;
    if(count > 0){
      cEl.textContent = String(count);
      wrap.style.display = "block";
    } else {
      wrap.style.display = "none";
    }
  }

  function openCallModal(text){
    const modal = document.getElementById("callModal");
    const t = document.getElementById("callModalText");
    if(!modal || !t) return;
    t.textContent = text || "";
    modal.style.display = "block";
    beepOnce();
    // r√©p√©tition courte
    setTimeout(()=>beepOnce(), 450);
    setTimeout(()=>beepOnce(), 900);
  }
  function closeCallModal(){
    const modal = document.getElementById("callModal");
    if(modal) modal.style.display = "none";
  }

  function attachUIHandlers(){
    const idEl = document.getElementById("stationIdInput");
    const zoneEl = document.getElementById("stationZoneInput");
    const saveBtn = document.getElementById("saveStationBtn");
    const startBtn = document.getElementById("startStationStopBtn");
    const endBtn = document.getElementById("endStationStopBtn");
    const pivot = document.getElementById("pivotStopsIndicator");

    if(idEl && !idEl.__rtBound){
      idEl.value = (LS2.getItem("STATION_ID") || "");
      idEl.addEventListener("change", ()=>setStationIdentity((idEl.value||"").trim(), getStationZone()));
      idEl.__rtBound = true;
    }
    if(zoneEl && !zoneEl.__rtBound){
      zoneEl.value = (LS2.getItem("STATION_ZONE") || "");
      zoneEl.addEventListener("change", ()=>setStationIdentity(getStationId(), (zoneEl.value||"").trim()));
      zoneEl.__rtBound = true;
    }
    if(saveBtn && !saveBtn.__rtBound){
      saveBtn.addEventListener("click", ()=>{
        const sid = getStationId();
        const z = getStationZone();
        if(!sid){
          if(typeof showNotification === "function") showNotification("‚ö†Ô∏è Entrez un poste (ex: P12)", "warning");
          return;
        }
        setStationIdentity(sid, z);
        if(typeof showNotification === "function") showNotification(`‚úÖ Poste enregistr√©: ${sid}${z?(" ("+z+")"):""}`, "success");
      });
      saveBtn.__rtBound = true;
    }
    if(startBtn && !startBtn.__rtBound){
      startBtn.addEventListener("click", startStationStop);
      startBtn.__rtBound = true;
    }
    if(endBtn && !endBtn.__rtBound){
      endBtn.addEventListener("click", endStationStop);
      endBtn.__rtBound = true;
    }
    if(pivot && !pivot.__rtBound){
      pivot.addEventListener("click", ()=>{
        const target = document.getElementById("realtimeStopsBoardChartContainer");
        if(target) target.scrollIntoView({behavior:"smooth", block:"start"});
      });
      pivot.__rtBound = true;
    }

    const closeBtn = document.getElementById("callModalCloseBtn");
    const ackBtn = document.getElementById("callAcknowledgeBtn");
    if(closeBtn && !closeBtn.__rtBound){
      closeBtn.addEventListener("click", closeCallModal);
      closeBtn.__rtBound = true;
    }
    if(ackBtn && !ackBtn.__rtBound){
      ackBtn.addEventListener("click", ()=>{
        acknowledgeMyCall();
        closeCallModal();
      });
      ackBtn.__rtBound = true;
    }
  }

  function ensureFirebaseReady(){
    return (onlineConnected && onlineMode === "firebase" && onlineFirebaseDb && onlineFirebaseRoom);
  }

  function attachFirebaseRealtime(){
    if(!ensureFirebaseReady()) return;
    const room = onlineFirebaseRoom;
    if(rtAttached && rtRoom === room) return;

    detachFirebaseRealtime();

    rtRoom = room;
    rtStationsRef = onlineFirebaseDb.ref(`rooms/${room}/stations`);
    rtPostsRef = onlineFirebaseDb.ref(`rooms/${room}/posts`).limitToLast(200);
    rtCallsRef = onlineFirebaseDb.ref(`rooms/${room}/calls`);

    // Stations board
    rtStationsRef.on("value", (snap)=>{
      const stations = snap.val() || {};
      lastStationsObj = stations;
      renderStationsBoard(stations);
    });

    // Posts multi-auteur
    rtPostsRef.on("value", (snap)=>{
      const obj = snap.val() || {};
      const arr = Object.entries(obj).map(([k,v])=>({ ...(v||{}), _fbid:k, timestamp: (v && v.timestamp) ? v.timestamp : (v && v.serverAt) ? v.serverAt : 0 }));
      // garder du plus r√©cent au plus ancien
      window.firebasePostsCache = arr.sort((a,b)=>(b.timestamp||0)-(a.timestamp||0)).slice(0,200);
      if(typeof renderPostsBoard === "function") renderPostsBoard();
    });

    // Calls: √©couter uniquement mon poste (si d√©fini)
    const myStation = getStationId();
    if(myStation){
      onlineFirebaseDb.ref(`rooms/${room}/calls/${myStation}`).on("value", (snap)=>{
        const v = snap.val();
        if(v && v.ts){
          const from = v.fromStation || v.fromUser || "Quelqu'un";
          const msg = v.message || "Appel au poste";
          openCallModal(`üì£ Appel re√ßu\n\nDe: ${from}\nPoste: ${myStation}\nMessage: ${msg}`);
        }
      });
    }

    // Rafra√Æchir la dur√©e d'arr√™t (minutes) m√™me sans nouvel √©v√©nement
    if(!durationTicker){
      durationTicker = setInterval(()=>{
        try{ if(lastStationsObj) renderStationsBoard(lastStationsObj); }catch(e){}
      }, 5000);
    }

    rtAttached = true;
  }

  function detachFirebaseRealtime(){
    try{
      if(rtStationsRef) rtStationsRef.off();
      // limitToLast returns a Query; off() works too
      if(rtPostsRef) rtPostsRef.off();
      if(rtCallsRef) rtCallsRef.off();
    }catch(e){}
    rtStationsRef = null;
    rtPostsRef = null;
    rtCallsRef = null;
    rtAttached = false;
    try{ if(durationTicker){ clearInterval(durationTicker); durationTicker=null; } }catch(e){}
    lastStationsObj = null;
    rtRoom = null;
  }

  function renderStationsBoard(stationsObj){
    const grid = document.getElementById("realtimeStopsGrid");
    if(!grid) return;

    const now = Date.now();
    const entries = Object.entries(stationsObj || {}).map(([sid, s])=>({ sid, ...(s||{}) }));
    entries.sort((a,b)=> String(a.sid).localeCompare(String(b.sid), 'fr', {numeric:true}));

    let activeCount = 0;

    const cards = entries.map(s=>{
      const status = (s.status || "UNKNOWN");
      const isStop = status === "STOP";
      if(isStop) activeCount++;

      const zone = s.zone || "";
      const cause = s.cause || "";
      const startedAt = (typeof s.startedAt === "number") ? s.startedAt : 0;
      const mins = (isStop && startedAt) ? Math.max(0, Math.round((now - startedAt)/60000)) : 0;

      const badgeBg = isStop ? "rgba(239,68,68,0.20)" : (status==="RUN" ? "rgba(34,197,94,0.18)" : "rgba(148,163,184,0.18)");
      const badgeBr = isStop ? "rgba(239,68,68,0.55)" : (status==="RUN" ? "rgba(34,197,94,0.45)" : "rgba(148,163,184,0.45)");
      const badgeTxt = isStop ? `üî¥ ARR√äT ${mins} min` : (status==="RUN" ? "üü¢ MARCHE" : "‚ö™ INCONNU");

      const me = (getStationId() && String(getStationId())===String(s.sid)) ? " <span style='font-size:11px; color:#FFD700;'>(Vous)</span>" : "";

      return `
        <div style="padding:12px; border-radius:14px; border:1px solid rgba(255,255,255,0.12); background:rgba(0,0,0,0.22);">
          <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start;">
            <div style="font-weight:800; color:#e0e1dd;">
              üìç ${esc(s.sid)}${me}<div style="font-size:11px; color:#9aa4b2; margin-top:2px;">${esc(zone)}</div>
            </div>
            <div style="padding:6px 10px; border-radius:999px; background:${badgeBg}; border:1px solid ${badgeBr}; font-size:12px; font-weight:800;">
              ${badgeTxt}
            </div>
          </div>

          <div style="margin-top:10px; color:#e0e1dd; font-size:13px;">
            <div><b>Cause:</b> ${esc(cause || (isStop ? "‚Äî" : ""))}</div>
          </div>

          <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; margin-top:10px;">
            <button class="btn" style="padding:8px 10px;" onclick="sendCallToStation('${esc(String(s.sid)).replace(/'/g,'&#39;')}')">üì£ Appeler</button>
          </div>
        </div>
      `;
    });

    if(cards.length === 0){
      grid.innerHTML = `<div style="text-align:center; color:#9aa4b2; padding:14px; border:1px dashed rgba(255,255,255,0.15); border-radius:12px;">
        Aucun poste d√©tect√©. Enregistrez un poste et d√©clarez un arr√™t pour d√©marrer.
      </div>`;
    } else {
      grid.innerHTML = cards.join("");
    }

    showPivot(activeCount);
  }

  // Exposer sendCallToStation globalement (utilis√© par onclick)
  window.sendCallToStation = function(targetStationId){
    try{
      if(!ensureFirebaseReady()){
        if(typeof showNotification === "function") showNotification("‚ö†Ô∏è Activez Mode en ligne ‚Üí Firebase", "warning");
        return;
      }
      const target = String(targetStationId || "").trim();
      if(!target){
        if(typeof showNotification === "function") showNotification("‚ö†Ô∏è Poste cible vide", "warning");
        return;
      }
      const room = onlineFirebaseRoom;
      const fromStation = getStationId() || "(inconnu)";
      const fromUser = onlineFirebaseUser || teamLeader || "Utilisateur";
      const message = "Besoin d'aide / intervention (arr√™t en cours)";
      onlineFirebaseDb.ref(`rooms/${room}/calls/${target}`).set({
        fromStation,
        fromUser,
        message,
        ts: firebase.database.ServerValue.TIMESTAMP
      });
      if(typeof showNotification === "function") showNotification(`üì£ Appel envoy√© au poste ${target}`, "success");
    }catch(e){
      console.error("sendCallToStation error:", e);
      if(typeof showNotification === "function") showNotification("‚ùå Erreur appel poste", "error");
    }
  };

  function acknowledgeMyCall(){
    try{
      if(!ensureFirebaseReady()) return;
      const room = onlineFirebaseRoom;
      const myStation = getStationId();
      if(!myStation) return;
      onlineFirebaseDb.ref(`rooms/${room}/calls/${myStation}`).remove();
    }catch(e){}
  }

  function pushFirebasePostObject(post){
    try{
      if(!ensureFirebaseReady()) return false;
      const ref = onlineFirebaseDb.ref(`rooms/${onlineFirebaseRoom}/posts`).push();
      const payload = {
        ...post,
        _fbid: ref.key,
        uid: onlineFirebaseUid || "",
        room: onlineFirebaseRoom || "",
        serverAt: firebase.database.ServerValue.TIMESTAMP
      };
      ref.set(payload);
      return true;
    }catch(e){
      console.error("pushFirebasePostObject error:", e);
      return false;
    }
  }

  function startStationStop(){
    try{
      attachUIHandlers();
      if(!ensureFirebaseReady()){
        if(typeof showNotification === "function") showNotification("‚ö†Ô∏è Activez Mode en ligne ‚Üí Firebase", "warning");
        return;
      }
      const stationId = getStationId();
      const zone = getStationZone();
      const cause = getSelectedCause();
      if(!stationId){
        if(typeof showNotification === "function") showNotification("‚ö†Ô∏è Entrez un poste (ex: P12)", "warning");
        return;
      }
      if(!cause){
        if(typeof showNotification === "function") showNotification("‚ö†Ô∏è Choisissez/√©crivez une cause", "warning");
        return;
      }
      setStationIdentity(stationId, zone);

      const room = onlineFirebaseRoom;
      const uid = onlineFirebaseUid || "";
      const user = onlineFirebaseUser || teamLeader || "Utilisateur";

      const stopRef = onlineFirebaseDb.ref(`rooms/${room}/stops`).push();
      const stopId = stopRef.key;

      const startedAt = Date.now(); // affichage imm√©diat (client)
      myActiveStopId = stopId;
      myActiveStopStartedAt = startedAt;

      const stopPayload = {
        stopId,
        stationId,
        zone: zone || "",
        cause,
        startedBy: uid,
        startedByName: user,
        startedAt: firebase.database.ServerValue.TIMESTAMP
      };

      stopRef.set(stopPayload);

      onlineFirebaseDb.ref(`rooms/${room}/stations/${stationId}`).set({
        stationId,
        zone: zone || "",
        status: "STOP",
        cause,
        startedAt: firebase.database.ServerValue.TIMESTAMP,
        activeStopId: stopId,
        updatedAt: firebase.database.ServerValue.TIMESTAMP,
        updatedBy: uid,
        updatedByName: user
      });

      // Post automatique (demande d'aide / id√©es)
      pushFirebasePostObject({
        id: `rtstop_${Date.now()}_${Math.random().toString(36).slice(2,8)}`,
        kind: "stop_start",
        stationId,
        zone: zone || "",
        author: user,
        text: `üî¥ ARR√äT SIGNAL√â\nPoste: ${stationId}\nZone: ${zone || "-"}\nCause: ${cause}\n\nüí° Proposez une action / id√©e de solution ici.`,
        timestamp: Date.now(),
        updatedAt: Date.now()
      });

      if(typeof showNotification === "function") showNotification(`üî¥ Arr√™t d√©clar√© (${stationId})`, "warning");
    }catch(e){
      console.error("startStationStop error:", e);
      if(typeof showNotification === "function") showNotification("‚ùå Erreur d√©claration arr√™t", "error");
    }
  }

  function endStationStop(){
    try{
      attachUIHandlers();
      if(!ensureFirebaseReady()){
        if(typeof showNotification === "function") showNotification("‚ö†Ô∏è Activez Mode en ligne ‚Üí Firebase", "warning");
        return;
      }
      const stationId = getStationId();
      if(!stationId){
        if(typeof showNotification === "function") showNotification("‚ö†Ô∏è Entrez un poste (ex: P12)", "warning");
        return;
      }
      const room = onlineFirebaseRoom;
      const uid = onlineFirebaseUid || "";
      const user = onlineFirebaseUser || teamLeader || "Utilisateur";

      // R√©cup√©rer station state pour activeStopId
      onlineFirebaseDb.ref(`rooms/${room}/stations/${stationId}`).once("value").then((snap)=>{
        const st = snap.val() || {};
        const activeStopId = st.activeStopId || myActiveStopId;
        const startedAt = st.startedAt || myActiveStopStartedAt || null;

        // update station
        onlineFirebaseDb.ref(`rooms/${room}/stations/${stationId}`).update({
          status: "RUN",
          updatedAt: firebase.database.ServerValue.TIMESTAMP,
          updatedBy: uid,
          updatedByName: user
        });

        // close stop record
        if(activeStopId){
          onlineFirebaseDb.ref(`rooms/${room}/stops/${activeStopId}`).update({
            endedAt: firebase.database.ServerValue.TIMESTAMP,
            endedBy: uid,
            endedByName: user
          });
        }

        // Post automatique cl√¥ture
        const now = Date.now();
        let durMin = "";
        if(typeof startedAt === "number"){
          durMin = Math.max(0, Math.round((now - startedAt)/60000)) + " min";
        }
        pushFirebasePostObject({
          id: `rtstopend_${now}_${Math.random().toString(36).slice(2,8)}`,
          kind: "stop_end",
          stationId,
          zone: st.zone || getStationZone() || "",
          author: user,
          text: `üü¢ REPRISE\nPoste: ${stationId}\nDur√©e (approx): ${durMin || "-"}\n\n‚úÖ Indiquez l'action r√©alis√©e / solution appliqu√©e.`,
          timestamp: now,
          updatedAt: now
        });

        myActiveStopId = null;
        myActiveStopStartedAt = null;

        if(typeof showNotification === "function") showNotification(`üü¢ Reprise (${stationId})`, "success");
      });
    }catch(e){
      console.error("endStationStop error:", e);
      if(typeof showNotification === "function") showNotification("‚ùå Erreur reprise", "error");
    }
  }

  // Init public
  window.initRealtimeCollabUI = function(){
    attachUIHandlers();
    // Watcher attach/detach Firebase
    if(!rtTicker){
      rtTicker = setInterval(()=>{
        try{
          if(ensureFirebaseReady()){
            attachFirebaseRealtime();
          } else {
            detachFirebaseRealtime();
            showPivot(0);
          }
        }catch(e){}
      }, 1200);
    }
  };
})();


/* =========================================================
   üîí RESET SECRET (d√©butant-friendly)
   - Appui long (3.5s) sur le Titre (h1) ‚Üí demande mot de passe
   - Efface TOUT en LOCAL (ce t√©l√©phone/PC) : LocalStorage + IndexedDB
   - Ne supprime PAS les donn√©es de la Room pour les autres (s√©curis√©)
   ========================================================= */
;(function(){
  const HOLD_MS = 3500;
  let timer = null;

  function getTitleEl(){
    return document.querySelector("h1") || document.querySelector(".container") || document.body;
  }
  function startHold(){
    if(timer) return;
    timer = setTimeout(()=>{ timer=null; openReset(); }, HOLD_MS);
  }
  function cancelHold(){
    if(timer){ clearTimeout(timer); timer=null; }
  }

  async function sha256(str){
    try{
      if(!(window.crypto && crypto.subtle)) return "plain:" + String(str);
      const buf = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(String(str)));
      return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,"0")).join("");
    }catch(e){
      return "plain:" + String(str);
    }
  }

  async function ensurePinHash(){
    let h = null;
    try{ h = LS.getItem("SECRET_RESET_PIN_HASH"); }catch(e){}
    if(h) return h;

    const p1 = prompt("üîí ÿ•ŸÜÿ¥ÿßÿ° ŸÉŸÑŸÖÿ© ÿ≥ÿ± ŸÑŸÖÿ≥ÿ≠ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ (PIN)\nCr√©er un mot de passe pour RESET :");
    if(!p1) return null;
    const p2 = prompt("‚úÖ ÿ™ÿ£ŸÉŸäÿØ ŸÉŸÑŸÖÿ© ÿßŸÑÿ≥ÿ±\nConfirmer le mot de passe :");
    if(p1 !== p2){
      alert("‚ùå ÿ∫Ÿäÿ± ŸÖÿ™ÿ∑ÿßÿ®ŸÇ / Ne correspond pas");
      return null;
    }
    h = await sha256(p1);
    try{ LS.setItem("SECRET_RESET_PIN_HASH", h); }catch(e){}
    alert("‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ŸÉŸÑŸÖÿ© ÿßŸÑÿ≥ÿ±.\nŸÑŸÑŸÖÿ≥ÿ≠: ÿßÿ∂ÿ∫ÿ∑ ŸÖÿ∑ŸàŸÑÿßŸã ÿπŸÑŸâ ÿßŸÑÿπŸÜŸàÿßŸÜ 3 ÿ´ŸàÿßŸÜŸä ÿ´ŸÖ ÿ£ÿØÿÆŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑÿ≥ÿ±.");
    return h;
  }

  async function openReset(){
    const stored = await ensurePinHash();
    if(!stored) return;

    const pin = prompt("üß® RESET SECRET\nÿ£ÿØÿÆŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑÿ≥ÿ± ŸÑŸÖÿ≥ÿ≠ ŸÉŸÑ ÿ¥Ÿäÿ° ŸÖÿ≠ŸÑŸäÿßŸã (Ÿáÿ∞ÿß ÿßŸÑÿ¨Ÿáÿßÿ≤ ŸÅŸÇÿ∑) :");
    if(!pin) return;

    const h = await sha256(pin);
    if(h !== stored){
      alert("‚ùå ŸÉŸÑŸÖÿ© ÿßŸÑÿ≥ÿ± ÿÆÿßÿ∑ÿ¶ÿ© / Mot de passe incorrect");
      return;
    }

    const ok = confirm("‚ö†Ô∏è ÿ≥Ÿäÿ™ŸÖ ŸÖÿ≥ÿ≠ ŸÉŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ© ŸÖŸÜ Ÿáÿ∞ÿß ÿßŸÑÿ¨Ÿáÿßÿ≤ ŸÅŸÇÿ∑.\nLocalStorage + IndexedDB (StellantisTrackerDB)\n\nŸáŸÑ ÿ™ÿ±ŸäÿØ ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ©ÿü / Continuer ?");
    if(!ok) return;

    // 1) Disconnect online (si ŸÖŸàÿ¨ŸàÿØ)
    try{ if(typeof disconnectOnline === "function") await disconnectOnline(); }catch(e){}

    // 2) Clear Safe Storage + localStorage (si possible)
    try{ if(LS && typeof LS.clear === "function") LS.clear(); }catch(e){}
    try{ localStorage.clear(); }catch(e){}

    // 3) Delete IndexedDB
    try{
      await new Promise((res)=>{
        const req = indexedDB.deleteDatabase("StellantisTrackerDB");
        req.onsuccess = ()=>res();
        req.onerror = ()=>res();
        req.onblocked = ()=>res();
      });
    }catch(e){}

    // 4) Clear Cache Storage (si ŸäŸàÿ¨ÿØ Service Worker)
    try{
      if("caches" in window){
        const ks = await caches.keys();
        await Promise.all(ks.map(k=>caches.delete(k)));
      }
    }catch(e){}

    alert("‚úÖ ÿ™ŸÖ ÿßŸÑŸÖÿ≥ÿ≠. ÿ≥Ÿäÿ™ŸÖ ÿ•ÿπÿßÿØÿ© ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ© ÿßŸÑÿ¢ŸÜ.");
    location.reload();
  }

  function bind(){
    const el = getTitleEl();
    el.addEventListener("mousedown", startHold);
    el.addEventListener("touchstart", startHold, {passive:true});
    ["mouseup","mouseleave","touchend","touchcancel"].forEach(ev=> el.addEventListener(ev, cancelHold));

    // Visible button: Reset (PIN)
    const btn = document.getElementById("secretResetBtn");
    if(btn){
      btn.addEventListener("click", (e)=>{ e.preventDefault(); openReset(); });
    }

    // Expose for debugging (optional)
    window.openSecretReset = openReset;
  }

  if(document.readyState === "loading") document.addEventListener("DOMContentLoaded", bind);
  else bind();
})();


// Auto-init Realtime Collab
try{
  if(document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", ()=>{ try{ window.initRealtimeCollabUI(); }catch(e){} });
  }else{
    try{ window.initRealtimeCollabUI(); }catch(e){}
  }
}catch(e){}
</script>


<script>
/* ===== STOP_ALARMS_ONLY (Firebase rooms/<room>/stations) ===== */
(function(){
  function isFirebaseReady(){
    return !!(window.onlineConnected && window.onlineMode === 'firebase' && window.onlineFirebaseDb && window.onlineFirebaseRoom);
  }
  function getRoom(){
    return (window.onlineFirebaseRoom || (document.getElementById('onlineRoom')?.value||'')).toString().trim();
  }
  function beepOnce(){
    try{
      const Ctx = window.AudioContext || window.webkitAudioContext;
      if(!Ctx) return;
      const ctx = new Ctx();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = 'square';
      o.frequency.value = 880;
      g.gain.value = 0.04;
      o.connect(g); g.connect(ctx.destination);
      o.start();
      setTimeout(()=>{ try{o.stop();}catch(e){} try{ctx.close();}catch(e){} }, 220);
    }catch(e){}
  }
  let loopTimer=null;
  function startLoop(){ stopLoop(); loopTimer=setInterval(()=>beepOnce(), 600); }
  function stopLoop(){ if(loopTimer){ clearInterval(loopTimer); loopTimer=null; } }
  function popup(title, body){
    try{ if(document.getElementById('stopAlarmPopupToggle')?.checked) alert(title + "\n" + body); }catch(e){}
  }

  let ref=null, attachedRoom=null;
  let initialDone=false;
  let lastState={};

  function detach(){
    try{ if(ref) ref.off(); }catch(e){}
    ref=null; attachedRoom=null; initialDone=false; lastState={};
    stopLoop();
  }

  function attach(){
    if(!isFirebaseReady()) return;
    const room=getRoom();
    if(!room) return;
    if(ref && attachedRoom===room) return;

    detach();
    attachedRoom=room;
    ref = window.onlineFirebaseDb.ref(`rooms/${room}/stations`);
    ref.on('value',(snap)=>{
      const stations = snap.val() || {};
      let activeStops=0;
      const current={};
      Object.keys(stations).forEach((sid)=>{
        const st=stations[sid]||{};
        const s=(st.status||'UNKNOWN').toString().toUpperCase();
        const norm = (s==='STOP'||s==='RUN') ? s : 'UNKNOWN';
        current[sid]=norm;
        if(norm==='STOP') activeStops++;
      });

      // Pivot
      const pv=document.getElementById('pivotStopsCount');
      if(pv) pv.textContent=String(activeStops);
      const piv=document.getElementById('pivotStopsIndicator');
      if(piv) piv.style.display = activeStops>0 ? 'block' : 'none';

      // First snapshot: no alarm
      if(!initialDone){
        lastState=current;
        initialDone=true;
        return;
      }

      const alarmEnabled = document.getElementById('stopAlarmToggle')?.checked ?? true;
      const loopEnabled  = document.getElementById('stopAlarmLoopToggle')?.checked ?? false;

      if(alarmEnabled){
        for(const sid of Object.keys(current)){
          if(current[sid]==='STOP' && (lastState[sid]||'UNKNOWN')!=='STOP'){
            beepOnce();
            setTimeout(beepOnce, 260);
            popup('üö® STOP ÿ¨ÿØŸäÿØ', `Station: ${sid}`);
            if(loopEnabled) startLoop();
          }
        }
      }

      if(activeStops===0) stopLoop();
      lastState=current;
    });
  }

  document.addEventListener('click',(e)=>{
    if(e.target && e.target.id==='stopAlarmStopBtn') stopLoop();
  }, true);

  // ticker
  if(!window.__stopAlarmsTicker){
    window.__stopAlarmsTicker=setInterval(()=>{
      try{ if(isFirebaseReady()) attach(); else detach(); }catch(e){}
    }, 1200);
  }
})();
</script>

<!-- ===== DEFECTS_MODAL_V1: Module D√©fauts (Qualit√©) + CSV ÿßŸÑŸäŸàŸÖ ===== -->
<div id="defectsFabBtn" style="position:fixed; left:14px; bottom:14px; z-index:9999; cursor:pointer;
  padding:10px 12px; border-radius:999px; background:rgba(255,215,0,0.18); border:1px solid rgba(255,215,0,0.55);
  color:#FFD700; font-weight:900; box-shadow:0 10px 25px rgba(0,0,0,0.35); user-select:none;">
  üß© D√©fauts
</div>

<div id="defectsModal" style="display:none; position:fixed; inset:0; z-index:10050; background:rgba(0,0,0,0.62);">
  <div style="max-width:760px; margin:6vh auto; padding:16px; background:rgba(15,23,42,0.98); border:1px solid rgba(255,255,255,0.16); border-radius:16px;">
    <div style="display:flex; justify-content:space-between; gap:10px; align-items:center; flex-wrap:wrap;">
      <div style="font-weight:900; color:#FFD700; font-size:16px;">üß© SUIVI DES D√âFAUTS (Qualit√©) ‚Äî CSV ÿßŸÑŸäŸàŸÖ ŸÅŸÇÿ∑</div>
      <div style="display:flex; gap:8px; align-items:center;">
        <div style="font-size:12px; color:#9aa4b2; font-weight:800;">Date: <span id="defectsTodayLbl">-</span></div>
        <button id="defectsCloseBtn" class="btn" style="padding:7px 10px;">‚úñ</button>
      </div>
    </div>

    <div style="margin-top:10px; font-size:12px; color:#9aa4b2; line-height:1.6;">
      ÿßŸÉÿ™ÿ® ÿßŸÑÿπŸäÿ® + <b>Traitement</b> (ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°/ÿßŸÑÿ≠ŸÑ). ÿ´ŸÖ ŸäŸÖŸÉŸÜŸÉ ÿ•ÿÆÿ±ÿßÿ¨ <b>CSV ŸÑŸÑŸäŸàŸÖ ÿßŸÑÿ≠ÿßŸÑŸä ŸÅŸÇÿ∑</b>.
    </div>

    <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-top:12px;">
      <input id="defStation" type="text" placeholder="Station (ex: P100)" style="min-width:140px; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.18); background:rgba(0,0,0,0.18); color:#e0e1dd;">
      <input id="defZone" type="text" placeholder="Zone/Ligne (ex: LIGNE-1-A)" style="min-width:180px; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.18); background:rgba(0,0,0,0.18); color:#e0e1dd;">
      <button id="defCopyFromRoomBtn" class="btn" style="padding:10px 12px;">üìå Copier Poste/Zone</button>
    </div>

    <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-top:10px;">
      <select id="defCategory" style="min-width:210px; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.18); background:rgba(0,0,0,0.18); color:#e0e1dd;">
        <option value="">Cat√©gorie</option>
        <option value="Mode op√©rateur">Mode op√©rateur</option>
        <option value="D√©faut peinture">D√©faut peinture</option>
        <option value="D√©faut ferrage">D√©faut ferrage</option>
        <option value="Autres">Autres</option>
      </select>
      <input id="defTitle" type="text" placeholder="D√©faut (ex: Rayure / Manque point / Mauvais serrage...)" style="min-width:260px; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.18); background:rgba(0,0,0,0.18); color:#e0e1dd;">
    </div>

    <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-top:10px;">
      <select id="defStatus" style="min-width:170px; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.18); background:rgba(0,0,0,0.18); color:#e0e1dd;">
        <option value="Ouvert">Ouvert</option>
        <option value="En cours">En cours</option>
        <option value="R√©solu">R√©solu</option>
      </select>
      <input id="defAuthor" type="text" placeholder="Auteur (optionnel)" style="min-width:210px; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.18); background:rgba(0,0,0,0.18); color:#e0e1dd;">
      <select id="defQuick" style="min-width:220px; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.18); background:rgba(0,0,0,0.18); color:#e0e1dd;">
        <option value="">Traitement rapide (option)</option>
        <option>Retouche</option>
        <option>Reprise</option>
        <option>R√©glage machine</option>
        <option>Appel maintenance</option>
        <option>Changer outil</option>
        <option>Contr√¥le renforc√©</option>
        <option>Blocage / Arr√™t ligne</option>
      </select>
    </div>

    <textarea id="defTreatment" rows="3" placeholder="Traitement / Action / Solution √©crite (obligatoire)" style="width:100%; box-sizing:border-box; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.18); background:rgba(0,0,0,0.18); color:#e0e1dd; margin-top:10px;"></textarea>

    <button id="defAddBtn" class="btn" style="margin-top:10px; width:100%; padding:12px; background:rgba(255,215,0,0.16); border:1px solid rgba(255,215,0,0.45); font-weight:900;">‚ûï Enregistrer d√©faut</button>

    <div class="button-group-2" style="margin-top:10px;">
      <button id="defCsvBtn">üìÑ Export D√©fauts CSV (Aujourd'hui)</button>
      <button id="defShareBtn">üì§ Partager CSV (Aujourd'hui)</button>
    </div>

    <div style="margin-top:10px; font-weight:900; text-align:center; color:#FFD700;">
      üìã D√©fauts ‚Äì Aujourd'hui : <span id="defectsRoomLbl">-</span>
      <span style="color:#9aa4b2; font-size:11px; font-weight:700;">(Room)</span>
    </div>

    <div style="overflow:auto; margin-top:8px; border-radius:12px; border:1px solid rgba(255,255,255,0.10); max-height:38vh;">
      <table style="width:100%; border-collapse:collapse; font-size:12px;">
        <thead>
          <tr style="background:rgba(0,0,0,0.20);">
            <th style="padding:8px; text-align:left;">Heure</th>
            <th style="padding:8px; text-align:left;">Station</th>
            <th style="padding:8px; text-align:left;">Cat√©gorie</th>
            <th style="padding:8px; text-align:left;">D√©faut</th>
            <th style="padding:8px; text-align:left;">Statut</th>
            <th style="padding:8px; text-align:left;">Traitement</th>
            <th style="padding:8px; text-align:left;">Auteur</th>
          </tr>
        </thead>
        <tbody id="defectsBody"></tbody>
      </table>
    </div>

    <div style="margin-top:10px; font-size:11px; color:#9aa4b2; line-height:1.6;">
      üí° <b>Traitement</b> ÿßŸÑŸÖŸÇÿ™ÿ±ÿ≠: 1) Action imm√©diateÿå 2) Cause probableÿå 3) Contre-mesureÿå 4) Qui/Quand.
    </div>
  </div>
</div>

<script>
// ===== DEFECTS_MODAL_V1 logic =====
(function(){
  function pad2(n){ return String(n).padStart(2,'0'); }
  function todayKey(){
    const d = new Date();
    return d.getFullYear() + '-' + pad2(d.getMonth()+1) + '-' + pad2(d.getDate());
  }
  function timeHHMM(){
    const d = new Date();
    return pad2(d.getHours()) + ':' + pad2(d.getMinutes());
  }
  function safeStr(s){ return (s||'').toString().replace(/[\r\n]+/g,' ').replace(/"/g,'""').trim(); }
const fab = document.getElementById('defectsFabBtn');
  const modal = document.getElementById('defectsModal');
  const closeBtn = document.getElementById('defectsCloseBtn');
  const lblDate = document.getElementById('defectsTodayLbl');
  const lblRoom = document.getElementById('defectsRoomLbl');

  const inpStation = document.getElementById('defStation');
  const inpZone = document.getElementById('defZone');
  const selCat = document.getElementById('defCategory');
  const inpTitle = document.getElementById('defTitle');
  const selStatus = document.getElementById('defStatus');
  const inpAuthor = document.getElementById('defAuthor');
  const selQuick = document.getElementById('defQuick');
  const inpTreat = document.getElementById('defTreatment');
  const btnAdd = document.getElementById('defAddBtn');
  const btnCsv = document.getElementById('defCsvBtn');
  const btnShare = document.getElementById('defShareBtn');
  const btnCopy = document.getElementById('defCopyFromRoomBtn');
  const tbody = document.getElementById('defectsBody');

  let defectsMap = {}; // id -> obj
  let fbRef = null;
  let fbListener = null;

  function currentRoom(){
    // Try onlineFirebaseRoom (when connected) else input value
    try {
      if (window.onlineMode === 'firebase' && window.onlineConnected && window.onlineFirebaseRoom) return String(window.onlineFirebaseRoom);
    } catch(_) {}
    const v = document.getElementById('onlineRoom')?.value;
    return (v||'').trim();
  }

  function cacheKey(room, date){ return 'DEFECTS_CACHE_' + (room||'') + '_' + date; }

  function openModal(){
    const tk = todayKey();
    lblDate.textContent = tk;
    const r = currentRoom() || '-';
    lblRoom.textContent = r;
    modal.style.display = 'block';
    // auto start listener
    startListener();
  }
  function closeModal(){ modal.style.display = 'none'; }

  function notify(msg, type){
    if (window.showNotification) window.showNotification(msg, type || 'info');
    else alert(msg);
  }

  function render(){
    const items = Object.values(defectsMap).sort((a,b)=> (a.ts||0) - (b.ts||0));
    tbody.innerHTML = '';
    for (const it of items){
      const tr = document.createElement('tr');
      tr.innerHTML = '<td style="padding:8px; border-top:1px solid rgba(255,255,255,0.06);">'+safeStr(it.time)+'</td>'+
        '<td style="padding:8px; border-top:1px solid rgba(255,255,255,0.06);">'+safeStr(it.station)+'</td>'+
        '<td style="padding:8px; border-top:1px solid rgba(255,255,255,0.06);">'+safeStr(it.category)+'</td>'+
        '<td style="padding:8px; border-top:1px solid rgba(255,255,255,0.06);">'+safeStr(it.title)+'</td>'+
        '<td style="padding:8px; border-top:1px solid rgba(255,255,255,0.06);">'+safeStr(it.status)+'</td>'+
        '<td style="padding:8px; border-top:1px solid rgba(255,255,255,0.06); white-space:pre-wrap;">'+safeStr(it.treatment)+'</td>'+
        '<td style="padding:8px; border-top:1px solid rgba(255,255,255,0.06);">'+safeStr(it.author)+'</td>';
      tbody.appendChild(tr);
    }
  }

  function loadLocal(room, date){
    try {
      const LS = window.LS || window.localStorage;
      const raw = LS.getItem(cacheKey(room,date));
      if (!raw) { defectsMap = {}; render(); return; }
      const arr = JSON.parse(raw);
      defectsMap = { };
      for (const o of (arr||[])){
        if (!o || !o.id) continue;
        defectsMap[o.id] = o;
      }
      render();
    } catch(e){
      console.error(e);
      defectsMap = {}; render();
    }
  }

  function saveLocal(room, date){
    try {
      const LS = window.LS || window.localStorage;
      const arr = Object.values(defectsMap);
      LS.setItem(cacheKey(room,date), JSON.stringify(arr));
    } catch(e){ console.error(e); }
  }

  function stopListener(){
    try {
      if (fbRef && fbListener) fbRef.off('value', fbListener);
    } catch(e){}
    fbRef = null; fbListener = null;
  }

  function startListener(){
    const room = currentRoom();
    const date = todayKey();

    // Always show local as fallback
    loadLocal(room, date);

    // Firebase listener if connected
    try {
      if (window.onlineMode === 'firebase' && window.onlineConnected && window.onlineFirebaseDb && room){
        stopListener();
        fbRef = window.onlineFirebaseDb.ref('rooms/' + room + '/defectsByDate/' + date);
        fbListener = (snap)=>{
          const v = snap.val() || {};
          defectsMap = {};
          Object.keys(v).forEach((k)=>{
            const o = v[k];
            if (!o) return;
            o.id = k;
            defectsMap[k] = o;
          });
          saveLocal(room, date);
          render();
        };
        fbRef.on('value', fbListener);
      }
    } catch(e){ console.error(e); }
  }

  function addDefect(){
    const room = currentRoom();
    const date = todayKey();

    const station = (inpStation.value||'').trim();
    const zone = (inpZone.value||'').trim();
    const category = (selCat.value||'').trim();
    const title = (inpTitle.value||'').trim();
    const status = (selStatus.value||'Ouvert').trim();
    const author = (inpAuthor.value||'').trim();
    const treatment = (inpTreat.value||'').trim();

    if (!room){ notify('‚ùå ÿßŸÉÿ™ÿ® Room ÿ´ŸÖ Connect', 'error'); return; }
    if (!category){ notify('‚ö†Ô∏è ÿßÿÆÿ™ÿ± Cat√©gorie', 'warning'); return; }
    if (!title){ notify('‚ö†Ô∏è ÿßŸÉÿ™ÿ® D√©faut', 'warning'); return; }
    if (!treatment){ notify('‚ö†Ô∏è ÿßŸÉÿ™ÿ® Traitement (ÿ≠ŸÑ/ÿ•ÿ¨ÿ±ÿßÿ°)', 'warning'); return; }

    const obj = {
      date: date,
      time: timeHHMM(),
      ts: Date.now(),
      room: room,
      station: station,
      zone: zone,
      category: category,
      title: title,
      status: status,
      treatment: treatment,
      author: author,
      uid: (window.onlineFirebaseUid||''),
      user: (window.onlineFirebaseUser||'')
    };

    // Local id
    const localId = 'L' + String(Date.now()) + '_' + Math.random().toString(16).slice(2,8);
    obj.id = localId;

    // Optimistic local render
    defectsMap[localId] = obj;
    saveLocal(room, date);
    render();

    // Push to Firebase if possible
    try {
      if (window.onlineMode === 'firebase' && window.onlineConnected && window.onlineFirebaseDb){
        const ref = window.onlineFirebaseDb.ref('rooms/' + room + '/defectsByDate/' + date).push();
        const fid = ref.key;
        obj.id = fid;
        // Write without the temp localId; Firebase will re-render via listener
        const toWrite = dict(obj); toWrite.pop('id', None)
      }
    } catch(e){}
  }

  function dict(o){ return Object.assign({}, o); }

  async function pushFirebase(room, date, obj){
    const ref = window.onlineFirebaseDb.ref('rooms/' + room + '/defectsByDate/' + date).push();
    const fid = ref.key;
    const payload = Object.assign({}, obj);
    delete payload.id;
    await ref.set(payload);
    return fid;
  }

  async function addDefectFirebaseSafe(){
    const room = currentRoom();
    const date = todayKey();

    const station = (inpStation.value||'').trim();
    const zone = (inpZone.value||'').trim();
    const category = (selCat.value||'').trim();
    const title = (inpTitle.value||'').trim();
    const status = (selStatus.value||'Ouvert').trim();
    const author = (inpAuthor.value||'').trim();
    const treatment = (inpTreat.value||'').trim();

    if (!room){ notify('‚ùå ÿßŸÉÿ™ÿ® Room ÿ´ŸÖ Connect', 'error'); return; }
    if (!category){ notify('‚ö†Ô∏è ÿßÿÆÿ™ÿ± Cat√©gorie', 'warning'); return; }
    if (!title){ notify('‚ö†Ô∏è ÿßŸÉÿ™ÿ® D√©faut', 'warning'); return; }
    if (!treatment){ notify('‚ö†Ô∏è ÿßŸÉÿ™ÿ® Traitement (ÿ≠ŸÑ/ÿ•ÿ¨ÿ±ÿßÿ°)', 'warning'); return; }

    const base = {
      date: date,
      time: timeHHMM(),
      ts: Date.now(),
      room: room,
      station: station,
      zone: zone,
      category: category,
      title: title,
      status: status,
      treatment: treatment,
      author: author,
      uid: (window.onlineFirebaseUid||''),
      user: (window.onlineFirebaseUser||'')
    };

    // If firebase connected, write then rely on listener
    if (window.onlineMode === 'firebase' && window.onlineConnected && window.onlineFirebaseDb){
      try {
        await pushFirebase(room, date, base);
        notify('‚úÖ D√©faut enregistr√©', 'success');
      } catch(e){
        console.error(e);
        // fallback local
        const id = 'L' + String(Date.now()) + '_' + Math.random().toString(16).slice(2,8);
        base.id = id;
        defectsMap[id] = base;
        saveLocal(room, date);
        render();
        notify('‚ö†Ô∏è D√©faut enregistr√© localement (Firebase refus√©)', 'warning');
      }
    } else {
      // local only
      const id = 'L' + String(Date.now()) + '_' + Math.random().toString(16).slice(2,8);
      base.id = id;
      defectsMap[id] = base;
      saveLocal(room, date);
      render();
      notify('‚úÖ D√©faut enregistr√© (local)', 'success');
    }

    // reset some fields
    inpTitle.value = '';
    inpTreat.value = '';
    selQuick.value = '';
  }

  function makeCsv(){
    const room = currentRoom();
    const date = todayKey();
    const items = Object.values(defectsMap).sort((a,b)=> (a.ts||0) - (b.ts||0));
    let csv = 'Date,Heure,Station,Zone,Categorie,Defaut,Statut,Traitement,Auteur,Room,UID\n';
    for (const it of items){
      csv += [
        safeStr(date),
        safeStr(it.time),
        safeStr(it.station),
        safeStr(it.zone),
        safeStr(it.category),
        safeStr(it.title),
        safeStr(it.status),
        safeStr(it.treatment),
        safeStr(it.author),
        safeStr(room),
        safeStr(it.uid)
      ].map(v => '"' + v + '"').join(',') + '\n';
    }
    return {csv, date, room};
  }

  function downloadCsv(){
    const o = makeCsv();
    const blob = new Blob([o.csv], {type:'text/csv;charset=utf-8'});
    const a = document.createElement('a');
    const name = 'Defauts_' + (o.room||'ROOM') + '_' + o.date + '.csv';
    a.href = URL.createObjectURL(blob);
    a.download = name;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 800);
  }

  async function shareCsv(){
    const o = makeCsv();
    const name = 'Defauts_' + (o.room||'ROOM') + '_' + o.date + '.csv';
    const blob = new Blob([o.csv], {type:'text/csv;charset=utf-8'});

    try {
      if (navigator.share && window.File){
        const file = new File([blob], name, {type:'text/csv'});
        await navigator.share({ title: 'Rapport D√©fauts (Aujourd\'hui)', text: 'Rapport CSV - ' + o.date, files: [file] });
        return;
      }
    } catch(e){
      console.warn('share failed', e);
    }

    // fallback
    downloadCsv();
  }

  function copyFromRealtime(){
    // Try existing fields in page: station / room
    const room = currentRoom();
    if (room) inpZone.value = room;

    // Some pages have selected station input
    const st = document.getElementById('stationSelect')?.value || document.getElementById('station')?.value || '';
    if (st) inpStation.value = st;
  }

  // Events
  fab?.addEventListener('click', openModal);
  closeBtn?.addEventListener('click', closeModal);
  modal?.addEventListener('click', (e)=>{ if (e.target === modal) closeModal(); });

  selQuick?.addEventListener('change', ()=>{
    const v = (selQuick.value||'').trim();
    if (!v) return;
    const cur = (inpTreat.value||'').trim();
    inpTreat.value = cur ? (cur + '\n- ' + v) : ('- ' + v);
    selQuick.value = '';
  });

  btnAdd?.addEventListener('click', ()=>{ addDefectFirebaseSafe(); });
  btnCsv?.addEventListener('click', downloadCsv);
  btnShare?.addEventListener('click', shareCsv);
  btnCopy?.addEventListener('click', copyFromRealtime);

  // keep labels in sync
  setInterval(()=>{
    const tk = todayKey();
    if (lblDate.textContent !== tk) lblDate.textContent = tk;
    const r = currentRoom() || '-';
    if (lblRoom.textContent !== r) lblRoom.textContent = r;
  }, 1500);

})();
</script>
<script id="__top_shortcuts_script">
(function(){
  function scrollToId(id){
    var el = document.getElementById(id);
    if(!el) return;
    el.scrollIntoView({behavior:'smooth', block:'start'});
  }
  function goDefauts(){
    var openBtn = document.getElementById('openDefectsBtn');
    if(openBtn){ openBtn.click(); return; }
    var modal = document.getElementById('defectsModal');
    if(modal){ modal.style.display='block'; }
    scrollToId('defectsModal');
  }
  window.addEventListener('DOMContentLoaded', function(){
    var bDef = document.getElementById('topBtnDefauts');
    if(bDef) bDef.addEventListener('click', goDefauts);
  });
})();
</script>
<style>
    /* 1. ESPACE EN BAS */
    body { padding-bottom: 120px !important; }

    /* 2. DOCK FIXE */
    #appDock {
        position: fixed; bottom: 0; left: 0; width: 100%; height: 70px;
        background: #1a1a1a; border-top: 3px solid #1A7DFF;
        display: flex; justify-content: space-around; align-items: center;
        z-index: 999999; box-shadow: 0 -5px 15px rgba(0,0,0,0.5);
    }
    .dock-item {
        display: flex; flex-direction: column; align-items: center;
        justify-content: center; color: #aaa; cursor: pointer;
        font-family: sans-serif; font-size: 11px; width: 18%; height: 100%;
    }
    .dock-item span.icon { font-size: 24px; margin-bottom: 3px; }
    .dock-item:active { background: #333; color: white; }

    /* 3. POPUP CAMERA PRO */
    #camPopupPanel {
        display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: #111; border: 2px solid #fff; border-radius: 12px; padding: 10px;
        z-index: 1000000; text-align: center; box-shadow: 0 0 30px rgba(0,0,0,0.9);
        width: 95%; max-width: 380px; color: white; font-family: sans-serif;
        max-height: 90vh; overflow-y: auto; /* Scroll si trop petit */
    }

    /* Selecteur Mode */
    #modeSelector {
        width: 100%; padding: 10px; margin-bottom: 5px;
        background: #333; color: white; border: 1px solid #1A7DFF;
        border-radius: 6px; font-weight: bold; font-size: 14px; cursor: pointer;
    }

    /* Zone Vid√©o */
    .video-container { position: relative; width: 100%; height: 200px; background: black; margin-bottom: 5px; overflow: hidden; border-radius: 6px; }
    #camVideo { width: 100%; height: 100%; object-fit: cover; }
    
    /* Le Carr√© de D√©tection (Ajustable) */
    #detectionZone {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        width: 100px; height: 100px; /* Valeur par d√©faut */
        border: 3px dashed #00ff00; 
        box-shadow: 0 0 10px rgba(0,255,0,0.3);
        display: flex; justify-content: center; align-items: center;
        font-size: 20px; transition: width 0.1s, height 0.1s;
    }

    /* Infos */
    .status-text { font-size: 12px; margin: 5px 0; font-weight: bold; color:#aaa; min-height:18px;}
    

    /* Ajouts visuels (Cycle / Arr√™t cha√Æne) */
    .cam-big-state{
        font-size:16px;font-weight:900;text-align:center;
        padding:10px 8px;border-radius:12px;margin:8px 0 6px;
        border:1px solid #444;background: rgba(0,0,0,0.35);
        letter-spacing:.2px;
    }
    .cam-big-state.state-veh{ border-color: rgba(40,167,69,0.65); box-shadow: 0 0 18px rgba(40,167,69,0.18); }
    .cam-big-state.state-vide{ border-color: rgba(23,162,184,0.70); box-shadow: 0 0 18px rgba(23,162,184,0.18); }
    .cam-big-state.state-wait{ border-color: rgba(26,125,255,0.65); box-shadow: 0 0 18px rgba(26,125,255,0.18); }
    .cam-big-state.state-stop{ border-color: rgba(220,53,69,0.85); box-shadow: 0 0 22px rgba(220,53,69,0.22); }

    .timer-row{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .timer-side{ font-size:11px; color:#bbb; min-width:78px; text-align:right; }
    .pct-pill{
        display:inline-block; font-weight:900; font-size:12px;
        padding:3px 8px; border-radius:999px; border:1px solid #444; background:#1b1b1b;
    }
    .cycle-target{ margin-top:2px; font-size:10px; color:#999; }

    .idle-timer{
        margin:6px 0 2px; font-size:12px; font-weight:900; text-align:center;
        padding:7px 8px; border-radius:12px; border:1px dashed #555; color:#ddd; background:#1a1a1a;
    }
.big-timer {
        font-size: 42px;
        font-weight: 800;
        text-align: center;
        padding: 10px 12px;
        margin: 8px 0 10px;
        border-radius: 12px;
        background: rgba(0,0,0,0.35);
        border: 1px solid rgba(255,255,255,0.18);
        letter-spacing: 1px;
        font-variant-numeric: tabular-nums;
    }


    /* Couleurs du timer (visuel) */
    .big-timer.timer-ok{ color:#d7ffe0; border-color: rgba(40,167,69,0.55); box-shadow: 0 0 18px rgba(40,167,69,0.18); }
    .big-timer.timer-warn{ color:#fff3d6; border-color: rgba(255,193,7,0.65); box-shadow: 0 0 18px rgba(255,193,7,0.18); }
    .big-timer.timer-danger{ color:#ffe0e0; border-color: rgba(220,53,69,0.70); box-shadow: 0 0 22px rgba(220,53,69,0.20); }
    .big-timer.timer-over{ color:#ffe0e0; border-color: rgba(220,53,69,0.95); box-shadow: 0 0 26px rgba(220,53,69,0.35); animation: timerPulse 0.9s ease-in-out infinite; }
    @keyframes timerPulse{ 0%{ transform: scale(1.00); filter: brightness(1.0);} 50%{ transform: scale(1.02); filter: brightness(1.15);} 100%{ transform: scale(1.00); filter: brightness(1.0);} }
    #cycleProgress { width: 100%; height: 8px; background: #333; margin: 5px 0; border-radius: 4px; overflow: hidden; display:none; }
    #cycleBar { width: 0%; height: 100%; background: #28a745; transition: width 0.5s linear; }

    /* Grille de r√©glages */
    .control-group { background: #222; padding: 8px; border-radius: 6px; border: 1px solid #444; margin-bottom: 5px; }
    .control-label { font-size: 11px; color: #1A7DFF; font-weight: bold; margin-bottom: 5px; text-align: left; display:block; border-bottom:1px solid #444; padding-bottom:2px;}
    
    .settings-flex { display: flex; gap: 5px; justify-content: space-between; align-items: flex-end; }
    .setting-col { width: 48%; }
    .setting-col label { font-size: 9px; color: #ccc; display:block; }
    .setting-col input[type=number] { width: 100%; background: #333; color: white; border: 1px solid #555; text-align: center; padding: 4px; border-radius: 4px; }
    .setting-col input[type=range] { width: 100%; cursor: pointer; }

    /* Boutons */
    .btn-action { width: 100%; padding: 10px; margin-top: 5px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; color: white;}
    
    .mode-hide { display: none !important; }
</style>

<div id="appDock">
    <div class="dock-item" onclick="openCamPanel()">
        <span class="icon">üì∑</span><span>Cam√©ra</span>
    </div>
    <div class="dock-item" onclick="openPauseConfig()">
        <span class="icon">‚öôÔ∏è</span><span>Pauses</span>
    </div>
    <div class="dock-item" onclick="window.open('https://www.google.com', '_blank')">
        <span class="icon">üåê</span><span>Google</span>
    </div>
    <div class="dock-item" onclick="scrollToChat()">
        <span class="icon">üí¨</span><span>Chat</span>
    </div>
    <div class="dock-item" onclick="scrollToDefect()">
        <span class="icon">üõ†Ô∏è</span><span>D√©faut</span>
    </div>
</div>

<div id="camPopupPanel">
    
    <select id="modeSelector" onchange="switchMode()">
        <option value="RED">üî¥ Mode : LED Rouge</option>
        <option value="CYCLE">‚è±Ô∏è Mode : Temps de Cycle</option>
    </select>

    <div class="video-container">
        <video id="camVideo" autoplay playsinline muted></video>
        <div id="detectionZone">+</div>
        <canvas id="camCanvas" style="display:none;"></canvas>
    </div>

    
    <div class="cam-big-state" id="camBigState">‚è±Ô∏è Temps de Cycle</div>
    <div class="status-text" id="camStatus">En attente...</div>
    <div class="timer-row mode-cycle-only">
        <div class="big-timer timer-ok" id="camTimerDisplay">00:00:00</div>
        <div class="timer-side">
            <div class="pct-pill" id="cyclePctDisplay">0%</div>
            <div class="cycle-target" id="cycleTargetTxt">/ 0s</div>
        </div>
    </div>
    <div class="idle-timer mode-cycle-only" id="idleTimerDisplay" style="display:none;">Attente: 00:00</div>
    <div id="cycleProgress" class="mode-cycle-only"><div id="cycleBar"></div></div>

    <div class="control-group">
        <span class="control-label">üìè Forme Zone (Taille)</span>
        <div class="settings-flex">
            <div class="setting-col">
                <label>Largeur</label>
                <input type="range" id="zoneW" min="20" max="300" value="100" oninput="updateZoneUI()">
            </div>
            <div class="setting-col mode-cycle-only">
                <label>Auto recalib (s)</label>
                <input type="number" id="autoRecalibSec" value="0" min="0">
            </div>
            <div class="setting-col">
                <label>Hauteur</label>
                <input type="range" id="zoneH" min="20" max="200" value="100" oninput="updateZoneUI()">
            </div>
        </div>
    </div>

    <div class="control-group">
        <span class="control-label">‚ö° Param√®tres</span>
        <div class="settings-flex">
            <div class="setting-col mode-cycle-only">
                <label>Cycle (s)</label>
                <input type="number" id="targetCycle" value="30">
            </div>
            <div class="setting-col mode-cycle-only">
                <label>Gap (s)</label>
                <input type="number" id="gapTime" value="20">
            </div>
            <div class="setting-col mode-cycle-only">
                <label>Arr√™t cha√Æne (s)</label>
                <input type="number" id="idleLimitSec" value="300" min="0">
            </div>
            <div class="setting-col">
                <label>Sensibilit√©</label>
                <input type="number" id="sensibility" value="30">
            </div>
        </div>
    </div>

    <div class="control-group">
        <span class="control-label">üîä Volume Alarme</span>
        <input type="range" id="volRange" min="0" max="1" step="0.1" value="1" style="width:100%;">
    </div>

    <button id="btnCalib" class="btn-action mode-cycle-only" style="background:#17a2b8;" onclick="calibrateEmpty()">üéØ CALIBRER VIDE</button>
    <button class="btn-action" style="background:#dc3545;" onclick="closeCamPanel()">Fermer</button>
</div>

<div id="pauseConfigModal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#222; border:2px solid #fff; border-radius:12px; padding:10px; z-index:1000000; width:95%; max-width:350px; color:white; font-family:sans-serif;">
    <button onclick="document.getElementById('pauseConfigModal').style.display='none'" style="float:right; background:none; border:none; color:#aaa; font-size:18px;">√ó</button>
    <h3 style="text-align:center; color:#2196f3; margin:0 0 10px 0;">‚è∞ Pauses Auto</h3>
    <div style="max-height: 350px; overflow-y: auto;">
        <div class="shift-box" id="box_Matin" style="background:#252525; padding:8px; margin-bottom:5px; border-radius:5px; border:1px solid #444;"><h4>‚òÄÔ∏è Matin</h4>
            <div class="pause-row" style="display:flex; gap:5px; margin-bottom:5px;"><input type="time" id="pm_1_s" style="background:black; color:white; border:1px solid #555;"><input type="time" id="pm_1_e" style="background:black; color:white; border:1px solid #555;"></div>
            <div class="pause-row" style="display:flex; gap:5px; margin-bottom:5px;"><input type="time" id="pm_2_s" style="background:black; color:white; border:1px solid #555;"><input type="time" id="pm_2_e" style="background:black; color:white; border:1px solid #555;"></div>
            <div class="pause-row" style="display:flex; gap:5px; margin-bottom:5px;"><input type="time" id="pm_3_s" style="background:black; color:white; border:1px solid #555;"><input type="time" id="pm_3_e" style="background:black; color:white; border:1px solid #555;"></div>
        </div>
        <div class="shift-box" id="box_ApresMidi" style="background:#252525; padding:8px; margin-bottom:5px; border-radius:5px; border:1px solid #444;">
            <h4>‚õÖ Apr√®s-midi</h4>
            <div class="pause-row" style="display:flex; gap:5px; margin-bottom:5px;"><input type="time" id="pa_1_s" style="background:black; color:white; border:1px solid #555;"><input type="time" id="pa_1_e" style="background:black; color:white; border:1px solid #555;"></div>
            <div class="pause-row" style="display:flex; gap:5px; margin-bottom:5px;"><input type="time" id="pa_2_s" style="background:black; color:white; border:1px solid #555;"><input type="time" id="pa_2_e" style="background:black; color:white; border:1px solid #555;"></div>
            <div class="pause-row" style="display:flex; gap:5px; margin-bottom:5px;"><input type="time" id="pa_3_s" style="background:black; color:white; border:1px solid #555;"><input type="time" id="pa_3_e" style="background:black; color:white; border:1px solid #555;"></div>
        </div>
        <div class="shift-box" id="box_Nuit" style="background:#252525; padding:8px; margin-bottom:5px; border-radius:5px; border:1px solid #444;">
            <h4>üåô Nuit</h4>
            <div class="pause-row" style="display:flex; gap:5px; margin-bottom:5px;"><input type="time" id="pn_1_s" style="background:black; color:white; border:1px solid #555;"><input type="time" id="pn_1_e" style="background:black; color:white; border:1px solid #555;"></div>
            <div class="pause-row" style="display:flex; gap:5px; margin-bottom:5px;"><input type="time" id="pn_2_s" style="background:black; color:white; border:1px solid #555;"><input type="time" id="pn_2_e" style="background:black; color:white; border:1px solid #555;"></div>
            <div class="pause-row" style="display:flex; gap:5px; margin-bottom:5px;"><input type="time" id="pn_3_s" style="background:black; color:white; border:1px solid #555;"><input type="time" id="pn_3_e" style="background:black; color:white; border:1px solid #555;"></div>
        </div>
    </div>
    <button onclick="savePauses()" style="width:100%; padding:10px; background:#28a745; color:white; border:none; margin-top:10px; border-radius:5px; font-weight:bold;">üíæ ENREGISTRER</button>
</div>

<script>
(function(){
    // --- NAVIGATION ---
    window.scrollToChat = () => window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    window.scrollToDefect = () => { const el = document.getElementById('cause') || document.body; el.scrollIntoView({ behavior: 'smooth', block: 'center' }); };

    // --- EXPORT AUTO ---
    setTimeout(() => {
        const t = document.getElementById('csvBtn'); if(!t || document.getElementById('wkE')) return;
        const d = new Date(); d.setHours(0,0,0,0); d.setDate(d.getDate()+3-(d.getDay()+6)%7);
        const w1 = new Date(d.getFullYear(),0,4);
        const curW = 1 + Math.round(((d.getTime()-w1.getTime())/86400000-3+(w1.getDay()+6)%7)/7);
        const div = document.createElement('div'); div.id='wkE';
        div.style.cssText="margin-top:8px;padding:6px;background:#e9ecef;border-radius:6px;display:flex;gap:5px;align-items:center;border:1px solid #ced4da;";
        div.innerHTML=`<span style="font-size:12px;font-weight:bold;color:#333;">üìÖ Sem:</span><input type="number" id="iW" value="${curW}" style="width:45px;padding:5px;text-align:center;font-weight:bold;color:#0056b3;border:1px solid #ccc;border-radius:4px;"><button id="bExp" style="flex:1;background:#17a2b8;color:white;border:none;border-radius:4px;font-size:11px;font-weight:bold;padding:6px;cursor:pointer;">üì• CSV</button>`;
        t.parentNode.insertBefore(div, t.nextSibling);
        document.getElementById('bExp').addEventListener('click', () => {
            const w=parseInt(document.getElementById('iW').value);
            const dt=(typeof history!=='undefined')?history:JSON.parse(localStorage.getItem("HISTO")||"[]");
            const flt=dt.filter(r=>{if(!r.date)return false;const rd=new Date(r.date);const rdn=new Date(Date.UTC(rd.getFullYear(),rd.getMonth(),rd.getDate()));rdn.setUTCDate(rdn.getUTCDate()+4-(rdn.getUTCDay()||7));const ys=new Date(Date.UTC(rdn.getUTCFullYear(),0,1));return Math.ceil((((rdn-ys)/86400000)+1)/7)===w;});
            if(flt.length===0){alert("Semaine "+w+" vide.");return;}
            let c="\uFEFFDate;Heure D√©but;Heure Fin;Dur√©e;Cause;√âquipe;TL\n";
            flt.forEach(r=>c+=`${r.date};${r.start};${r.end};${r.duration};"${(r.cause||'').replace(/"/g,'""')}";${r.equipe};${r.teamLeader||''}\n`);
            const a=document.createElement("a"); a.href=URL.createObjectURL(new Blob([c],{type:"text/csv;charset=utf-8;"})); a.download=`Semaine_${w}.csv`; document.body.appendChild(a); a.click(); document.body.removeChild(a);
        });
    }, 1000);

    // ==========================================
    // LOGIQUE CAMERA AVANC√âE
    // ==========================================
    let stream=null, intCam=null;
    // Variables Cycle
    let baselineData=null, isVeh=false, seenVehOnce=false, tStart=null, stopped=false, svTL="", videSince=null, vehSince=null, idleSince=null;
    const VEH_CONFIRM_SECONDS = 2; // anti faux d√©clenchements (1-2s)
    // Variables Rouge
    let rStart=null;
    
    const ui = {
        sel: document.getElementById('modeSelector'),
        v: document.getElementById('camVideo'),
        c: document.getElementById('camCanvas'),
        ctx: document.getElementById('camCanvas').getContext('2d'),
        zone: document.getElementById('detectionZone'),
        status: document.getElementById('camStatus'),
        state: document.getElementById('camBigState'),
        pct: document.getElementById('cyclePctDisplay'),
        tgtTxt: document.getElementById('cycleTargetTxt'),
        idleDisp: document.getElementById('idleTimerDisplay'),
        timer: document.getElementById('camTimerDisplay'),
        bar: document.getElementById('cycleBar'),
        prog: document.getElementById('cycleProgress'),
        cycEl: document.querySelectorAll('.mode-cycle-only'),
        vol: document.getElementById('volRange'),
        // Inputs Zone
        zW: document.getElementById('zoneW'),
        zH: document.getElementById('zoneH')
    };

    function setCamState(txt, cls){
        if(!ui.state) return;
        ui.state.textContent = txt || '';
        ui.state.classList.remove('state-veh','state-vide','state-wait','state-stop');
        if(cls) ui.state.classList.add(cls);
    }

    function fmtHMS(sec){
        sec = Math.max(0, Math.floor(sec));
        const h = Math.floor(sec/3600);
        const m = Math.floor((sec%3600)/60);
        const s = sec%60;
        return String(h).padStart(2,'0')+":"+String(m).padStart(2,'0')+":"+String(s).padStart(2,'0');
    }

    function fmtMS(sec){
        sec = Math.max(0, Math.floor(sec));
        const m = Math.floor(sec/60);
        const s = sec%60;
        return String(m).padStart(2,'0')+":"+String(s).padStart(2,'0');
    }


    // UI : Mise √† jour taille du carr√©
    window.updateZoneUI = function() {
        ui.zone.style.width = ui.zW.value + "px";
        ui.zone.style.height = ui.zH.value + "px";
    };

    window.switchMode = function() {
        const mode = ui.sel.value;
        if(mode === 'RED') {
            ui.cycEl.forEach(e => e.classList.add('mode-hide'));
            ui.status.innerText = "Mode Rouge : D√©tection couleur...";
            ui.zone.style.borderColor = "red";
            baselineData = null; 
        } else {
            ui.cycEl.forEach(e => e.classList.remove('mode-hide'));
            ui.timer.style.display = 'block';
            if(!ui.timer.innerText) ui.timer.innerText='00:00:00';
            ui.prog.style.display = 'block';
            ui.status.innerText = "Mode Cycle : Calibrez le vide svp.";
            ui.zone.style.borderColor = "#00ff00";
        }
    };

    window.openCamPanel = async function() {
        try {
            document.getElementById('camPopupPanel').style.display = 'block';
            updateZoneUI(); // Init taille
            switchMode();   // Init mode
            stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            ui.v.srcObject = stream;
            // D√©bloquer son
            const a = document.getElementById('alarm'); if(a){a.muted=true;a.play().then(()=>{a.pause();a.muted=false}).catch(()=>{});}
            intCam = setInterval(loop, 400);
        } catch(e) { alert("Erreur Cam: "+e); closeCamPanel(); }
    };

    window.closeCamPanel = function() {
        if(stream) stream.getTracks().forEach(t=>t.stop());
        clearInterval(intCam);
        stream = null;
        // Reset √©tats pour √©viter reprise avec ancienne logique
        baselineData = null;
        isVeh = false;
        seenVehOnce = false;
        tStart = null;
        videSince = null;
        vehSince = null;
        idleSince = null;
        rStart = null;
        stopped = false;
        svTL = "";
        // Stop alarme si en cours
        const a = document.getElementById('alarm');
        if(a){ try{ a.pause(); a.currentTime = 0; }catch(e){} }
        document.getElementById('camPopupPanel').style.display = 'none';
    };

    window.calibrateEmpty = function() {
        if(ui.v.readyState!==4)return;
        const w = parseInt(ui.zW.value);
        const h = parseInt(ui.zH.value);
        ui.c.width=w; ui.c.height=h;
        ui.ctx.drawImage(ui.v, (ui.v.videoWidth/2)-(w/2), (ui.v.videoHeight/2)-(h/2), w, h, 0, 0, w, h);
        baselineData = ui.ctx.getImageData(0,0,w,h).data;
        ui.status.innerText="‚úÖ Calibr√© ! En attente v√©hicule...";
        ui.status.style.color="#0f0";
    };

    function formatCamTime(sec){
        sec = Math.max(0, Math.floor(sec||0));
        const h = Math.floor(sec/3600);
        const m = Math.floor((sec%3600)/60);
        const s = sec%60;
        const hh = String(h).padStart(2,'0');
        const mm = String(m).padStart(2,'0');
        const ss = String(s).padStart(2,'0');
        return `${hh}:${mm}:${ss}`;
    }


    function loop() {
        if(ui.v.readyState!==4) return;
        const mode = ui.sel.value;
        const w = parseInt(ui.zW.value);
        const h = parseInt(ui.zH.value);
        const sens = parseInt(document.getElementById('sensibility').value)||30;

        // Capture la zone choisie
        ui.c.width=w; ui.c.height=h;
        ui.ctx.drawImage(ui.v, (ui.v.videoWidth/2)-(w/2), (ui.v.videoHeight/2)-(h/2), w, h, 0, 0, w, h);
        const data = ui.ctx.getImageData(0,0,w,h).data;

        if (mode === 'RED') {
            // --- MODE ROUGE ---
            let r=0,g=0,b=0,c=0;
            for(let i=0;i<data.length;i+=4){r+=data[i];g+=data[i+1];b+=data[i+2];c++;}
            r/=c; g/=c; b/=c;
            const isRed = (r>130 && r>(g*1.3) && r>(b*1.3)); 
            
            if(isRed) {
                ui.zone.style.borderColor="red"; ui.status.style.color="red";
                if(!rStart) { rStart=Date.now(); ui.status.innerText="‚ö†Ô∏è Rouge d√©tect√©..."; }
                else {
                    const d=(Date.now()-rStart)/1000; ui.status.innerText=`üî¥ ${d.toFixed(1)}s`;
                    if(d > 5) triggerStop("üî¥ Arr√™t LED Rouge");
                }
            } else {
                ui.zone.style.borderColor="#0f0"; ui.status.style.color="#0f0"; ui.status.innerText="üü¢ Surveillance LED...";
                if(rStart && stopped) triggerResume();
                rStart=null;
            }

        } else {
            // --- MODE CYCLE ---
            if(!baselineData || baselineData.length !== data.length) return; // Si taille change, recalibrer
            let diff=0;
            for(let i=0;i<data.length;i+=4){
                const d = (Math.abs(data[i]-baselineData[i])+Math.abs(data[i+1]-baselineData[i+1])+Math.abs(data[i+2]-baselineData[i+2]))/3;
                if(d > sens) diff++;
            }
            const pct = (diff / (w*h)) * 100; // % de pixels diff√©rents

            if(pct > 10) { // V√©hicule
                ui.zone.style.borderColor="red";
                videSince = null; // reset validation vide
                idleSince = null; // reset arr√™t cha√Æne (idle)

                // Confirmation v√©hicule pour √©viter faux d√©clenchements (ombre/flash)
                if(!isVeh) {
                    if(!vehSince) vehSince = Date.now();
                    const vElap = (Date.now()-vehSince)/1000;
                    if(vElap < VEH_CONFIRM_SECONDS) {
                        ui.status.innerText = `üöó D√©tection... validation ${Math.ceil(vElap)}/${VEH_CONFIRM_SECONDS}s`;
                        return;
                    }
                    // Confirm√©
                    isVeh = true;
                    seenVehOnce = true;
                    tStart = vehSince; // compte depuis la 1√®re d√©tection
                    vehSince = null;
                    ui.status.innerText = "üöó V√©hicule !";
                    if(stopped) triggerResume();
                } else {
                    vehSince = null;
                }

                const elap = Math.floor((Date.now()-tStart)/1000);
                let tgt = parseInt(document.getElementById('targetCycle').value);
                if(!Number.isFinite(tgt)) tgt = 267;
                // Astuce: mettre Cycle(s)=0 pour d√©sactiver le STOP cycle
                const hh = Math.floor(elap/3600);
                const mm = Math.floor((elap%3600)/60);
                const ss = elap%60;
                ui.timer.innerText = `${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
                // Couleur du timer selon l"avancement (OK -> WARN -> DANGER -> OVER)
                const ratio = (tgt>0) ? (elap/tgt) : 0;
                ui.timer.classList.remove("timer-ok","timer-warn","timer-danger","timer-over");
                if(tgt<=0){
                    ui.timer.classList.add("timer-ok");
                } else if(ratio < 0.70){
                    ui.timer.classList.add("timer-ok");
                } else if(ratio < 0.90){
                    ui.timer.classList.add("timer-warn");
                } else if(ratio < 1.0){
                    ui.timer.classList.add("timer-danger");
                } else {
                    ui.timer.classList.add("timer-over");
                }
                const pBar = (tgt>0) ? Math.min((elap/tgt)*100, 100) : 0;
                ui.bar.style.width = pBar+"%";
                ui.bar.style.background = (tgt<=0) ? "#28a745" : (ratio < 0.70 ? "#28a745" : (ratio < 0.90 ? "#ffc107" : "#dc3545"));

                if(ui.pct){ ui.pct.textContent = (tgt>0 ? Math.min(100, Math.round((elap/tgt)*100)) + "%" : "‚àû"); }
                if(ui.tgtTxt){ ui.tgtTxt.textContent = "/ " + (tgt>0 ? Math.round(tgt) : 0) + "s"; }
                setCamState("üöó V√©hicule - cycle en cours", "state-veh");
                if(ui.idleDisp) ui.idleDisp.style.display="none";

                if(tgt>0 && elap >= tgt && !stopped) triggerStop("‚è±Ô∏è Cycle d√©pass√© ("+tgt+"s)");

            } else { // Vide (confirmation avec Gap)
                vehSince = null;
                ui.zone.style.borderColor="#0f0";
                const gap = parseInt(document.getElementById('gapTime').value)||0;

                // Si on √©tait en pr√©sence (isVeh), on ne valide le retour vide qu'apr√®s gap secondes de vide stable
                if(isVeh) {
                    if(!videSince) videSince = Date.now();
                    const gElap = (Date.now()-videSince)/1000;

                    if(gap > 0 && gElap < gap) {
                        ui.status.innerText = `‚ö™ Vide... validation ${Math.ceil(gElap)}/${gap}s`;
                        setCamState('‚ö™ Vide (Gap)', 'state-vide');
                        // On garde le timer affich√© (freeze) jusqu'√† validation
                    } else {
                        isVeh = false;
                        tStart = null;
                        videSince = null;
                        ui.status.innerText = "‚ö™ Vide confirm√©";
                        setCamState('‚úÖ Vide confirm√©', 'state-vide');
                        // D√©marrer timer d'arr√™t cha√Æne SEULEMENT apr√®s une pr√©sence confirm√©e puis retour vide
                        idleSince = Date.now();
                        if(ui.idleDisp){ ui.idleDisp.style.display='block'; ui.idleDisp.textContent='Attente: 00:00'; }
                        ui.timer.innerText = "00:00:00";
                        ui.bar.style.width = "0%";
                        if(ui.pct) ui.pct.textContent='0%';
                    }
                } else {
                    // D√©j√† vide (avant 1er v√©hicule, on n'active PAS l'arr√™t de cha√Æne)
                    videSince = null;
                    if(baselineData){
                        ui.status.innerText = "‚úÖ En attente v√©hicule...";
                        setCamState("‚è≥ En attente v√©hicule", "state-wait");
                        if(ui.idleDisp) ui.idleDisp.style.display="none";
                        // Ne d√©marre pas idleSince ici. Il d√©marre uniquement apr√®s un cycle (v√©hicule confirm√© puis vide confirm√©).
                    }
                }

                // Si vide persiste trop longtemps => arr√™t de cha√Æne
                const idleLimit = parseFloat(document.getElementById('idleLimitSec')?.value)||0;
                if(idleLimit > 0 && seenVehOnce && idleSince && !stopped) {
                    const idleSec = (Date.now()-idleSince)/1000;
                    // Afficher le compteur d'attente (arr√™t de cha√Æne)
                    if(idleLimit>0 && idleSec < idleLimit && !isVeh && baselineData){
                        const st = ui.status.innerText || "";
                        if(!st.startsWith('‚ö™ Vide... validation')){
                            ui.status.innerText = `‚úÖ En attente v√©hicule... (${Math.floor(idleSec)}/${Math.round(idleLimit)}s)`;
                        }
                    }

                    // Auto recalibrage (optionnel) : uniquement quand c'est vide confirm√© et qu'on attend
                    const ar = parseFloat(document.getElementById('autoRecalibSec')?.value)||0;
                    if(ar>0 && !isVeh && baselineData && idleSince && idleSec >= ar && !stopped){
                        calibrateEmpty();
                        idleSince = Date.now(); // reset attente ÿ®ÿπÿØ recalib
                        if(ui.status) ui.status.innerText = "‚ôªÔ∏è Auto recalibr√© (vide)";
                        setCamState('‚ôªÔ∏è Auto recalibr√©', 'state-wait');
                    }
                    if(idleSec >= idleLimit) {
                        triggerStop(`üõë Arr√™t de cha√Æne (${Math.round(idleLimit)}s sans v√©hicule)`);
                    }
                }
            }
        }
    }

    function triggerStop(msg) {
        if(stopped) return;
        const tl=document.getElementById('teamLeader'),c=document.getElementById('cause'),b=document.getElementById('stopBtn');
        if(tl){svTL=tl.value; tl.value="Cam√©ra Auto";} if(c)c.value=msg;
        if(b){b.click(); stopped=true;}
        setCamState('üõë STOP AUTO', 'state-stop');
        const a=document.getElementById('alarm'); 
        if(a){ a.volume = parseFloat(ui.vol.value); a.play(); }
    }

    function triggerResume() {
        const b=document.getElementById('goBtn'),tl=document.getElementById('teamLeader');
        if(b){
            const o=window.sendWhatsApp;window.sendWhatsApp=()=>{console.log("No WA")}; 
            b.click(); stopped=false;
            setTimeout(()=>{window.sendWhatsApp=o;if(tl&&svTL)tl.value=svTL;},1000);
        }
    }

    // --- LOGIQUE STANDARD PAUSES ---
    const LS_P="FINAL_CFG_V2"; const D_P={Matin:{p1s:"08:00",p1e:"08:30",p2s:"10:00",p2e:"10:30",p3s:"12:00",p3e:"12:30"},"Apr√®s-midi":{p1s:"16:00",p1e:"16:30",p2s:"18:00",p2e:"18:30",p3s:"20:00",p3e:"20:30"},Nuit:{p1s:"00:00",p1e:"00:30",p2s:"02:00",p2e:"02:30",p3s:"04:00",p3e:"04:30"}};
    let pC=JSON.parse(localStorage.getItem(LS_P))||D_P;
    window.openPauseConfig=function(){document.getElementById('pauseConfigModal').style.display='block'; fl('pm',pC.Matin);fl('pa',pC["Apr√®s-midi"]);fl('pn',pC.Nuit);};
    function fl(p,d){if(!d)return;set(p+'_1_s',d.p1s);set(p+'_1_e',d.p1e);set(p+'_2_s',d.p2s);set(p+'_2_e',d.p2e);set(p+'_3_s',d.p3s);set(p+'_3_e',d.p3e);}
    function rd(p){return{p1s:v(p+'_1_s'),p1e:v(p+'_1_e'),p2s:v(p+'_2_s'),p2e:v(p+'_2_e'),p3s:v(p+'_3_s'),p3e:v(p+'_3_e')};}
    function set(i,val){const e=document.getElementById(i);if(e)e.value=val;} function v(i){const e=document.getElementById(i);return e?e.value:'';}
    window.savePauses=function(){pC={Matin:rd('pm'),"Apr√®s-midi":rd('pa'),Nuit:rd('pn')}; localStorage.setItem(LS_P,JSON.stringify(pC)); document.getElementById('pauseConfigModal').style.display='none'; appLogic(true); alert("‚úÖ Sauvegard√©");};
    function appLogic(frc){
        const h=new Date().getHours(); const s=(h>=6&&h<14)?"Matin":(h>=14&&h<22)?"Apr√®s-midi":"Nuit";
        if(typeof currentShiftType!=='undefined'&&currentShiftType!==s){currentShiftType=s;const sl=document.getElementById('shiftSelect');if(sl)sl.value=s;if(typeof refreshTable==='function')refreshTable();}
        const d=pC[s]; if(d){set('p1Start',d.p1s);set('p1End',d.p1e);set('p2Start',d.p2s);set('p2End',d.p2e);set('p3Start',d.p3s);set('p3End',d.p3e);}
        if(frc)try{if(typeof updateProductionCalculations==='function')updateProductionCalculations();}catch(e){}
    }
    setInterval(appLogic,2000); setTimeout(()=>appLogic(true),1000);
})();
</script>

<!-- ============================
     üì∑ CAM√âRA AUTO (Android) ‚Äì Plein √©cran + ROI + D√©tection arr√™t
     Ajout√©: fusion avec index_camera_tracker.html
     ============================ -->
<style id="camAutoStyles">
  #camAutoFab{
    position:fixed; right:16px; bottom: calc(env(safe-area-inset-bottom, 0px) + 16px);
    z-index: 20000;
    width:56px; height:56px; border-radius: 18px;
    display:flex; align-items:center; justify-content:center;
    background: linear-gradient(135deg, #1A7DFF 0%, #00509e 100%);
    color:#fff; font-size:22px; cursor:pointer;
    box-shadow: 0 12px 30px rgba(0,0,0,.35);
    border: 1px solid rgba(255,255,255,.14);
  }
  #camAutoModal{
    position:fixed; inset:0; z-index: 20001; display:none;
    background: rgba(0,0,0,.92);
  }
  #camAutoModal.active{ display:block; }
  #camAutoTopBar{
    position:absolute; left:0; right:0;
    top: 0; padding: 10px 12px;
    padding-top: calc(env(safe-area-inset-top, 0px) + 10px);
    display:flex; gap:10px; align-items:center; justify-content:space-between;
    z-index: 20004;
    background: linear-gradient(180deg, rgba(0,0,0,.75), rgba(0,0,0,.0));
  }
  #camAutoTopBar .left{
    display:flex; gap:10px; align-items:center;
    min-width: 0;
  }
  #camAutoClose{
    width:44px; height:44px; border-radius: 14px;
    background: rgba(255,255,255,.10);
    border: 1px solid rgba(255,255,255,.16);
    color:#fff; font-weight:900; cursor:pointer;
  }
  #camAutoTitle{
    font-weight:900; color:#fff; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }
  #camAutoPill{
    padding: 8px 10px; border-radius: 999px; font-weight: 900; font-size: 12px;
    border: 1px solid rgba(255,255,255,.14); background: rgba(255,255,255,.06);
    color:#fff;
  }
  #camAutoPill.ok{background:rgba(42,157,143,.18);border-color:rgba(42,157,143,.35)}
  #camAutoPill.stop{background:rgba(217,4,41,.18);border-color:rgba(217,4,41,.45)}
  #camAutoPill.wait{background:rgba(255,159,28,.18);border-color:rgba(255,159,28,.45)}

  #camAutoStage{ position:absolute; inset:0; }
  #camAutoVideo{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; background:#000; }
  #camAutoRoi{
    position:absolute; border:2px dashed rgba(255,255,255,.9);
    border-radius: 14px;
    box-shadow: 0 0 0 9999px rgba(0,0,0,.22);
    display:none;
    touch-action:none;
    z-index:20003;
  }
  #camAutoHud{
    position:absolute; left:12px;
    top: calc(env(safe-area-inset-top, 0px) + 70px);
    z-index:20004;
    background: rgba(17,26,46,.78);
    backdrop-filter: blur(8px);
    border: 1px solid rgba(255,255,255,.12);
    border-radius: 14px;
    padding: 10px 12px;
    max-width: min(92vw, 520px);
  }
  #camAutoHud .line{ font-size:12px; color: rgba(255,255,255,.9); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  #camAutoHud b{ font-weight: 900; }

  #camAutoPanel{
    position:absolute; left:0; right:0;
    bottom:0; z-index:20004;
    padding: 12px;
    padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 12px);
    background: linear-gradient(180deg, rgba(0,0,0,.0), rgba(0,0,0,.82) 45%, rgba(0,0,0,.92));
  }
  #camAutoCard{
    background: rgba(17,26,46,.88);
    border: 1px solid rgba(255,255,255,.10);
    border-radius: 16px;
    padding: 12px;
  }
  #camAutoCard label{ font-size:12px; color: rgba(255,255,255,.75); font-weight: 900; display:block; margin-bottom:6px; }
  #camAutoCard input, #camAutoCard button{
    width: 100%; box-sizing:border-box;
    padding: 12px 12px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.20);
    color: #fff;
    font-weight: 900;
    font-size: 14px;
  }
  #camAutoCard .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  #camAutoCard .row > *{ flex:1; min-width: 150px; }
  #camAutoCard .btn{ border:none; cursor:pointer; background: linear-gradient(135deg, #1A7DFF 0%, #00509e 100%); }
  #camAutoCard .btn2{ border:none; cursor:pointer; background: linear-gradient(135deg, #2a9d8f 0%, #1a936f 100%); }
  #camAutoCard .btn3{ border:none; cursor:pointer; background: linear-gradient(135deg, #ff9f1c 0%, #f77f00 100%); color:#000; }
  #camAutoCard .btn4{ border:none; cursor:pointer; background: linear-gradient(135deg, #d90429 0%, #9d0208 100%); }
  #camAutoCard .mini{ padding: 10px 10px; font-size: 13px; }
  #camAutoHint{ margin-top: 8px; font-size:12px; color: rgba(255,255,255,.80); line-height: 1.35; }
</style>

<div id="camAutoFab" class="no-print" title="Cam√©ra Auto">üì∑</div>

<div id="camAutoModal" aria-hidden="true">
  <div id="camAutoStage">
    <video id="camAutoVideo" playsinline muted></video>
    <div id="camAutoRoi" aria-label="Zone de d√©tection (ROI)"></div>

    <div id="camAutoTopBar">
      <div class="left">
        <button id="camAutoClose" type="button">‚úï</button>
        <div id="camAutoTitle">Cam√©ra Auto ‚Ä¢ ROI ‚Ä¢ D√©tection Arr√™t</div>
      </div>
      <div id="camAutoPill" class="wait">‚è≥ En attente</div>
    </div>

    <div id="camAutoHud">
      <div class="line"><b>Motion:</b> <span id="camAutoMotion">--</span> ‚Ä¢ <b>Seuil:</b> <span id="camAutoThr">--</span></div>
      <div class="line"><b>Sans mouvement:</b> <span id="camAutoIdle">0.0</span> s ‚Ä¢ <b>Stop apr√®s:</b> <span id="camAutoStopAfterShow">--</span> s</div>
      <div class="line"><b>Roi:</b> <span id="camAutoRoiInfo">auto (centre)</span> ‚Ä¢ <b>Zoom:</b> <span id="camAutoZoomShow">1.00</span>x</div>
    </div>

    <div id="camAutoPanel">
      <div id="camAutoCard">
        <div class="row">
          <div>
            <label>Stop apr√®s (secondes sans mouvement)</label>
            <input id="camAutoStopAfter" type="number" inputmode="numeric" min="1" value="8"/>
          </div>
          <div>
            <label>Sensibilit√© (plus bas = plus sensible)</label>
            <input id="camAutoThreshold" type="range" min="3" max="60" value="18"/>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <button id="camAutoStart" class="btn" type="button">‚ñ∂Ô∏è D√©marrer cam√©ra</button>
          <button id="camAutoSetRoi" class="btn3" type="button">üéØ D√©finir ROI</button>
          <button id="camAutoTorch" class="btn2 mini" type="button">üí° Torch OFF</button>
          <button id="camAutoPhoto" class="btn2" type="button">üì∏ Photo</button>
        </div>

        <div class="row" style="margin-top:10px">
          <div>
            <label>Zoom (si support√©)</label>
            <input id="camAutoZoom" type="range" min="1" max="1" step="0.01" value="1"/>
          </div>
          <div>
            <label>Distance (approx.)</label>
            <input id="camAutoDistanceHint" type="text" value="Fixe ‚Ä¢ ROI petit ‚Ä¢ rep√®re visible" readonly />
          </div>
        </div>

        <div id="camAutoHint">
          M√©thode pr√©cision: place le t√©l√©phone <b>fixe</b> (tr√©pied), mets une <b>lumi√®re stable</b>, vise une zone o√π <b>les v√©hicules passent</b>,
          puis ROI sur cette zone seulement. Si tu n‚Äôas ‚Äúaucun signal‚Äù, baisse la sensibilit√© (seuil) et augmente ‚ÄúStop apr√®s‚Äù.
        </div>
      </div>
    </div>
  </div>

  <canvas id="camAutoCanvas" width="320" height="240" style="display:none"></canvas>
</div>

<script id="camAutoScript">
(() => {
  const $ = (id) => document.getElementById(id);

  const fab = $('camAutoFab');
  const modal = $('camAutoModal');
  const closeBtn = $('camAutoClose');

  const video = $('camAutoVideo');
  const canvas = $('camAutoCanvas');
  const ctx = canvas.getContext('2d', { willReadFrequently: true });

  const startBtn = $('camAutoStart');
  const setRoiBtn = $('camAutoSetRoi');
  const torchBtn = $('camAutoTorch');
  const photoBtn = $('camAutoPhoto');

  const thresholdEl = $('camAutoThreshold');
  const zoomEl = $('camAutoZoom');
  const stopAfterEl = $('camAutoStopAfter');

  const motionEl = $('camAutoMotion');
  const thrEl = $('camAutoThr');
  const idleEl = $('camAutoIdle');
  const stopAfterShow = $('camAutoStopAfterShow');
  const zoomShow = $('camAutoZoomShow');

  const pill = $('camAutoPill');
  const roiBox = $('camAutoRoi');
  const roiInfo = $('camAutoRoiInfo');

  const LS = {
    roi: 'cam_auto_roi_v2',
    thr: 'cam_auto_thr_v2',
    stopAfter: 'cam_auto_stopafter_v2',
    zoom: 'cam_auto_zoom_v2',
  };

  let stream = null;
  let track = null;
  let raf = 0;

  let roi = null; // {x,y,w,h} in canvas coords
  let pickingROI = false;

  let lastFrame = null;
  let lastT = performance.now();
  let idleMs = 0;

  // state machine to avoid double click spam
  let state = 'WAIT'; // WAIT | RUN | STOP
  let lastAutoAction = 0; // ms

  function setPill(kind, text){
    pill.className = '';
    pill.classList.add(kind);
    pill.textContent = text;
  }
  function setState(next){
    state = next;
    if(next === 'WAIT'){ setPill('wait','‚è≥ En attente'); }
    if(next === 'RUN'){ setPill('ok','üü¢ En marche'); }
    if(next === 'STOP'){ setPill('stop','üî¥ Arr√™t'); }
  }

  function openModal(){
    modal.classList.add('active');
    modal.setAttribute('aria-hidden','false');
    // Lock scroll
    document.body.style.overflow = 'hidden';
  }
  function closeModal(){
    modal.classList.remove('active');
    modal.setAttribute('aria-hidden','true');
    document.body.style.overflow = '';
  }

  fab?.addEventListener('click', openModal);
  closeBtn?.addEventListener('click', closeModal);
  modal?.addEventListener('click', (e)=>{ if(e.target===modal) closeModal(); });

  // Load settings
  try{
    const savedRoi = localStorage.getItem(LS.roi);
    if(savedRoi) roi = JSON.parse(savedRoi);
    const savedThr = localStorage.getItem(LS.thr);
    if(savedThr) thresholdEl.value = savedThr;
    const savedStopAfter = localStorage.getItem(LS.stopAfter);
    if(savedStopAfter) stopAfterEl.value = savedStopAfter;
    const savedZoom = localStorage.getItem(LS.zoom);
    if(savedZoom) zoomEl.value = savedZoom;
  }catch(_){}

  function saveSettings(){
    try{
      localStorage.setItem(LS.thr, String(thresholdEl.value));
      localStorage.setItem(LS.stopAfter, String(stopAfterEl.value));
      localStorage.setItem(LS.zoom, String(zoomEl.value));
      if(roi) localStorage.setItem(LS.roi, JSON.stringify(roi));
    }catch(_){}
  }
  thresholdEl.addEventListener('input', () => { thrEl.textContent = thresholdEl.value; saveSettings(); });
  stopAfterEl.addEventListener('change', () => { stopAfterShow.textContent = stopAfterEl.value; saveSettings(); });
  zoomEl.addEventListener('input', () => { zoomShow.textContent = Number(zoomEl.value).toFixed(2); applyZoom(); saveSettings(); });

  function getStopBtn(){ return document.getElementById('stopBtn'); }
  function getGoBtn(){ return document.getElementById('goBtn'); }

  // Hook to your existing app logic (if present)
  function triggerStopFromCamera(){
    const now = Date.now();
    if(now - lastAutoAction < 2500) return; // anti double click
    lastAutoAction = now;

    // Prefer existing helper if present
    if(typeof window.triggerStop === 'function'){ window.triggerStop('CAMERA_AUTO'); return; }

    // Fallback: click button if exists
    const b = getStopBtn();
    if(b){ b.click(); }
  }

  function triggerResumeFromCamera(){
    const now = Date.now();
    if(now - lastAutoAction < 2500) return;
    lastAutoAction = now;

    if(typeof window.triggerResume === 'function'){ window.triggerResume('CAMERA_AUTO'); return; }

    const b = getGoBtn();
    if(b){ b.click(); }
  }

  async function startCamera(){
    if(stream) return;

    // Back camera preference
    const constraints = {
      audio:false,
      video:{
        facingMode: { ideal: 'environment' },
        width: { ideal: 1280 },
        height:{ ideal: 720 }
      }
    };

    stream = await navigator.mediaDevices.getUserMedia(constraints);
    video.srcObject = stream;
    await video.play();

    // Choose first video track
    track = stream.getVideoTracks()[0];

    // Resize analysis canvas
    const vw = video.videoWidth || 640;
    const vh = video.videoHeight || 360;
    // keep low-res for speed
    const targetW = 320;
    const targetH = Math.round(targetW * (vh / vw));
    canvas.width = targetW;
    canvas.height = targetH;

    // Init ROI if none -> centered
    if(!roi){
      const w = Math.round(canvas.width * 0.35);
      const h = Math.round(canvas.height * 0.35);
      roi = { x: Math.round((canvas.width - w)/2), y: Math.round((canvas.height - h)/2), w, h };
    }
    drawRoiBox();
    updateRoiInfo();

    // Setup capabilities
    setupZoomTorch();

    thrEl.textContent = thresholdEl.value;
    stopAfterShow.textContent = stopAfterEl.value;
    zoomShow.textContent = Number(zoomEl.value).toFixed(2);

    setState('RUN');
    loop();
  }

  function stopCamera(){
    cancelAnimationFrame(raf);
    raf = 0;
    if(stream){
      stream.getTracks().forEach(t=>t.stop());
    }
    stream = null; track = null;
    lastFrame = null; idleMs = 0;
    setState('WAIT');
  }

  startBtn.addEventListener('click', async ()=>{
    try{
      if(!stream){
        startBtn.textContent = '‚èπÔ∏è Arr√™ter cam√©ra';
        await startCamera();
      }else{
        startBtn.textContent = '‚ñ∂Ô∏è D√©marrer cam√©ra';
        stopCamera();
      }
    }catch(err){
      console.error(err);
      alert("Erreur cam√©ra: autorisation refus√©e ou navigateur non compatible.\nAstuce: ouvre le fichier via Chrome/Edge et autorise la cam√©ra.");
      startBtn.textContent = '‚ñ∂Ô∏è D√©marrer cam√©ra';
      stopCamera();
    }
  });

  // ROI selection using pointer drag on overlay
  setRoiBtn.addEventListener('click', ()=>{
    pickingROI = !pickingROI;
    roiBox.style.display = pickingROI ? 'block' : 'block';
    roiBox.style.borderStyle = pickingROI ? 'solid' : 'dashed';
    roiBox.style.borderColor = pickingROI ? 'rgba(255,159,28,.95)' : 'rgba(255,255,255,.9)';
    setRoiBtn.textContent = pickingROI ? '‚úÖ ROI: fini' : 'üéØ D√©finir ROI';
    updateRoiInfo();
    saveSettings();
  });

  function updateRoiInfo(){
    if(!roi){ roiInfo.textContent = 'auto'; return; }
    roiInfo.textContent = `${roi.w}√ó${roi.h} @ (${roi.x},${roi.y})`;
  }

  // Draggable ROI
  let drag = null;
  roiBox.addEventListener('pointerdown', (e)=>{
    e.preventDefault();
    roiBox.setPointerCapture(e.pointerId);
    const rect = roiBox.getBoundingClientRect();
    drag = {
      startX: e.clientX, startY: e.clientY,
      baseLeft: rect.left, baseTop: rect.top,
      baseW: rect.width, baseH: rect.height,
      mode: (e.offsetX > rect.width-28 && e.offsetY > rect.height-28) ? 'resize' : 'move'
    };
  });
  roiBox.addEventListener('pointermove', (e)=>{
    if(!drag) return;
    const stage = $('camAutoStage').getBoundingClientRect();
    const dx = e.clientX - drag.startX;
    const dy = e.clientY - drag.startY;

    // compute new roiBox in screen px then map to canvas coords
    let left = drag.baseLeft - stage.left;
    let top  = drag.baseTop  - stage.top;
    let w = drag.baseW;
    let h = drag.baseH;

    if(drag.mode === 'move'){
      left += dx; top += dy;
    }else{
      w = Math.max(40, w + dx);
      h = Math.max(40, h + dy);
    }

    // clamp
    left = Math.max(10, Math.min(left, stage.width - w - 10));
    top  = Math.max(10, Math.min(top,  stage.height - h - 10));

    // apply visual
    roiBox.style.left = `${left}px`;
    roiBox.style.top = `${top}px`;
    roiBox.style.width = `${w}px`;
    roiBox.style.height = `${h}px`;

    // map to canvas coords (video covers stage: object-fit cover)
    const mapped = mapScreenRectToCanvas(left, top, w, h, stage.width, stage.height);
    if(mapped){
      roi = mapped;
      updateRoiInfo();
      saveSettings();
    }
  });
  roiBox.addEventListener('pointerup', ()=>{ drag=null; });

  function mapScreenRectToCanvas(left, top, w, h, stageW, stageH){
    // We analyze on canvas drawn from video, which is scaled to cover the stage.
    // Compute video-to-stage cover transform in analysis space:
    const vw = video.videoWidth || 640;
    const vh = video.videoHeight || 360;

    // cover scale
    const scale = Math.max(stageW / vw, stageH / vh);
    const dispW = vw * scale;
    const dispH = vh * scale;
    const offX = (stageW - dispW) / 2; // can be negative
    const offY = (stageH - dispH) / 2;

    // convert stage px -> video px
    const vx = (left - offX) / scale;
    const vy = (top  - offY) / scale;
    const vwRect = w / scale;
    const vhRect = h / scale;

    // now video px -> canvas px
    const cx = Math.round(vx * (canvas.width / vw));
    const cy = Math.round(vy * (canvas.height / vh));
    const cw = Math.round(vwRect * (canvas.width / vw));
    const ch = Math.round(vhRect * (canvas.height / vh));

    // clamp within canvas
    const x = Math.max(0, Math.min(cx, canvas.width - 1));
    const y = Math.max(0, Math.min(cy, canvas.height - 1));
    const ww = Math.max(20, Math.min(cw, canvas.width - x));
    const hh = Math.max(20, Math.min(ch, canvas.height - y));

    return { x, y, w: ww, h: hh };
  }

  function drawRoiBox(){
    const stage = $('camAutoStage').getBoundingClientRect();
    if(!roi || !stage.width || !stage.height) return;

    // Map ROI canvas coords -> stage screen px, using cover transform
    const vw = video.videoWidth || 640;
    const vh = video.videoHeight || 360;
    const scale = Math.max(stage.width / vw, stage.height / vh);
    const dispW = vw * scale;
    const dispH = vh * scale;
    const offX = (stage.width - dispW) / 2;
    const offY = (stage.height - dispH) / 2;

    const vx = roi.x * (vw / canvas.width);
    const vy = roi.y * (vh / canvas.height);
    const vwRect = roi.w * (vw / canvas.width);
    const vhRect = roi.h * (vh / canvas.height);

    const left = offX + vx * scale;
    const top  = offY + vy * scale;
    const w = vwRect * scale;
    const h = vhRect * scale;

    roiBox.style.display = 'block';
    roiBox.style.left = `${Math.max(10,left)}px`;
    roiBox.style.top  = `${Math.max(10,top)}px`;
    roiBox.style.width  = `${Math.max(40,w)}px`;
    roiBox.style.height = `${Math.max(40,h)}px`;
  }

  window.addEventListener('resize', ()=>{ if(stream) drawRoiBox(); });

  // Torch + Zoom (best-effort)
  function setupZoomTorch(){
    if(!track) return;

    const caps = track.getCapabilities ? track.getCapabilities() : {};
    // Zoom
    if(caps.zoom){
      zoomEl.min = caps.zoom.min;
      zoomEl.max = caps.zoom.max;
      zoomEl.step = caps.zoom.step || 0.01;
      const wanted = Math.min(caps.zoom.max, Math.max(caps.zoom.min, Number(zoomEl.value)));
      zoomEl.value = String(wanted);
      applyZoom();
    }else{
      zoomEl.min = 1; zoomEl.max = 1; zoomEl.step = 0.01; zoomEl.value = "1";
    }

    // Torch
    if(caps.torch){
      torchBtn.disabled = false;
    }else{
      torchBtn.disabled = true;
      torchBtn.textContent = 'üí° Torch N/A';
    }
  }

  async function applyZoom(){
    if(!track || !track.applyConstraints) return;
    const caps = track.getCapabilities ? track.getCapabilities() : {};
    if(!caps.zoom) return;
    const z = Number(zoomEl.value);
    try{ await track.applyConstraints({ advanced: [{ zoom: z }] }); }
    catch(e){ console.warn('Zoom constraint failed', e); }
  }

  let torchOn = false;
  torchBtn.addEventListener('click', async ()=>{
    if(!track || !track.applyConstraints) return;
    const caps = track.getCapabilities ? track.getCapabilities() : {};
    if(!caps.torch) return;
    torchOn = !torchOn;
    try{
      await track.applyConstraints({ advanced: [{ torch: torchOn }] });
      torchBtn.textContent = torchOn ? 'üí° Torch ON' : 'üí° Torch OFF';
    }catch(e){
      console.warn('Torch failed', e);
      torchOn = false;
      torchBtn.textContent = 'üí° Torch OFF';
    }
  });

  // Photo capture
  photoBtn.addEventListener('click', ()=>{
    if(!stream) return;
    // capture current full analysis frame
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const dataUrl = canvas.toDataURL('image/jpeg', 0.92);
    const a = document.createElement('a');
    a.href = dataUrl;
    a.download = `photo_${new Date().toISOString().replace(/[:.]/g,'-')}.jpg`;
    a.click();
  });

  function loop(){
    if(!stream) return;
    raf = requestAnimationFrame(loop);

    const now = performance.now();
    const dt = now - lastT;
    lastT = now;

    // draw frame
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    // compute motion score in ROI
    const r = roi || { x: Math.round(canvas.width*0.33), y: Math.round(canvas.height*0.33),
                      w: Math.round(canvas.width*0.34), h: Math.round(canvas.height*0.34) };

    const img = ctx.getImageData(r.x, r.y, r.w, r.h);
    const data = img.data;

    // grayscale and diff
    let diffSum = 0;
    if(lastFrame && lastFrame.length === data.length){
      for(let i=0;i<data.length;i+=4){
        const g = (data[i]*0.299 + data[i+1]*0.587 + data[i+2]*0.114);
        const pg = lastFrame[i];
        diffSum += Math.abs(g - pg);
        lastFrame[i] = g; // reuse buffer
      }
    }else{
      lastFrame = new Float32Array(data.length);
      for(let i=0;i<data.length;i+=4){
        lastFrame[i] = (data[i]*0.299 + data[i+1]*0.587 + data[i+2]*0.114);
      }
      diffSum = 999999; // first frame
    }

    const pixels = (data.length/4);
    const motion = diffSum / pixels; // average abs diff 0..255
    motionEl.textContent = motion.toFixed(1);
    thrEl.textContent = thresholdEl.value;
    stopAfterShow.textContent = stopAfterEl.value;

    const thr = Number(thresholdEl.value);
    const moving = motion >= thr;

    if(moving){
      idleMs = 0;
      idleEl.textContent = (idleMs/1000).toFixed(1);

      // if we were in STOP, resume only after stable movement for ~1s
      if(state === 'STOP'){
        // small hysteresis: require 1s of movement
        // we'll track with negative idleMs as "moving ms"
        idleMs = -Math.min(1000, (-idleMs) + dt);
        if((-idleMs) >= 800){
          setState('RUN');
          triggerResumeFromCamera();
          idleMs = 0;
        }
      }else{
        if(state !== 'RUN') setState('RUN');
      }
    }else{
      // no movement
      if(state === 'STOP'){
        idleMs += dt;
        idleEl.textContent = (idleMs/1000).toFixed(1);
      }else{
        idleMs += dt;
        idleEl.textContent = (idleMs/1000).toFixed(1);

        const stopAfter = Math.max(1, Number(stopAfterEl.value)) * 1000;
        if(idleMs >= stopAfter){
          setState('STOP');
          triggerStopFromCamera();
          // Keep counting
        }
      }
    }

    // keep ROI overlay aligned
    drawRoiBox();
  }

  // If user closes modal, stop camera to save battery
  modal.addEventListener('transitionend', ()=>{});
  closeBtn.addEventListener('click', ()=>{
    if(stream){
      startBtn.textContent = '‚ñ∂Ô∏è D√©marrer cam√©ra';
      stopCamera();
    }
  });
})();
</script>

</body>
</html>
